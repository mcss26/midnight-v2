<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - POS</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">POS</span></div>
    <div class="admin-header-right">
      <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">Terminales POS</h2>
        <p class="section-desc">Puntos de cobro del sistema.</p>
      </div>
      <button class="btn-primary" onclick="openPosModal()">+ NUEVA TERMINAL</button>
    </div>

    <input type="text" id="searchPos" class="search-input-admin" placeholder="üîç Buscar terminal..." oninput="filterPos()">

    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left:25px;">NOMBRE</th>
            <th>PROVEEDOR</th>
            <th>ID EXTERNO</th>
            <th>ESTADO</th>
            <th style="width:60px;"></th>
          </tr>
        </thead>
        <tbody id="posList"></tbody>
      </table>
    </div>
  </div>

  <div id="posModal" class="modal-overlay">
    <div class="modal-box">
      <h3 class="section-title" style="font-size:20px; margin-bottom:20px;">Terminal POS</h3>
      <input type="hidden" id="pId">
      <label class="input-label">NOMBRE AMIGABLE</label>
      <input type="text" id="pName" class="modal-input" placeholder="Ej: CAJA BARRA 1">
      <div style="display:flex; gap:15px; margin-top:15px;">
        <div style="flex:1;">
          <label class="input-label">PROVEEDOR</label>
          <select id="pProvider" class="modal-select">
            <option value="MERCADO PAGO">MERCADO PAGO</option>
            <option value="GETNET">GETNET</option>
            <option value="POS BANCO">POS BANCO</option>
            <option value="OTRO">OTRO</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">ID EXTERNO</label>
          <input type="text" id="pExternal" class="modal-input" placeholder="Ref. T√©cnica">
        </div>
      </div>
      <div style="margin-top:15px; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="pActive" checked>
          <span style="font-size:13px; color:var(--text-secondary);">Terminal Activa</span>
      </div>
      <div class="modal-btns">
        <button onclick="closePosModal()" class="btn-modal-cancel">CANCELAR</button>
        <button onclick="savePos()" class="btn-modal-save">GUARDAR</button>
      </div>
    </div>
  </div>

  <script>
    let posTerminals=[];
    document.addEventListener('DOMContentLoaded',loadPos);
    async function loadPos(){
        const{data}=await client.from('pos_terminals').select('*').order('friendly_name');
        posTerminals=data||[]; renderPos(posTerminals);
    }
    function renderPos(l){
        const tb=document.getElementById('posList');
        if(!l.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center; padding:30px;">Sin terminales.</td></tr>';return;}
        tb.innerHTML=l.map(t=>`<tr>
            <td style="padding-left:25px;" class="row-title">${t.friendly_name}</td>
            <td>${t.provider}</td>
            <td style="font-family:monospace; color:var(--text-secondary);">${t.external_id||'-'}</td>
            <td><span class="tag ${t.is_active?'tag-green':'tag-gray'}">${t.is_active?'ACTIVA':'OFF'}</span></td>
            <td style="text-align:center;"><button class="btn-icon" onclick="openPosModal(${t.id})">‚úèÔ∏è</button></td>
        </tr>`).join('');
    }
    function filterPos(){ renderPos(posTerminals.filter(p=>p.friendly_name.toLowerCase().includes(document.getElementById('searchPos').value.toLowerCase()))); }
    function openPosModal(id){
        const m=document.getElementById('posModal'); m.style.display='flex';
        if(id){
            const t=posTerminals.find(x=>x.id===id);
            document.getElementById('pId').value=t.id;
            document.getElementById('pName').value=t.friendly_name;
            document.getElementById('pProvider').value=t.provider;
            document.getElementById('pExternal').value=t.external_id;
            document.getElementById('pActive').checked=t.is_active;
        }else{
            document.getElementById('pId').value='';
            document.getElementById('pName').value='';
        }
    }
    function closePosModal(){document.getElementById('posModal').style.display='none';}
    async function savePos(){
        const id=document.getElementById('pId').value;
        const d={
            friendly_name:document.getElementById('pName').value,
            provider:document.getElementById('pProvider').value,
            external_id:document.getElementById('pExternal').value,
            is_active:document.getElementById('pActive').checked
        };
        if(!d.friendly_name)return;
        if(id) await client.from('pos_terminals').update(d).eq('id',id);
        else await client.from('pos_terminals').insert(d);
        closePosModal(); loadPos();
    }
  </script>
</body>
</html>