<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - POS Link</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@800;900&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>

  <style>
    .pos-card {
        background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px;
        margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
    }
    .provider-tag {
        font-family: 'Outfit'; font-weight: 800; font-size: 10px; padding: 3px 6px; 
        border-radius: 4px; letter-spacing: 1px;
    }
    .tag-gbol { background: rgba(232, 55, 47, 0.15); color: #e8372f; border: 1px solid #e8372f; }
    .tag-zoco { background: rgba(0, 234, 255, 0.15); color: #00eaff; border: 1px solid #00eaff; }
    
    .id-display { font-family: monospace; color: #ccc; font-size: 14px; margin-left: 10px; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-accent-blue);">POS</span></div>
    <button onclick="window.location.href='panel-master.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div>
            <h2 class="section-title">Mapeo de Terminales</h2>
            <p style="color:#666; font-size:12px;">Conexión GBol y Zoco</p>
        </div>
        <button onclick="openModal()" class="btn-primary">+ MANUAL</button>
    </div>
    
    <div id="posList">
        <div class="loading-state">Cargando configuración...</div>
    </div>
  </div>

  <div id="posModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Configurar Terminal</h3>
        <input type="hidden" id="pId">
        
        <label class="input-label">NOMBRE INTERNO (FRIENDLY NAME)</label>
        <input type="text" id="pName" class="modal-input" placeholder="Ej: CAJA 1">
        
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
            <div>
                <label class="input-label">SISTEMA</label>
                <select id="pProv" class="modal-select">
                    <option value="GBOL">GBOL</option>
                    <option value="ZOCO">ZOCO</option>
                </select>
            </div>
            <div>
                <label class="input-label">ID EXTERNO</label>
                <input type="text" id="pExtId" class="modal-input" placeholder="ID del sistema">
            </div>
        </div>

        <div class="modal-btns">
            <button onclick="closeModal()" class="btn-modal-cancel">CANCELAR</button>
            <button onclick="savePos()" class="btn-modal-save">GUARDAR</button>
        </div>
        <button id="btnDel" onclick="deletePos()" style="width:100%; margin-top:10px; background:none; border:none; color:#666; cursor:pointer;">ELIMINAR CONEXIÓN</button>
    </div>
  </div>

  <script>
    window.onload = loadData;

    async function loadData() {
        const { data } = await client.from('pos_terminals').select('*').order('friendly_name').order('provider');
        const c = document.getElementById('posList');
        
        if(!data || !data.length) { 
            c.innerHTML = '<div class="empty-state">Sin terminales configuradas.</div>'; 
            return; 
        }

        c.innerHTML = data.map(t => {
            const tagClass = t.provider === 'ZOCO' ? 'tag-zoco' : 'tag-gbol';
            return `
            <div class="pos-card">
                <div>
                    <div style="font-weight:700; color:#fff; font-size:14px; margin-bottom:5px;">${t.friendly_name}</div>
                    <div style="display:flex; align-items:center;">
                        <span class="provider-tag ${tagClass}">${t.provider}</span>
                        <span class="id-display">ID: ${t.external_id}</span>
                    </div>
                </div>
                <button onclick="edit(${t.id})" style="background:none; border:1px solid #333; color:#fff; width:30px; height:30px; border-radius:4px; cursor:pointer;">✏️</button>
            </div>
        `;}).join('');
    }

    // === ABM MANUAL ===
    function openModal() { 
        document.getElementById('posModal').style.display='flex'; 
        document.getElementById('pId').value=''; 
        document.getElementById('pName').value=''; 
        document.getElementById('pExtId').value='';
        document.getElementById('btnDel').style.display='none'; 
    }
    
    function closeModal() { document.getElementById('posModal').style.display='none'; }
    
    async function edit(id) {
        const { data } = await client.from('pos_terminals').select('*').eq('id',id).single();
        document.getElementById('pId').value = data.id;
        document.getElementById('pProv').value = data.provider;
        document.getElementById('pExtId').value = data.external_id;
        document.getElementById('pName').value = data.friendly_name;
        document.getElementById('btnDel').style.display='block';
        document.getElementById('posModal').style.display='flex';
    }

    async function savePos() {
        const id = document.getElementById('pId').value;
        const d = {
            provider: document.getElementById('pProv').value,
            external_id: document.getElementById('pExtId').value,
            friendly_name: document.getElementById('pName').value.toUpperCase()
        };

        if(!d.external_id || !d.friendly_name) return alert("Completa todos los datos.");

        const { error } = id 
            ? await client.from('pos_terminals').update(d).eq('id', id)
            : await client.from('pos_terminals').insert(d);
        
        if(error) alert(error.message);
        else { closeModal(); loadData(); }
    }

    async function deletePos() {
        if(!confirm("¿Eliminar esta conexión?")) return;
        const id = document.getElementById('pId').value;
        await client.from('pos_terminals').delete().eq('id', id);
        closeModal(); loadData();
    }
  </script>
</body>
</html>