<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - POS & Terminales</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <!-- HEADER MASTER DATA -->
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div style="display:flex; align-items:center;">
          <button class="btn-back" type="button" onclick="window.location.href='panel-master.html'">
            VOLVER
          </button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Master Data</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <section class="section-header">
      <div>
        <h1 class="section-title">TERMINALES POS</h1>
        <p class="section-desc">Puntos de cobro y terminales vinculadas al sistema.</p>
      </div>
      <button class="btn-primary" type="button" id="btnNewPos">
        Nueva terminal
      </button>
    </section>

    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <div style="flex:1; min-width:260px;">
        <input
          type="text"
          id="searchPos"
          class="search-input-admin"
          placeholder="Buscar terminal, proveedor o ID..."
        />
      </div>
    </div>

    <div class="table-container">
      <table class="sku-table" aria-label="Listado de terminales POS">
        <thead>
          <tr>
            <th style="padding-left:24px;">TERMINAL</th>
            <th>PROVEEDOR</th>
            <th>ID EXTERNO</th>
            <th>ESTADO</th>
            <th class="text-right">ACCIONES</th>
          </tr>
        </thead>
        <tbody id="posList"></tbody>
      </table>
    </div>
  </main>

  <!-- MODAL TERMINAL POS -->
  <div id="posModal" class="modal-overlay">
    <div class="modal-box">
      <h2 class="section-title" style="font-size:18px; letter-spacing:0.14em; text-align:left;">
        TERMINAL POS
      </h2>
      <p class="section-desc" id="posModalSubtitle" style="text-align:left;">
        Crear o editar terminal de cobro.
      </p>

      <form id="posForm">
        <input type="hidden" id="pId" />

        <div class="mt-2">
          <label class="input-label" for="pName">Nombre amigable</label>
          <input
            type="text"
            id="pName"
            class="modal-input"
            placeholder="Ej: CAJA BARRA 1"
            required
          />
        </div>

        <div class="mt-2" style="display:flex; gap:15px; flex-wrap:wrap;">
          <div style="flex:1; min-width:140px;">
            <label class="input-label" for="pProvider">Proveedor</label>
            <select id="pProvider" class="modal-select">
              <option value="MERCADO PAGO">MERCADO PAGO</option>
              <option value="GETNET">GETNET</option>
              <option value="POS BANCO">POS BANCO</option>
              <option value="OTRO">OTRO</option>
            </select>
          </div>
          <div style="flex:1; min-width:140px;">
            <label class="input-label" for="pExternal">ID externo / Ref. técnica</label>
            <input
              type="text"
              id="pExternal"
              class="modal-input"
              placeholder="Ej: N° de serie o ID interno"
            />
          </div>
        </div>

        <div class="mt-2" style="display:flex; align-items:center; gap:8px;">
          <label class="section-desc" style="margin:0; font-size:11px; display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="pActive" style="margin:0;" />
            Terminal activa
          </label>
        </div>
      </form>

      <div class="modal-btns">
        <button type="button" class="btn-secondary" id="btnCancelPos">
          Cancelar
        </button>
        <button type="button" class="btn-primary" id="btnSavePos">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <script>
    const posTableBody = document.getElementById('posList');
    const searchPosInput = document.getElementById('searchPos');
    const btnNewPos = document.getElementById('btnNewPos');

    const posModal = document.getElementById('posModal');
    const posModalSubtitle = document.getElementById('posModalSubtitle');
    const btnCancelPos = document.getElementById('btnCancelPos');
    const btnSavePos = document.getElementById('btnSavePos');

    const pId = document.getElementById('pId');
    const pName = document.getElementById('pName');
    const pProvider = document.getElementById('pProvider');
    const pExternal = document.getElementById('pExternal');
    const pActive = document.getElementById('pActive');

    let posTerminals = [];
    let editingPosId = null;

    document.addEventListener('DOMContentLoaded', () => {
      attachListeners();
      loadPos();
    });

    function attachListeners() {
      btnNewPos.addEventListener('click', () => openPosModal());
      btnCancelPos.addEventListener('click', closePosModal);
      btnSavePos.addEventListener('click', savePos);

      searchPosInput.addEventListener('input', applyFilterAndRender);

      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && posModal.style.display === 'flex') {
          closePosModal();
        }
      });
    }

    async function loadPos() {
      try {
        const { data, error } = await client
          .from('pos_terminals')
          .select('*')
          .order('friendly_name', { ascending: true });

        if (error) throw error;
        posTerminals = data || [];
        applyFilterAndRender();
      } catch (err) {
        console.error('Error al cargar terminales POS', err);
        posTableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center; padding:30px;">
              Error al cargar terminales.
            </td>
          </tr>
        `;
      }
    }

    function applyFilterAndRender() {
      const term = (searchPosInput.value || '').toLowerCase().trim();

      const filtered = posTerminals.filter(t => {
        if (!term) return true;
        return (
          (t.friendly_name || '').toLowerCase().includes(term) ||
          (t.provider || '').toLowerCase().includes(term) ||
          (t.external_id || '').toLowerCase().includes(term)
        );
      });

      renderPos(filtered);
    }

    function renderPos(list) {
      posTableBody.innerHTML = '';

      if (!list.length) {
        posTableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center; padding:30px;">
              Sin terminales cargadas.
            </td>
          </tr>
        `;
        return;
      }

      list.forEach(t => {
        const tr = document.createElement('tr');

        // TERMINAL
        const tdName = document.createElement('td');
        tdName.style.paddingLeft = '24px';
        tdName.innerHTML = `
          <div class="row-title">${t.friendly_name || '-'}</div>
          <div class="row-sub-text">ID interno: ${t.id}</div>
        `;

        // PROVEEDOR
        const tdProv = document.createElement('td');
        tdProv.textContent = t.provider || '-';

        // ID EXTERNO
        const tdExt = document.createElement('td');
        tdExt.style.fontFamily = 'monospace';
        tdExt.style.color = 'var(--text-secondary)';
        tdExt.textContent = t.external_id || '-';

        // ESTADO
        const tdEstado = document.createElement('td');
        const tag = document.createElement('span');
        const isActive = t.is_active !== false;
        tag.className = 'tag ' + (isActive ? 'tag-green' : 'tag-gray');
        tag.textContent = isActive ? 'ACTIVA' : 'OFF';
        tdEstado.appendChild(tag);

        // ACCIONES
        const tdAcciones = document.createElement('td');
        tdAcciones.className = 'text-right';
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'btn-icon';
        editBtn.textContent = '✏️';
        editBtn.addEventListener('click', () => openPosModal(t.id));
        tdAcciones.appendChild(editBtn);

        tr.append(tdName, tdProv, tdExt, tdEstado, tdAcciones);
        posTableBody.appendChild(tr);
      });
    }

    function openPosModal(id) {
      posModal.style.display = 'flex';

      if (id) {
        const t = posTerminals.find(x => x.id === id);
        if (!t) return;

        editingPosId = id;
        posModalSubtitle.textContent = 'Editar terminal existente.';

        pId.value = t.id;
        pName.value = t.friendly_name || '';
        pProvider.value = t.provider || 'MERCADO PAGO';
        pExternal.value = t.external_id || '';
        pActive.checked = t.is_active !== false;
      } else {
        editingPosId = null;
        posModalSubtitle.textContent = 'Crear nueva terminal POS.';

        pId.value = '';
        pName.value = '';
        pProvider.value = 'MERCADO PAGO';
        pExternal.value = '';
        pActive.checked = true;
      }
    }

    function closePosModal() {
      posModal.style.display = 'none';
      editingPosId = null;
    }

    async function savePos() {
      const friendlyName = (pName.value || '').trim();
      if (!friendlyName) {
        alert('El nombre amigable es obligatorio.');
        return;
      }

      const payload = {
        friendly_name: friendlyName,
        provider: pProvider.value || 'MERCADO PAGO',
        external_id: (pExternal.value || '').trim() || null,
        is_active: !!pActive.checked
      };

      try {
        btnSavePos.disabled = true;
        btnSavePos.textContent = 'Guardando...';

        if (editingPosId == null) {
          const { error } = await client
            .from('pos_terminals')
            .insert(payload);
          if (error) throw error;
        } else {
          const { error } = await client
            .from('pos_terminals')
            .update(payload)
            .eq('id', editingPosId);
          if (error) throw error;
        }

        closePosModal();
        await loadPos();

        if (window.MC_UTILS && typeof MC_UTILS.showToast === 'function') {
          MC_UTILS.showToast('Terminal guardada correctamente.');
        }
      } catch (err) {
        console.error('Error al guardar terminal POS', err);
        alert('No se pudo guardar la terminal. Revisá los datos e intentá nuevamente.');
      } finally {
        btnSavePos.disabled = false;
        btnSavePos.textContent = 'Guardar';
      }
    }
  </script>
</body>
</html>
