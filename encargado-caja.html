<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Midnight ‚Äî Encargado Caja</title>
  
  <link rel="stylesheet" href="admin-styles.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>

  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <!-- Columna izquierda (placeholder para respetar grid 1fr / auto / 1fr) -->
        <div></div>

        <!-- Centro: Logo ERP -->
        <div class="admin-logo" aria-hidden="true"></div>

        <!-- Derecha: usuario encargado -->
        <div class="admin-header-right">
          <div class="user-badge-container">
            <div id="userDisplay" class="user-name">ENCARGADO</div>
            <div class="user-role" style="color:var(--accent-gold);">CAJA</div>
          </div>
          <button onclick="window.location.href='index.html'" class="btn-logout">SALIR</button>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <!-- NAV TABS -->
    <nav class="tab-nav tabs-gold">
      <button class="tab-btn active" onclick="switchTab('validar', this)">üîç VALIDAR CAJAS</button>
      <button class="tab-btn" onclick="switchTab('retiros', this)">üí∏ GESTI√ìN RETIROS</button>
      <button class="tab-btn" onclick="switchTab('stock', this)">‚úèÔ∏è LIBRER√çA</button>
      <button class="tab-btn" onclick="switchTab('novedades', this)">üì¢ NOVEDADES</button>
    </nav>

    <!-- TAB: VALIDAR CAJAS -->
    <section id="view-validar">
      <div
        class="section-header"
        style="margin-bottom:16px; text-align:left; display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;"
      >
        <div>
          <h2 class="section-title" style="font-size:18px;">Cierres Recibidos</h2>
          <p class="section-desc">Monitoreo de declaraciones en tiempo real</p>
        </div>
        <div>
          <label class="input-label" for="filterDate">FECHA</label>
          <input
            type="date"
            id="filterDate"
            class="modal-input"
            style="width:auto; min-width:160px;"
            onchange="loadClosings()"
          />
        </div>
      </div>

      <div id="closingsList">
        <div class="text-center" style="padding:30px; color:var(--text-secondary);">
          Buscando cierres...
        </div>
      </div>
    </section>

    <!-- TAB: GESTI√ìN RETIROS -->
    <section id="view-retiros" style="display:none;">
      <div
        class="section-header"
        style="margin-bottom:16px; text-align:left;"
      >
        <h2 class="section-title" style="font-size:18px;">Solicitar Retiro</h2>
        <p class="section-desc">
          Autorizar salida de dinero para que entregue la cajera
        </p>
      </div>

      <div class="box-soft" style="margin-bottom:30px;">
        <div
          style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;"
        >
          <div>
            <label class="input-label">ORIGEN (CAJA)</label>
            <select id="wTerm" class="modal-select"></select>
          </div>
          <div>
            <label class="input-label">MONTO A RETIRAR</label>
            <input type="number" id="wAmount" class="modal-input" placeholder="$ 0" />
          </div>
        </div>
        <label class="input-label">MOTIVO / DESTINO</label>
        <input
          type="text"
          id="wDesc"
          class="modal-input"
          placeholder="Ej: Pago Hielo, Retiro Gerencia..."
        />
        
        <button
          onclick="createWithdrawal()"
          class="btn-primary"
          style="background:var(--accent-gold); color:#000; width:100%; margin-top:10px;"
        >
          GENERAR ORDEN DE RETIRO üöÄ
        </button>
      </div>

      <h3 class="section-title" style="font-size:16px; margin-bottom:15px; text-align:left;">
        Estado de Solicitudes (Hoy)
      </h3>
      <div id="withdrawalList"></div>
    </section>

    <!-- TAB: STOCK LIBRER√çA -->
    <section id="view-stock" style="display:none;">
      <div
        class="section-header"
        style="margin-bottom:16px; text-align:left; display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;"
      >
        <div>
          <h2 class="section-title" style="font-size:18px;">Insumos de Librer√≠a</h2>
          <p class="section-desc">Rollos, precintos y oficina</p>
        </div>
        <button onclick="openRequestModal()" class="btn-refresh">
          + PEDIR A COMPRAS
        </button>
      </div>
      
      <div id="suppliesList" style="margin-bottom:20px;"></div>
      <button onclick="saveStock()" class="btn-primary" style="width:100%;">
        GUARDAR CONTEO ‚úÖ
      </button>
    </section>

    <!-- TAB: NOVEDADES / INCIDENTES -->
    <section id="view-novedades" style="display:none;">
      <div class="box-soft">
        <h3 class="dash-title" style="margin-bottom:16px;">Reportar Incidente</h3>

        <label class="input-label">TIPO</label>
        <select id="incType" class="modal-select">
          <option value="DIFERENCIA_CAJA">üí∞ Diferencia de Caja</option>
          <option value="SISTEMA">üíª Error de Sistema</option>
          <option value="PERSONAL">üë• Conducta Personal</option>
          <option value="INFRAESTRUCTURA">üîß Mantenimiento Caja</option>
        </select>

        <label class="input-label">DETALLE</label>
        <textarea
          id="incDesc"
          class="modal-input"
          placeholder="Describa la situaci√≥n..."
          style="height:100px;"
        ></textarea>

        <button
          onclick="sendIncident()"
          class="btn-primary"
          style="background:var(--state-error); color:#fff; width:100%; margin-top:15px;"
        >
          REGISTRAR INCIDENTE
        </button>
      </div>
      
      <div style="margin-top:30px;">
        <h3 class="section-title" style="font-size:16px; margin-bottom:15px; text-align:left;">
          Historial Reciente
        </h3>
        <div id="incHistory" class="data-list"></div>
      </div>
    </section>
  </main>

  <!-- MODAL SOLICITAR INSUMOS -->
  <div id="reqModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <h3 class="section-title" style="font-size:18px; margin-bottom:4px;">
            Solicitar Insumos
          </h3>
          <p class="section-desc">Este pedido ir√° al Depto. de Compras</p>
        </div>
      </div>
      
      <label class="input-label">DETALLE</label>
      <textarea
        id="reqDetail"
        class="modal-input"
        placeholder="Ej: 5 Cajas Rollos 80mm..."
        style="height:100px;"
      ></textarea>

      <div class="modal-btns">
        <button
          onclick="document.getElementById('reqModal').style.display='none'"
          class="btn-secondary"
        >
          Cancelar
        </button>
        <button onclick="sendRequest()" class="btn-primary">
          Enviar Pedido
        </button>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let supplies = [];

    document.addEventListener('DOMContentLoaded', async () => {
      const session = localStorage.getItem('mc_user');
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = JSON.parse(session);

      const name =
        (currentUser.full_name || currentUser.username || 'ENCARGADO').toString();
      document.getElementById('userDisplay').innerText = name.toUpperCase();

      const filterDate = document.getElementById('filterDate');
      if (filterDate) {
        filterDate.valueAsDate = new Date();
      }

      // Carga inicial
      loadClosings();
      loadTerminals(); // Para el select de retiros
    });

    function switchTab(view, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      
      ['validar','retiros','stock','novedades'].forEach(v => {
        const el = document.getElementById('view-' + v);
        if (el) el.style.display = 'none';
      });
      const viewEl = document.getElementById('view-' + view);
      if (viewEl) viewEl.style.display = 'block';

      if (view === 'retiros') loadWithdrawals();
      if (view === 'stock') loadSupplies();
      if (view === 'novedades') loadHistory();
    }

    // === 1. VALIDACI√ìN (Monitor) ===
    async function loadClosings() {
      const date = document.getElementById('filterDate').value;
      const container = document.getElementById('closingsList');
      container.innerHTML =
        '<div class="text-center" style="padding:30px; color:var(--text-secondary);">Cargando datos...</div>';

      // Buscar Cierre Global
      const { data: head } = await client
        .from('cash_closings')
        .select('id')
        .eq('event_date', date)
        .maybeSingle();
      
      if (!head) {
        container.innerHTML =
          '<div style="text-align:center; padding:40px; color:var(--text-secondary);">No hay apertura de caja registrada para esta fecha.</div>';
        return;
      }

      // Buscar Detalles
      const { data: terms } = await client
        .from('closing_terminals')
        .select('*')
        .eq('closing_id', head.id)
        .order('terminal_name');

      if (!terms || terms.length === 0) {
        container.innerHTML =
          '<div style="text-align:center; padding:40px; color:var(--text-secondary);">Esperando declaraciones de venta...</div>';
        return;
      }

      container.innerHTML = terms
        .map(t => {
          const efvo = parseFloat(t.final_count_cash) || 0;
          const zoco = parseFloat(t.zoco_digital) || 0;
          const retiro = parseFloat(t.cash_withdrawals) || 0;

          return `
            <div class="box-soft" style="margin-bottom:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:8px; border-bottom:1px dashed var(--border-subtle);">
                <span class="row-title" style="font-size:14px;">${t.terminal_name}</span>
                <span class="tag tag-green">RECIBIDO</span>
              </div>
              <div class="summary-row" style="margin-bottom:0;">
                <div class="summary-card" style="min-width:0;">
                  <div class="summary-label">EFECTIVO</div>
                  <div class="summary-value" style="font-size:16px; color:var(--state-success);">
                    ${MC_UTILS.formatCurrency(efvo)}
                  </div>
                </div>
                <div class="summary-card" style="min-width:0;">
                  <div class="summary-label">ZOCO</div>
                  <div class="summary-value" style="font-size:16px; color:var(--state-info);">
                    ${MC_UTILS.formatCurrency(zoco)}
                  </div>
                </div>
                <div class="summary-card" style="min-width:0;">
                  <div class="summary-label">RETIROS</div>
                  <div class="summary-value" style="font-size:16px; color:var(--state-error);">
                    ${MC_UTILS.formatCurrency(retiro)}
                  </div>
                </div>
              </div>
            </div>`;
        })
        .join('');
    }

    // === 2. GESTI√ìN RETIROS ===
    async function loadTerminals() {
      const { data } = await client
        .from('pos_terminals')
        .select('friendly_name')
        .eq('is_active', true)
        .order('friendly_name');

      const list = Array.isArray(data) ? data : [];
      const unique = [...new Set(list.map(i => i.friendly_name))];

      document.getElementById('wTerm').innerHTML = unique
        .map(n => `<option value="${n}">${n}</option>`)
        .join('');
    }

    async function createWithdrawal() {
      const term = document.getElementById('wTerm').value;
      const amount = document.getElementById('wAmount').value;
      const desc = document.getElementById('wDesc').value;

      if (!amount || !desc) return alert('Complete monto y motivo.');

      const { error } = await client.from('cash_movements').insert({
        requested_by: currentUser.id,
        terminal_name: term,
        amount: amount,
        description: desc,
        event_date: new Date(),
        status: 'PENDING'
      });

      if (error) alert(error.message);
      else {
        alert('Solicitud enviada a la caja.');
        document.getElementById('wAmount').value = '';
        document.getElementById('wDesc').value = '';
        loadWithdrawals();
      }
    }

    async function loadWithdrawals() {
      const today = new Date().toISOString().split('T')[0];
      const { data } = await client
        .from('cash_movements')
        .select('*')
        .eq('event_date', today)
        .order('created_at', { ascending: false });

      const list = document.getElementById('withdrawalList');
      if (!data || !data.length) {
        list.innerHTML =
          '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Sin movimientos hoy.</div>';
        return;
      }

      list.innerHTML = data
        .map(w => {
          let statusBadge = `<span class="tag tag-gray">PENDIENTE</span>`;
          if (w.status === 'CONFIRMED') {
            statusBadge = `<span class="tag tag-green">ENTREGADO</span>`;
          }
          
          return `
            <div class="box-soft" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; opacity:${w.status === 'CONFIRMED' ? 0.6 : 1};">
              <div>
                <div style="font-weight:700; color:#fff;">
                  ${w.terminal_name}: ${MC_UTILS.formatCurrency(w.amount)}
                </div>
                <div style="font-size:12px; color:var(--text-secondary);">
                  ${w.description}
                </div>
              </div>
              ${statusBadge}
            </div>`;
        })
        .join('');
    }

    // === 3. STOCK LIBRER√çA ===
    async function loadSupplies() {
      const { data } = await client
        .from('inventory_skus')
        .select('*')
        .in('category', ['LIBRERIA', 'OFICINA', 'INSUMOS_CAJA'])
        .eq('is_active', true)
        .order('name');
      
      supplies = data || [];
      const container = document.getElementById('suppliesList');
      
      if (supplies.length === 0) {
        container.innerHTML =
          '<div style="padding:30px; text-align:center; color:var(--text-secondary);">No hay art√≠culos configurados.</div>';
        return;
      }

      container.innerHTML = supplies
        .map(s => `
          <div class="staff-lib-row">
            <div style="flex:1;">
              <div class="row-title" style="font-size:14px;">${s.name}</div>
              <div class="row-sub-text">Actual: ${s.stock_current}</div>
            </div>
            <input
              type="number"
              id="stk_${s.id}"
              class="input-stock"
              placeholder="${s.stock_current}"
            />
          </div>
        `)
        .join('');
    }

    async function saveStock() {
      let updates = [];
      for (const s of supplies) {
        const inp = document.getElementById(`stk_${s.id}`);
        if (inp && inp.value !== '') {
          updates.push(
            client
              .from('inventory_skus')
              .update({ stock_current: parseFloat(inp.value) })
              .eq('id', s.id)
          );
        }
      }
      if (updates.length === 0) return alert('No ingresaste cambios.');
      await Promise.all(updates);
      alert('Stock actualizado.');
      loadSupplies();
    }

    function openRequestModal() {
      document.getElementById('reqModal').style.display = 'flex';
      document.getElementById('reqDetail').value = '';
    }

    async function sendRequest() {
      const desc = document.getElementById('reqDetail').value;
      if (!desc) return;
      await client.from('incident_reports').insert({
        reporter_id: currentUser.id,
        area: 'CAJA',
        type: 'PEDIDO',
        description: desc,
        severity: 'BAJA',
        status: 'open'
      });
      document.getElementById('reqModal').style.display = 'none';
      alert('Pedido enviado.');
    }

    // === 4. NOVEDADES ===
    async function sendIncident() {
      const type = document.getElementById('incType').value;
      const desc = document.getElementById('incDesc').value;
      if (!desc) return alert('Detalle requerido.');

      const { error } = await client.from('incident_reports').insert({
        reporter_id: currentUser.id,
        area: 'CAJA',
        type: type,
        description: desc,
        severity: 'MEDIA',
        status: 'open'
      });

      if (error) alert(error.message);
      else {
        alert('Novedad registrada.');
        document.getElementById('incDesc').value = '';
        loadHistory();
      }
    }

    async function loadHistory() {
      const { data } = await client
        .from('incident_reports')
        .select('*')
        .eq('area', 'CAJA')
        .order('created_at', { ascending: false })
        .limit(10);

      const c = document.getElementById('incHistory');
      
      if (!data || !data.length) {
        c.innerHTML =
          '<div style="text-align:center; padding:20px; color:var(--text-secondary);">Sin reportes.</div>';
        return;
      }

      c.innerHTML = data
        .map(i => `
          <div class="list-row" style="padding:10px 0; border-bottom:1px solid var(--border-subtle);">
            <div>
              <div class="row-title">${i.type}</div>
              <div class="row-sub-text">${i.description}</div>
            </div>
            <div style="font-size:10px; color:var(--text-tertiary);">
              ${new Date(i.created_at).toLocaleDateString()}
            </div>
          </div>
        `)
        .join('');
    }
  </script>
</body>
</html>
