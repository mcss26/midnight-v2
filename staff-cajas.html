<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Midnight Staff ‚Äî Caja</title>
  
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    /* Estilos espec√≠ficos POS (Inputs Gigantes) */
    .pos-input-group { margin-bottom: 20px; }
    .pos-big-input {
        width: 100%; background: #000; border: 2px solid var(--border-subtle);
        color: #fff; font-size: 32px; font-weight: 700; padding: 20px;
        text-align: center; border-radius: 16px; outline: none; 
        font-family: 'Outfit', sans-serif; transition: 0.2s;
    }
    .pos-big-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 20px rgba(59,130,246,0.2); }
    .pos-big-input.cash { color: var(--accent-green); }
    .pos-big-input.zoco { color: var(--accent-blue); }

    /* Botonera Calculadora */
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
    .calc-btn { 
        background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: #fff; 
        padding: 12px 0; border-radius: 8px; font-weight: 600; font-size: 14px;
    }
    .calc-btn:active { background: var(--accent-green); color: #000; }

    /* Alerta de Retiro */
    .alert-card {
        background: rgba(251, 191, 36, 0.1); border: 1px solid var(--accent-gold);
        padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;
        animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(251,191,36,0.4); } 70% { box-shadow: 0 0 0 10px transparent; } 100% { box-shadow: 0 0 0 0 transparent; } }
  </style>
</head>
<body>

  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color:var(--accent-green);">POS</span></div>
    <div class="admin-header-right">
        <span id="userDisplay" style="font-size:12px; color:var(--text-secondary); font-weight:600;">STAFF</span>
        <button onclick="window.location.href='staff-index.html'" class="btn-logout">SALIR</button>
    </div>
  </header>

  <div class="admin-container" style="max-width:500px;">
    
    <div style="margin-bottom: 25px;">
        <label class="input-label">TU TERMINAL</label>
        <select id="termSelect" class="modal-select" style="padding: 15px; font-size: 16px;" onchange="loadPendingWithdrawals()">
            <option value="">Cargando...</option>
        </select>
    </div>

    <div id="withdrawalSection" style="display:none;">
        <div id="pendingList"></div>
    </div>

    <div id="closingForm">
        <div class="section-header">
            <h2 class="section-title">Cierre de Turno</h2>
        </div>
        
        <div class="pos-input-group">
            <label class="input-label" style="color:var(--accent-green);">TOTAL EFECTIVO (CONTADO)</label>
            <input type="number" id="cashInput" class="pos-big-input cash" placeholder="$ 0" inputmode="numeric">
            <div class="calc-grid">
                <button class="calc-btn" onclick="addCash(10000)">+10k</button>
                <button class="calc-btn" onclick="addCash(5000)">+5k</button>
                <button class="calc-btn" onclick="addCash(1000)">+1k</button>
                <button class="calc-btn" onclick="addCash(500)">+500</button>
            </div>
        </div>

        <div class="pos-input-group">
            <label class="input-label" style="color:var(--accent-blue);">TOTAL DIGITAL (ZOCO/QR)</label>
            <input type="number" id="zocoInput" class="pos-big-input zoco" placeholder="$ 0" inputmode="numeric">
        </div>

        <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:25px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div class="input-label" style="margin:0;">RETIROS CONFIRMADOS</div>
                <div style="font-size:11px; color:var(--text-secondary);">Entregado a Encargado</div>
            </div>
            <div id="autoWithdrawals" style="font-size:20px; font-weight:700; color:#fff;">$ 0</div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="openIncidentModal()" class="btn-secondary" style="flex:1; border-color:var(--accent-red); color:var(--accent-red);">‚ö†Ô∏è REPORTAR PROBLEMA</button>
        </div>

        <button onclick="submitClose()" id="btnSend" class="btn-primary" style="width:100%; padding:18px; font-size:16px;">CONFIRMAR Y CERRAR üîí</button>
    </div>
  </div>

  <div id="incModal" class="modal-overlay">
      <div class="modal-box">
          <h3 class="section-title">Reportar Novedad</h3>
          <label class="input-label">TIPO</label>
          <select id="incType" class="modal-select">
              <option value="ERROR_COBRO">Error de Cobro</option>
              <option value="SISTEMA">Falla de Sistema</option>
              <option value="OTRO">Otro</option>
          </select>
          <label class="input-label" style="margin-top:15px;">DETALLE</label>
          <textarea id="incDesc" class="modal-input" style="height:100px;"></textarea>
          <div class="modal-btns">
              <button onclick="closeIncidentModal()" class="btn-modal-cancel">CANCELAR</button>
              <button onclick="submitIncident()" class="btn-modal-save">ENVIAR</button>
          </div>
      </div>
  </div>

  <script>
    let currentUser=null, confirmedAmount=0;
    document.addEventListener('DOMContentLoaded',async()=>{
        const s=localStorage.getItem('mc_user'); if(!s){window.location.href='index.html';return;}
        currentUser=JSON.parse(s); document.getElementById('userDisplay').innerText=currentUser.username.toUpperCase();
        await loadTerminals();
    });
    async function loadTerminals(){
        const{data}=await client.from('pos_terminals').select('friendly_name').eq('is_active',true).order('friendly_name');
        const sel=document.getElementById('termSelect');
        if(data?.length) sel.innerHTML='<option value="">Selecciona tu caja...</option>'+[...new Set(data.map(i=>i.friendly_name))].map(n=>`<option value="${n}">${n}</option>`).join('');
    }
    async function loadPendingWithdrawals(){
        const term=document.getElementById('termSelect').value; if(!term){document.getElementById('withdrawalSection').style.display='none';return;}
        const today=new Date().toISOString().split('T')[0];
        const{data:pending}=await client.from('cash_movements').select('*').eq('terminal_name',term).eq('event_date',today).eq('status','PENDING');
        const{data:conf}=await client.from('cash_movements').select('amount').eq('terminal_name',term).eq('event_date',today).eq('status','CONFIRMED');
        confirmedAmount=conf?conf.reduce((s,i)=>s+Number(i.amount),0):0;
        document.getElementById('autoWithdrawals').innerText=MC_UTILS.formatCurrency(confirmedAmount);
        const c=document.getElementById('pendingList');
        if(pending?.length){
            document.getElementById('withdrawalSection').style.display='block';
            c.innerHTML=pending.map(w=>`
                <div class="alert-card" id="w-${w.id}">
                    <div style="font-weight:700; color:#fff; font-size:16px;">SOLICITUD DE RETIRO</div>
                    <div style="font-size:13px; color:#ddd; margin:5px 0;">${w.description}</div>
                    <div style="font-size:28px; font-weight:800; color:#fff; font-family:'Outfit'; margin:10px 0;">${MC_UTILS.formatCurrency(w.amount)}</div>
                    <button class="btn-primary" onclick="confirmWithdrawal(${w.id})" style="background:#000; border:1px solid #fff; width:100%;">CONFIRMAR ENTREGA</button>
                </div>`).join('');
        }else document.getElementById('withdrawalSection').style.display='none';
    }
    async function confirmWithdrawal(id){
        if(!confirm("¬øConfirmas la entrega del dinero?"))return;
        await client.from('cash_movements').update({status:'CONFIRMED',confirmed_by:currentUser.id,confirmed_at:new Date()}).eq('id',id);
        document.getElementById(`w-${id}`).remove(); loadPendingWithdrawals();
    }
    function addCash(v){const i=document.getElementById('cashInput'); i.value=(Number(i.value)||0)+v;}
    function openIncidentModal(){document.getElementById('incModal').style.display='flex';}
    function closeIncidentModal(){document.getElementById('incModal').style.display='none';}
    async function submitIncident(){
        const t=document.getElementById('incType').value, d=document.getElementById('incDesc').value, term=document.getElementById('termSelect').value;
        if(!d||!term)return alert("Datos incompletos.");
        await client.from('incident_reports').insert({reporter_id:currentUser.id,area:'CAJA',type:t,description:`[${term}] ${d}`,severity:'MEDIA',status:'open'});
        alert("Reportado."); closeIncidentModal();
    }
    async function submitClose(){
        const term=document.getElementById('termSelect').value, cash=Number(document.getElementById('cashInput').value)||0, zoco=Number(document.getElementById('zocoInput').value)||0;
        if(!term)return alert("Selecciona caja.");
        if(!confirm(`Confirmar Cierre:\nCaja: ${term}\nEfvo: $${cash}`))return;
        const btn=document.getElementById('btnSend'); btn.disabled=true; btn.innerText="ENVIANDO...";
        try{
            const date=new Date().toISOString().split('T')[0];
            let{data:head}=await client.from('cash_closings').select('id').eq('event_date',date).maybeSingle();
            if(!head){const{data:nw}=await client.from('cash_closings').insert({event_date:date,status:'open'}).select().single(); head=nw;}
            await client.from('closing_terminals').upsert({closing_id:head.id, terminal_name:term, final_count_cash:cash, zoco_digital:zoco, cash_withdrawals:confirmedAmount},{onConflict:'closing_id,terminal_name'});
            alert("‚úÖ Cierre registrado."); window.location.href='staff-index.html';
        }catch(e){alert(e.message); btn.disabled=false;}
    }
  </script>
</body>
</html>