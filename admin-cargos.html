<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Cargos</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-accent-purple);">ROLES</span></div>
    <button onclick="window.location.href='panel-master.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div>
            <h2 class="section-title">Cargos & Jornales</h2>
            <p class="section-desc">Estructura de RRHH y pagos base</p>
        </div>
        <button onclick="openModal()" class="btn-primary">+ NUEVO CARGO</button>
    </div>
    
    <div id="rolesList" class="data-list">
        <div style="text-align:center; padding: 40px; color: var(--text-secondary);">Cargando estructura...</div>
    </div>
  </div>

  <div id="roleModal" class="modal-overlay">
    <div class="modal-box">
        <h3 class="section-title" style="font-size:20px; margin-bottom:25px;">Editar Cargo</h3>
        <input type="hidden" id="rId">
        
        <label class="input-label">NOMBRE DEL PUESTO</label>
        <input type="text" id="rName" class="modal-input" placeholder="Ej: Cajero Principal">
        
        <div style="display:flex; gap:15px; margin-top:15px;">
            <div style="flex:1;">
                <label class="input-label">JORNAL BASE ($)</label>
                <input type="number" id="rPay" class="modal-input" placeholder="0">
            </div>
            <div style="flex:1;">
                <label class="input-label">MODALIDAD</label>
                <select id="rBill" class="modal-select">
                    <option value="INFORMAL">Informal / Jornal</option>
                    <option value="MONOTRIBUTO">Monotributo</option>
                    <option value="RELACION_DEPENDENCIA">Rel. Dependencia</option>
                    <option value="TERCERIZADO">Tercerizado</option>
                </select>
            </div>
        </div>

        <div class="modal-btns">
            <button onclick="closeModal()" class="btn-modal-cancel">Cancelar</button>
            <button onclick="saveRole()" class="btn-modal-save">Guardar</button>
        </div>
        
        <button id="btnDel" onclick="deleteRole()" style="width:100%; margin-top:20px; background:none; border:none; color:var(--color-danger); cursor:pointer; font-size:12px; font-weight:600; opacity:0.8;">ELIMINAR PUESTO</button>
    </div>
  </div>

  <script>
    window.onload = loadRoles;

    async function loadRoles() {
        try {
            const { data, error } = await client
                .from('staff_roles')
                .select('*')
                .order('base_pay', { ascending: false });

            if (error) throw error;

            const c = document.getElementById('rolesList');
            
            if (!data.length) {
                c.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">No hay cargos definidos.</div>';
                return;
            }

            c.innerHTML = data.map(r => {
                // Estilos según modalidad
                let tagClass = 'tag-gray';
                if(r.billing_condition === 'RELACION_DEPENDENCIA') tagClass = 'tag-blue';
                if(r.billing_condition === 'MONOTRIBUTO') tagClass = 'tag-outline';

                return `
                <div class="list-row" style="opacity: ${r.is_active ? 1 : 0.5}">
                    <div>
                        <div class="row-main-text" style="color: ${r.is_active ? '#fff' : '#666'}">${r.role_name}</div>
                        <div class="row-sub-text" style="margin-top:6px; display:flex; align-items:center;">
                            <span class="tag ${tagClass}">${r.billing_condition.replace('_', ' ')}</span>
                            <span style="margin-left:12px; color:var(--color-success); font-weight:600; font-family:'Inter'; letter-spacing:0.5px;">
                                ${MC_UTILS.formatCurrency(r.base_pay)}
                            </span>
                        </div>
                    </div>
                    <button onclick="edit(${r.id})" class="btn-icon">✏️</button>
                </div>`;
            }).join('');

        } catch (e) {
            console.error(e);
            document.getElementById('rolesList').innerHTML = '<div style="text-align:center; color:var(--color-danger);">Error de carga</div>';
        }
    }

    // --- LÓGICA DEL MODAL ---
    function openModal() { 
        document.getElementById('roleModal').style.display='flex'; 
        document.getElementById('rId').value=''; 
        document.getElementById('rName').value=''; 
        document.getElementById('rPay').value='';
        document.getElementById('btnDel').style.display='none'; 
    }
    
    function closeModal() { document.getElementById('roleModal').style.display='none'; }
    
    async function edit(id) {
        const { data } = await client.from('staff_roles').select('*').eq('id',id).single();
        document.getElementById('rId').value = data.id;
        document.getElementById('rName').value = data.role_name;
        document.getElementById('rPay').value = data.base_pay;
        document.getElementById('rBill').value = data.billing_condition;
        document.getElementById('btnDel').style.display='block';
        document.getElementById('roleModal').style.display='flex';
    }

    async function saveRole() {
        const id = document.getElementById('rId').value;
        const payload = {
            role_name: document.getElementById('rName').value.toUpperCase(),
            base_pay: parseFloat(document.getElementById('rPay').value) || 0,
            billing_condition: document.getElementById('rBill').value
        };

        if(!payload.role_name) return alert("El nombre es obligatorio");

        let error;
        if(id) {
            ({ error } = await client.from('staff_roles').update(payload).eq('id', id));
        } else {
            ({ error } = await client.from('staff_roles').insert(payload));
        }

        if(error) alert("Error: " + error.message);
        else {
            closeModal();
            loadRoles();
        }
    }

    async function deleteRole() {
        if(confirm("⚠ ¿Eliminar este cargo?\nSi hay personal asignado, esto podría generar errores.")) {
            const id = document.getElementById('rId').value;
            const { error } = await client.from('staff_roles').delete().eq('id', id);
            
            if(error) alert("No se puede eliminar: Probablemente hay personal asignado.");
            else {
                closeModal();
                loadRoles();
            }
        }
    }
  </script>
</body>
</html>