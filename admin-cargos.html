<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Cargos</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div class="admin-logo" aria-hidden="true"></div>
        <div class="admin-header-right">
          <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
        </div>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <div><h2 class="section-title">Cargos & Roles</h2><p class="section-desc">Estructura de personal.</p></div>
      <button class="btn-primary" onclick="openRoleModal()">+ NUEVO CARGO</button>
    </div>
    <input type="text" id="searchRole" class="search-input-admin" placeholder="üîç Buscar cargo..." oninput="filterRoles()">
    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr><th style="padding-left:25px;">CARGO</th><th style="text-align:right;">JORNAL BASE</th><th>MODALIDAD</th><th>ESTADO</th><th style="width:60px;"></th></tr>
        </thead>
        <tbody id="rolesList"></tbody>
      </table>
    </div>
  </div>

  <div id="roleModal" class="modal-overlay">
    <div class="modal-box">
      <h3 class="section-title" style="font-size:20px; margin-bottom:20px;">Cargo / Rol</h3>
      <input type="hidden" id="rId">
      <label class="input-label">NOMBRE</label>
      <input type="text" id="rName" class="modal-input" placeholder="Ej: CAJERO">
      <div style="display:flex; gap:15px; margin-top:15px;">
        <div style="flex:1;"><label class="input-label">BASE ($)</label><input type="number" id="rPay" class="modal-input"></div>
        <div style="flex:1;"><label class="input-label">MODALIDAD</label><select id="rBilling" class="modal-select"><option value="MONOTRIBUTO">MONOTRIBUTO</option><option value="EVENTUAL">EVENTUAL</option></select></div>
      </div>
      <div class="modal-btns">
        <button onclick="closeRoleModal()" class="btn-modal-cancel">CANCELAR</button>
        <button onclick="saveRole()" class="btn-modal-save">GUARDAR</button>
      </div>
    </div>
  </div>

  <script>
    let roles=[];
    document.addEventListener('DOMContentLoaded',loadRoles);
    async function loadRoles(){
        const{data}=await client.from('staff_roles').select('*').order('role_name');
        roles=data||[]; renderRoles(roles);
    }
    function renderRoles(l){
        const tb=document.getElementById('rolesList');
        if(!l.length){tb.innerHTML='<tr><td colspan="5" style="text-align:center; padding:30px;">Sin datos.</td></tr>';return;}
        tb.innerHTML=l.map(r=>`<tr>
            <td style="padding-left:25px;" class="row-title">${r.role_name}</td>
            <td style="text-align:right;" class="col-costo">${MC_UTILS.formatCurrency(r.base_pay)}</td>
            <td>${r.billing_condition}</td>
            <td><span class="tag ${r.is_active?'tag-green':'tag-gray'}">${r.is_active?'ACTIVO':'OFF'}</span></td>
            <td style="text-align:center;"><button class="btn-icon" onclick="openRoleModal(${r.id})">‚úèÔ∏è</button></td>
        </tr>`).join('');
    }
    function filterRoles(){renderRoles(roles.filter(r=>r.role_name.toLowerCase().includes(document.getElementById('searchRole').value.toLowerCase())));}
    function openRoleModal(id){
        const m=document.getElementById('roleModal'); m.style.display='flex';
        if(id){
            const r=roles.find(x=>x.id===id);
            document.getElementById('rId').value=r.id;
            document.getElementById('rName').value=r.role_name;
            document.getElementById('rPay').value=r.base_pay;
            document.getElementById('rBilling').value=r.billing_condition;
        }else{
            document.getElementById('rId').value='';
            document.getElementById('rName').value='';
        }
    }
    function closeRoleModal(){document.getElementById('roleModal').style.display='none';}
    async function saveRole(){
        const id=document.getElementById('rId').value;
        const d={
            role_name:document.getElementById('rName').value,
            base_pay:parseFloat(document.getElementById('rPay').value)||0,
            billing_condition:document.getElementById('rBilling').value,
            is_active:true
        };
        if(id) await client.from('staff_roles').update(d).eq('id',id);
        else await client.from('staff_roles').insert(d);
        closeRoleModal(); loadRoles();
    }
  </script>
</body>
</html>
