<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Midnight Staff ‚Äî Barra</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Outfit:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">BAR</span></div>
    <div class="admin-header-right">
        <button onclick="window.location.href='staff-index.html'" class="btn-logout">SALIR</button>
    </div>
  </header>

  <div class="admin-container" style="max-width:600px;">
    
    <div id="mainPanel">
        <div class="section-header" style="justify-content:center;">
            <h2 class="section-title">OPERACI√ìN BARRA</h2>
        </div>
        
        <div class="dash-grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
            
            <div class="dash-card dash-card-admin" onclick="showSection('incidents')" style="cursor:pointer; min-height:120px;">
                <div style="font-size:32px; margin-bottom:10px;">üì¢</div>
                <h3 class="dash-title">REPORTAR<br>INCIDENTE</h3>
            </div>

            <div class="dash-card dash-card-op" onclick="showSection('orders')" style="cursor:pointer; min-height:120px;">
                <div style="font-size:32px; margin-bottom:10px;">üì¶</div>
                <h3 class="dash-title">PEDIR<br>INSUMOS</h3>
            </div>

            <div class="dash-card dash-card-master" onclick="window.location.href='encargado-barra-cierre-stock.html'" style="cursor:pointer; grid-column: 1 / -1; min-height:100px;">
                <div style="font-size:28px; margin-bottom:5px;">üîÑ</div>
                <h3 class="dash-title">MOVIMIENTOS DE STOCK</h3>
                <div class="section-desc" style="font-size:11px;">Apertura, Reposici√≥n y Cierre</div>
            </div>

        </div>

        <div style="margin-top:30px;">
            <div class="input-label">MIS SOLICITUDES RECIENTES</div>
            <div id="historyList" style="background:var(--bg-card); padding:15px; border-radius:var(--radius); border:1px solid var(--border-subtle); min-height:80px;">
                <div style="text-align:center; color:var(--text-secondary); margin-top:20px;">Cargando...</div>
            </div>
        </div>
    </div>

    <div id="secIncidents" style="display:none;">
        <button onclick="showSection('main')" class="btn-back" style="margin-bottom:20px;">VOLVER</button>
        <h2 class="section-title">Reportar Incidente</h2>
        <label class="input-label">TIPO</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
            <button class="btn-secondary" onclick="setType('ROTURA')">üí• ROTURA</button>
            <button class="btn-secondary" onclick="setType('SEGURIDAD')">üëä SEGURIDAD</button>
            <button class="btn-secondary" onclick="setType('MANTENIMIENTO')">üîß EQUIPO</button>
            <button class="btn-secondary" onclick="setType('OBJETO_PERDIDO')">üéí OBJ. PERDIDO</button>
        </div>
        <input type="hidden" id="incType">
        <label class="input-label">DETALLE</label>
        <textarea id="incDesc" class="modal-input" style="height:100px;"></textarea>
        <button onclick="submitIncident()" class="btn-primary" style="width:100%; margin-top:20px;">ENVIAR ALERTA üö®</button>
    </div>

    <div id="secOrders" style="display:none;">
        <button onclick="showSection('main')" class="btn-back" style="margin-bottom:20px;">VOLVER</button>
        <h2 class="section-title">Pedir Insumos</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
            <button class="btn-secondary" onclick="setOrder('HIELO')">‚ùÑÔ∏è HIELO</button>
            <button class="btn-secondary" onclick="setOrder('FRUTA')">üçã FRUTA</button>
            <button class="btn-secondary" onclick="setOrder('VASOS')">ü•§ VASOS</button>
            <button class="btn-secondary" onclick="setOrder('ALCOHOL')">üçæ ALCOHOL</button>
        </div>
        <input type="hidden" id="ordItem">
        <label class="input-label">DETALLE / CANTIDAD</label>
        <textarea id="ordDesc" class="modal-input" placeholder="Ej: 5 bolsas de hielo..." style="height:80px;"></textarea>
        <button onclick="submitOrder()" class="btn-primary" style="width:100%; margin-top:20px;">SOLICITAR A RUNNER üèÉ</button>
    </div>

  </div>

  <script>
    let currentUser=null;
    document.addEventListener('DOMContentLoaded',async()=>{
        const s=localStorage.getItem('mc_user'); if(!s){window.location.href='index.html';return;}
        currentUser=JSON.parse(s); loadHistory();
    });
    function showSection(s){
        ['mainPanel','secIncidents','secOrders'].forEach(id=>document.getElementById(id).style.display='none');
        if(s==='main') document.getElementById('mainPanel').style.display='block';
        if(s==='incidents') document.getElementById('secIncidents').style.display='block';
        if(s==='orders') document.getElementById('secOrders').style.display='block';
    }
    function setType(t){ document.getElementById('incType').value=t; alert("Seleccionado: "+t); }
    function setOrder(t){ document.getElementById('ordItem').value=t; document.getElementById('ordDesc').value=t+': '; document.getElementById('ordDesc').focus(); }
    
    async function submitIncident(){
        const t=document.getElementById('incType').value, d=document.getElementById('incDesc').value;
        if(!t||!d)return alert("Completa los datos.");
        await client.from('incident_reports').insert({reporter_id:currentUser.id,area:'BARRA',type:t,severity:'MEDIA',description:d,status:'open'});
        alert("Enviado."); showSection('main'); loadHistory();
    }
    async function submitOrder(){
        const d=document.getElementById('ordDesc').value;
        if(!d)return;
        await client.from('incident_reports').insert({reporter_id:currentUser.id,area:'BARRA',type:'PEDIDO',severity:'BAJA',description:d,status:'open'});
        alert("Pedido enviado."); showSection('main'); loadHistory();
    }
    async function loadHistory(){
        const{data}=await client.from('incident_reports').select('type,created_at,status').eq('reporter_id',currentUser.id).order('created_at',{ascending:false}).limit(5);
        const c=document.getElementById('historyList');
        if(!data?.length){c.innerHTML='<div style="text-align:center; color:#666; padding:10px;">Sin actividad.</div>';return;}
        c.innerHTML=data.map(i=>`<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #333; font-size:12px;">
            <span style="color:#fff;">${i.type}</span>
            <span style="color:${i.status==='open'?'var(--accent-blue)':'var(--accent-green)'}">${i.status.toUpperCase()}</span>
        </div>`).join('');
    }
  </script>
</body>
</html>