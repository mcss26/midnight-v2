<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Club | Sistema de Gesti√≥n Administrativa</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --primary: #6200ea; /* Purple Midnight */
            --accent: #00e5ff; /* Cyan Neon */
            --danger: #cf6679;
            --success: #00c853;
            --text-main: #ffffff;
            --text-dim: #b0b0b0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        aside {
            width: 250px;
            background-color: var(--bg-card);
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
        }

        .brand {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            text-align: center;
        }

        nav button {
            background: none;
            border: none;
            width: 100%;
            padding: 15px 20px;
            text-align: left;
            color: var(--text-dim);
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
        }

        nav button:hover, nav button.active {
            background-color: var(--primary);
            color: white;
        }

        .server-status {
            margin-top: auto;
            padding: 15px;
            font-size: 0.8rem;
            color: var(--success);
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dot { height: 10px; width: 10px; background-color: var(--success); border-radius: 50%; display: inline-block; }

        /* MAIN CONTENT */
        main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }

        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-top: 0; }

        /* GRID SYSTEM */
        .grid-pos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        /* CARDS */
        .card-product {
            background-color: var(--bg-card);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .card-product:hover { transform: translateY(-2px); border-color: var(--accent); }
        .card-product h3 { margin: 10px 0 5px; font-size: 1rem; }
        .price { color: var(--accent); font-weight: bold; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #333; }
        th { color: var(--text-dim); }
        .stock-low { color: var(--danger); font-weight: bold; }

        /* FORMS & INPUTS */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-dim); }
        input { 
            width: 100%; padding: 10px; 
            background: #2a2a2a; border: 1px solid #444; 
            color: white; border-radius: 4px; box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; text-transform: uppercase;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-success { background-color: var(--success); color: white; }

        /* AUDIT LOG STYLES */
        .audit-entry {
            background: #2a2a2a;
            padding: 10px;
            margin-bottom: 5px;
            border-left: 4px solid var(--text-dim);
            font-family: monospace;
        }
        .audit-entry.ANULACION { border-left-color: var(--danger); }
        .audit-entry.VENTA { border-left-color: var(--success); }
        
        /* NOTIFICATIONS */
        #notification-area {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
        }
        .toast {
            background: #333; color: white; padding: 15px 25px;
            margin-top: 10px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 5px solid var(--accent);
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <aside>
        <div class="brand">Midnight Club<br><small>Panel Administrativo</small></div>
        <nav>
            <button onclick="app.nav('pos')" class="active">üç∏ Barra (POS)</button>
            <button onclick="app.nav('stock')">üì¶ Stock & Recetas</button>
            <button onclick="app.nav('audit')">üõ°Ô∏è Auditor√≠a</button>
            <button onclick="app.nav('close')">üí∞ Cierre Ciego</button>
        </nav>
        <div class="server-status">
            <span class="dot"></span> Servidor Local: ONLINE
        </div>
    </aside>

    <main>
        <section id="pos" class="section active">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Punto de Venta (Barra Principal)</h2>
                <div>
                    <span>Cliente VIP: <strong>Juan P√©rez</strong></span> | 
                    <span>Saldo: <strong id="vip-balance" style="color:var(--accent)">$15000</strong></span>
                </div>
            </div>
            
            <div class="grid-pos" id="product-grid">
                </div>

            <div style="margin-top: 30px; background:#252525; padding:20px; border-radius:8px;">
                <h3>√öltimas Transacciones</h3>
                <table id="pos-log">
                    <thead><tr><th>ID</th><th>Producto</th><th>Hora</th><th>Acci√≥n</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>

        <section id="stock" class="section">
            <h2>Inventario en Tiempo Real (Dep√≥sito Barra)</h2>
            <p style="color:var(--text-dim)">Visualizaci√≥n de descuento fraccional por receta (ml/gr).</p>
            <table>
                <thead>
                    <tr><th>Insumo</th><th>Unidad</th><th>Stock Actual</th><th>Stock Ideal</th><th>Estado</th></tr>
                </thead>
                <tbody id="inventory-table">
                    </tbody>
            </table>
        </section>

        <section id="audit" class="section">
            <h2>Auditor√≠a de Seguridad</h2>
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="flex:1; background:var(--bg-card); padding:15px; border-radius:5px;">
                    <h3 style="color:var(--danger)">Solicitudes de Anulaci√≥n Pendientes</h3>
                    <div id="pending-voids">
                        <p style="color:#666">No hay solicitudes pendientes.</p>
                    </div>
                </div>
            </div>
            <h3>Log de Eventos (Inmutable)</h3>
            <div id="audit-log-container"></div>
        </section>

        <section id="close" class="section">
            <h2>Cierre de Caja Ciego (Blind Close)</h2>
            <p>Ingrese los valores contados f√≠sicamente. El sistema calcular√° las diferencias.</p>
            
            <div style="max-width: 500px; background:var(--bg-card); padding:30px; border-radius:10px;">
                <div class="form-group">
                    <label>Efectivo Contado ($)</label>
                    <input type="number" id="cash-counted" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Vouchers Tarjeta / QR Contados ($)</label>
                    <input type="number" id="card-counted" placeholder="0.00">
                </div>
                
                <button class="btn btn-primary" onclick="app.performClose()">EJECUTAR CIERRE Y COMPARAR</button>
                
                <div id="close-result" style="margin-top:20px; display:none; border-top:1px solid #444; padding-top:15px;">
                    </div>
            </div>
        </section>
    </main>

    <div id="notification-area"></div>

    <script>
        class MidnightSystem {
            constructor() {
                // BASE DE DATOS LOCAL SIMULADA
                this.db = {
                    ingredients: [
                        { id: 'ron', name: 'Ron Bacardi', unit: 'ml', stock: 5000, ideal: 1000 }, // 5 Litros
                        { id: 'coca', name: 'Coca Cola', unit: 'ml', stock: 20000, ideal: 5000 }, // 20 Litros
                        { id: 'vodka', name: 'Vodka Smirnoff', unit: 'ml', stock: 3000, ideal: 1000 },
                        { id: 'speed', name: 'Speed Unlimited', unit: 'ml', stock: 10000, ideal: 2000 },
                        { id: 'hielo', name: 'Hielo', unit: 'kg', stock: 50, ideal: 10 }
                    ],
                    products: [
                        { 
                            id: 1, name: 'Cuba Libre', price: 4500, 
                            recipe: [ { id: 'ron', qty: 60 }, { id: 'coca', qty: 200 }, { id: 'hielo', qty: 0.2 } ]
                        },
                        { 
                            id: 2, name: 'Vodka con Speed', price: 5000, 
                            recipe: [ { id: 'vodka', qty: 60 }, { id: 'speed', qty: 200 }, { id: 'hielo', qty: 0.2 } ]
                        },
                        { 
                            id: 3, name: 'Coca Cola (Sola)', price: 2000, 
                            recipe: [ { id: 'coca', qty: 350 }, { id: 'hielo', qty: 0.2 } ]
                        }
                    ],
                    transactions: [],
                    pendingVoids: [],
                    salesTotal: 0,
                    vipBalance: 15000
                };
                
                this.init();
            }

            init() {
                this.renderProducts();
                this.renderInventory();
                this.updateAuditLog("SISTEMA", "Inicio de sesi√≥n", "Sistema iniciado correctamente.");
            }

            // NAVEGACI√ìN
            nav(sectionId) {
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
                
                document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
                // Simple logic for button active state based on index/order
                const btnIndex = ['pos', 'stock', 'audit', 'close'].indexOf(sectionId);
                document.querySelectorAll('nav button')[btnIndex].classList.add('active');

                if(sectionId === 'stock') this.renderInventory();
            }

            // MODULO 1: GESTI√ìN DE STOCK Y RECETAS
            renderInventory() {
                const tbody = document.getElementById('inventory-table');
                tbody.innerHTML = '';
                
                this.db.ingredients.forEach(ing => {
                    const statusClass = ing.stock < ing.ideal ? 'stock-low' : '';
                    const statusText = ing.stock < ing.ideal ? '‚ö†Ô∏è CR√çTICO' : 'OK';
                    
                    const row = `<tr>
                        <td>${ing.name}</td>
                        <td>${ing.unit}</td>
                        <td class="${statusClass}">${ing.stock.toFixed(1)}</td>
                        <td>${ing.ideal}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }

            checkStock(recipe) {
                // Verifica si hay suficiente stock para todos los ingredientes
                for (let item of recipe) {
                    const ingredient = this.db.ingredients.find(i => i.id === item.id);
                    if (ingredient.stock < item.qty) return false;
                }
                return true;
            }

            deductStock(recipe) {
                // Descuenta stock basado en la receta (Soluci√≥n a la brecha de GBOL)
                recipe.forEach(item => {
                    const ingredient = this.db.ingredients.find(i => i.id === item.id);
                    ingredient.stock -= item.qty;
                });
            }

            // MODULO 2: POS Y VENTA
            renderProducts() {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                this.db.products.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'card-product';
                    card.innerHTML = `<h3>${p.name}</h3><div class="price">$${p.price}</div>`;
                    card.onclick = () => this.processSale(p);
                    grid.appendChild(card);
                });
            }

            processSale(product) {
                // 1. Verificar Saldo VIP
                if (this.db.vipBalance < product.price) {
                    this.notify("Saldo insuficiente en Tarjeta VIP", "error");
                    return;
                }

                // 2. Verificar Stock (Receta)
                if (!this.checkStock(product.recipe)) {
                    this.notify(`Stock insuficiente de insumos para ${product.name}`, "error");
                    return;
                }

                // 3. Ejecutar Venta
                this.db.vipBalance -= product.price;
                this.deductStock(product.recipe);
                this.db.salesTotal += product.price;

                // 4. Registrar Transacci√≥n
                const txId = Date.now().toString().slice(-6);
                const tx = { id: txId, product: product.name, price: product.price, time: new Date().toLocaleTimeString(), status: 'OK' };
                this.db.transactions.unshift(tx);

                // UI Updates
                document.getElementById('vip-balance').innerText = `$${this.db.vipBalance}`;
                this.notify(`Venta exitosa: ${product.name}`, "success");
                this.updatePosLog();
                this.updateAuditLog("BARTENDER", "VENTA", `Vendi√≥ ${product.name} (ID: ${txId})`);
            }

            updatePosLog() {
                const tbody = document.querySelector('#pos-log tbody');
                tbody.innerHTML = '';
                this.db.transactions.slice(0, 5).forEach(tx => {
                    // Bot√≥n de seguridad: SOLICITAR ANULACI√ìN (No borrar)
                    const actionBtn = tx.status === 'OK' 
                        ? `<button onclick="app.requestVoid('${tx.id}')" style="background:none; border:1px solid #666; color:#aaa; cursor:pointer; font-size:0.8rem;">Solicitar Anulaci√≥n</button>` 
                        : `<span style="color:var(--danger)">${tx.status}</span>`;

                    tbody.innerHTML += `<tr>
                        <td>${tx.id}</td>
                        <td>${tx.product}</td>
                        <td>${tx.time}</td>
                        <td>${actionBtn}</td>
                    </tr>`;
                });
            }

            // MODULO 3: AUDITOR√çA Y SEGURIDAD
            requestVoid(txId) {
                const tx = this.db.transactions.find(t => t.id === txId);
                if (!tx) return;

                // Bloqueo l√≥gico: Cambia estado a PENDIENTE
                tx.status = 'PENDIENTE';
                this.db.pendingVoids.push(tx);
                
                this.updatePosLog();
                this.renderPendingVoids();
                this.updateAuditLog("BARTENDER", "SOLICITUD_ANULACION", `Solicit√≥ anular venta ${txId} (${tx.product})`);
                this.notify("Solicitud de anulaci√≥n enviada a Gerencia", "warning");
            }

            renderPendingVoids() {
                const container = document.getElementById('pending-voids');
                if (this.db.pendingVoids.length === 0) {
                    container.innerHTML = '<p style="color:#666">No hay solicitudes pendientes.</p>';
                    return;
                }

                container.innerHTML = '';
                this.db.pendingVoids.forEach(tx => {
                    const div = document.createElement('div');
                    div.style = "background:#333; padding:10px; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;";
                    div.innerHTML = `
                        <span><strong>${tx.id}</strong>: ${tx.product} ($${tx.price})</span>
                        <div>
                            <button onclick="app.approveVoid('${tx.id}', true)" class="btn-success" style="padding:5px 10px; font-size:0.8rem;">‚úì</button>
                            <button onclick="app.approveVoid('${tx.id}', false)" class="btn-danger" style="padding:5px 10px; font-size:0.8rem;">‚úï</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            approveVoid(txId, isApproved) {
                const txIndex = this.db.pendingVoids.findIndex(t => t.id === txId);
                if (txIndex === -1) return;
                
                const tx = this.db.pendingVoids[txIndex];
                this.db.pendingVoids.splice(txIndex, 1); // Remover de pendientes

                const originalTx = this.db.transactions.find(t => t.id === txId);

                if (isApproved) {
                    originalTx.status = 'ANULADO';
                    // Reintegrar saldo y (opcionalmente) stock - Aqu√≠ asumimos que stock se tir√≥ (merma) o se recupera seg√∫n pol√≠tica
                    this.db.vipBalance += tx.price;
                    this.db.salesTotal -= tx.price;
                    document.getElementById('vip-balance').innerText = `$${this.db.vipBalance}`;
                    this.updateAuditLog("GERENCIA", "APROBACION", `Anulaci√≥n ${txId} APROBADA. Saldo reintegrado.`);
                } else {
                    originalTx.status = 'OK'; // Vuelve a estar v√°lida
                    this.updateAuditLog("GERENCIA", "RECHAZO", `Anulaci√≥n ${txId} RECHAZADA.`);
                }
                
                this.renderPendingVoids();
                this.updatePosLog();
            }

            updateAuditLog(user, type, detail) {
                const logContainer = document.getElementById('audit-log-container');
                const time = new Date().toLocaleTimeString();
                const entry = `<div class="audit-entry ${type}">
                    <span style="color:var(--accent)">[${time}]</span> <strong>${user}</strong>: ${type} - ${detail}
                </div>`;
                logContainer.innerHTML = entry + logContainer.innerHTML;
            }

            // MODULO 4: CIERRE DE CAJA CIEGO
            performClose() {
                const countedCash = parseFloat(document.getElementById('cash-counted').value) || 0;
                const countedCard = parseFloat(document.getElementById('card-counted').value) || 0;
                const totalCounted = countedCash + countedCard;
                
                // En un escenario real, salesTotal estar√≠a dividido por m√©todo de pago.
                // Aqu√≠ simplificamos asumiendo que salesTotal es todo lo que entr√≥.
                const difference = totalCounted - this.db.salesTotal;
                
                const resultDiv = document.getElementById('close-result');
                let resultHTML = `
                    <p><strong>Total Sistema (Oculto al Cajero):</strong> $${this.db.salesTotal}</p>
                    <p><strong>Total Declarado:</strong> $${totalCounted}</p>
                    <hr style="border-color:#444">
                `;

                if (difference === 0) {
                    resultHTML += `<h3 style="color:var(--success)">CAJA BALANCEADA PERFECTAMENTE</h3>`;
                    this.updateAuditLog("SISTEMA", "CIERRE", "Cierre exitoso sin diferencias.");
                } else if (difference < 0) {
                    resultHTML += `<h3 style="color:var(--danger)">FALTANTE DE CAJA: $${Math.abs(difference)}</h3>`;
                    this.updateAuditLog("SISTEMA", "ALERTA_FALTANTE", `Faltante detectado: $${Math.abs(difference)}`);
                } else {
                    resultHTML += `<h3 style="color:var(--accent)">SOBRANTE DE CAJA: $${difference}</h3>`;
                }

                resultDiv.innerHTML = resultHTML;
                resultDiv.style.display = 'block';
            }

            notify(msg, type) {
                const area = document.getElementById('notification-area');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.style.borderLeftColor = type === 'error' ? 'var(--danger)' : (type === 'success' ? 'var(--success)' : 'var(--accent)');
                toast.innerText = msg;
                area.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        }

        // INICIALIZAR APP
        const app = new MidnightSystem();
    </script>
</body>
</html>