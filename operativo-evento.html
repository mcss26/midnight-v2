<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MIDNIGHT ERP · Operativo Evento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet" />

  <style>
    /* Mínimo, solo para completar lo que tu CSS no trae (sin “pesar” admin-styles) */
    .evento-main{ display:flex; flex-direction:column; gap:16px; min-width:0; }
    .evento-card-header{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; flex-wrap:wrap;
      margin-bottom:14px; padding-bottom:10px;
      border-bottom:1px solid var(--border-subtle);
    }
    .evento-card-header-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .evento-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; }
    .plan-total{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px; border:1px solid var(--border-subtle);
      border-radius:var(--radius-md);
      background:rgba(0,0,0,0.25);
      margin-top:12px;
    }
    .plan-total .value{ font-family:var(--font-display); font-size:20px; font-weight:900; }
    .role-controls{ display:flex; align-items:center; gap:6px; }
    .role-controls .input-stock{ width:76px; }
    .role-controls .btn-icon{ width:32px; height:32px; border-radius:12px; }
    .link-soft{ color:var(--text-secondary); font-size:12px; }
    .link-soft:hover{ color:#fff; }
    .inline-status{ margin-left:6px; }
    .stack-8{ display:flex; flex-direction:column; gap:8px; }
    .divider-soft{ height:1px; background:var(--border-subtle); margin:12px 0; }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div>
          <button class="btn-back" type="button" onclick="window.location.href='operativo-index.html'">Volver</button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Operativo · Evento</span>
          <button id="btnLogout" class="btn-logout" type="button">Salir</button>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <section class="section-header">
      <h1 class="section-title">Operativo · Evento</h1>
      <p class="section-desc">Un evento por fecha. Dotación por rol (sin nombres) + checklist de insumos críticos.</p>
      <div class="section-underline"></div>
    </section>

    <section class="evento-layout">
      <!-- IZQUIERDA: DOTACIÓN (PLAN) -->
      <aside class="evento-sidebar">
        <div class="staff-lib-header">
          <div class="row-title">Dotación (plan)</div>
          <div class="row-sub-text">Cargá cantidades por rol</div>
        </div>

        <div id="rolesPlanList" class="stack-8"></div>

        <div class="plan-total">
          <div>
            <div class="summary-label">Total planificado</div>
            <div class="row-sub-text">Se guarda en el evento</div>
          </div>
          <div id="planTotal" class="value">0</div>
        </div>

        <div class="divider-soft"></div>
        <a class="link-soft" href="encargado-caja.html">→ Encargado Caja (retiros/validación)</a>
        <div style="height:6px;"></div>
        <a class="link-soft" href="operativo-stock.html">→ Operativo Stock (detalle completo)</a>
      </aside>

      <!-- DERECHA: EVENTO + INSUMOS -->
      <section class="evento-main">
        <!-- EVENTO -->
        <article class="evento-card" id="eventCard">
          <div class="evento-card-header">
            <div>
              <div class="row-title" id="currentEventTitle">Sin evento seleccionado</div>
              <div class="row-sub-text" id="currentEventSubtitle">Elegí una fecha y abrí o creá el evento.</div>
            </div>

            <div class="evento-card-header-actions">
              <span id="currentEventStatusTag" class="tag tag-gray">Sin evento</span>
              <span id="saveState" class="inline-status">—</span>
              <button id="btnNew" class="btn-secondary" type="button">Nuevo</button>
              <button id="btnOpen" class="btn-secondary" type="button">Abrir / crear</button>
              <button id="btnSave" class="btn-primary" type="button" disabled>Guardar</button>
            </div>
          </div>

          <div class="evento-grid">
            <div>
              <label for="eventDate" class="input-label">Fecha operativa</label>
              <input id="eventDate" type="date" class="modal-input" />
            </div>

            <div>
              <label for="eventLabel" class="input-label">Etiqueta</label>
              <input id="eventLabel" type="text" class="modal-input" placeholder="Ej: Sábado reggaetón" />
            </div>

            <div>
              <label for="eventStartTime" class="input-label">Hora inicio</label>
              <input id="eventStartTime" type="time" class="modal-input" />
            </div>

            <div>
              <label for="eventEndTime" class="input-label">Hora cierre</label>
              <input id="eventEndTime" type="time" class="modal-input" />
            </div>
          </div>

          <div class="mt-2">
            <label for="eventNotes" class="input-label">Notas operativas</label>
            <textarea id="eventNotes" class="modal-input" placeholder="Observaciones, pendientes, etc."></textarea>
          </div>

          <div class="mt-2">
            <div class="summary-row">
              <div class="summary-card border-total">
                <div class="summary-label">Fecha</div>
                <div id="summaryDate" class="summary-value">—</div>
              </div>
              <div class="summary-card border-digital">
                <div class="summary-label">Horario</div>
                <div id="summaryTime" class="summary-value">—</div>
              </div>
              <div class="summary-card border-internal">
                <div class="summary-label">Dotación</div>
                <div id="summaryStaffTotal" class="summary-value">0</div>
              </div>
            </div>
          </div>

          <div id="toast" class="toast inline-toast"></div>
        </article>

        <!-- INSUMOS CRÍTICOS -->
        <article class="evento-card" id="lowStockCard">
          <div class="evento-card-header">
            <div>
              <div class="row-title">Insumos con stock bajo ideal</div>
              <div class="row-sub-text">Top 6 más críticos para revisar antes del evento.</div>
            </div>
            <div class="evento-card-header-actions">
              <button id="btnRefreshLowStock" class="btn-refresh" type="button">Refrescar</button>
            </div>
          </div>

          <div class="table-container">
            <table class="sku-table">
              <thead>
                <tr>
                  <th>Insumo / Categoría</th>
                  <th class="text-center">Actual</th>
                  <th class="text-center">Ideal</th>
                  <th class="text-center">Sugerido</th>
                  <th class="text-right">Costo</th>
                  <th class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody id="lowStockTableBody">
                <tr>
                  <td colspan="6" class="text-muted text-center">Creá un evento para ver insumos críticos.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-2 text-right">
            <a href="operativo-stock.html" class="text-muted">Ver detalle completo en Operativo Stock →</a>
          </div>
        </article>
      </section>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <script>
    (function () {
      'use strict';

      const supa = window.client;
      if (!supa) {
        alert('Error de conexión a la base de datos.');
        return;
      }

      // --- DOM ---
      const btnLogout = document.getElementById('btnLogout');
      const btnNew = document.getElementById('btnNew');
      const btnOpen = document.getElementById('btnOpen');
      const btnSave = document.getElementById('btnSave');

      const eventDate = document.getElementById('eventDate');
      const eventLabel = document.getElementById('eventLabel');
      const eventStartTime = document.getElementById('eventStartTime');
      const eventEndTime = document.getElementById('eventEndTime');
      const eventNotes = document.getElementById('eventNotes');

      const currentEventTitle = document.getElementById('currentEventTitle');
      const currentEventSubtitle = document.getElementById('currentEventSubtitle');
      const currentEventStatusTag = document.getElementById('currentEventStatusTag');
      const saveState = document.getElementById('saveState');

      const summaryDate = document.getElementById('summaryDate');
      const summaryTime = document.getElementById('summaryTime');
      const summaryStaffTotal = document.getElementById('summaryStaffTotal');

      const rolesPlanList = document.getElementById('rolesPlanList');
      const planTotalEl = document.getElementById('planTotal');

      const lowStockTableBody = document.getElementById('lowStockTableBody');
      const btnRefreshLowStock = document.getElementById('btnRefreshLowStock');

      const toastEl = document.getElementById('toast');

      // --- Session ---
      let currentUser = null;
      try {
        const raw = localStorage.getItem('mc_user');
        if (raw) currentUser = JSON.parse(raw);
      } catch (_) {}

      btnLogout.addEventListener('click', () => {
        localStorage.removeItem('mc_user');
        window.location.href = 'index.html';
      });

      // --- Utils ---
      const formatCurrency =
        window.MC_UTILS && typeof window.MC_UTILS.formatCurrency === 'function'
          ? window.MC_UTILS.formatCurrency
          : (amount) =>
              new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                maximumFractionDigits: 0
              }).format(Number(amount) || 0);

      function todayLocalYYYYMMDD() {
        const d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 10);
      }

      function formatDateYYYYMMDDToDDMM(dateStr) {
        if (!dateStr) return '—';
        const p = dateStr.split('-');
        if (p.length !== 3) return dateStr;
        return p[2] + '/' + p[1];
      }

      function formatTimeHHMM(timeStr) {
        if (!timeStr) return '—';
        return String(timeStr).slice(0, 5);
      }

      function showToast(type, msg) {
        toastEl.className = 'toast ' + (type === 'ok' ? 'ok' : 'warn') + ' inline-toast';
        toastEl.textContent = msg;
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(() => {
          toastEl.className = 'toast inline-toast';
          toastEl.textContent = '';
        }, 3500);
      }

      // --- State ---
      let roles = [];
      let currentEvent = null;
      let dirty = false;

      // planCounts por role_id (string)
      let planCounts = {};

      function setDirty(v) {
        dirty = !!v;
        if (!currentEvent) {
          saveState.textContent = '—';
          return;
        }
        saveState.textContent = dirty ? 'EDITANDO' : 'GUARDADO';
      }

      function getPlanTotal() {
        return Object.values(planCounts).reduce((sum, n) => sum + (Number(n) || 0), 0);
      }

      function getPlanPayload() {
        // guardar solo roles con > 0
        const out = {};
        for (const k of Object.keys(planCounts)) {
          const v = Number(planCounts[k]) || 0;
          if (v > 0) out[k] = v;
        }
        return out;
      }

      function applyEventUIState() {
        const hasEvent = !!currentEvent;
        const status = hasEvent ? (currentEvent.status || 'OPEN') : null;

        // fecha fija desde que hay evento (aunque esté abierto)
        eventDate.disabled = hasEvent;
        btnSave.disabled = !hasEvent;

        if (!hasEvent) {
          currentEventStatusTag.textContent = 'Sin evento';
          currentEventStatusTag.className = 'tag tag-gray';
          currentEventTitle.textContent = 'Sin evento seleccionado';
          currentEventSubtitle.textContent = 'Elegí una fecha y abrí o creá el evento.';
          summaryDate.textContent = '—';
          summaryTime.textContent = '—';
          summaryStaffTotal.textContent = '0';
          saveState.textContent = '—';
          return;
        }

        if (String(status).toUpperCase() === 'LOCKED') {
          currentEventStatusTag.textContent = 'Cerrado';
          currentEventStatusTag.className = 'tag tag-green';
        } else {
          currentEventStatusTag.textContent = 'Abierto';
          currentEventStatusTag.className = 'tag tag-gray';
        }

        const dateLabel = formatDateYYYYMMDDToDDMM(currentEvent.operational_date);
        const timeLabel = formatTimeHHMM(currentEvent.start_time) + ' – ' + formatTimeHHMM(currentEvent.end_time);

        currentEventTitle.textContent = (currentEvent.label || dateLabel).toUpperCase();
        currentEventSubtitle.textContent = dateLabel + ' · ' + timeLabel;

        summaryDate.textContent = dateLabel;
        summaryTime.textContent = timeLabel;
        summaryStaffTotal.textContent = String(getPlanTotal());
      }

      function renderRolesPlanner() {
        rolesPlanList.innerHTML = '';

        if (!roles.length) {
          const empty = document.createElement('div');
          empty.className = 'text-muted';
          empty.textContent = 'No hay roles activos.';
          rolesPlanList.appendChild(empty);
          planTotalEl.textContent = '0';
          return;
        }

        roles.forEach(r => {
          const roleId = String(r.id);
          const count = Number(planCounts[roleId]) || 0;

          const row = document.createElement('div');
          row.className = 'staff-lib-row';
          row.dataset.roleId = roleId;

          const left = document.createElement('div');
          left.style.flex = '1';

          left.innerHTML =
            `<div class="row-title">${r.role_name}</div>` +
            `<div class="row-sub-text">${r.base_pay ? ('Base: ' + formatCurrency(r.base_pay) + ' / h') : '—'}</div>`;

          const right = document.createElement('div');
          right.className = 'role-controls';

          const btnMinus = document.createElement('button');
          btnMinus.type = 'button';
          btnMinus.className = 'btn-icon';
          btnMinus.textContent = '−';
          btnMinus.title = 'Restar 1';

          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.step = '1';
          input.className = 'input-stock';
          input.value = String(count);

          const btnPlus = document.createElement('button');
          btnPlus.type = 'button';
          btnPlus.className = 'btn-icon';
          btnPlus.textContent = '+';
          btnPlus.title = 'Sumar 1';

          btnMinus.addEventListener('click', () => {
            const v = Math.max(0, (Number(input.value) || 0) - 1);
            input.value = String(v);
            planCounts[roleId] = v;
            planTotalEl.textContent = String(getPlanTotal());
            if (currentEvent) applyEventUIState();
            setDirty(true);
          });

          btnPlus.addEventListener('click', () => {
            const v = (Number(input.value) || 0) + 1;
            input.value = String(v);
            planCounts[roleId] = v;
            planTotalEl.textContent = String(getPlanTotal());
            if (currentEvent) applyEventUIState();
            setDirty(true);
          });

          input.addEventListener('input', () => {
            const v = Math.max(0, Number(input.value) || 0);
            planCounts[roleId] = v;
            planTotalEl.textContent = String(getPlanTotal());
            if (currentEvent) applyEventUIState();
            setDirty(true);
          });

          right.appendChild(btnMinus);
          right.appendChild(input);
          right.appendChild(btnPlus);

          row.appendChild(left);
          row.appendChild(right);

          rolesPlanList.appendChild(row);
        });

        planTotalEl.textContent = String(getPlanTotal());
      }

      // --- Data ---
      async function loadRoles() {
        const { data, error } = await supa
          .from('staff_roles')
          .select('id, role_name, base_pay, is_active')
          .eq('is_active', true)
          .order('role_name', { ascending: true });

        if (error) {
          console.error('Error cargando roles', error);
          showToast('warn', 'No se pudieron cargar roles.');
          roles = [];
        } else {
          roles = data || [];
        }

        // inicializar planCounts (manteniendo lo que haya)
        const next = { ...planCounts };
        roles.forEach(r => {
          const k = String(r.id);
          if (next[k] == null) next[k] = 0;
        });
        planCounts = next;

        renderRolesPlanner();
      }

      function hydratePlanFromEvent(ev) {
        const raw = ev && ev.staff_plan ? ev.staff_plan : null;
        const next = {};

        // inicializar con 0
        roles.forEach(r => next[String(r.id)] = 0);

        if (raw && typeof raw === 'object') {
          // caso guardado por role_id (recomendado)
          for (const k of Object.keys(raw)) {
            if (next[k] != null) next[k] = Number(raw[k]) || 0;
          }
        }

        planCounts = next;
        renderRolesPlanner();
      }

      async function openOrCreateEvent() {
        const dateValue = eventDate.value;
        if (!dateValue) return alert('Elegí una fecha operativa.');

        btnOpen.disabled = true;

        try {
          const { data: found, error: e1 } = await supa
            .from('staff_events')
            .select('*')
            .eq('operational_date', dateValue)
            .order('created_at', { ascending: true })
            .limit(1)
            .maybeSingle();

          if (e1) throw e1;

          if (found) {
            currentEvent = found;

            // hidratar formulario
            eventLabel.value = currentEvent.label || '';
            eventStartTime.value = currentEvent.start_time ? formatTimeHHMM(currentEvent.start_time) : '';
            eventEndTime.value = currentEvent.end_time ? formatTimeHHMM(currentEvent.end_time) : '';
            eventNotes.value = currentEvent.notes || '';

            hydratePlanFromEvent(currentEvent);
            setDirty(false);

            applyEventUIState();
            await loadLowStock();

            showToast('ok', 'Evento cargado.');
            return;
          }

          // crear base (sin staff_plan por compatibilidad si aún no corriste SQL)
          const payload = {
            operational_date: dateValue,
            label: (eventLabel.value || '').trim() || null,
            start_time: eventStartTime.value || null,
            end_time: eventEndTime.value || null,
            status: 'OPEN'
          };

          const { data: created, error: e2 } = await supa
            .from('staff_events')
            .insert(payload)
            .select('*')
            .single();

          if (e2) throw e2;

          currentEvent = created;

          // intentar guardar extras (staff_plan/notes/total) si existen columnas
          await saveEvent(true);

          applyEventUIState();
          await loadLowStock();

          showToast('ok', 'Evento creado.');
        } catch (e) {
          console.error('openOrCreateEvent error', e);
          alert(e && e.message ? e.message : 'No se pudo abrir/crear el evento.');
        } finally {
          btnOpen.disabled = false;
        }
      }

      async function saveEvent(silent) {
        if (!currentEvent) return;

        const payload = {
          label: (eventLabel.value || '').trim() || null,
          start_time: eventStartTime.value || null,
          end_time: eventEndTime.value || null,
          staff_plan: getPlanPayload(),
          staff_total: getPlanTotal(),
          notes: (eventNotes.value || '').trim() || null
        };

        btnSave.disabled = true;

        try {
          const { data, error } = await supa
            .from('staff_events')
            .update(payload)
            .eq('id', currentEvent.id)
            .select('*')
            .single();

          if (error) {
            // si todavía no corriste el SQL de columnas, cae acá
            const msg = String(error.message || '');
            if (msg.toLowerCase().includes('staff_plan') || msg.toLowerCase().includes('staff_total') || msg.toLowerCase().includes('notes')) {
              if (!silent) {
                showToast('warn', 'Faltan columnas (staff_plan/staff_total/notes). Corré el SQL que te pasé.');
              }
              // igual guardamos lo “base” sin romper: reintento sin extras
              const basePayload = {
                label: payload.label,
                start_time: payload.start_time,
                end_time: payload.end_time
              };
              const { data: d2, error: e2 } = await supa
                .from('staff_events')
                .update(basePayload)
                .eq('id', currentEvent.id)
                .select('*')
                .single();
              if (e2) throw e2;
              currentEvent = d2;
            } else {
              throw error;
            }
          } else {
            currentEvent = data;
          }

          setDirty(false);
          applyEventUIState();
          if (!silent) showToast('ok', 'Guardado.');
        } catch (e) {
          console.error('saveEvent error', e);
          alert(e && e.message ? e.message : 'No se pudo guardar.');
        } finally {
          btnSave.disabled = false;
        }
      }

      function resetToNew() {
        currentEvent = null;
        eventDate.disabled = false;

        eventDate.value = todayLocalYYYYMMDD();
        eventLabel.value = '';
        eventStartTime.value = '';
        eventEndTime.value = '';
        eventNotes.value = '';

        // reset plan
        const next = {};
        roles.forEach(r => next[String(r.id)] = 0);
        planCounts = next;

        renderRolesPlanner();
        applyEventUIState();

        lowStockTableBody.innerHTML =
          '<tr><td colspan="6" class="text-muted text-center">Creá un evento para ver insumos críticos.</td></tr>';
      }

      async function loadLowStock() {
        // si no hay evento, solo render placeholder
        if (!currentEvent) {
          lowStockTableBody.innerHTML =
            '<tr><td colspan="6" class="text-muted text-center">Creá un evento para ver insumos críticos.</td></tr>';
          return;
        }

        try {
          const { data, error } = await supa
            .from('inventory_stock')
            .select(`
              sku_id,
              stock_current,
              stock_ideal,
              inventory_skus (
                id,
                name,
                category,
                unit_type,
                cost_price,
                is_active
              )
            `);

          if (error) throw error;

          const raw = (data || []).filter(x => x.inventory_skus && x.inventory_skus.is_active);

          const mapped = raw
            .map(item => {
              const sku = item.inventory_skus;
              const stockCurrent = Number(item.stock_current) || 0;
              const stockIdeal = item.stock_ideal != null ? Number(item.stock_ideal) : null;
              if (stockIdeal == null) return null;
              if (stockIdeal <= 0) return null;
              if (stockCurrent >= stockIdeal) return null;

              const suggested = Math.max(0, stockIdeal - stockCurrent);
              const costPrice = Number(sku.cost_price) || 0;

              return {
                sku_id: item.sku_id,
                name: sku.name,
                category: sku.category,
                unit_type: sku.unit_type,
                stock_current: stockCurrent,
                stock_ideal: stockIdeal,
                suggested_qty: suggested,
                estimated_cost: suggested * costPrice
              };
            })
            .filter(Boolean)
            .sort((a, b) => b.suggested_qty - a.suggested_qty)
            .slice(0, 6);

          renderLowStock(mapped);
        } catch (e) {
          console.error('loadLowStock error', e);
          lowStockTableBody.innerHTML =
            '<tr><td colspan="6" class="text-muted text-center">No se pudo cargar stock crítico.</td></tr>';
        }
      }

      function renderLowStock(items) {
        lowStockTableBody.innerHTML = '';

        if (!items || !items.length) {
          lowStockTableBody.innerHTML =
            '<tr><td colspan="6" class="text-muted text-center">No hay insumos por debajo del ideal.</td></tr>';
          return;
        }

        items.forEach(item => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          tdName.innerHTML =
            '<div class="row-title">' + item.name + '</div>' +
            '<div class="row-sub-text"><span class="tag tag-gray">' + (item.category || 'GRAL') + '</span></div>';

          const tdCurrent = document.createElement('td');
          tdCurrent.className = 'text-center';
          tdCurrent.textContent = item.stock_current + ' ' + (item.unit_type || '');

          const tdIdeal = document.createElement('td');
          tdIdeal.className = 'text-center text-muted';
          tdIdeal.textContent = item.stock_ideal;

          const tdSuggested = document.createElement('td');
          tdSuggested.className = 'text-center';
          tdSuggested.textContent = item.suggested_qty;

          const tdCost = document.createElement('td');
          tdCost.className = 'text-right';
          tdCost.textContent = formatCurrency(item.estimated_cost);

          const tdAction = document.createElement('td');
          tdAction.className = 'text-center';

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn-primary';
          btn.textContent = 'Solicitar';
          btn.addEventListener('click', () => handleLowStockRequest(item));

          tdAction.appendChild(btn);

          tr.appendChild(tdName);
          tr.appendChild(tdCurrent);
          tr.appendChild(tdIdeal);
          tr.appendChild(tdSuggested);
          tr.appendChild(tdCost);
          tr.appendChild(tdAction);

          lowStockTableBody.appendChild(tr);
        });
      }

      async function handleLowStockRequest(item) {
        if (!currentEvent) return alert('Primero creá o abrí un evento.');

        const userId =
          currentUser && currentUser.id && currentUser.id !== 'dev'
            ? currentUser.id
            : null;

        if (!confirm(`Confirmar solicitud de ${item.suggested_qty} ${item.unit_type || ''} de "${item.name}"?`)) return;

        try {
          const { error } = await supa.from('stock_requests').insert({
            sku_id: item.sku_id,
            requested_qty: item.suggested_qty,
            requested_by: userId,
            status: 'PENDING'
          });

          if (error) throw error;

          showToast('ok', 'Solicitud registrada.');
          await loadLowStock();
        } catch (e) {
          console.error('handleLowStockRequest error', e);
          alert('No se pudo registrar la solicitud.');
        }
      }

      // --- Listeners: mark dirty ---
      [eventLabel, eventStartTime, eventEndTime, eventNotes].forEach(el => {
        el.addEventListener('input', () => {
          if (!currentEvent) return;
          setDirty(true);
        });
      });

      btnNew.addEventListener('click', resetToNew);
      btnOpen.addEventListener('click', openOrCreateEvent);
      btnSave.addEventListener('click', () => saveEvent(false));
      btnRefreshLowStock.addEventListener('click', loadLowStock);

      // --- Bootstrap ---
      (async function bootstrap() {
        eventDate.value = todayLocalYYYYMMDD();
        await loadRoles();
        resetToNew(); // deja todo consistente
      })();
    })();
  </script>
</body>
</html>

