<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Master SKUs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>
</head>

<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">DATA</span></div>
    <div class="admin-header-right">
        <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">Maestro de Insumos</h2>
        <p class="section-desc">Art칤culos, costos y stock ideal operativo.</p>
      </div>
      <div style="display:flex; gap:10px;">
        <input type="file" id="fileInput" hidden accept=".xlsx,.xls,.csv" onchange="handleFile(this)">
        <button onclick="document.getElementById('fileInput').click()" class="btn-secondary">
          游닌 IMPORTAR PRECIOS
        </button>
        <button onclick="openModal()" class="btn-primary">+ NUEVO SKU</button>
      </div>
    </div>

    <input
      type="text"
      id="searchInput"
      class="search-input-admin"
      placeholder="Buscar insumo por nombre o c칩digo..."
      oninput="filterList()"
    >

    <div class="table-container" style="margin-top: 20px;">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left: 25px;">INSUMO / CATEGOR칈A</th>
            <th style="text-align:center; width: 100px;">UNIDAD</th>
            <th style="text-align:center; width: 120px;">STOCK IDEAL</th>
            <th style="width: 220px;">PROVEEDOR</th>
            <th style="text-align:right; width: 120px;">COSTO</th>
            <th style="width: 60px;"></th>
          </tr>
        </thead>
        <tbody id="skuList">
          <tr>
            <td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);">
              Cargando inventario...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="skuModal" class="modal-overlay">
    <div class="modal-box">
      <h3 class="section-title" style="font-size:20px; margin-bottom:25px;">Datos del Insumo</h3>
      <input type="hidden" id="skuId">

      <label class="input-label">NOMBRE DEL PRODUCTO</label>
      <input type="text" id="skuName" class="modal-input" placeholder="Ej: VODKA ABSOLUT">

      <div style="display:flex; gap:15px; margin-top:15px;">
        <div style="flex:1;">
          <label class="input-label">CATEGOR칈A</label>
          <select id="skuCat" class="modal-select">
            <option value="BEBIDAS">BEBIDAS</option>
            <option value="INSUMOS">INSUMOS BARRA</option>
            <option value="LIMPIEZA">LIMPIEZA</option>
            <option value="LIBRERIA">LIBRER칈A / OFICINA</option>
            <option value="MANTENIMIENTO">MANTENIMIENTO</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">FAMILIA / TIPO</label>
          <input type="text" id="skuFam" class="modal-input" placeholder="Ej: VODKA">
        </div>
      </div>

      <div style="display:flex; gap:15px; margin-top:15px;">
        <div style="flex:1;">
          <label class="input-label">UNIDAD</label>
          <select id="skuUnit" class="modal-select">
            <option value="UNIDAD">UNIDAD</option>
            <option value="LITRO">LITRO</option>
            <option value="KG">KG</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">VOLUMEN (ml)</label>
          <input type="number" id="skuVol" class="modal-input" value="0">
        </div>
      </div>

      <label class="input-label" style="margin-top:15px;">COSTO REFERENCIA ($)</label>
      <input type="number" id="skuCost" class="modal-input">

      <div class="modal-btns">
        <button onclick="closeModal()" class="btn-modal-cancel">Cancelar</button>
        <button onclick="saveSku()" class="btn-modal-save">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    /* L칍GICA DE SUPABASE INTACTA - MISMOS IDs */
    let allSkus = [];
    let allSupps = [];
    let stockBySku = new Map();

    window.addEventListener('DOMContentLoaded', () => { loadData(); });

    async function loadData() {
      try {
        const [skusRes, stockRes, suppsRes] = await Promise.all([
          client.from('inventory_skus').select('*').order('name'),
          client.from('inventory_stock').select('sku_id, stock_ideal, stock_current'),
          client.from('suppliers').select('id, name').eq('is_active', true).order('name')
        ]);

        if (skusRes.error) throw skusRes.error;
        if (stockRes.error) throw stockRes.error;
        if (suppsRes.error) throw suppsRes.error;

        stockBySku = new Map();
        (stockRes.data || []).forEach(row => { stockBySku.set(row.sku_id, row); });

        allSupps = suppsRes.data || [];
        allSkus = (skusRes.data || []).map(sku => ({
          ...sku,
          stock_ideal: stockBySku.get(sku.id)?.stock_ideal ?? null
        }));

        renderList(allSkus);
      } catch (err) {
        console.error('Error:', err);
        document.getElementById('skuList').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--state-error);">Error al cargar datos.</td></tr>';
      }
    }

    function renderList(list) {
      const tbody = document.getElementById('skuList');
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary);">Sin insumos cargados.</td></tr>';
        return;
      }

      tbody.innerHTML = list.map(i => {
        const suppOpts = '<option value="">-- Sin Asignar --</option>' + allSupps.map(s => `<option value="${s.id}" ${i.preferred_supplier_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
        let catClass = 'tag-gray';
        if (i.category === 'BEBIDAS') catClass = 'tag-red';
        if (i.category === 'LIMPIEZA') catClass = 'tag-green';
        const stockIdeal = i.stock_ideal ?? '';

        return `
          <tr>
            <td style="padding-left: 25px;">
              <div class="row-title">${i.name}</div>
              <div style="margin-top:6px;">
                <span class="tag ${catClass}">${i.category || 'GRAL'}</span>
                <span style="font-family:monospace; color:var(--text-muted); font-size:11px; margin-left:8px;">ID: ${i.external_id || '-'}</span>
              </div>
            </td>
            <td style="text-align:center;">
              <div style="color:var(--text-secondary); font-size:12px;">${i.unit_type || '-'}</div>
              ${i.volume_ml > 0 ? `<div style="color:var(--accent-blue); font-size:11px; font-weight:600;">${i.volume_ml} ml</div>` : ''}
            </td>
            <td>
              <input type="number" class="table-input" value="${stockIdeal}" onchange="updateField(${i.id}, 'stock_ideal', this.value)" placeholder="-">
            </td>
            <td>
              <select class="table-select" onchange="updateField(${i.id}, 'preferred_supplier_id', this.value)">${suppOpts}</select>
            </td>
            <td class="col-costo">${MC_UTILS.formatCurrency(i.cost_price)}</td>
            <td style="text-align:center;">
              <button onclick="editSku(${i.id})" class="btn-icon">九勇</button>
            </td>
          </tr>`;
      }).join('');
    }

    function filterList() {
      const t = document.getElementById('searchInput').value.toLowerCase();
      renderList(allSkus.filter(i => i.name.toLowerCase().includes(t) || (i.external_id && i.external_id.toLowerCase().includes(t))));
    }

    async function updateField(id, field, val) {
      if (field === 'stock_ideal') { await updateStockIdeal(id, val); return; }
      try { await client.from('inventory_skus').update({ [field]: val === '' ? null : val }).eq('id', id); } 
      catch (err) { alert('Error al guardar: ' + err.message); }
    }

    async function updateStockIdeal(skuId, rawVal) {
      const value = rawVal === '' ? null : parseFloat(rawVal);
      try {
        const existing = stockBySku.get(skuId);
        if (existing) {
          await client.from('inventory_stock').update({ stock_ideal: value }).eq('sku_id', skuId);
          existing.stock_ideal = value;
        } else {
          const { data } = await client.from('inventory_stock').insert({ sku_id: skuId, stock_current: 0, stock_ideal: value }).select().single();
          stockBySku.set(skuId, data);
        }
        const sku = allSkus.find(s => s.id === skuId);
        if (sku) sku.stock_ideal = value;
      } catch (err) { alert('Error al guardar stock ideal: ' + err.message); }
    }

    async function handleFile(input) {
      const file = input.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
          let headerRowIndex = -1;
          for (let i = 0; i < rawData.length; i++) {
            if (JSON.stringify(rawData[i]).includes('Articulo') && JSON.stringify(rawData[i]).includes('Precio')) { headerRowIndex = i; break; }
          }
          if (headerRowIndex === -1) throw new Error('Formato inv치lido.');
          const json = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex });
          let updated = 0;
          for (const row of json) {
            const codigo = row['Articulo'] ? String(row['Articulo']).trim() : null;
            const nombre = row['Detalle'] ? String(row['Detalle']).trim().toUpperCase() : null;
            const precio = row['Precio'] ? parseFloat(row['Precio']) : 0;
            if (nombre && codigo) {
               let unidad = 'UNIDAD';
               if ((row['U.Medida']||'').toUpperCase().includes('LITRO')) unidad = 'LITRO';
               if ((row['U.Medida']||'').toUpperCase().includes('KG')) unidad = 'KG';
               await client.from('inventory_skus').upsert({ name: nombre, cost_price: precio, unit_type: unidad, external_id: codigo, updated_at: new Date() }, { onConflict: 'external_id' });
               updated++;
            }
          }
          alert(`Importaci칩n completada. Items actualizados: ${updated}`);
          await loadData();
          input.value = '';
        } catch (err) { alert('Error: ' + err.message); }
      };
      reader.readAsArrayBuffer(file);
    }

    function openModal() { document.getElementById('skuModal').style.display = 'flex'; document.getElementById('skuId').value = ''; resetForm(); }
    function closeModal() { document.getElementById('skuModal').style.display = 'none'; }
    function resetForm() { document.getElementById('skuName').value = ''; document.getElementById('skuCost').value = ''; document.getElementById('skuFam').value = ''; document.getElementById('skuVol').value = '0'; }
    function editSku(id) {
      const s = allSkus.find(x => x.id === id); if (!s) return;
      document.getElementById('skuId').value = s.id;
      document.getElementById('skuName').value = s.name;
      document.getElementById('skuCat').value = s.category || 'BEBIDAS';
      document.getElementById('skuFam').value = s.family || '';
      document.getElementById('skuUnit').value = s.unit_type || 'UNIDAD';
      document.getElementById('skuVol').value = s.volume_ml || 0;
      document.getElementById('skuCost').value = s.cost_price || 0;
      document.getElementById('skuModal').style.display = 'flex';
    }
    async function saveSku() {
      const id = document.getElementById('skuId').value;
      const d = {
        name: document.getElementById('skuName').value.toUpperCase(),
        category: document.getElementById('skuCat').value,
        family: document.getElementById('skuFam').value.toUpperCase(),
        unit_type: document.getElementById('skuUnit').value,
        volume_ml: parseFloat(document.getElementById('skuVol').value) || 0,
        cost_price: parseFloat(document.getElementById('skuCost').value) || 0
      };
      if (!d.name) return alert('El nombre es obligatorio.');
      try {
        if (id) await client.from('inventory_skus').update(d).eq('id', id);
        else await client.from('inventory_skus').insert(d);
        closeModal(); await loadData();
      } catch (err) { alert('Error: ' + err.message); }
    }
  </script>
</body>
</html>