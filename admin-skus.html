<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midnight - Maestro SKUs</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>

  <style>
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        
        <div style="display:flex; align-items:center;">
          <button class="btn-back" type="button" onclick="window.location.href='panel-master.html'">
            VOLVER
          </button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Master Data</span>
        </div>

      </div>
    </div>
  </header>

  <main class="admin-container">
    
    <section class="section-header">
      <h1 class="section-title">MAESTRO DE INSUMOS</h1>
      <p class="section-desc">
        Gesti贸n de art铆culos, costos y asignaci贸n de proveedores.
      </p>
    </section>

    <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:space-between; margin-bottom:20px;">
      
      <div style="display:flex; gap:12px; align-items:center; flex:1; min-width: 280px;">
        <input
          id="searchSkus"
          class="search-input-admin"
          type="text"
          placeholder=" Buscar por nombre o c贸digo..."
        />
        <label class="input-label" style="margin:0; display:flex; align-items:center; gap:6px; white-space:nowrap; cursor:pointer;">
          <input type="checkbox" id="showInactive" /> Ver inactivos
        </label>
      </div>

      <div style="display:flex; gap:10px;">
        <input type="file" id="xlsxInput" accept=".xlsx,.xls" hidden />
        <button class="btn-secondary" type="button" id="importSkusBtn">
          IMPORTAR EXCEL
        </button>
        <button class="btn-primary" type="button" id="newSkuBtn">
          + NUEVO SKU
        </button>
      </div>
    </div>

    <nav class="tab-nav" id="categoryTabs">
      <button type="button" class="tab-btn active" data-cat="ALL">TODOS</button>
      <button type="button" class="tab-btn" data-cat="BEBIDAS">BEBIDAS</button>
      <button type="button" class="tab-btn" data-cat="INSUMOS_BARRA">INSUMOS BARRA</button>
      <button type="button" class="tab-btn" data-cat="LIMPIEZA">LIMPIEZA</button>
      <button type="button" class="tab-btn" data-cat="LIBRERIA">LIBRERA</button>
      <button type="button" class="tab-btn" data-cat="MANTENIMIENTO">MANTENIMIENTO</button>
      <button type="button" class="tab-btn" data-cat="OTROS">OTROS</button>
    </nav>

    <div id="skusStatus" class="section-desc" style="margin-bottom:10px; height:20px;"></div>

    <div class="table-container">
      <table class="sku-table" id="skuTable">
        <thead>
          <tr>
            <th style="padding-left:20px;">INSUMO</th>
            <th>FORMATO</th>
            <th class="text-center" style="width:100px;">STOCK IDEAL</th>
            <th>PROVEEDOR PREFERIDO</th>
            <th class="text-right">COSTO UN.</th>
            <th class="text-right">COSTO PACK</th>
            <th class="text-right" style="padding-right:20px;">ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="7" class="text-center text-muted" style="padding:40px;">Cargando inventario...</td></tr>
        </tbody>
      </table>
    </div>

  </main>

  <div class="modal-overlay" id="skuModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2 class="section-title" style="font-size:18px; margin:0;" id="modalTitle">NUEVO SKU</h2>
      </div>

      <form id="skuForm" onsubmit="event.preventDefault();">
        <input type="hidden" id="skuId" />
        <input type="hidden" id="skuFamily" />

        <div style="margin-bottom:16px;">
          <label class="input-label">NOMBRE DEL INSUMO</label>
          <input id="skuName" class="modal-input" type="text" placeholder="Ej: VODKA ABSOLUT 750ML" required />
        </div>

        <div style="display:flex; gap:12px; margin-bottom:12px;">
          <div style="flex:1;">
            <label class="input-label">CDIGO EXTERNO</label>
            <input id="skuCode" class="modal-input" type="text" placeholder="Ej: 7791234..." />
          </div>
          <div style="flex:1;">
            <label class="input-label">CATEGORA</label>
            <select id="skuCategory" class="modal-select" onchange="updateFormUI()">
              <option value="BEBIDAS">BEBIDAS</option>
              <option value="INSUMOS BARRA">INSUMOS BARRA</option>
              <option value="LIMPIEZA">LIMPIEZA</option>
              <option value="LIBRERIA">LIBRERA</option>
              <option value="MANTENIMIENTO">MANTENIMIENTO</option>
              <option value="OTROS">OTROS</option>
            </select>
          </div>
        </div>

        <div id="drinkFields" style="background:rgba(56, 189, 248, 0.05); padding:12px; border-radius:8px; border:1px dashed var(--accent-blue); margin-bottom:12px;">
            <div class="input-label" style="color:var(--accent-blue); margin-bottom:10px;">CONFIGURACIN DE BEBIDA</div>
            
            <div style="display:flex; gap:12px; margin-bottom:10px;">
                <div style="flex:1;">
                    <label class="input-label">UNIDAD BASE</label>
                    <select id="skuBaseUnit" class="modal-select">
                        <option value="BOTELLA">BOTELLA</option>
                        <option value="LATA">LATA</option>
                        <option value="UNIDAD">UNIDAD (Suelto)</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label class="input-label">PRESENTACIN DE COMPRA</label>
                    <select id="skuMode" class="modal-select" onchange="updateDrinkMode()">
                        <option value="UNITARIO">UNITARIO (Suelto)</option>
                        <option value="PACK">PACK / CAJA CERRADA</option>
                    </select>
                </div>
            </div>

            <div id="packConfig" style="display:flex; gap:12px;">
                <div style="flex:1;">
                    <label class="input-label">UNIDADES POR PACK</label>
                    <input id="skuPackSize" class="modal-input" type="number" min="2" placeholder="Ej: 6, 12, 24" />
                </div>
                <div style="flex:1; display:flex; align-items:center;">
                    <div style="font-size:11px; color:var(--text-secondary); line-height:1.3;">
                        Se ingresan <b>PACKS</b> en la compra, pero el stock se suma en <b>UNIDADES</b>.
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:12px; margin-bottom:12px;">
          <div style="flex:1;">
            <label class="input-label">VOLUMEN POR UNIDAD (ML)</label>
            <input id="skuVolume" class="modal-input" type="number" placeholder="Ej: 750" />
          </div>
          <div style="flex:1;">
            <label class="input-label">COSTO UNITARIO ($)</label>
            <input id="skuCost" class="modal-input" type="number" step="0.01" placeholder="0.00" />
          </div>
        </div>

        <div style="margin-bottom:12px;">
            <label class="input-label">PROVEEDOR PREFERIDO</label>
            <select id="skuPreferredSupplier" class="modal-select">
              <option value="">Sin asignar</option>
            </select>
        </div>

        <div style="margin-top:20px; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="skuIsActive" checked />
          <label for="skuIsActive" class="input-label" style="margin:0; cursor:pointer;">SKU Activo</label>
        </div>

        <div class="modal-btns">
          <button type="button" class="btn-secondary" onclick="closeSkuModal()">CANCELAR</button>
          <button type="button" class="btn-primary" onclick="handleSaveSku()">GUARDAR</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- ESTADO Y REFERENCIAS ---
    let allSkus = [];
    let allSuppliers = [];
    let stockBySku = new Map();
    let currentCategory = 'ALL';
    
    // UI Refs
    const tbody = document.querySelector('#skuTable tbody');
    const statusEl = document.getElementById('skusStatus');
    const searchInput = document.getElementById('searchSkus');
    const checkInactive = document.getElementById('showInactive');
    
    // Modal Refs
    const modal = document.getElementById('skuModal');
    const modalTitle = document.getElementById('modalTitle');
    const xlsxInput = document.getElementById('xlsxInput');

    // --- INICIALIZACIN ---
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setupEventListeners();
    });

    function setupEventListeners() {
      searchInput.addEventListener('input', renderTable);
      checkInactive.addEventListener('change', renderTable);

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentCategory = e.target.dataset.cat;
          renderTable();
        });
      });

      document.getElementById('newSkuBtn').addEventListener('click', () => openModal());
      document.getElementById('importSkusBtn').addEventListener('click', () => xlsxInput.click());
      xlsxInput.addEventListener('change', handleXlsxImport);
    }

    // --- CARGA DE DATOS ---
    async function loadData() {
      statusEl.textContent = 'Actualizando datos...';
      try {
        const [resSkus, resStock, resSupp] = await Promise.all([
          client.from('inventory_skus')
            .select('id, name, external_id, category, family, unit_type, volume_ml, cost_price, preferred_supplier_id, is_active, pack_size, unit_label, pack_cost')
            .order('name'),
          client.from('inventory_stock').select('sku_id, stock_ideal'),
          client.from('suppliers').select('id, name').eq('is_active', true).order('name')
        ]);

        if (resSkus.error) throw resSkus.error;
        
        allSkus = resSkus.data || [];
        allSuppliers = resSupp.data || [];
        
        stockBySku.clear();
        (resStock.data || []).forEach(row => {
          stockBySku.set(row.sku_id, row.stock_ideal);
        });

        populateSupplierSelect();
        renderTable();
        statusEl.textContent = '';

      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error de conexi贸n.';
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Error al cargar datos.</td></tr>`;
      }
    }

    function populateSupplierSelect() {
      const sel = document.getElementById('skuPreferredSupplier');
      sel.innerHTML = '<option value="">Sin asignar</option>';
      allSuppliers.forEach(s => {
        sel.innerHTML += `<option value="${s.id}">${escapeHtml(s.name)}</option>`;
      });
    }

    // --- LGICA DE UI (MODAL DINMICO) ---
    function updateFormUI() {
      const cat = document.getElementById('skuCategory').value;
      const drinkFields = document.getElementById('drinkFields');
      
      if (cat === 'BEBIDAS') {
        drinkFields.classList.remove('hidden');
        updateDrinkMode();
      } else {
        drinkFields.classList.add('hidden');
      }
    }

    function updateDrinkMode() {
      const mode = document.getElementById('skuMode').value;
      const packConfig = document.getElementById('packConfig');
      
      if (mode === 'PACK') {
        packConfig.classList.remove('hidden');
      } else {
        packConfig.classList.add('hidden');
        document.getElementById('skuPackSize').value = '';
      }
    }

    // --- RENDERIZADO ---
    function renderTable() {
      const term = searchInput.value.toLowerCase();
      const showOff = checkInactive.checked;

      const filtered = allSkus.filter(sku => {
        if (!showOff && !sku.is_active) return false;
        if (currentCategory !== 'ALL') {
          if (currentCategory === 'INSUMOS_BARRA') {
            if (!['INSUMOS BARRA', 'INSUMOS', 'DESCARTABLES'].includes(sku.category)) return false;
          } else if (currentCategory === 'OTROS') {
            if (['BEBIDAS','INSUMOS BARRA','LIMPIEZA','LIBRERIA','MANTENIMIENTO'].includes(sku.category)) return false;
          } else {
            if (sku.category !== currentCategory) return false;
          }
        }
        return sku.name.toLowerCase().includes(term) || (sku.external_id || '').toLowerCase().includes(term);
      });

      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted" style="padding:30px;">No hay resultados.</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(sku => {
        const stockIdeal = stockBySku.get(sku.id) || 0;
        const statusTag = !sku.is_active ? '<span class="tag tag-red tag-small">OFF</span>' : '';

        let mainLine = '';
        let subLine = '';

        if (sku.category === 'BEBIDAS') {
          const baseUnit = sku.unit_type || 'UNIDAD';
          const volDisplay = sku.volume_ml ? `${sku.volume_ml} ml` : '';

          if (sku.unit_label === 'PACK' && sku.pack_size && sku.pack_size > 1) {
            mainLine = `<span class="tag tag-blue">PACK x${sku.pack_size}</span>`;
            const parts = [];
            if (baseUnit) parts.push(baseUnit);
            if (volDisplay) parts.push(volDisplay);
            subLine = parts.join(' 路 ');
          } else {
            mainLine = baseUnit;
            subLine = volDisplay;
          }
        } else {
          mainLine = sku.unit_type || 'UNIDAD';
          subLine = '';
        }

        const volHtml = subLine ? `<div class="row-sub-text">${subLine}</div>` : '';

        const supplierOptions = allSuppliers.map(s => 
          `<option value="${s.id}" ${sku.preferred_supplier_id === s.id ? 'selected' : ''}>${escapeHtml(s.name)}</option>`
        ).join('');

        let packCostDisplay = '-';
        if (sku.unit_label === 'PACK' && sku.pack_size && sku.pack_size > 1) {
          let packCost = sku.pack_cost;
          if (packCost == null && sku.cost_price != null) {
            const size = Number(sku.pack_size);
            const cost = Number(sku.cost_price);
            if (!Number.isNaN(size) && !Number.isNaN(cost)) {
              packCost = size * cost;
            }
          }
          if (packCost != null) {
            packCostDisplay = MC_UTILS.formatCurrency(packCost);
          }
        }

        return `
          <tr>
            <td style="padding-left:20px;">
              <div class="row-title">${escapeHtml(sku.name)} ${statusTag}</div>
              <div class="row-sub-text">COD: ${sku.external_id || '-'}</div>
            </td>
            <td>
              <div style="font-size:12px; font-weight:600;">${mainLine}</div>
              ${volHtml}
            </td>
            <td class="text-center">
              <input type="number" class="table-input" value="${stockIdeal}" 
                onchange="updateInline(${sku.id}, 'stock_ideal', this.value)" 
                style="max-width:80px; font-weight:700;">
            </td>
            <td>
              <select class="table-input" style="text-align:left; width:100%; color:var(--text-secondary);"
                onchange="updateInline(${sku.id}, 'supplier', this.value)">
                <option value="">--</option>
                ${supplierOptions}
              </select>
            </td>
            <td class="col-costo text-right">${MC_UTILS.formatCurrency(sku.cost_price)}</td>
            <td class="col-costo text-right">${packCostDisplay}</td>
            <td class="text-right" style="padding-right:20px;">
              <button class="btn-icon" onclick="openModal(${sku.id})" title="Editar">锔</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // --- ACCIONES ---
    async function updateInline(id, field, value) {
      try {
        if (field === 'stock_ideal') {
          const num = parseFloat(value) || 0;
          const { error } = await client.from('inventory_stock').upsert(
            { sku_id: id, stock_ideal: num },
            { onConflict: 'sku_id', ignoreDuplicates: false }
          );
          if (error) throw error;
          stockBySku.set(id, num);
        } else if (field === 'supplier') {
          const suppId = value ? parseInt(value, 10) : null;
          const { error } = await client.from('inventory_skus').update({ preferred_supplier_id: suppId }).eq('id', id);
          if (error) throw error;
          const target = allSkus.find(s => s.id === id);
          if (target) target.preferred_supplier_id = suppId;
        }
      } catch (e) {
        console.error(e);
        alert("Error al guardar cambio.");
      }
    }

    function openModal(id = null) {
        const form = document.getElementById('skuForm');
        form.reset();
        
        if (id) {
            const sku = allSkus.find(s => s.id === id);
            document.getElementById('skuId').value = sku.id;
            document.getElementById('modalTitle').innerText = 'EDITAR SKU';
            
            document.getElementById('skuName').value = sku.name;
            document.getElementById('skuCode').value = sku.external_id || '';
            document.getElementById('skuCategory').value = sku.category || 'BEBIDAS';
            document.getElementById('skuFamily').value = sku.family || ''; 
            document.getElementById('skuPreferredSupplier').value = sku.preferred_supplier_id || '';
            document.getElementById('skuVolume').value = sku.volume_ml || '';
            document.getElementById('skuCost').value = sku.cost_price || '';
            document.getElementById('skuIsActive').checked = sku.is_active;

            if (sku.category === 'BEBIDAS') {
                document.getElementById('skuBaseUnit').value = sku.unit_type || 'BOTELLA';
                
                if (sku.unit_label === 'PACK' && sku.pack_size > 1) {
                    document.getElementById('skuMode').value = 'PACK';
                    document.getElementById('skuPackSize').value = sku.pack_size;
                } else {
                    document.getElementById('skuMode').value = 'UNITARIO';
                }
            }

        } else {
            document.getElementById('skuId').value = '';
            document.getElementById('modalTitle').innerText = 'NUEVO SKU';
            document.getElementById('skuCategory').value = 'BEBIDAS';
            document.getElementById('skuIsActive').checked = true;
            document.getElementById('skuBaseUnit').value = 'BOTELLA';
            document.getElementById('skuMode').value = 'UNITARIO';
        }
        
        modal.style.display = 'flex';
        updateFormUI();
    }

    function closeSkuModal() { modal.style.display = 'none'; }

    async function handleSaveSku() {
        const id = document.getElementById('skuId').value;
        const name = document.getElementById('skuName').value.trim().toUpperCase();
        const cat = document.getElementById('skuCategory').value;
        
        if (!name) return alert("El nombre es obligatorio");

        const rawSupplier = document.getElementById('skuPreferredSupplier').value;
        const preferredSupplierId = rawSupplier ? parseInt(rawSupplier, 10) : null;

        const volumeRaw = document.getElementById('skuVolume').value;
        const costRaw = document.getElementById('skuCost').value;

        const payload = {
            name: name,
            external_id: document.getElementById('skuCode').value.trim() || null,
            category: cat,
            family: document.getElementById('skuFamily').value || null,
            preferred_supplier_id: preferredSupplierId,
            volume_ml: volumeRaw ? parseFloat(volumeRaw) : null,
            cost_price: costRaw ? parseFloat(costRaw) : 0,
            is_active: document.getElementById('skuIsActive').checked,
            updated_at: new Date()
        };

        if (cat === 'BEBIDAS') {
            payload.unit_type = document.getElementById('skuBaseUnit').value;
            const mode = document.getElementById('skuMode').value;
            
            if (mode === 'PACK') {
                const packSizeRaw = document.getElementById('skuPackSize').value;
                const packSize = packSizeRaw ? parseInt(packSizeRaw, 10) : null;
                if (!packSize || packSize <= 1) return alert("Si es PACK, ingresa una cantidad mayor a 1.");
                
                payload.pack_size = packSize;
                payload.unit_label = 'PACK';
            } else {
                payload.pack_size = null;
                payload.unit_label = 'UNITARIO';
            }
        } else {
            payload.unit_type = 'UNIDAD';
            payload.pack_size = null;
            payload.unit_label = null;
        }

        const btn = document.querySelector('#skuForm .btn-primary');
        btn.disabled = true; btn.innerText = "GUARDANDO...";

        try {
            if (id) {
                const { error } = await client.from('inventory_skus').update(payload).eq('id', id);
                if (error) throw error;
            } else {
                const { error } = await client.from('inventory_skus').insert(payload);
                if (error) throw error;
            }
            
            closeSkuModal();
            loadData();
            
        } catch (e) {
            alert("Error al guardar: " + e.message);
        } finally {
            btn.disabled = false; btn.innerText = "GUARDAR";
        }
    }

    function handleXlsxImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
            try {
                const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                let count = 0;
                for (const row of json) {
                    const code = row['CODIGO'] || row['Articulo'];
                    const name = row['NOMBRE'] || row['Detalle'];
                    if (name) {
                        const pl = {
                            name: String(name).toUpperCase().trim(),
                            external_id: code ? String(code).trim() : null,
                            cost_price: row['COSTO'] || 0,
                            is_active: true
                        };
                        if (code) await client.from('inventory_skus').upsert(pl, { onConflict: 'external_id' });
                        else await client.from('inventory_skus').insert(pl);
                        count++;
                    }
                }
                alert(`Importaci贸n OK: ${count}`); loadData();
            } catch (err) { alert("Error: " + err.message); } finally { xlsxInput.value = ''; }
        };
        reader.readAsArrayBuffer(file);
    }

    function escapeHtml(text) {
      if (!text) return text;
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>
