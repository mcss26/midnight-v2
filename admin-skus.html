<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Master SKUs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@800;900&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>
  
  <style>
    .table-input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-family: monospace; font-size: 13px; }
    .table-input:focus { background: #111; outline: 1px solid var(--mc-accent-green); }
    .table-select { background: transparent; border: none; color: #aaa; width: 100%; font-size: 11px; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-accent-green);">DATA</span></div>
    <button onclick="window.location.href='panel-master.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div>
            <h2 class="section-title">Maestro de Insumos</h2>
            <p style="color:#666; font-size:12px;">Base de datos de art√≠culos y costos</p>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="file" id="fileInput" hidden accept=".xlsx,.xls,.csv" onchange="handleFile(this)">
            <button onclick="document.getElementById('fileInput').click()" class="btn-refresh" style="background:#222; border-color:#666;">üì• IMPORTAR COSTOS + ML</button>
            <button onclick="openModal()" class="btn-refresh">+ NUEVO SKU</button>
        </div>
    </div>

    <input type="text" id="searchInput" class="search-input-admin" placeholder="üîç Buscar insumo..." oninput="filterList()">

    <div class="table-responsive">
        <table class="sku-table">
            <thead>
                <tr>
                    <th>Nombre / Categor√≠a</th>
                    <th style="text-align:center; width: 100px;">Unidad</th>
                    <th style="text-align:center; width: 120px;">Stock Ideal</th>
                    <th>Proveedor</th>
                    <th style="text-align:right;">Costo (Precio)</th>
                    <th style="width: 50px;"></th>
                </tr>
            </thead>
            <tbody id="skuList"><tr><td colspan="6" style="text-align:center;">Cargando...</td></tr></tbody>
        </table>
    </div>
  </div>

  <div id="skuModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Datos del Insumo</h3>
        <input type="hidden" id="skuId">
        <label class="input-label">NOMBRE</label><input type="text" id="skuName" class="modal-input">
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label class="input-label">CATEGOR√çA</label><select id="skuCat" class="modal-select"><option value="BEBIDAS">BEBIDAS</option><option value="INSUMOS">INSUMOS</option><option value="LIMPIEZA">LIMPIEZA</option></select></div>
            <div style="flex:1;"><label class="input-label">FAMILIA</label><input type="text" id="skuFam" class="modal-input"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label class="input-label">UNIDAD</label><select id="skuUnit" class="modal-select"><option value="UNIDAD">UNIDAD</option><option value="LITRO">LITRO</option></select></div>
            <div style="flex:1;"><label class="input-label">VOLUMEN (ml)</label><input type="number" id="skuVol" class="modal-input" value="0"></div>
        </div>
        <label class="input-label">COSTO ($)</label><input type="number" id="skuCost" class="modal-input">
        <div class="modal-btns">
            <button onclick="closeModal()" class="btn-modal-cancel">CANCELAR</button>
            <button onclick="saveSku()" class="btn-modal-save">GUARDAR</button>
        </div>
    </div>
  </div>

  <script>
    let allSkus = [];
    let allSupps = [];

    window.onload = async () => { await loadData(); };

    async function loadData() {
        const [skusRes, suppsRes] = await Promise.all([
            client.from('inventory_skus').select('*').order('name'),
            client.from('suppliers').select('id, name').eq('is_active', true).order('name')
        ]);
        allSkus = skusRes.data || [];
        allSupps = suppsRes.data || [];
        renderList(allSkus);
    }

    function renderList(list) {
        const tbody = document.getElementById('skuList');
        if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Sin insumos.</td></tr>'; return; }

        tbody.innerHTML = list.map(i => {
            const suppOpts = `<option value="">-</option>` + allSupps.map(s => `<option value="${s.id}" ${i.preferred_supplier_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
            
            // Info Volumen
            let volInfo = '';
            if(i.volume_ml > 0) volInfo = `<br><span style="color:#00eaff;">${i.volume_ml} ml</span>`;

            return `
            <tr>
                <td><div style="font-weight:700; color:#fff;">${i.name}</div><div style="font-size:10px; color:#666;">${i.external_id ? 'ID: '+i.external_id : ''} ‚Ä¢ ${i.category||'-'}</div></td>
                <td style="text-align:center; font-size:11px; color:#888;">${i.unit_type}${volInfo}</td>
                <td><input type="number" class="table-input" value="${i.stock_ideal}" onchange="updateField(${i.id}, 'stock_ideal', this.value)" placeholder="0"></td>
                <td><select class="table-select" onchange="updateField(${i.id}, 'preferred_supplier_id', this.value)">${suppOpts}</select></td>
                <td class="col-costo">$ ${i.cost_price ? i.cost_price.toLocaleString() : '0'}</td>
                <td style="text-align:right;"><button onclick="editSku(${i.id})" style="border:none; background:none; cursor:pointer;">‚úèÔ∏è</button></td>
            </tr>`;
        }).join('');
    }

    function filterList() {
        const t = document.getElementById('searchInput').value.toLowerCase();
        renderList(allSkus.filter(i => i.name.toLowerCase().includes(t)));
    }

    async function updateField(id, field, val) {
        await client.from('inventory_skus').update({ [field]: val === "" ? null : val }).eq('id', id);
    }

    // === IMPORTADOR DEFINITIVO "COSTOS + ML" ===
    async function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                
                // 1. Buscar cabecera correcta
                let headerRowIndex = -1;
                for (let i = 0; i < rawData.length; i++) {
                    const rowStr = JSON.stringify(rawData[i]);
                    // Buscamos las columnas clave de tu archivo: Articulo, Detalle, Precio, Litros
                    if (rowStr.includes("Articulo") && rowStr.includes("Detalle") && rowStr.includes("Precio")) {
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headerRowIndex === -1) throw new Error("No se encontr√≥ cabecera v√°lida (Articulo, Detalle, Precio).");

                // 2. Procesar Datos
                const json = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex });
                let processed = 0, updated = 0;

                for (const row of json) {
                    const codigo = row['Articulo'] ? String(row['Articulo']).trim() : null;
                    const nombre = row['Detalle'] ? String(row['Detalle']).trim().toUpperCase() : null;
                    const precio = row['Precio'] ? parseFloat(row['Precio']) : 0;
                    
                    // C√°lculo de Volumen (Litros -> ML)
                    let litros = row['Litros'] ? parseFloat(row['Litros']) : 0;
                    let volume_ml = litros > 0 ? litros * 1000 : 0;

                    // Mapeo de Unidad
                    let unidad = 'UNIDAD'; // Default
                    const uMedida = row['U.Medida'] ? String(row['U.Medida']).toUpperCase() : '';
                    if(uMedida.includes('LITRO')) unidad = 'LITRO';
                    if(uMedida.includes('KG')) unidad = 'KG';

                    if (nombre && codigo) {
                        processed++;
                        
                        const payload = {
                            name: nombre,
                            cost_price: precio,
                            volume_ml: volume_ml,
                            unit_type: unidad,
                            updated_at: new Date(),
                            is_active: true
                        };
                        
                        // Upsert
                        const { error } = await client.from('inventory_skus')
                            .upsert({ ...payload, external_id: codigo }, { onConflict: 'external_id' });
                            
                        if (!error) updated++;
                    }
                }

                await client.from('admin_logs').insert({
                    admin_id: (await MC_UTILS.getCurrentUser())?.id,
                    action: 'IMPORT_SKU',
                    details: `Carga Masiva: ${updated} items actualizados.`
                });

                alert(`Importaci√≥n Exitosa.\nLe√≠dos: ${processed}\nActualizados: ${updated}`);
                loadData(); 
                input.value = '';

            } catch (err) {
                console.error(err);
                alert("Error importando: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Modal Logic
    function openModal() { document.getElementById('skuModal').style.display='flex'; document.getElementById('skuId').value=''; resetForm(); }
    function closeModal() { document.getElementById('skuModal').style.display='none'; }
    function resetForm() { document.getElementById('skuName').value=''; document.getElementById('skuCost').value=''; }
    
    function editSku(id) {
        const s = allSkus.find(x=>x.id===id);
        document.getElementById('skuId').value=s.id;
        document.getElementById('skuName').value=s.name;
        document.getElementById('skuCat').value=s.category;
        document.getElementById('skuFam').value=s.family;
        document.getElementById('skuUnit').value=s.unit_type;
        document.getElementById('skuVol').value=s.volume_ml;
        document.getElementById('skuCost').value=s.cost_price;
        document.getElementById('skuModal').style.display='flex';
    }

    async function saveSku() {
        const id = document.getElementById('skuId').value;
        const d = {
            name: document.getElementById('skuName').value.toUpperCase(),
            category: document.getElementById('skuCat').value,
            family: document.getElementById('skuFam').value.toUpperCase(),
            unit_type: document.getElementById('skuUnit').value,
            volume_ml: parseFloat(document.getElementById('skuVol').value)||0,
            cost_price: parseFloat(document.getElementById('skuCost').value)||0
        };
        const { error } = id ? await client.from('inventory_skus').update(d).eq('id',id) : await client.from('inventory_skus').insert(d);
        if(error) alert(error.message); else { closeModal(); loadData(); }
    }
  </script>
</body>
</html>