<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Master SKUs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>
  
  <style>
    /* Inputs "Stealth" para la tabla */
    .table-input { 
        background: transparent; border: 1px solid transparent; color: var(--text-primary); 
        width: 100%; text-align: center; font-family: 'Inter', monospace; font-size: 13px; 
        padding: 6px; border-radius: 4px; transition: all 0.2s;
    }
    .table-input:focus { background: #000; border-color: var(--color-info); outline: none; }
    .table-input:hover { background: rgba(255,255,255,0.05); }
    
    .table-select {
        background: transparent; border: 1px solid transparent; color: var(--text-secondary); 
        width: 100%; font-size: 12px; padding: 6px; border-radius: 4px; cursor: pointer;
    }
    .table-select:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .table-select:focus { background: #000; border-color: var(--color-info); outline: none; color:#fff; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--color-success);">DATA</span></div>
    <button onclick="window.location.href='panel-master.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div>
            <h2 class="section-title">Maestro de Insumos</h2>
            <p class="section-desc">Base de datos de art칤culos, costos y stock ideal</p>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="file" id="fileInput" hidden accept=".xlsx,.xls,.csv" onchange="handleFile(this)">
            <button onclick="document.getElementById('fileInput').click()" class="btn-refresh">游늭 IMPORTAR PRECIOS</button>
            <button onclick="openModal()" class="btn-primary">+ NUEVO SKU</button>
        </div>
    </div>

    <input type="text" id="searchInput" class="search-input-admin" placeholder="游댌 Buscar insumo por nombre o c칩digo..." oninput="filterList()">

    <div class="table-container" style="margin-top: 20px;">
        <table class="sku-table">
            <thead>
                <tr>
                    <th style="padding-left: 25px;">INSUMO / CATEGOR칈A</th>
                    <th style="text-align:center; width: 100px;">UNIDAD</th>
                    <th style="text-align:center; width: 120px;">STOCK IDEAL</th>
                    <th style="width: 220px;">PROVEEDOR</th>
                    <th style="text-align:right; width: 120px;">COSTO</th>
                    <th style="width: 60px;"></th>
                </tr>
            </thead>
            <tbody id="skuList">
                <tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);">Cargando inventario...</td></tr>
            </tbody>
        </table>
    </div>
  </div>

  <div id="skuModal" class="modal-overlay">
    <div class="modal-box">
        <h3 class="section-title" style="font-size:20px; margin-bottom:25px;">Datos del Insumo</h3>
        <input type="hidden" id="skuId">
        
        <label class="input-label">NOMBRE DEL PRODUCTO</label>
        <input type="text" id="skuName" class="modal-input" placeholder="Ej: VODKA ABSOLUT">

        <div style="display:flex; gap:15px; margin-top:15px;">
            <div style="flex:1;">
                <label class="input-label">CATEGOR칈A</label>
                <select id="skuCat" class="modal-select">
                    <option value="BEBIDAS">BEBIDAS</option>
                    <option value="INSUMOS">INSUMOS BARRA</option>
                    <option value="LIMPIEZA">LIMPIEZA</option>
                    <option value="LIBRERIA">LIBRERIA / OFICINA</option>
                    <option value="MANTENIMIENTO">MANTENIMIENTO</option>
                </select>
            </div>
            <div style="flex:1;">
                <label class="input-label">FAMILIA / TIPO</label>
                <input type="text" id="skuFam" class="modal-input" placeholder="Ej: VODKA">
            </div>
        </div>

        <div style="display:flex; gap:15px; margin-top:15px;">
            <div style="flex:1;">
                <label class="input-label">UNIDAD</label>
                <select id="skuUnit" class="modal-select">
                    <option value="UNIDAD">UNIDAD</option>
                    <option value="LITRO">LITRO</option>
                    <option value="KG">KG</option>
                </select>
            </div>
            <div style="flex:1;">
                <label class="input-label">VOLUMEN (ml)</label>
                <input type="number" id="skuVol" class="modal-input" value="0">
            </div>
        </div>

        <label class="input-label">COSTO REFERENCIA ($)</label>
        <input type="number" id="skuCost" class="modal-input">

        <div class="modal-btns">
            <button onclick="closeModal()" class="btn-modal-cancel">Cancelar</button>
            <button onclick="saveSku()" class="btn-modal-save">Guardar</button>
        </div>
    </div>
  </div>

  <script>
    let allSkus = [];
    let allSupps = [];

    window.onload = async () => { await loadData(); };

    async function loadData() {
        const [skusRes, suppsRes] = await Promise.all([
            client.from('inventory_skus').select('*').order('name'),
            client.from('suppliers').select('id, name').eq('is_active', true).order('name')
        ]);
        allSkus = skusRes.data || [];
        allSupps = suppsRes.data || [];
        renderList(allSkus);
    }

    function renderList(list) {
        const tbody = document.getElementById('skuList');
        if (!list.length) { 
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary);">Sin insumos cargados.</td></tr>'; 
            return; 
        }

        tbody.innerHTML = list.map(i => {
            const suppOpts = `<option value="">-- Sin Asignar --</option>` + 
                allSupps.map(s => `<option value="${s.id}" ${i.preferred_supplier_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('');

            // Estilos Tags
            let catClass = 'tag-gray';
            if(i.category === 'BEBIDAS') catClass = 'tag-blue'; 
            if(i.category === 'LIMPIEZA') catClass = 'tag-outline';

            return `
            <tr>
                <td style="padding-left: 25px;">
                    <div style="font-weight:600; color:#fff; font-size:14px;">${i.name}</div>
                    <div style="margin-top:6px;">
                        <span class="tag ${catClass}">${i.category || 'GRAL'}</span>
                        <span style="font-family:monospace; color:var(--text-tertiary); font-size:11px; margin-left:8px;">ID: ${i.external_id || '-'}</span>
                    </div>
                </td>
                <td style="text-align:center;">
                    <div style="color:var(--text-secondary); font-size:12px;">${i.unit_type}</div>
                    ${i.volume_ml > 0 ? `<div style="color:var(--color-info); font-size:11px; font-weight:600;">${i.volume_ml} ml</div>` : ''}
                </td>
                <td>
                    <input type="number" class="table-input" value="${i.stock_ideal}" 
                           onchange="updateField(${i.id}, 'stock_ideal', this.value)" placeholder="-">
                </td>
                <td>
                    <select class="table-select" onchange="updateField(${i.id}, 'preferred_supplier_id', this.value)">
                        ${suppOpts}
                    </select>
                </td>
                <td class="col-costo">
                    ${MC_UTILS.formatCurrency(i.cost_price)}
                </td>
                <td style="text-align:center;">
                    <button onclick="editSku(${i.id})" class="btn-icon">九勇</button>
                </td>
            </tr>`;
        }).join('');
    }

    function filterList() {
        const t = document.getElementById('searchInput').value.toLowerCase();
        renderList(allSkus.filter(i => i.name.toLowerCase().includes(t) || (i.external_id && i.external_id.toLowerCase().includes(t))));
    }

    async function updateField(id, field, val) {
        await client.from('inventory_skus').update({ [field]: val === "" ? null : val }).eq('id', id);
    }

    // === IMPORTADOR INTELIGENTE (Formato "COSTOS + ML") ===
    async function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                
                // 1. Buscar cabecera
                let headerRowIndex = -1;
                for (let i = 0; i < rawData.length; i++) {
                    const rowStr = JSON.stringify(rawData[i]);
                    // Claves del archivo definitivo
                    if (rowStr.includes("Articulo") && rowStr.includes("Detalle") && rowStr.includes("Precio")) {
                        headerRowIndex = i; break;
                    }
                }

                if (headerRowIndex === -1) throw new Error("Formato inv치lido. Se busca: Articulo, Detalle, Precio.");

                // 2. Parsear
                const json = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex });
                let processed = 0, updated = 0;

                for (const row of json) {
                    const codigo = row['Articulo'] ? String(row['Articulo']).trim() : null;
                    const nombre = row['Detalle'] ? String(row['Detalle']).trim().toUpperCase() : null;
                    const precio = row['Precio'] ? parseFloat(row['Precio']) : 0;
                    
                    // Conversi칩n inteligente de Litros a ML
                    let litros = row['Litros'] ? parseFloat(row['Litros']) : 0;
                    let volume_ml = litros > 0 ? litros * 1000 : 0;

                    let unidad = 'UNIDAD';
                    const uMedida = row['U.Medida'] ? String(row['U.Medida']).toUpperCase() : '';
                    if(uMedida.includes('LITRO')) unidad = 'LITRO';
                    if(uMedida.includes('KG')) unidad = 'KG';

                    if (nombre && codigo) {
                        processed++;
                        const payload = {
                            name: nombre,
                            cost_price: precio,
                            volume_ml: volume_ml,
                            unit_type: unidad,
                            updated_at: new Date(),
                            is_active: true
                        };
                        
                        const { error } = await client.from('inventory_skus')
                            .upsert({ ...payload, external_id: codigo }, { onConflict: 'external_id' });
                            
                        if (!error) updated++;
                    }
                }

                await client.from('admin_logs').insert({
                    admin_id: (await MC_UTILS.getCurrentUser())?.id,
                    action: 'IMPORT_SKU',
                    details: `Excel Costos: ${updated} items actualizados.`
                });

                alert(`Importaci칩n completada.\nLe칤dos: ${processed}\nActualizados: ${updated}`);
                loadData(); 
                input.value = '';

            } catch (err) {
                console.error(err);
                alert("Error importando: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Modal Logic
    function openModal() { document.getElementById('skuModal').style.display='flex'; document.getElementById('skuId').value=''; resetForm(); }
    function closeModal() { document.getElementById('skuModal').style.display='none'; }
    function resetForm() { document.getElementById('skuName').value=''; document.getElementById('skuCost').value=''; }
    
    function editSku(id) {
        const s = allSkus.find(x=>x.id===id);
        document.getElementById('skuId').value=s.id;
        document.getElementById('skuName').value=s.name;
        document.getElementById('skuCat').value=s.category;
        document.getElementById('skuFam').value=s.family;
        document.getElementById('skuUnit').value=s.unit_type;
        document.getElementById('skuVol').value=s.volume_ml;
        document.getElementById('skuCost').value=s.cost_price;
        document.getElementById('skuModal').style.display='flex';
    }

    async function saveSku() {
        const id = document.getElementById('skuId').value;
        const d = {
            name: document.getElementById('skuName').value.toUpperCase(),
            category: document.getElementById('skuCat').value,
            family: document.getElementById('skuFam').value.toUpperCase(),
            unit_type: document.getElementById('skuUnit').value,
            volume_ml: parseFloat(document.getElementById('skuVol').value)||0,
            cost_price: parseFloat(document.getElementById('skuCost').value)||0
        };
        const { error } = id ? await client.from('inventory_skus').update(d).eq('id',id) : await client.from('inventory_skus').insert(d);
        if(error) alert(error.message); else { closeModal(); loadData(); }
    }
  </script>
  <script type="module" src="app-init.js"></script>
</body>
</html>