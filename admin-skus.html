<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Master SKUs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <style>
    .sku-table input, .sku-table select { background: transparent; border: none; color: #fff; width: 100%; text-align: center; }
    .sku-table input:focus, .sku-table select:focus { outline: 1px solid var(--mc-accent-green); background: #000; }
    .col-ideal { width: 80px; background: #111; border-radius: 4px; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-accent-green);">SKU</span></div>
    <button onclick="window.history.back()" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div><h2 class="section-title">Maestro de Insumos</h2><p class="dash-desc">Inventario base y Costos</p></div>
        <button onclick="openModal()" class="btn-refresh">+ NUEVO SKU</button>
    </div>

    <input type="text" id="searchInput" class="search-input-admin" placeholder="üîç Buscar insumo por nombre o categor√≠a..." oninput="filterList()">

    <div class="table-responsive">
        <table class="sku-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Categor√≠a</th>
                    <th>Unidad</th>
                    <th style="text-align:center;">Stock Ideal</th>
                    <th>Proveedor</th>
                    <th style="text-align:right;">Costo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="skuList"><tr><td colspan="7">Cargando...</td></tr></tbody>
        </table>
    </div>
  </div>

  <div id="skuModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Datos del Insumo</h3>
        <input type="hidden" id="skuId">
        <label class="input-label">Nombre</label><input type="text" id="skuName" class="modal-input">
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label class="input-label">Categor√≠a</label><input type="text" id="skuCat" class="modal-input" placeholder="Ej: VODKA"></div>
            <div style="flex:1;"><label class="input-label">Familia</label><input type="text" id="skuFam" class="modal-input" placeholder="Ej: BEBIDAS"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;"><label class="input-label">Unidad</label><select id="skuUnit" class="modal-select"><option value="UNIDAD">UNIDAD</option><option value="LITRO">LITRO</option><option value="KG">KG</option></select></div>
            <div style="flex:1;"><label class="input-label">Volumen (ml)</label><input type="number" id="skuVol" class="modal-input" value="0"></div>
        </div>
        <label class="input-label">Costo ($)</label><input type="number" id="skuCost" class="modal-input">
        <div class="modal-btns">
            <button onclick="closeModal()" class="btn-modal-cancel">CANCELAR</button>
            <button onclick="saveSku()" class="btn-modal-save">GUARDAR</button>
        </div>
    </div>
  </div>

  <script>
    let allSkus = [], allSupps = [];

    window.addEventListener('DOMContentLoaded', async () => {
        await loadData();
    });

    async function loadData() {
        const [skus, supps] = await Promise.all([
            client.from('inventory_skus').select('*').order('name'),
            client.from('suppliers').select('id, name').eq('is_active', true).order('name')
        ]);
        
        allSkus = skus.data || [];
        allSupps = supps.data || [];
        renderList(allSkus);
    }

    function renderList(list) {
        const tbody = document.getElementById('skuList');
        if(!list.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Sin resultados.</td></tr>'; return; }

        tbody.innerHTML = list.map(i => {
            const suppOpts = `<option value="">-</option>` + allSupps.map(s => `<option value="${s.id}" ${i.preferred_supplier_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('');
            
            return `
            <tr>
                <td style="font-weight:700; color:#fff;">${i.name}</td>
                <td><span style="font-size:10px; background:#222; padding:2px 6px; border-radius:4px;">${i.category || '-'}</span></td>
                <td style="font-size:11px; color:#666;">${i.unit_type} (${i.volume_ml}ml)</td>
                <td style="text-align:center;">
                    <input type="number" class="col-ideal" value="${i.stock_ideal}" onchange="quickUpdate(${i.id}, 'stock_ideal', this.value)">
                </td>
                <td>
                    <select style="color:#888; font-size:11px;" onchange="quickUpdate(${i.id}, 'preferred_supplier_id', this.value)">${suppOpts}</select>
                </td>
                <td class="col-costo">${MC_UTILS.formatCurrency(i.cost_price)}</td>
                <td style="text-align:right;">
                    <button onclick="editSku(${i.id})" style="background:none; border:none; cursor:pointer;">‚úèÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }

    function filterList() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        renderList(allSkus.filter(i => i.name.toLowerCase().includes(term) || (i.category && i.category.toLowerCase().includes(term))));
    }

    async function quickUpdate(id, field, val) {
        const payload = { [field]: val === "" ? null : val };
        const { error } = await client.from('inventory_skus').update(payload).eq('id', id);
        if(error) alert("Error actualizando: " + error.message);
    }

    // Modal Logic
    function openModal() { document.getElementById('skuModal').style.display='flex'; resetForm(); }
    function closeModal() { document.getElementById('skuModal').style.display='none'; }
    function resetForm() {
        document.getElementById('skuId').value = '';
        document.getElementById('skuName').value = '';
        document.getElementById('skuCat').value = '';
        document.getElementById('skuFam').value = '';
        document.getElementById('skuVol').value = '0';
        document.getElementById('skuCost').value = '';
    }

    function editSku(id) {
        const s = allSkus.find(x => x.id === id);
        document.getElementById('skuId').value = s.id;
        document.getElementById('skuName').value = s.name;
        document.getElementById('skuCat').value = s.category;
        document.getElementById('skuFam').value = s.family;
        document.getElementById('skuUnit').value = s.unit_type;
        document.getElementById('skuVol').value = s.volume_ml;
        document.getElementById('skuCost').value = s.cost_price;
        document.getElementById('skuModal').style.display = 'flex';
    }

    async function saveSku() {
        const id = document.getElementById('skuId').value;
        const data = {
            name: document.getElementById('skuName').value.toUpperCase(),
            category: document.getElementById('skuCat').value.toUpperCase(),
            family: document.getElementById('skuFam').value.toUpperCase(),
            unit_type: document.getElementById('skuUnit').value,
            volume_ml: parseFloat(document.getElementById('skuVol').value) || 0,
            cost_price: parseFloat(document.getElementById('skuCost').value) || 0
        };

        let error;
        if(id) {
            ({ error } = await client.from('inventory_skus').update(data).eq('id', id));
        } else {
            ({ error } = await client.from('inventory_skus').insert(data));
        }

        if(error) alert(error.message);
        else { closeModal(); loadData(); }
    }
  </script>
</body>
</html>