<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midnight - SKUs</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>
</head>
<body>
  <!-- HEADER MISMO LAYOUT QUE PROVEEDORES -->
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div class="admin-logo"></div>
        <div class="admin-header-right">
          <button class="btn-back" onclick="window.location.href='panel-master.html'">
            VOLVER
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <!-- TITULO + DESC IGUAL ESTILO -->
    <section class="section-header">
      <h1 class="section-title">INSUMOS / SKUs</h1>
      <p class="section-desc">
        Maestro de insumos: alta, edición, proveedor preferido y stock ideal por SKU.
      </p>
    </section>

    <!-- BARRA SUPERIOR: BUSCADOR + VER INACTIVOS + BOTONES -->
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <div style="display:flex; gap:8px; align-items:center;">
        <input
          id="searchSkus"
          class="search-input-admin"
          type="text"
          placeholder="Buscar por nombre o código externo..."
        />
        <label class="section-desc" style="margin:0; font-size:11px; display:flex; align-items:center; gap:4px;">
          <input type="checkbox" id="showInactiveSkus" style="margin:0;" />
          Ver inactivos
        </label>
      </div>

      <div style="display:flex; gap:12px; align-items:center;">
        <button class="btn-secondary" type="button" id="importSkusBtn">
          Importar lista precios
        </button>
        <button class="btn-primary" type="button" id="newSkuBtn">
          Nuevo SKU
        </button>
      </div>
    </div>

    <div id="skusStatus" class="section-desc"></div>

    <!-- TABLA PRINCIPAL -->
    <div class="table-container">
      <table class="sku-table" id="skuTable" aria-label="Listado de SKUs / insumos">
        <thead>
          <tr>
            <th>INSUMO</th>
            <th>UNIDAD / VOLUMEN</th>
            <th>STOCK IDEAL</th>
            <th>PROVEEDOR</th>
            <th class="text-right">COSTO</th>
            <th class="text-right">ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <!-- Se llena por JS -->
        </tbody>
      </table>
    </div>
  </main>

  <!-- MODAL SKU (MISMO ESTILO QUE PROVEEDORES) -->
  <div class="modal-overlay" id="skuModal">
    <div class="modal-box">
      <h2 class="section-title" style="font-size:18px; letter-spacing:0.14em; text-align:left;">
        SKU / INSUMO
      </h2>
      <p class="section-desc" id="skuModalSubtitle" style="text-align:left;">
        Crear o editar insumo de inventario.
      </p>

      <form id="skuForm">
        <input type="hidden" id="skuId" />

        <div class="mt-2">
          <label class="input-label" for="skuName">Nombre del insumo</label>
          <input id="skuName" class="modal-input" type="text" placeholder="Ej: VODKA ABSOLUT 750ML" required />
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuCode">Código externo</label>
          <input id="skuCode" class="modal-input" type="text" placeholder="Código en Gbol / proveedor" />
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuCategory">Categoría</label>
          <input id="skuCategory" class="modal-input" type="text" placeholder="Ej: BEBIDAS BLANCAS" />
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuFamily">Familia</label>
          <input id="skuFamily" class="modal-input" type="text" placeholder="Ej: BOTELLAS 750ML" />
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuUnit">Unidad</label>
          <select id="skuUnit" class="modal-select">
            <option value="UNIDAD">UNIDAD</option>
            <option value="LITRO">LITRO</option>
            <option value="KG">KG</option>
          </select>
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuVolume">Volumen (ml)</label>
          <input id="skuVolume" class="modal-input" type="number" placeholder="Ej: 750" />
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuCost">Costo unitario (ARS)</label>
          <input id="skuCost" class="modal-input" type="number" placeholder="Ej: 15000" />
        </div>

        <div class="mt-2">
          <label class="input-label" for="skuPreferredSupplier">Proveedor preferido</label>
          <select id="skuPreferredSupplier" class="modal-select">
            <option value="">Sin asignar</option>
          </select>
        </div>

        <div class="mt-2" style="display:flex; align-items:center; gap:8px;">
          <label class="section-desc" style="margin:0; font-size:11px; display:flex; align-items:center; gap:6px;">
            <input type="checkbox" id="skuIsActive" style="margin:0;" />
            SKU activo
          </label>
        </div>
      </form>

      <div class="modal-btns">
        <button type="button" class="btn-secondary" id="deleteSkuBtn" style="margin-right:auto; display:none;">
          Eliminar SKU
        </button>
        <button type="button" class="btn-secondary" id="cancelSkuBtn">
          Cancelar
        </button>
        <button type="button" class="btn-primary" id="saveSkuBtn">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- INPUT OCULTO PARA EXCEL -->
  <input
    type="file"
    id="xlsxInput"
    accept=".xlsx,.xls"
    style="display:none"
  />

  <script>
    const skuTableBody = document.querySelector('#skuTable tbody');
    const statusEl = document.getElementById('skusStatus');
    const searchInput = document.getElementById('searchSkus');
    const showInactiveCheckbox = document.getElementById('showInactiveSkus');
    const newSkuBtn = document.getElementById('newSkuBtn');
    const importSkusBtn = document.getElementById('importSkusBtn');
    const xlsxInput = document.getElementById('xlsxInput');

    const skuModal = document.getElementById('skuModal');
    const skuModalSubtitle = document.getElementById('skuModalSubtitle');
    const deleteSkuBtn = document.getElementById('deleteSkuBtn');
    const cancelSkuBtn = document.getElementById('cancelSkuBtn');
    const saveSkuBtn = document.getElementById('saveSkuBtn');

    const skuIdEl = document.getElementById('skuId');
    const skuNameEl = document.getElementById('skuName');
    const skuCodeEl = document.getElementById('skuCode');
    const skuCategoryEl = document.getElementById('skuCategory');
    const skuFamilyEl = document.getElementById('skuFamily');
    const skuUnitEl = document.getElementById('skuUnit');
    const skuVolumeEl = document.getElementById('skuVolume');
    const skuCostEl = document.getElementById('skuCost');
    const skuPreferredSupplierEl = document.getElementById('skuPreferredSupplier');
    const skuIsActiveEl = document.getElementById('skuIsActive');

    let allSkus = [];
    let allSuppliers = [];
    let stockBySku = new Map();
    let editingSkuId = null;

    document.addEventListener('DOMContentLoaded', () => {
      attachListeners();
      loadData();
    });

    function attachListeners() {
      newSkuBtn.addEventListener('click', openCreateModal);
      cancelSkuBtn.addEventListener('click', closeSkuModal);
      saveSkuBtn.addEventListener('click', handleSaveSku);
      deleteSkuBtn.addEventListener('click', () => {
        if (editingSkuId != null) confirmDeleteSku(editingSkuId);
      });

      searchInput.addEventListener('input', applyFiltersAndRender);
      showInactiveCheckbox.addEventListener('change', applyFiltersAndRender);

      importSkusBtn.addEventListener('click', () => xlsxInput && xlsxInput.click());
      xlsxInput.addEventListener('change', handleXlsxImport);

      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape' && skuModal.style.display === 'flex') {
          closeSkuModal();
        }
      });
    }

    // CARGA INICIAL
    async function loadData() {
      statusEl.textContent = 'Cargando SKUs e inventario...';
      try {
        const [skusRes, stockRes, suppsRes] = await Promise.all([
          client
            .from('inventory_skus')
            .select('id, external_id, name, family, category, unit_type, volume_ml, cost_price, preferred_supplier_id, is_active')
            .order('name', { ascending: true }),
          client
            .from('inventory_stock')
            .select('sku_id, stock_ideal, stock_current'),
          client
            .from('suppliers')
            .select('id, name, is_active')
            .order('name', { ascending: true })
        ]);

        if (skusRes.error) throw skusRes.error;
        if (stockRes.error) throw stockRes.error;
        if (suppsRes.error) throw suppsRes.error;

        allSkus = skusRes.data || [];
        allSuppliers = suppsRes.data || [];

        stockBySku = new Map();
        (stockRes.data || []).forEach(row => {
          stockBySku.set(row.sku_id, {
            stock_ideal: row.stock_ideal,
            stock_current: row.stock_current
          });
        });

        populateModalSuppliers();
        applyFiltersAndRender();
        statusEl.textContent = '';
      } catch (err) {
        console.error('Error al cargar SKUs', err);
        statusEl.textContent = 'Error al cargar SKUs. Revisar conexión con Supabase.';
      }
    }

    function populateModalSuppliers() {
      skuPreferredSupplierEl.innerHTML = '<option value="">Sin asignar</option>';
      allSuppliers
        .filter(s => s.is_active !== false)
        .forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.name;
          skuPreferredSupplierEl.appendChild(opt);
        });
    }

    function applyFiltersAndRender() {
      const term = (searchInput.value || '').toLowerCase().trim();
      const showInactive = showInactiveCheckbox.checked;

      const rows = allSkus.filter(sku => {
        if (!showInactive && sku.is_active === false) return false;
        if (!term) return true;

        const n = (sku.name || '').toLowerCase();
        const c = (sku.external_id || '').toLowerCase();
        return n.includes(term) || c.includes(term);
      });

      renderTable(rows);
      if (!rows.length) {
        statusEl.textContent = 'No se encontraron SKUs con los filtros actuales.';
      } else {
        statusEl.textContent = '';
      }
    }

    function renderTable(rows) {
      skuTableBody.innerHTML = '';

      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.style.textAlign = 'center';
        td.style.padding = '32px';
        td.style.color = 'var(--text-secondary)';
        td.textContent = 'No hay SKUs para mostrar.';
        tr.appendChild(td);
        skuTableBody.appendChild(tr);
        return;
      }

      rows.forEach(sku => {
        const tr = document.createElement('tr');

        const stock = stockBySku.get(sku.id) || {};
        const stockIdeal = stock.stock_ideal ?? '';

        // Columna INSUMO
        const tdInsumo = document.createElement('td');
        const inactiveTag = sku.is_active === false
          ? '<span class="tag tag-red" style="margin-left:6px;">INACTIVO</span>'
          : '';
        const subPieces = [];
        if (sku.external_id) subPieces.push('#' + escapeHtml(String(sku.external_id)));
        if (sku.category) subPieces.push(escapeHtml(sku.category));
        if (sku.family) subPieces.push(escapeHtml(sku.family));
        const subText = subPieces.join(' · ');

        tdInsumo.innerHTML = `
          <div class="row-title">
            ${escapeHtml(sku.name || '')}
            ${inactiveTag}
          </div>
          <div class="row-sub-text">
            ${subText || '&nbsp;'}
          </div>
        `;

        // Columna unidad / volumen
        const tdUnidad = document.createElement('td');
        tdUnidad.innerHTML = `
          <div>${escapeHtml(sku.unit_type || '-')}</div>
          <div class="row-sub-text">${sku.volume_ml ? sku.volume_ml + ' ml' : '&nbsp;'}</div>
        `;

        // Columna stock ideal (input)
        const tdStockIdeal = document.createElement('td');
        tdStockIdeal.innerHTML = `
          <input
            type="number"
            class="table-input"
            value="${stockIdeal}"
            placeholder="-"
            onchange="updateField(${sku.id}, 'stock_ideal', this.value)"
          />
        `;

        // Columna proveedor (select)
        const tdProv = document.createElement('td');
        const selectHtml = buildSupplierSelectHtml(sku.id, sku.preferred_supplier_id);
        tdProv.innerHTML = selectHtml;

        // Costo formateado
        const tdCosto = document.createElement('td');
        tdCosto.className = 'text-right';
        tdCosto.textContent = MC_UTILS.formatCurrency(sku.cost_price || 0);

        // Acciones (Editar + Eliminar)
        const tdAcciones = document.createElement('td');
        tdAcciones.className = 'text-right';

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'btn-secondary';
        editBtn.textContent = 'Editar';
        editBtn.style.marginRight = '6px';
        editBtn.addEventListener('click', () => openEditModal(sku.id));

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn-secondary';
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.style.borderColor = 'rgba(255, 10, 30, 0.7)';
        deleteBtn.style.color = '#FF0A1E';
        deleteBtn.addEventListener('click', () => confirmDeleteSku(sku.id));

        tdAcciones.appendChild(editBtn);
        tdAcciones.appendChild(deleteBtn);

        tr.append(tdInsumo, tdUnidad, tdStockIdeal, tdProv, tdCosto, tdAcciones);
        skuTableBody.appendChild(tr);
      });
    }

    function buildSupplierSelectHtml(skuId, selectedId) {
      const options = ['<option value="">Sin asignar</option>'];
      allSuppliers.forEach(s => {
        const selected = selectedId === s.id ? 'selected' : '';
        options.push(
          `<option value="${s.id}" ${selected}>${escapeHtml(s.name)}</option>`
        );
      });

      return `
        <select
          class="modal-select"
          onchange="updateField(${skuId}, 'preferred_supplier_id', this.value)"
        >
          ${options.join('')}
        </select>
      `;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;/g')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // UPDATE INLINE (STOCK IDEAL / PROVEEDOR)
    async function updateField(id, field, val) {
      try {
        if (field === 'stock_ideal') {
          await updateStockIdeal(id, val);
          return;
        }

        if (field === 'preferred_supplier_id') {
          const payload = {
            preferred_supplier_id: val === '' ? null : Number(val)
          };
          const { error } = await client
            .from('inventory_skus')
            .update(payload)
            .eq('id', id);
          if (error) throw error;
          return;
        }
      } catch (err) {
        console.error('Error actualizando campo', field, err);
        alert('Error al guardar: ' + err.message);
      }
    }

    async function updateStockIdeal(skuId, rawVal) {
      const value = rawVal === '' ? null : parseFloat(rawVal);
      if (rawVal !== '' && (isNaN(value) || value < 0)) {
        alert('Ingresá un número válido para stock ideal.');
        return;
      }

      try {
        const current = stockBySku.get(skuId);
        if (!current) {
          const { error } = await client
            .from('inventory_stock')
            .insert({
              sku_id: skuId,
              stock_ideal: value ?? 0,
              stock_current: 0
            });
          if (error) throw error;
        } else {
          const { error } = await client
            .from('inventory_stock')
            .update({ stock_ideal: value ?? 0 })
            .eq('sku_id', skuId);
          if (error) throw error;
        }

        await loadData();
      } catch (err) {
        console.error('Error actualizando stock ideal', err);
        alert('Error al guardar: ' + err.message);
      }
    }

    // MODAL: CREAR / EDITAR
    function openCreateModal() {
      editingSkuId = null;
      skuModalSubtitle.textContent = 'Crear nuevo SKU / insumo.';
      deleteSkuBtn.style.display = 'none';

      skuIdEl.value = '';
      skuNameEl.value = '';
      skuCodeEl.value = '';
      skuCategoryEl.value = '';
      skuFamilyEl.value = '';
      skuUnitEl.value = 'UNIDAD';
      skuVolumeEl.value = '';
      skuCostEl.value = '';
      skuPreferredSupplierEl.value = '';
      skuIsActiveEl.checked = true;

      openSkuModal();
    }

    function openEditModal(id) {
      const sku = allSkus.find(s => s.id === id);
      if (!sku) return;

      editingSkuId = id;
      skuModalSubtitle.textContent = 'Editar SKU existente.';
      deleteSkuBtn.style.display = 'inline-flex';

      skuIdEl.value = sku.id;
      skuNameEl.value = sku.name || '';
      skuCodeEl.value = sku.external_id || '';
      skuCategoryEl.value = sku.category || '';
      skuFamilyEl.value = sku.family || '';
      skuUnitEl.value = sku.unit_type || 'UNIDAD';
      skuVolumeEl.value = sku.volume_ml != null ? sku.volume_ml : '';
      skuCostEl.value = sku.cost_price != null ? sku.cost_price : '';
      skuPreferredSupplierEl.value = sku.preferred_supplier_id || '';
      skuIsActiveEl.checked = sku.is_active !== false;

      openSkuModal();
    }

    function openSkuModal() {
      skuModal.style.display = 'flex';
    }

    function closeSkuModal() {
      skuModal.style.display = 'none';
      editingSkuId = null;
    }

    // GUARDAR (INSERT / UPDATE)
    async function handleSaveSku() {
      const nameVal = skuNameEl.value.trim();
      if (!nameVal) {
        alert('El nombre del insumo es obligatorio.');
        return;
      }

      const payload = {
        name: nameVal,
        external_id: skuCodeEl.value.trim() || null,
        category: skuCategoryEl.value.trim() || null,
        family: skuFamilyEl.value.trim() || null,
        unit_type: skuUnitEl.value || 'UNIDAD',
        volume_ml: skuVolumeEl.value === '' ? null : Number(skuVolumeEl.value),
        cost_price: skuCostEl.value === '' ? null : Number(skuCostEl.value),
        preferred_supplier_id:
          skuPreferredSupplierEl.value === '' ? null : Number(skuPreferredSupplierEl.value),
        updated_at: new Date().toISOString(),
        is_active: !!skuIsActiveEl.checked
      };

      try {
        saveSkuBtn.disabled = true;
        saveSkuBtn.textContent = 'Guardando...';

        if (editingSkuId == null) {
          const { error } = await client.from('inventory_skus').insert(payload);
          if (error) throw error;
        } else {
          const { error } = await client
            .from('inventory_skus')
            .update(payload)
            .eq('id', editingSkuId);
          if (error) throw error;
        }

        closeSkuModal();
        await loadData();
      } catch (err) {
        console.error('Error al guardar SKU', err);
        alert('Error al guardar: ' + err.message);
      } finally {
        saveSkuBtn.disabled = false;
        saveSkuBtn.textContent = 'Guardar';
      }
    }

    // ELIMINAR (soft delete)
    async function confirmDeleteSku(id) {
      const sku = allSkus.find(s => s.id === id);
      const name = sku && sku.name ? `\n\n${sku.name}` : '';
      const ok = confirm(
        '¿Eliminar este SKU del maestro?' +
        name +
        '\n\nSe marcará como INACTIVO. Las recetas y movimientos históricos no se borran.'
      );
      if (!ok) return;

      try {
        const { error } = await client
          .from('inventory_skus')
          .update({
            is_active: false,
            updated_at: new Date().toISOString()
          })
          .eq('id', id);
        if (error) throw error;

        closeSkuModal();
        await loadData();
      } catch (err) {
        console.error('Error eliminando SKU', err);
        alert('Error al eliminar: ' + err.message);
      }
    }

    // IMPORT DESDE EXCEL
    function handleXlsxImport(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });

          let headerRowIndex = -1;
          for (let i = 0; i < rawData.length; i++) {
            const rowStr = JSON.stringify(rawData[i]);
            if (
              rowStr.includes('Articulo') &&
              rowStr.includes('Detalle') &&
              rowStr.includes('Precio')
            ) {
              headerRowIndex = i;
              break;
            }
          }

          if (headerRowIndex === -1) {
            throw new Error('Formato inválido. Se espera encabezado: Articulo, Detalle, Precio, etc.');
          }

          const json = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex });

          let processed = 0;
          let updated = 0;

          for (const row of json) {
            const codigo = row['Articulo'] ? String(row['Articulo']).trim() : null;
            const nombre = row['Detalle']
              ? String(row['Detalle']).trim().toUpperCase()
              : null;
            const precio = row['Precio'] ? parseFloat(row['Precio']) : 0;

            let litros = row['Litros'] ? parseFloat(row['Litros']) : 0;
            let volume_ml = litros > 0 ? litros * 1000 : 0;

            let unidad = 'UNIDAD';
            const uMedida = row['U.Medida']
              ? String(row['U.Medida']).toUpperCase()
              : '';
            if (uMedida.includes('LITRO')) unidad = 'LITRO';
            if (uMedida.includes('KG')) unidad = 'KG';

            if (nombre && codigo) {
              processed++;
              const payload = {
                name: nombre,
                cost_price: precio,
                volume_ml: volume_ml,
                unit_type: unidad,
                updated_at: new Date().toISOString(),
                is_active: true
              };

              const { error } = await client
                .from('inventory_skus')
                .upsert(
                  { ...payload, external_id: codigo },
                  { onConflict: 'external_id' }
                );

              if (!error) {
                updated++;
              }
            }
          }

          let userId = null;
          if (window.MC_UTILS && typeof MC_UTILS.getCurrentUser === 'function') {
            const u = await MC_UTILS.getCurrentUser();
            if (u && u.id) userId = u.id;
          }

          await client.from('admin_logs').insert({
            admin_id: userId,
            action: 'IMPORT_SKU',
            details: `Excel Costos: ${updated} items actualizados.`
          });

          alert(
            `Importación completada.\nLeídos: ${processed}\nActualizados/creados: ${updated}`
          );
          await loadData();
          xlsxInput.value = '';
        } catch (err) {
          console.error('Error importando SKUs', err);
          alert('Error importando: ' + err.message);
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
