<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight Admin â€” Master SKU</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .input-ideal { background:#000; border:1px solid #444; color:var(--mc-accent-green); width:60px; text-align:center; padding:5px; border-radius:4px; font-weight:700; }
    .supp-select { background:#111; border:none; color:#888; font-size:11px; max-width:120px; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-accent-green);">DATA</span></div>
    <button onclick="window.history.back()" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div><h2 class="section-title">Master SKUs</h2><p style="color:#666; font-size:12px;">Metas y Proveedores</p></div>
    </div>

    <input type="text" id="searchSku" class="search-input-admin" placeholder="ðŸ” Buscar..." oninput="filter()">
    <div class="table-responsive"><table class="sku-table"><tbody id="skuBody"></tbody></table></div>
  </div>

  <script>
    // CREDENCIALES V2
    const SUPABASE_URL = 'https://dlwewdlfuovxofetcmjv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsd2V3ZGxmdW92eG9mZXRjbWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3Mjc0OTAsImV4cCI6MjA4MDMwMzQ5MH0.8Ddesga7tiHQ-kPAXgJO1zEswXafk-M_F3qenWuHEgs';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let allSkus=[], allSupps=[];

    window.onload = async () => {
        const [k, s] = await Promise.all([
            client.from('inventory_skus').select('*').order('name'),
            client.from('suppliers').select('id,name').order('name')
        ]);
        allSkus = k.data||[]; allSupps = s.data||[];
        render(allSkus);
    };

    function render(list) {
        const h = `<thead><tr><th>Insumo</th><th>Stock Ideal</th><th>Proveedor Habitual</th><th>Costo</th></tr></thead>`;
        const b = list.map(i => {
            const suppOpts = `<option value="">- Asignar -</option>` + allSupps.map(s=>`<option value="${s.id}" ${i.preferred_supplier_id==s.id?'selected':''}>${s.name}</option>`).join('');
            return `<tr>
                <td><div style="font-weight:700; color:#fff;">${i.name}</div><div style="font-size:10px; color:#666;">${i.category||'-'}</div></td>
                <td style="text-align:center;"><input type="number" class="input-ideal" value="${i.stock_ideal||0}" onchange="upd(${i.id},'stock_ideal',this.value)"></td>
                <td><select class="supp-select" onchange="upd(${i.id},'preferred_supplier_id',this.value)">${suppOpts}</select></td>
                <td class="col-costo">$${i.cost_price}</td>
            </tr>`;
        }).join('');
        document.getElementById('skuBody').innerHTML = h + b;
    }

    async function upd(id, col, val) { await client.from('inventory_skus').update({[col]:val||null}).eq('id',id); }
    function filter() { render(allSkus.filter(i=>i.name.toLowerCase().includes(document.getElementById('searchSku').value.toLowerCase()))); }
  </script>
</body>
</html>