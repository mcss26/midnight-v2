<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Proveedores</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div class="admin-logo">MIDNIGHT<span class="logo-accent">MASTER</span></div>
        <div class="admin-header-right">
          <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <!-- HEADER + BUSCADOR + CTA -->
    <div class="section-header" style="align-items:flex-start; gap:14px; margin-bottom:16px;">
      <div>
        <h2 class="section-title">PROVEEDORES</h2>
        <p class="section-desc">
          Directorio fiscal y bancario para órdenes de compra y calendario de pagos.
        </p>
      </div>

      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end; width:100%; max-width:620px;">
        <input
          type="text"
          id="searchSupplier"
          class="search-input-admin"
          placeholder="Buscar por nombre comercial o razón social…"
          oninput="filterSuppliers()"
          style="flex:1; min-width:220px;"
        />
        <button class="btn-primary" onclick="openSupplierModal()">+ NUEVO PROVEEDOR</button>
      </div>
    </div>

    <!-- RESUMEN SUPERIOR -->
    <div id="supSummary" class="stock-summary" style="margin-top:0;">
      <!-- Se completa por JS -->
      <div class="stock-summary-label">RESUMEN</div>
      <div class="stock-summary-value">Sin proveedores cargados.</div>
    </div>

    <!-- TABLA PRINCIPAL -->
    <div class="table-container" style="margin-top:16px;">
      <table class="sku-table">
        <colgroup>
          <col style="width:26%;">
          <col style="width:28%;">
          <col style="width:32%;">
          <col style="width:9%;">
          <col style="width:5%;">
        </colgroup>
        <thead>
          <tr>
            <th style="padding-left:25px;">PROVEEDOR</th>
            <th>DATOS FISCALES</th>
            <th>DATOS DE PAGO</th>
            <th>ESTADO</th>
            <th style="text-align:center;">ACCIONES</th>
          </tr>
        </thead>
        <tbody id="suppliersList"></tbody>
      </table>
    </div>
  </main>

  <!-- MODAL PROVEEDOR -->
  <div id="supplierModal" class="modal-overlay">
    <div class="modal-box">
      <h3 class="section-title" style="font-size:20px; margin-bottom:16px;">Proveedor</h3>

      <input type="hidden" id="supId" />

      <label class="input-label">NOMBRE COMERCIAL</label>
      <input
        type="text"
        id="supName"
        class="modal-input"
        placeholder="Ej: DISTRIBUIDORA X"
      />

      <div style="display:flex; gap:15px; margin-top:12px;">
        <div style="flex:1;">
          <label class="input-label">RAZÓN SOCIAL</label>
          <input
            type="text"
            id="supLegalName"
            class="modal-input"
            placeholder="Ej: DISTRIBUIDORA X SRL"
          />
        </div>
        <div style="flex:1;">
          <label class="input-label">CUIT</label>
          <input
            type="text"
            id="supCuit"
            class="modal-input"
            placeholder="Ej: 30-00000000-0"
          />
        </div>
      </div>

      <div style="display:flex; gap:15px; margin-top:12px;">
        <div style="flex:1;">
          <label class="input-label">CATEGORÍA</label>
          <select id="supCat" class="modal-select">
            <option value="BEBIDAS">BEBIDAS</option>
            <option value="ALIMENTOS">ALIMENTOS</option>
            <option value="DESCARTABLES">DESCARTABLES</option>
            <option value="SERVICIOS">SERVICIOS</option>
            <option value="VARIOS">VARIOS</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">CENTRO DE COSTO</label>
          <input
            type="text"
            id="supCostCenter"
            class="modal-input"
            placeholder="Ej: BARRA / SERVICIOS"
          />
        </div>
      </div>

      <div style="display:flex; gap:15px; margin-top:12px;">
        <div style="flex:1;">
          <label class="input-label">COND. FACTURACIÓN</label>
          <input
            type="text"
            id="supBilling"
            class="modal-input"
            placeholder="Ej: Factura A / B / Monotributo"
          />
        </div>
        <div style="flex:1;">
          <label class="input-label">COND. DE PAGO</label>
          <input
            type="text"
            id="supPaymentTerms"
            class="modal-input"
            placeholder="Ej: Contado / 7 días / 30 días"
          />
        </div>
      </div>

      <label class="input-label" style="margin-top:12px;">CONTACTO</label>
      <textarea
        id="supContact"
        class="modal-input"
        style="height:70px;"
        placeholder="Teléfono, mail, contacto comercial…"
      ></textarea>

      <div style="margin-top:14px;">
        <label class="input-label">DATOS BANCARIOS</label>
        <div style="display:flex; gap:10px; margin-top:4px;">
          <input
            type="text"
            id="supBankName"
            class="modal-input"
            placeholder="Banco / Fintech"
            style="flex:1;"
          />
          <input
            type="text"
            id="supBankAlias"
            class="modal-input"
            placeholder="Alias"
            style="flex:1;"
          />
          <input
            type="text"
            id="supBankCbu"
            class="modal-input"
            placeholder="CBU"
            style="flex:1;"
          />
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:14px;">
        <label class="input-label" style="margin:0;">ESTADO</label>
        <label style="font-size:12px; color:var(--text-secondary); display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="supIsActive" checked />
          ACTIVO
        </label>
      </div>

      <div class="modal-btns">
        <button onclick="closeSupplierModal()" class="btn-modal-cancel">CANCELAR</button>
        <button onclick="saveSupplier()" class="btn-modal-save">GUARDAR</button>
      </div>
    </div>
  </div>

  <script>
    let suppliers = [];

    document.addEventListener('DOMContentLoaded', loadSuppliers);

    async function loadSuppliers() {
      const tb = document.getElementById('suppliersList');

      try {
        const { data, error } = await client
          .from('suppliers')
          .select('*')
          .order('name', { ascending: true });

        if (error) {
          console.error('Error cargando proveedores:', error);
          suppliers = [];
          tb.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--state-error);">Error al cargar proveedores.</td></tr>';
          updateSuppliersSummary();
          return;
        }

        suppliers = data || [];
        updateSuppliersSummary();
        renderSuppliers(suppliers);
      } catch (err) {
        console.error('Error inesperado cargando proveedores:', err);
        suppliers = [];
        tb.innerHTML =
          '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--state-error);">Error al cargar proveedores.</td></tr>';
        updateSuppliersSummary();
      }
    }

    function updateSuppliersSummary() {
      const box = document.getElementById('supSummary');
      if (!box) return;

      const total = suppliers.length;
      const active = suppliers.filter(s => s.is_active !== false).length;
      const inactive = total - active;

      if (!total) {
        box.innerHTML = `
          <div class="stock-summary-label">RESUMEN</div>
          <div class="stock-summary-value">Sin proveedores cargados.</div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="stock-summary-label">RESUMEN</div>
        <div class="stock-summary-value">
          ${total} proveedor${total !== 1 ? 'es' : ''} ·
          ${active} activo${active !== 1 ? 's' : ''} ·
          ${inactive} inactivo${inactive !== 1 ? 's' : ''}
        </div>
      `;
    }

    function renderSuppliers(list) {
      const tb = document.getElementById('suppliersList');

      if (!list.length) {
        tb.innerHTML =
          '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-secondary);">Sin proveedores para los filtros actuales.</td></tr>';
        return;
      }

      tb.innerHTML = list
        .map((s) => {
          const provName = s.name || 'SIN NOMBRE';
          const legal = s.legal_name || '-';
          const cuit = s.cuit || '-';
          const cat = s.category || 'VARIOS';

          const bankLine = [
            s.bank_name || '',
            s.bank_account_alias || '',
            s.bank_account_cbu || ''
          ]
            .filter(Boolean)
            .join(' / ') || '-';

          const billing = s.billing_condition || '-';
          const payTerms = s.payment_terms || '-';

          const estadoLabel = s.is_active ? 'ACTIVO' : 'INACTIVO';
          const estadoClass = s.is_active ? 'tag-green' : 'tag-red';

          const contactLine = s.contact_info ? `<div class="row-sub-text">${s.contact_info}</div>` : '';

          let fiscalExtra = '';
          if (billing !== '-' || payTerms !== '-') {
            const parts = [];
            if (billing !== '-') parts.push(`Facturación: ${billing}`);
            if (payTerms !== '-') parts.push(`Pago: ${payTerms}`);
            fiscalExtra = `<div class="row-sub-text">${parts.join(' · ')}</div>`;
          }

          return `
            <tr>
              <td style="padding-left:25px;">
                <div class="row-title">${provName}</div>
                <div class="row-sub-text">
                  <span class="tag tag-gray">${cat}</span>
                  ${s.cost_center ? `<span style="margin-left:6px;">CC: ${s.cost_center}</span>` : ''}
                </div>
                ${contactLine}
              </td>
              <td>
                <div class="row-title">${legal}</div>
                <div class="row-sub-text">
                  CUIT:
                  <span style="font-variant-numeric:tabular-nums;">${cuit}</span>
                </div>
                ${fiscalExtra || '<div class="row-sub-text">—</div>'}
              </td>
              <td>
                <div class="row-sub-text">${bankLine}</div>
              </td>
              <td>
                <span class="tag ${estadoClass}">${estadoLabel}</span>
              </td>
              <td style="text-align:center;">
                <button class="btn-icon" onclick="openSupplierModal(${s.id})">✏️</button>
              </td>
            </tr>
          `;
        })
        .join('');
    }

    function filterSuppliers() {
      const term = document
        .getElementById('searchSupplier')
        .value.toLowerCase();

      const filtered = suppliers.filter((s) => {
        const name = (s.name || '').toLowerCase();
        const legal = (s.legal_name || '').toLowerCase();
        return name.includes(term) || legal.includes(term);
      });

      renderSuppliers(filtered);
    }

    function openSupplierModal(id) {
      const m = document.getElementById('supplierModal');
      m.style.display = 'flex';

      if (id) {
        const s = suppliers.find((x) => x.id === id);
        if (!s) return;

        document.getElementById('supId').value = s.id;
        document.getElementById('supName').value = s.name || '';
        document.getElementById('supLegalName').value = s.legal_name || '';
        document.getElementById('supCuit').value = s.cuit || '';
        document.getElementById('supCat').value = s.category || 'VARIOS';
        document.getElementById('supCostCenter').value = s.cost_center || '';
        document.getElementById('supBilling').value = s.billing_condition || '';
        document.getElementById('supPaymentTerms').value = s.payment_terms || '';
        document.getElementById('supContact').value = s.contact_info || '';
        document.getElementById('supBankName').value = s.bank_name || '';
        document.getElementById('supBankAlias').value = s.bank_account_alias || '';
        document.getElementById('supBankCbu').value = s.bank_account_cbu || '';
        document.getElementById('supIsActive').checked = s.is_active !== false;
      } else {
        document.getElementById('supId').value = '';
        document.getElementById('supName').value = '';
        document.getElementById('supLegalName').value = '';
        document.getElementById('supCuit').value = '';
        document.getElementById('supCat').value = 'BEBIDAS';
        document.getElementById('supCostCenter').value = '';
        document.getElementById('supBilling').value = '';
        document.getElementById('supPaymentTerms').value = '';
        document.getElementById('supContact').value = '';
        document.getElementById('supBankName').value = '';
        document.getElementById('supBankAlias').value = '';
        document.getElementById('supBankCbu').value = '';
        document.getElementById('supIsActive').checked = true;
      }
    }

    function closeSupplierModal() {
      document.getElementById('supplierModal').style.display = 'none';
    }

    async function saveSupplier() {
      const id = document.getElementById('supId').value;
      const name = document.getElementById('supName').value.trim();

      if (!name) {
        alert('El nombre comercial es obligatorio.');
        return;
      }

      const payload = {
        name,
        legal_name: document.getElementById('supLegalName').value.trim() || null,
        cuit: document.getElementById('supCuit').value.trim() || null,
        category: document.getElementById('supCat').value || 'VARIOS',
        cost_center: document.getElementById('supCostCenter').value.trim() || null,
        billing_condition: document.getElementById('supBilling').value.trim() || null,
        payment_terms: document.getElementById('supPaymentTerms').value.trim() || null,
        contact_info: document.getElementById('supContact').value.trim() || null,
        bank_name: document.getElementById('supBankName').value.trim() || null,
        bank_account_alias: document.getElementById('supBankAlias').value.trim() || null,
        bank_account_cbu: document.getElementById('supBankCbu').value.trim() || null,
        is_active: document.getElementById('supIsActive').checked
      };

      try {
        if (id) {
          const { error } = await client
            .from('suppliers')
            .update(payload)
            .eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await client
            .from('suppliers')
            .insert(payload);
          if (error) throw error;
        }

        closeSupplierModal();
        await loadSuppliers();
      } catch (err) {
        console.error('Error guardando proveedor:', err);
        alert('No se pudo guardar el proveedor. Revisa los datos.');
      }
    }
  </script>
</body>
</html>
