<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Proveedores</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">AGENDA</span></div>
    <div class="admin-header-right">
        <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">Proveedores</h2>
        <p class="section-desc">Directorio comercial y condiciones de pago.</p>
      </div>
      <button class="btn-primary" onclick="openSupplierModal()">+ NUEVO PROVEEDOR</button>
    </div>

    <input
      type="text"
      id="searchSupplier"
      class="search-input-admin"
      placeholder="Buscar por nombre, categoría o centro de costo..."
      oninput="filterSuppliers()"
    >

    <div class="table-container" style="margin-top: 18px;">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left:25px;">PROVEEDOR / CATEGORÍA</th>
            <th style="width:140px;">CENTRO DE COSTO</th>
            <th style="width:130px;">FACTURACIÓN</th>
            <th>CONDICIONES DE PAGO</th>
            <th style="width:110px;">ESTADO</th>
            <th style="width:60px;"></th>
          </tr>
        </thead>
        <tbody id="suppliersList">
          <tr>
            <td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary);">
              Cargando proveedores...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="supplierModal" class="modal-overlay">
    <div class="modal-box">
      <h3 class="section-title" style="font-size:20px; margin-bottom:14px;">Datos del Proveedor</h3>
      <input type="hidden" id="supId">

      <label class="input-label">NOMBRE</label>
      <input type="text" id="supName" class="modal-input" placeholder="Ej: DISTRIBUIDORA LOS AMIGOS">

      <div style="display:flex; gap:15px; margin-top:15px;">
        <div style="flex:1;">
          <label class="input-label">CATEGORÍA</label>
          <select id="supCat" class="modal-select">
            <option value="">Seleccionar...</option>
            <option value="BEBIDAS">BEBIDAS</option>
            <option value="ALIMENTOS">ALIMENTOS</option>
            <option value="SERVICIOS">SERVICIOS</option>
            <option value="VARIOS">VARIOS</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">CENTRO DE COSTO</label>
          <input type="text" id="supCostCenter" class="modal-input" placeholder="Ej: BARRA">
        </div>
      </div>

      <div style="display:flex; gap:15px; margin-top:15px;">
        <div style="flex:1;">
          <label class="input-label">FACTURACIÓN</label>
          <select id="supBilling" class="modal-select">
            <option value="">Seleccionar...</option>
            <option value="FACTURA_A">Factura A</option>
            <option value="FACTURA_C">Factura C</option>
            <option value="MONOTRIBUTO">Monotributo</option>
            <option value="SIN_FACTURA">Sin Factura</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">CUIT / TAX ID</label>
          <input type="text" id="supCuit" class="modal-input" placeholder="CUIT / DNI">
        </div>
      </div>

      <label class="input-label" style="margin-top:15px;">CONDICIONES DE PAGO</label>
      <input type="text" id="supTerms" class="modal-input" placeholder="Ej: 7 días, contra entrega...">

      <label class="input-label" style="margin-top:15px;">CONTACTO</label>
      <textarea id="supContact" class="modal-input" style="min-height:70px; resize:vertical;" placeholder="Teléfono, mail..."></textarea>

      <div style="margin-top:15px;">
        <label style="font-size:12px; color:var(--text-secondary); display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="supActive" checked>
          Proveedor activo
        </label>
      </div>

      <div class="modal-btns">
        <button onclick="closeSupplierModal()" class="btn-modal-cancel">Cancelar</button>
        <button onclick="saveSupplier()" class="btn-modal-save">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    let suppliers = [];
    document.addEventListener('DOMContentLoaded', () => { loadSuppliers(); });

    async function loadSuppliers() {
      try {
        const { data, error } = await client.from('suppliers').select('*').order('name');
        if (error) throw error;
        suppliers = data || [];
        renderSuppliers(suppliers);
      } catch (err) {
        document.getElementById('suppliersList').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--state-error);">Error al cargar.</td></tr>';
      }
    }

    function renderSuppliers(list) {
      const tbody = document.getElementById('suppliersList');
      if (!list.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary);">Sin proveedores.</td></tr>'; return; }
      
      tbody.innerHTML = list.map(s => {
        const active = s.is_active !== false;
        return `
          <tr>
            <td style="padding-left:25px;">
              <div class="row-title">${s.name}</div>
              <div class="row-sub-text"><span class="tag tag-gray">${s.category || 'VARIOS'}</span></div>
            </td>
            <td>${s.cost_center || '-'}</td>
            <td>${s.billing_condition || '-'}</td>
            <td>${s.payment_terms || '-'}</td>
            <td><span class="tag ${active ? 'tag-green' : 'tag-gray'}">${active ? 'ACTIVO' : 'PAUSADO'}</span></td>
            <td style="text-align:center;"><button class="btn-icon" onclick="openSupplierModal(${s.id})">✏️</button></td>
          </tr>`;
      }).join('');
    }

    function filterSuppliers() {
      const t = document.getElementById('searchSupplier').value.toLowerCase();
      renderSuppliers(suppliers.filter(s => s.name.toLowerCase().includes(t) || (s.category||'').toLowerCase().includes(t)));
    }

    function openSupplierModal(id) {
      const modal = document.getElementById('supplierModal');
      if (id) {
        const s = suppliers.find(x => x.id === id); if (!s) return;
        document.getElementById('supId').value = s.id;
        document.getElementById('supName').value = s.name;
        document.getElementById('supCat').value = s.category || '';
        document.getElementById('supCostCenter').value = s.cost_center || '';
        document.getElementById('supBilling').value = s.billing_condition || '';
        document.getElementById('supCuit').value = s.tax_id || '';
        document.getElementById('supTerms').value = s.payment_terms || '';
        document.getElementById('supContact').value = s.contact_info || '';
        document.getElementById('supActive').checked = s.is_active !== false;
      } else {
        document.getElementById('supId').value = '';
        document.getElementById('supName').value = '';
        document.getElementById('supCat').value = '';
        document.getElementById('supCostCenter').value = '';
        document.getElementById('supBilling').value = '';
        document.getElementById('supCuit').value = '';
        document.getElementById('supTerms').value = '';
        document.getElementById('supContact').value = '';
        document.getElementById('supActive').checked = true;
      }
      modal.style.display = 'flex';
    }
    function closeSupplierModal() { document.getElementById('supplierModal').style.display = 'none'; }

    async function saveSupplier() {
      const id = document.getElementById('supId').value;
      const payload = {
        name: document.getElementById('supName').value.trim(),
        category: document.getElementById('supCat').value || null,
        cost_center: document.getElementById('supCostCenter').value || null,
        billing_condition: document.getElementById('supBilling').value || null,
        tax_id: document.getElementById('supCuit').value || null,
        payment_terms: document.getElementById('supTerms').value || null,
        contact_info: document.getElementById('supContact').value || null,
        is_active: document.getElementById('supActive').checked
      };
      if (!payload.name) return alert('Nombre obligatorio.');
      try {
        if (id) await client.from('suppliers').update(payload).eq('id', id);
        else await client.from('suppliers').insert(payload);
        closeSupplierModal(); await loadSuppliers();
      } catch (err) { alert('Error: ' + err.message); }
    }
  </script>
</body>
</html>