<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Pedidos y Merma</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    /* Tabs Navegaci√≥n */
    .tab-nav { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--border-light); padding-bottom: 0; }
    .tab-btn { 
        background: none; border: none; color: var(--txt-secondary); padding: 15px 10px; 
        font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; 
        border-bottom: 3px solid transparent; transition: 0.2s;
    }
    .tab-btn.active { color: var(--txt-primary); border-bottom-color: var(--accent-blue); }

    /* Tarjeta de Merma */
    .merma-card {
        background: var(--bg-card); border: 1px solid var(--border-light); border-radius: var(--radius);
        padding: 30px; margin-bottom: 30px;
    }

    /* Pedidos Staff */
    .pedido-item {
        background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.2); 
        border-left: 4px solid var(--accent-blue);
        border-radius: 8px; padding: 15px; margin-bottom: 10px;
        display: flex; justify-content: space-between; align-items: flex-start;
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div class="admin-logo" aria-hidden="true"></div>
        <div class="admin-header-right">
          <button onclick="window.location.href='encargado-barra-index.html'" class="btn-back">VOLVER</button>
        </div>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <h2 class="section-title">Pedidos y Control de Merma</h2>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('merma', this)">üìâ REGISTRAR MERMA</button>
        <button class="tab-btn" onclick="switchTab('pedidos', this)">üìù CONSOLIDAR PEDIDOS STAFF</button>
    </div>

    <div id="view-merma">
        <div class="merma-card">
            <h3 class="section-title" style="font-size:18px; margin-bottom:25px;">Declarar P√©rdida de Inventario</h3>
            
            <label class="input-label">INSUMO PERDIDO / ROTO</label>
            <select id="mermaSku" class="modal-select"></select>
            
            <div style="display:flex; gap:15px; margin-top:15px;">
                <div style="flex:1;">
                    <label class="input-label">CANTIDAD (UNIDAD)</label>
                    <input type="number" id="mermaQty" class="modal-input" placeholder="0">
                </div>
                <div style="width:100px;">
                    <label class="input-label">UNIDAD DE MEDIDA</label>
                    <input type="text" id="mermaUnit" class="modal-input" value="UNIDAD" disabled>
                </div>
            </div>

            <label class="input-label">MOTIVO DE LA P√âRDIDA</label>
            <select id="mermaReason" class="modal-select">
                <option value="ROTURA">Rotura de Botella / Vaso</option>
                <option value="DESPERDICIO">Desperdicio por Mala Pr√°ctica</option>
                <option value="VENCIMIENTO">Vencimiento</option>
                <option value="ROBO_INTERNO">Hurto / Robo Interno</option>
                <option value="OTRO">Otro Motivo (Especificar)</option>
            </select>

            <label class="input-label">DETALLE BREVE (Obligatorio)</label>
            <textarea id="mermaNotes" class="modal-input" placeholder="Ej: Botella de Fernet 750ml rota en barra 2..." style="height:80px;"></textarea>

            <button onclick="submitMerma()" id="btnMerma" class="btn-primary" style="width:100%; padding:15px; margin-top:20px; background:var(--accent-red); color:#fff;">REGISTRAR MERMA Y AJUSTAR STOCK üö®</button>
        </div>
    </div>

    <div id="view-pedidos" style="display:none;">
        <div class="section-header">
            <h3 class="section-title" style="font-size:18px;">Pedidos Pendientes de Consolidaci√≥n</h3>
            <button onclick="loadPedidos()" class="btn-refresh">REFRESCAR</button>
        </div>
        
        <div id="pedidosList" class="data-list"></div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let skus = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const session = localStorage.getItem('mc_user');
        if (!session) { window.location.href = 'index.html'; return; }
        currentUser = JSON.parse(session);
        await loadSkus();
        switchTab('merma', document.querySelector('.tab-btn.active'));
    });

    function switchTab(view, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('view-merma').style.display = 'none';
        document.getElementById('view-pedidos').style.display = 'none';
        
        if (view === 'merma') {
            document.getElementById('view-merma').style.display = 'block';
        } else if (view === 'pedidos') {
            document.getElementById('view-pedidos').style.display = 'block';
            loadPedidos();
        }
    }

    // === L√ìGICA DE MERMA ===

    async function loadSkus() {
        const { data } = await client.from('inventory_skus').select('id, name, unit_type, stock_current').order('name');
        skus = data || [];
        const sel = document.getElementById('mermaSku');
        
        if (!skus.length) { 
            sel.innerHTML = '<option value="">No hay insumos maestros.</option>'; 
            return; 
        }

        sel.innerHTML = '<option value="">Selecciona el insumo...</option>' + 
            skus.map(s => `<option value="${s.id}" data-unit="${s.unit_type}">${s.name} (Stock: ${s.stock_current} ${s.unit_type})</option>`).join('');

        // Listener para actualizar la unidad de medida
        sel.addEventListener('change', (e) => {
            const selected = e.target.options[e.target.selectedIndex];
            document.getElementById('mermaUnit').value = selected.dataset.unit || 'UNIDAD';
        });
    }

    async function submitMerma() {
        const skuId = document.getElementById('mermaSku').value;
        const qty = parseFloat(document.getElementById('mermaQty').value);
        const reason = document.getElementById('mermaReason').value;
        const notes = document.getElementById('mermaNotes').value.trim();

        if (!skuId || !qty || qty <= 0) return alert("Selecciona el insumo e ingresa una cantidad v√°lida.");
        if (!notes) return alert("Ingresa un detalle breve del incidente.");

        if(!confirm(`‚ö†Ô∏è ¬øConfirmas registrar una MERMA de ${qty} unidades de este insumo? Se ajustar√° el stock.`)) return;

        const btn = document.getElementById('btnMerma');
        btn.disabled = true; btn.innerText = "REGISTRANDO...";

        try {
            // 1. Registrar Movimiento de Merma (Cantidad negativa)
            const { error: moveError } = await client.from('inventory_movements').insert({
                sku_id: skuId,
                user_id: currentUser.id,
                change_amount: -qty, // Cantidad negativa para Merma
                movement_type: 'MERMA', 
                notes: `[MOTIVO: ${reason}] ${notes}`,
                event_date: new Date().toISOString().split('T')[0]
            });
            if (moveError) throw moveError;

            // 2. Ajustar Stock Actual (Optimista: Sumar el cambio negativo al stock actual)
            const currentSku = skus.find(s => s.id == skuId);
            const newStock = (currentSku.stock_current || 0) - qty;

            const { error: stockError } = await client.from('inventory_skus')
                .update({ stock_current: newStock })
                .eq('id', skuId);
            if (stockError) throw stockError;

            alert("‚úÖ Merma registrada y Stock ajustado.");
            
            // Limpiar formulario y recargar SKUs para ver el nuevo stock
            document.getElementById('mermaQty').value = '';
            document.getElementById('mermaNotes').value = '';
            await loadSkus();

        } catch (e) {
            console.error(e);
            alert("Error al registrar Merma: " + e.message);
        } finally {
            btn.disabled = false; btn.innerText = "REGISTRAR MERMA Y AJUSTAR STOCK üö®";
        }
    }

    // === L√ìGICA DE PEDIDOS ===

    async function loadPedidos() {
        const container = document.getElementById('pedidosList');
        container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--txt-secondary);">Cargando pedidos...</div>';

        // Carga solo los PEDIDOS abiertos
        const { data, error } = await client.from('incident_reports')
            .select(`id, created_at, description, profiles(full_name, username)`)
            .eq('area', 'BARRA')
            .eq('type', 'PEDIDO')
            .neq('status', 'closed')
            .order('created_at', { ascending: false });

        if (error) {
            container.innerHTML = `<div style="text-align:center; padding:30px; color:var(--accent-red);">Error: ${error.message}</div>`;
            return;
        }
        
        if (!data || data.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--txt-secondary);">No hay pedidos de insumos pendientes.</div>`;
            return;
        }

        container.innerHTML = data.map(p => {
            const reporter = p.profiles ? (p.profiles.full_name || p.profiles.username) : 'Staff';
            const time = new Date(p.created_at).toLocaleString('es-AR', { hour: '2-digit', minute:'2-digit' });
            
            return `
            <div class="pedido-item">
                <div style="flex:1;">
                    <div style="font-size:15px; font-weight:700; color:var(--accent-blue);">#${p.id} - ${p.description.replace('SOLICITUD: ','')}</div>
                    <div style="font-size:11px; color:var(--txt-tertiary); margin-top:5px;">
                        Solicitado por: ${reporter} a las ${time}
                    </div>
                </div>
                <button 
                    onclick="consolidatePedido(${p.id})" 
                    class="btn-primary" 
                    style="background:var(--accent-blue); color:#fff; padding:8px 12px; font-size:11px; margin-left:15px; border:none;">
                    CONSOLIDAR
                </button>
            </div>`;
        }).join('');
    }

    async function consolidatePedido(id) {
        if(!confirm(`¬øMarcar el pedido #${id} como Consolidado/Cerrado?`)) return;

        const { error } = await client.from('incident_reports')
            .update({ status: 'closed' })
            .eq('id', id);

        if(error) {
            alert("Error al consolidar: " + error.message);
        } else {
            alert(`Pedido #${id} cerrado. Listo para generar Orden de Compra.`);
            loadPedidos();
        }
    }
  </script>
</body>
</html>
