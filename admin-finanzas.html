<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Contabilidad</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>
</head>
<body>

  <!-- HEADER ESTÃNDAR CMS -->
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div>
          <button
            type="button"
            class="btn-back"
            onclick="window.location.href='administracion-index.html'">
            VOLVER
          </button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">AdministraciÃ³n</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <!-- TÃTULO -->
    <section class="section-header">
      <h1 class="section-title">CONTABILIDAD Y FACTURACIÃ“N</h1>
      <p class="section-desc">AuditorÃ­a fiscal y exportaciÃ³n para estudio contable.</p>
    </section>

    <!-- FECHA + SINCRONIZACIÃ“N -->
    <div class="box-soft" style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:16px; margin-bottom:20px;">
      <div style="min-width:220px;">
        <label class="input-label" for="queryDate">FECHA DE CIERRE (FISCAL)</label>
        <div style="display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-top:4px;">
          <input
            type="date"
            id="queryDate"
            class="modal-input"
            style="width:160px; font-weight:700;" />
          <span
            id="statusMsg"
            class="section-desc"
            style="margin:0; font-size:11px;">
            Selecciona fecha para sincronizar.
          </span>
        </div>
      </div>

      <button
        type="button"
        onclick="syncGbolData()"
        id="btnSync"
        class="btn-primary"
        style="min-width:220px;">
        ðŸ”„ SINCRONIZAR DESDE GBOL
      </button>
    </div>

    <!-- KPIs usando summary-card / border-* del design system -->
    <div class="summary-row">
      <div class="summary-card border-total">
        <div class="summary-label">FACTURACIÃ“N TOTAL</div>
        <div class="summary-value" id="valTotal">$ 0</div>
        <button
          type="button"
          class="btn-secondary"
          style="width:100%; margin-top:8px; font-size:10px;"
          onclick="exportExcel('TOTAL')">
          ðŸ“¥ DESCARGAR TODO
        </button>
      </div>

      <div class="summary-card border-digital">
        <div class="summary-label">DIGITAL (TARJETA / QR)</div>
        <div class="summary-value" id="valDigital" style="color:var(--accent-blue);">$ 0</div>
        <button
          type="button"
          class="btn-secondary"
          style="width:100%; margin-top:8px; font-size:10px;"
          onclick="exportExcel('DIGITAL')">
          ðŸ“¥ DESCARGAR DIGITAL
        </button>
      </div>

      <div class="summary-card border-fiscal">
        <div class="summary-label">EFECTIVO FACT. B (BLANCO)</div>
        <div class="summary-value" id="valFiscal" style="color:var(--accent-green);">$ 0</div>
        <button
          type="button"
          class="btn-secondary"
          style="width:100%; margin-top:8px; font-size:10px;"
          onclick="exportExcel('FISCAL')">
          ðŸ“¥ DESCARGAR FISCAL (B)
        </button>
      </div>

      <div class="summary-card border-internal">
        <div class="summary-label">EFECTIVO INTERNO (X)</div>
        <div class="summary-value" id="valInternal" style="color:var(--accent-gold);">$ 0</div>
        <button
          type="button"
          class="btn-secondary"
          style="width:100%; margin-top:8px; font-size:10px;"
          onclick="exportExcel('INTERNAL')">
          ðŸ“¥ DESCARGAR INTERNO (X)
        </button>
      </div>
    </div>

    <!-- TABLA PRINCIPAL -->
    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left:20px;">TIPO</th>
            <th>COMPROBANTE</th>
            <th>CAE / AUTORIZACIÃ“N</th>
            <th class="text-right">NETO (BIMP)</th>
            <th class="text-right">IVA</th>
            <th class="text-right" style="padding-right:20px;">TOTAL</th>
          </tr>
        </thead>
        <tbody id="accountingBody">
          <tr>
            <td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary);">
              Sin datos cargados para esta fecha.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </main>

  <script>
    // ================= CONFIGURACIÃ“N =================
    const GBOL_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiI3UUhyZHJTaWNmUDJjOWowT2RMc1VjNmJVcFFkVFRSMEpFZ3JTSDBGM2pieVlWaHpNeDRYTEJhcUlEVWR0TDR2OSt4a1kxTzliUHhDc3grMVBQNVo3RmVYN2I0RGR2dk5UaGh2dzJOWWVpcz0iLCJleHAiOjE3NjU1OTEwMjd9.qUXEqRBV2oArhWug01KMNaTQ-VYGQ3EVVNv816hWmao";
    const GBOL_ENDPOINT = "https://sd-2515114-h00190.ferozo.net/gbol/api/tickets/facturacionElectronicaConsulta";
    
    // AlmacÃ©n temporal en memoria para exportaciÃ³n rÃ¡pida
    let currentData = [];

    document.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      d.setDate(d.getDate() - 1); // Ayer por defecto
      document.getElementById('queryDate').valueAsDate = d;
      loadFromSupabase(); // Intentar cargar si ya existe en DB
    });

    // --- 1. SINCRONIZACIÃ“N (FETCH + SAVE) ---
    async function syncGbolData() {
      const dateStr = document.getElementById('queryDate').value;
      const btn = document.getElementById('btnSync');
      const status = document.getElementById('statusMsg');

      if (!dateStr) return alert("Selecciona una fecha.");
      if (!confirm(`Â¿Sincronizar facturaciÃ³n del ${dateStr} con Gbol? Se actualizarÃ¡ la base de datos.`)) return;

      btn.disabled = true; btn.innerHTML = "CONECTANDO...";
      status.innerText = "Descargando comprobantes...";

      try {
        // A. Fetch Gbol
        const rawBody = JSON.stringify({
          "estado": -1, "metodoDePago": -1, "puntoDeVenta": "T-0",
          "noche": dateStr, "tipoBusqueda": 1
        });

        const response = await fetch(GBOL_ENDPOINT, {
          method: 'POST',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json;charset=UTF-8',
            'Authorization': 'Bearer ' + GBOL_TOKEN
          },
          body: rawBody
        });

        if (!response.ok) throw new Error("Error de conexiÃ³n con Gbol");
        const data = await response.json();

        if (!data.facturacion || !Array.isArray(data.facturacion)) {
          throw new Error("No hay datos de facturaciÃ³n disponibles.");
        }

        // B. Mapeo Robusto para SQL
        const rowsToInsert = data.facturacion.map(t => {
          // LÃ³gica de importes
          const importe = parseFloat(t.importe) || 0;
          const efectivo = parseFloat(t.efectivo) || 0;
          const digital = (parseFloat(t.tarjetas) || 0) + (parseFloat(t.merpag) || 0);
          const neto = parseFloat(t.bimp) || 0;
          const iva = parseFloat(t.iva) || 0;

          // LÃ³gica de Tipos (A, B, X)
          let tipo = 'X';
          // tcom 1=A, 6=B, 83=Ticket
          if (t.tcom == 1) tipo = 'A';
          if (t.tcom == 6 || t.tcom == 83) tipo = 'B';
          if (t.tcom == 0 || t.tcom == 99) tipo = 'X';

          return {
            fecha: dateStr,
            ticket_id: t.id || `GEN-${Math.random()}`, // ID Ãºnico
            nro_comprobante: t.factura || t.ticket || '0',
            tipo_comp: tipo,
            cae: t.cae || null,
            pto_vta: parseInt(t.ptovta) || 0,
            cliente_doc: t.ndoc || null,
            cliente_razon: t.cliente || null,
            cajanom: t.cajanom || 'GENERAL',

            // Importes
            importe_total: importe,
            importe_neto: neto,
            importe_iva: iva,
            pago_efectivo: efectivo,
            pago_digital: digital,

            // Metadata raw para futuro debugging
            raw_data: JSON.stringify(t)
          };
        });

        // C. TransacciÃ³n Supabase (Borrar previo -> Insertar nuevo)
        status.innerText = "Guardando en base de datos...";

        // 1. Limpiar dÃ­a
        const { error: delErr } = await client
          .from('import_gbol_sales')
          .delete()
          .eq('fecha', dateStr);
        if (delErr) throw delErr;

        // 2. Insertar lote
        const { error: insErr } = await client
          .from('import_gbol_sales')
          .insert(rowsToInsert);
        if (insErr) throw insErr;

        status.innerText = `âœ… Sincronizado: ${rowsToInsert.length} comprobantes.`;
        status.style.color = "var(--accent-green)";

        // D. Renderizar desde memoria (mÃ¡s rÃ¡pido que volver a pedir a DB)
        processAndRender(rowsToInsert);

      } catch (e) {
        console.error(e);
        status.innerText = "Error: " + e.message;
        status.style.color = "var(--accent-red)";
        alert("Fallo la sincronizaciÃ³n: " + e.message);
      } finally {
        btn.disabled = false; btn.innerHTML = "ðŸ”„ SINCRONIZAR DESDE GBOL";
      }
    }

    // --- 2. CARGA DESDE DB (SOLO LECTURA) ---
    async function loadFromSupabase() {
      const dateStr = document.getElementById('queryDate').value;
      const status = document.getElementById('statusMsg');

      status.innerText = "Buscando en historial...";

      const { data, error } = await client
        .from('import_gbol_sales')
        .select('*')
        .eq('fecha', dateStr);

      if (!error && data && data.length > 0) {
        status.innerText = `Datos recuperados del historial (${data.length} registros).`;
        processAndRender(data);
      } else {
        status.innerText = "Sin datos locales. Pulsa Sincronizar.";
        document.getElementById('accountingBody').innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-secondary);">No hay datos sincronizados para esta fecha.</td></tr>';
        // Reset KPIs
        ['valTotal', 'valDigital', 'valFiscal', 'valInternal']
          .forEach(id => document.getElementById(id).innerText = '$ 0');
        currentData = [];
      }
    }

    // --- 3. LÃ“GICA DE NEGOCIO AND RENDER ---
    function processAndRender(rows) {
      currentData = rows; // Guardar en global para exportar

      let sumTotal = 0, sumDigital = 0, sumFiscal = 0, sumInternal = 0;
      const tbody = document.getElementById('accountingBody');

      // Generar HTML de tabla (limitado a 100 para no trabar el navegador)
      const tableRows = rows.slice(0, 100).map(r => {
        // Calcular KPIs mientras iteramos
        sumTotal += (r.importe_total || r.importe || 0); // compatibilidad con nombres viejos
        sumDigital += (r.pago_digital || r.tarjetas || 0);

        const efvo = (r.pago_efectivo || r.efectivo || 0);
        const tipo = r.tipo_comp || 'X';

        if (tipo === 'A' || tipo === 'B') {
          if (efvo > 0) sumFiscal += efvo;
        } else {
          if (efvo > 0) sumInternal += efvo;
        }

        // Visual
        let badgeClass = 'tag-gray';
        if (tipo === 'A') badgeClass = 'tag-blue';
        if (tipo === 'B') badgeClass = 'tag-green';
        if (tipo === 'X') badgeClass = 'tag-gold';

        return `
          <tr>
            <td style="padding-left:20px;">
              <span class="tag ${badgeClass}">FACT ${tipo}</span>
            </td>
            <td>
              <div class="row-title">#${r.nro_comprobante || r.ticket_id}</div>
              <div class="row-sub-text">${r.cliente_razon || 'Consumidor Final'}</div>
            </td>
            <td style="font-family:monospace; color:var(--text-secondary); font-size:11px;">
              ${r.cae || '-'}
            </td>
            <td class="text-right text-muted">${format(r.importe_neto || 0)}</td>
            <td class="text-right text-muted">${format(r.importe_iva || 0)}</td>
            <td class="text-right col-costo" style="font-weight:700; padding-right:20px;">
              ${format(r.importe_total || r.importe)}
            </td>
          </tr>`;
      }).join('');

      // KPIs exactas si hay mÃ¡s de 100
      if (rows.length > 100) {
        sumTotal = rows.reduce((a, b) => a + (b.importe_total || b.importe || 0), 0);
        sumDigital = rows.reduce((a, b) => a + (b.pago_digital || b.tarjetas || 0), 0);
        sumFiscal = rows
          .filter(r => (r.tipo_comp === 'A' || r.tipo_comp === 'B'))
          .reduce((a, b) => a + (b.pago_efectivo || b.efectivo || 0), 0);
        sumInternal = rows
          .filter(r => (r.tipo_comp !== 'A' && r.tipo_comp !== 'B'))
          .reduce((a, b) => a + (b.pago_efectivo || b.efectivo || 0), 0);
      }

      tbody.innerHTML = tableRows + (
        rows.length > 100
          ? `<tr><td colspan="6" class="text-center text-muted">... y ${rows.length - 100} mÃ¡s ...</td></tr>`
          : ''
      );

      // Actualizar UI
      document.getElementById('valTotal').innerText = format(sumTotal);
      document.getElementById('valDigital').innerText = format(sumDigital);
      document.getElementById('valFiscal').innerText = format(sumFiscal);
      document.getElementById('valInternal').innerText = format(sumInternal);
    }

    // --- 4. EXPORTACIÃ“N EXCEL (SheetJS) ---
    function exportExcel(mode) {
      if (!currentData.length) return alert("No hay datos para exportar.");

      let dataToExport = [];
      let filename = `MIDNIGHT_${mode}_${document.getElementById('queryDate').value}.xlsx`;

      // Filtrado inteligente
      if (mode === 'TOTAL') {
        dataToExport = currentData;
      }
      else if (mode === 'DIGITAL') {
        dataToExport = currentData.filter(r => (r.pago_digital || r.tarjetas) > 0);
      }
      else if (mode === 'FISCAL') {
        // Solo efectivo fiscal (Facturas B/A pagadas en cash)
        dataToExport = currentData.filter(
          r => (r.tipo_comp === 'A' || r.tipo_comp === 'B') &&
               (r.pago_efectivo || r.efectivo) > 0
        );
      }
      else if (mode === 'INTERNAL') {
        // Solo efectivo interno (X)
        dataToExport = currentData.filter(
          r => (r.tipo_comp !== 'A' && r.tipo_comp !== 'B') &&
               (r.pago_efectivo || r.efectivo) > 0
        );
      }

      if (dataToExport.length === 0) return alert("No hay registros para este filtro.");

      // Mapeo para Excel
      const excelRows = dataToExport.map(r => ({
        "FECHA": r.fecha,
        "TIPO": r.tipo_comp,
        "PUNTO_VTA": r.pto_vta || r.ptovta,
        "NUMERO": r.nro_comprobante,
        "CAE": r.cae || "",
        "CLIENTE": r.cliente_razon || "CONS FINAL",
        "CUIT_CLIENTE": r.cliente_doc || "",
        "NETO_GRAVADO": r.importe_neto || 0,
        "IVA": r.importe_iva || 0,
        "TOTAL": r.importe_total || r.importe,
        "PAGO_EFVO": r.pago_efectivo || r.efectivo,
        "PAGO_DIGITAL": r.pago_digital || r.tarjetas
      }));

      const ws = XLSX.utils.json_to_sheet(excelRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "FacturaciÃ³n");
      XLSX.writeFile(wb, filename);
    }

    function format(n) {
      if (typeof MC_UTILS !== 'undefined') return MC_UTILS.formatCurrency(n);
      return new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS',
        maximumFractionDigits: 0
      }).format(n);
    }
  </script>
</body>
</html>
