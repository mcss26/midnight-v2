<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Midnight ‚Äî Encargado Barra</title>
  
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    /* Navegaci√≥n */
    .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab-btn { 
        background: #111; border: 1px solid #333; color: #666; padding: 10px 15px; 
        border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap; cursor: pointer;
    }
    .tab-btn.active { background: #fff; color: #000; border-color: #fff; }

    /* Tarjetas de Pedido Staff */
    .req-card { 
        background: #111; border-left: 3px solid var(--mc-accent-blue); padding: 15px; 
        margin-bottom: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
    }
    .btn-approve { background: var(--mc-accent-green); color: #000; border: none; padding: 8px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 10px; }
    .btn-reject { background: #333; color: #fff; border: 1px solid #444; padding: 8px 12px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 10px; margin-left: 5px; }

    /* Grilla de Stock */
    .stock-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; align-items: center; padding: 10px 0; border-bottom: 1px dashed #333; }
    .stock-inp { background: #000; border: 1px solid #333; color: #fff; padding: 8px; text-align: center; border-radius: 4px; width: 100%; box-sizing: border-box; }
    
    /* Panel Merma */
    .merma-box { background: rgba(232, 55, 47, 0.1); border: 1px solid var(--mc-red); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
  </style>
</head>
<body>

  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-accent-green);">BARRA</span></div>
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="userDisplay" style="font-size:10px; color:#888; font-weight:700;">ENCARGADO</span>
        <button onclick="window.location.href='index.html'" class="btn-logout">SALIR</button>
    </div>
  </header>

  <div class="admin-container" style="max-width:600px; margin-top:20px;">
    
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('validar', this)">üõéÔ∏è PEDIDOS STAFF</button>
        <button class="tab-btn" onclick="switchTab('stock', this)">üì¶ STOCK & TURNO</button>
        <button class="tab-btn" onclick="switchTab('mermas', this)">üìâ MERMAS</button>
        <button class="tab-btn" onclick="switchTab('insumos', this)">üìù PEDIR INSUMOS</button>
    </div>

    <div id="view-validar">
        <div class="section-header">
            <h2 class="section-title">Solicitudes de Barra</h2>
            <button onclick="loadRequests()" class="btn-refresh">‚Üª</button>
        </div>
        <div id="staffRequestsList"><div class="loading-state">Buscando pedidos...</div></div>
    </div>

    <div id="view-stock" style="display:none;">
        <div class="section-header">
            <h2 class="section-title">Control de Inventario</h2>
            <select id="barSelect" class="modal-select" style="width:auto; margin:0;">
                <option value="BARRA_1">BARRA 1</option>
                <option value="BARRA_2">BARRA 2</option>
                <option value="VIP">VIP</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn-action" style="flex:1; border-color:var(--mc-accent-blue); color:var(--mc-accent-blue);" onclick="loadStockList('OPEN')">üîì ABRIR TURNO</button>
            <button class="btn-action" style="flex:1; border-color:var(--mc-red); color:var(--mc-red);" onclick="loadStockList('CLOSE')">üîí CERRAR TURNO</button>
        </div>

        <div id="stockContainer" style="display:none;">
            <h3 id="stockModeTitle" style="color:#fff; font-size:14px; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:5px;">CONTEO</h3>
            <div id="stockList"></div>
            <button onclick="submitStock()" class="btn-primary" style="width:100%; margin-top:20px; padding:15px;">CONFIRMAR CONTEO</button>
        </div>
    </div>

    <div id="view-mermas" style="display:none;">
        <div class="merma-box">
            <h3 style="color:var(--mc-red); margin-top:0;">Reportar Rotura / P√©rdida</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:15px;">Esto descontar√° el stock inmediatamente.</p>
            
            <label class="input-label">PRODUCTO</label>
            <select id="mermaSku" class="modal-select"></select>
            
            <label class="input-label">CANTIDAD (UNIDADES)</label>
            <input type="number" id="mermaQty" class="modal-input" placeholder="1">

            <label class="input-label">MOTIVO</label>
            <input type="text" id="mermaReason" class="modal-input" placeholder="Ej: Se cay√≥ la botella llena">

            <button onclick="submitMerma()" class="btn-primary" style="width:100%; margin-top:15px; background:var(--mc-red);">CONFIRMAR BAJA</button>
        </div>
    </div>

    <div id="view-insumos" style="display:none;">
        <div class="dash-card" style="height:auto;">
            <h3 class="dash-title">Solicitud a Dep√≥sito</h3>
            <label class="input-label">DETALLE</label>
            <textarea id="supplyReq" class="modal-input" placeholder="Ej: 5 Cajas Champ, 10 Bolsas Hielo..." style="height:100px;"></textarea>
            <button onclick="submitSupplyReq()" class="btn-primary" style="width:100%; margin-top:10px;">ENVIAR PEDIDO</button>
        </div>
    </div>

  </div>

  <script>
    let currentUser = null;
    let allSkus = [];
    let currentStockMode = ''; // 'OPEN' o 'CLOSE'

    document.addEventListener('DOMContentLoaded', async () => {
        const session = localStorage.getItem('mc_user');
        if (!session) { window.location.href = 'index.html'; return; }
        currentUser = JSON.parse(session);
        document.getElementById('userDisplay').innerText = currentUser.username.toUpperCase();
        
        loadRequests();
        loadSkus();
    });

    function switchTab(view, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['validar','stock','mermas','insumos'].forEach(v => document.getElementById('view-'+v).style.display='none');
        document.getElementById('view-'+view).style.display='block';
    }

    // === 1. VALIDACI√ìN PEDIDOS STAFF ===
    async function loadRequests() {
        const c = document.getElementById('staffRequestsList');
        c.innerHTML = '<div class="loading-state">Cargando...</div>';
        
        // Traer incidentes tipo PEDIDO de area BARRA en estado 'open'
        const { data } = await client.from('incident_reports')
            .select('id, description, created_at, profiles(username)')
            .eq('type', 'PEDIDO')
            .eq('area', 'BARRA')
            .eq('status', 'open')
            .order('created_at', {ascending:false});

        if (!data || data.length === 0) {
            c.innerHTML = '<div class="empty-state">No hay pedidos pendientes.</div>';
            return;
        }

        c.innerHTML = data.map(r => `
            <div class="req-card" id="req-${r.id}">
                <div>
                    <div style="font-weight:700; color:#fff;">${r.description}</div>
                    <div style="font-size:10px; color:#888;">Por: ${r.profiles?.username || 'Staff'} ‚Ä¢ ${new Date(r.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>
                <div>
                    <button class="btn-approve" onclick="resolveReq('${r.id}', 'resolved')">‚úì</button>
                    <button class="btn-reject" onclick="resolveReq('${r.id}', 'rejected')">‚úï</button>
                </div>
            </div>
        `).join('');
    }

    async function resolveReq(id, status) {
        // Optimista
        document.getElementById(`req-${id}`).style.opacity = '0.5';
        await client.from('incident_reports').update({ status: status }).eq('id', id);
        loadRequests();
    }

    // === 2. GESTI√ìN STOCK ===
    async function loadSkus() {
        // Cargar SKUs para Mermas y Stock (Categor√≠a BEBIDAS, DESCARTABLES, INSUMOS)
        const { data } = await client.from('inventory_skus')
            .select('id, name, category')
            .in('family', ['BEBIDAS', 'INSUMOS']) // Asumiendo que usas familias
            .eq('is_active', true)
            .order('name');
        
        allSkus = data || [];
        
        // Llenar select mermas
        const sel = document.getElementById('mermaSku');
        sel.innerHTML = allSkus.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    function loadStockList(mode) {
        currentStockMode = mode;
        document.getElementById('stockContainer').style.display = 'block';
        document.getElementById('stockModeTitle').innerText = mode === 'OPEN' ? 'APERTURA (Conteo Inicial)' : 'CIERRE (Conteo Final)';
        
        const c = document.getElementById('stockList');
        c.innerHTML = allSkus.map(s => `
            <div class="stock-grid">
                <div style="font-size:12px; font-weight:700; color:#ccc;">${s.name}</div>
                <input type="number" class="stock-inp" id="cnt_${s.id}" placeholder="0">
            </div>
        `).join('');
    }

    async function submitStock() {
        const bar = document.getElementById('barSelect').value;
        const counts = [];
        
        // Recorrer inputs
        allSkus.forEach(s => {
            const val = document.getElementById(`cnt_${s.id}`).value;
            if(val !== '') counts.push({ sku_id: s.id, name: s.name, qty: parseFloat(val) });
        });

        if(counts.length === 0) return alert("Ingresa al menos un conteo.");

        if(!confirm(`¬øConfirmar ${currentStockMode === 'OPEN' ? 'APERTURA' : 'CIERRE'} de ${bar}?`)) return;

        // Guardar como Reporte JSON (Estrategia V2.1 Simplificada)
        const reportJson = JSON.stringify({
            bar: bar,
            mode: currentStockMode,
            items: counts
        });

        const { error } = await client.from('incident_reports').insert({
            reporter_id: currentUser.id,
            area: 'BARRA_STOCK',
            type: currentStockMode === 'OPEN' ? 'APERTURA_SESION' : 'CIERRE_SESION',
            description: `Sesi√≥n ${bar} (${counts.length} items)`,
            details: reportJson, // Si agregaste columna details o usar description
            status: 'closed'
        });

        // Nota: Si la tabla incident_reports no tiene columna 'details' en tu versi√≥n,
        // mete todo el JSON en 'description' o usa 'admin_logs'.
        // Aqu√≠ asumo que usaremos 'description' para el resumen y 'details' si existe, si no, concatenamos.
        
        if(error) alert("Error: " + error.message);
        else {
            alert("‚úÖ Inventario guardado.");
            document.getElementById('stockContainer').style.display = 'none';
        }
    }

    // === 3. MERMAS ===
    async function submitMerma() {
        const skuId = document.getElementById('mermaSku').value;
        const qty = parseFloat(document.getElementById('mermaQty').value);
        const reason = document.getElementById('mermaReason').value;

        if(!qty || !reason) return alert("Completa todos los campos.");

        if(!confirm("¬øConfirmar Merma? Se descontar√° del stock.")) return;

        // Registrar Movimiento de Inventario
        const { error } = await client.from('inventory_movements').insert({
            sku_id: skuId,
            user_id: currentUser.id,
            change_amount: -Math.abs(qty), // Resta
            movement_type: 'MERMA',
            notes: reason,
            event_date: new Date()
        });

        // Actualizar SKU Master (Opcional, si llevas stock centralizado al d√≠a)
        /* const { data: curr } = await client.from('inventory_skus').select('stock_current').eq('id', skuId).single();
        if(curr) await client.from('inventory_skus').update({ stock_current: curr.stock_current - qty }).eq('id', skuId);
        */

        if(error) alert("Error: " + error.message);
        else {
            alert("Merma registrada.");
            document.getElementById('mermaQty').value = '';
            document.getElementById('mermaReason').value = '';
        }
    }

    // === 4. PEDIDOS A DEP√ìSITO ===
    async function submitSupplyReq() {
        const desc = document.getElementById('supplyReq').value;
        if(!desc) return;

        await client.from('incident_reports').insert({
            reporter_id: currentUser.id,
            area: 'BARRA',
            type: 'REPOSICION', // Tipo especial para Encargado -> Dep√≥sito
            description: desc,
            severity: 'MEDIA',
            status: 'open'
        });

        alert("Pedido enviado a Dep√≥sito.");
        document.getElementById('supplyReq').value = '';
    }
  </script>
</body>
</html>