<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Recetas</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    /* Layout Grid Específico de Recetas */
    .recipes-layout { display: grid; grid-template-columns: 320px 1fr; gap: 18px; height: calc(100vh - 100px); }
    @media (max-width: 768px) { .recipes-layout { grid-template-columns: 1fr; height: auto; } }

    .recipes-list-panel {
      background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .recipes-list-header { padding: 15px; border-bottom: 1px solid var(--border-subtle); background: rgba(5,7,11,0.95); }
    .menu-list-scroll { flex: 1; overflow-y: auto; }

    .menu-item-row { padding: 12px 15px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: 0.2s; }
    .menu-item-row:hover { background: var(--bg-hover); }
    .menu-item-row.active { background: rgba(232,55,47,0.1); border-left: 3px solid var(--accent-red); padding-left: 12px; }

    .recipes-details-panel {
      background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-subtle); padding: 20px;
      overflow-y: auto;
    }

    /* KPIs */
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .kpi-card { background: #05080d; border-radius: var(--radius-md); border: 1px solid var(--border-subtle); padding: 15px; text-align: center; }
    .kpi-value { font-family: 'Outfit'; font-size: 20px; font-weight: 700; margin-top: 5px; }

    /* Ingredientes */
    .ing-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); }
    .add-ing-row { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-subtle); display: flex; gap: 10px; align-items: flex-end; }
  </style>
</head>

<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">LAB</span></div>
    <div class="admin-header-right">
        <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
    </div>
  </header>

  <div class="admin-container" style="max-width:1240px;">
    <div class="section-header">
      <h2 class="section-title">Recetas & Ficha Técnica</h2>
    </div>

    <div class="recipes-layout">
      <aside class="recipes-list-panel">
        <div class="recipes-list-header">
          <button onclick="createItem()" class="btn-primary" style="width:100%; margin-bottom:10px;">+ NUEVO PRODUCTO</button>
          <input type="text" id="searchMenu" class="search-input-admin" placeholder="Buscar producto...">
        </div>
        <div id="menuList" class="menu-list-scroll"></div>
      </aside>

      <section class="recipes-details-panel">
        <div id="emptyState" style="text-align:center; padding:50px; color:var(--text-secondary);">
          Selecciona un producto para ver su receta.
        </div>

        <div id="recipePanel" style="display:none;">
          <input type="hidden" id="currentItemId">

          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px;">
            <div>
                <div class="input-label">PRODUCTO</div>
                <div id="viewName" style="font-family:'Outfit'; font-size:24px; font-weight:700; color:#fff;">--</div>
            </div>
            <button class="btn-modal-cancel" onclick="deleteItem()" style="color:var(--accent-red); border-color:var(--accent-red);">ELIMINAR</button>
          </div>

          <div style="margin-bottom:20px;">
            <label class="input-label">PRECIO VENTA PÚBLICO ($)</label>
            <input type="number" id="viewPrice" class="modal-input" style="max-width:150px;" onchange="updatePrice()">
          </div>

          <div class="kpi-grid">
            <div class="kpi-card"><div class="input-label">COSTO RECETA</div><div id="kpiCost" class="kpi-value">$0</div></div>
            <div class="kpi-card"><div class="input-label">MARGEN ($)</div><div id="kpiMargin" class="kpi-value">$0</div></div>
            <div class="kpi-card"><div class="input-label">MARGEN (%)</div><div id="kpiPerc" class="kpi-value">0%</div></div>
          </div>

          <div style="border-bottom:1px solid var(--border-light); margin-bottom:10px; padding-bottom:5px;">
              <span class="input-label">INGREDIENTES</span>
          </div>
          <div id="ingList"></div>

          <div class="add-ing-row">
            <div style="flex:3;">
              <label class="input-label">INSUMO</label>
              <select id="selSku" class="modal-select"></select>
            </div>
            <div style="flex:1;">
              <label class="input-label">CANTIDAD</label>
              <input type="number" id="newQty" class="modal-input" placeholder="0">
            </div>
            <div style="width:80px;">
              <label class="input-label">UNIDAD</label>
              <select id="newUnit" class="modal-select">
                <option value="ml">ml</option>
                <option value="un">un</option>
                <option value="gr">gr</option>
              </select>
            </div>
            <button onclick="addIng()" class="btn-secondary" style="height:36px;">AGREGAR</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    let menuItems = [];
    let skus = [];
    let currentItemId = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const [mRes, sRes] = await Promise.all([
          client.from('menu_items').select('*').order('name'),
          client.from('inventory_skus').select('id, name, unit_type, cost_price, volume_ml').eq('is_active', true).order('name')
        ]);
        menuItems = mRes.data || [];
        skus = sRes.data || [];
        renderMenu(menuItems);
        
        document.getElementById('selSku').innerHTML = '<option value="">Seleccionar...</option>' + skus.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        
        document.getElementById('searchMenu').addEventListener('input', (e) => {
            const t = e.target.value.toLowerCase();
            renderMenu(menuItems.filter(i => i.name.toLowerCase().includes(t)));
        });
    });

    function renderMenu(list) {
      const c = document.getElementById('menuList');
      if (!list.length) { c.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary);">Sin productos.</div>'; return; }
      c.innerHTML = list.map(i => `
        <div class="menu-item-row" data-id="${i.id}" onclick="selectItem(${i.id})">
          <div style="font-weight:600; color:#fff;">${i.name}</div>
          <div style="font-size:11px; color:var(--text-secondary); margin-top:2px;">${i.category || 'GENERAL'} • ${MC_UTILS.formatCurrency(i.price)}</div>
        </div>
      `).join('');
      if(currentItemId) { const active = c.querySelector(`[data-id="${currentItemId}"]`); if(active) active.classList.add('active'); }
    }

    async function selectItem(id) {
      currentItemId = id;
      renderMenu(menuItems); // Re-render para marcar activo
      const item = menuItems.find(x => x.id === id);
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('recipePanel').style.display = 'block';
      document.getElementById('currentItemId').value = id;
      document.getElementById('viewName').innerText = item.name;
      document.getElementById('viewPrice').value = item.price || 0;
      await loadIngredients(id);
    }

    async function loadIngredients(itemId) {
      const { data } = await client.from('recipe_ingredients').select(`id, quantity_needed, unit_needed, inventory_skus (id, name, cost_price, volume_ml, unit_type)`).eq('menu_item_id', itemId);
      const list = data || [];
      const container = document.getElementById('ingList');
      let totalCost = 0;

      container.innerHTML = list.map(ing => {
        const sku = ing.inventory_skus;
        const qty = Number(ing.quantity_needed);
        let cost = 0;
        if (ing.unit_needed === 'un' || sku.unit_type === 'UNIDAD') cost = sku.cost_price * qty;
        else if (ing.unit_needed === 'ml' && sku.volume_ml > 0) cost = (sku.cost_price / sku.volume_ml) * qty;
        else if (ing.unit_needed === 'gr' && sku.unit_type === 'KG') cost = (sku.cost_price / 1000) * qty;
        
        totalCost += cost;
        return `
          <div class="ing-row">
            <div>
                <div style="color:#fff; font-weight:500;">${sku.name}</div>
                <div style="font-size:11px; color:var(--text-secondary);">Base: ${MC_UTILS.formatCurrency(sku.cost_price)}</div>
            </div>
            <div style="text-align:right;">
                <div style="color:#fff;">${qty} ${ing.unit_needed}</div>
                <div style="font-size:11px; color:var(--accent-red);">${MC_UTILS.formatCurrency(cost)}</div>
            </div>
            <button class="btn-icon" onclick="delIng(${ing.id})" style="margin-left:10px;">×</button>
          </div>`;
      }).join('');
      updateKPIs(totalCost);
    }

    function updateKPIs(cost) {
      const price = parseFloat(document.getElementById('viewPrice').value) || 0;
      const margin = price - cost;
      const perc = price > 0 ? (margin / price) * 100 : 0;
      document.getElementById('kpiCost').innerText = MC_UTILS.formatCurrency(cost);
      document.getElementById('kpiMargin').innerText = MC_UTILS.formatCurrency(margin);
      const pEl = document.getElementById('kpiPerc');
      pEl.innerText = Math.round(perc) + '%';
      pEl.style.color = perc < 30 ? 'var(--accent-red)' : 'var(--accent-green)';
    }

    async function addIng() {
        const menuId = document.getElementById('currentItemId').value;
        const skuId = document.getElementById('selSku').value;
        const qty = document.getElementById('newQty').value;
        const unit = document.getElementById('newUnit').value;
        if(!skuId || !qty) return;
        await client.from('recipe_ingredients').insert({ menu_item_id: menuId, sku_id: skuId, quantity_needed: qty, unit_needed: unit });
        document.getElementById('newQty').value = '';
        await loadIngredients(menuId);
    }
    async function delIng(id) {
        await client.from('recipe_ingredients').delete().eq('id', id);
        await loadIngredients(document.getElementById('currentItemId').value);
    }
    async function updatePrice() {
        const id = document.getElementById('currentItemId').value;
        const p = document.getElementById('viewPrice').value;
        await client.from('menu_items').update({ price: p }).eq('id', id);
        const item = menuItems.find(x => x.id == id); if(item) item.price = p;
        await loadIngredients(id);
    }
    async function createItem() {
        const name = prompt('Nombre del producto:'); if(!name) return;
        await client.from('menu_items').insert({ name: name.toUpperCase() });
        location.reload();
    }
    async function deleteItem() {
        if(!confirm('¿Eliminar producto?')) return;
        const id = document.getElementById('currentItemId').value;
        await client.from('recipe_ingredients').delete().eq('menu_item_id', id);
        await client.from('menu_items').delete().eq('id', id);
        location.reload();
    }
  </script>
</body>
</html>