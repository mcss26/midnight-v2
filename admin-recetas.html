<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Recetas</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">LAB</span></div>
    <div class="admin-header-right"><button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button></div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <h2 class="section-title">Recetas & Fichas</h2>
    </div>

    <div class="recipes-layout">
      <aside class="recipes-list-panel">
        <div class="recipes-list-header">
          <button onclick="createItem()" class="btn-primary" style="width:100%; margin-bottom:10px;">+ NUEVO PRODUCTO</button>
          <input type="text" id="searchMenu" class="search-input-admin" placeholder="Buscar..." style="width:100%;">
        </div>
        <div id="menuList" class="menu-list-scroll"></div>
      </aside>

      <section class="recipes-details-panel">
        <div id="emptyState" style="text-align:center; padding:50px; color:var(--text-secondary);">Selecciona un producto para ver su ficha.</div>
        
        <div id="recipePanel" style="display:none;">
          <input type="hidden" id="currentItemId">
          <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <div id="viewName" style="font-family:'Outfit'; font-size:24px; font-weight:700; color:#fff;">--</div>
            <button onclick="deleteItem()" class="btn-secondary" style="border-color:var(--color-admin); color:var(--color-admin);">ELIMINAR</button>
          </div>

          <div style="margin-bottom:20px;">
            <label class="input-label">PRECIO VENTA ($)</label>
            <input type="number" id="viewPrice" class="modal-input" style="max-width:150px;" onchange="updatePrice()">
          </div>

          <div class="kpi-grid">
            <div class="kpi-card"><div class="input-label">COSTO</div><div id="kpiCost" class="kpi-value">$0</div></div>
            <div class="kpi-card"><div class="input-label">MARGEN ($)</div><div id="kpiMargin" class="kpi-value">$0</div></div>
            <div class="kpi-card"><div class="input-label">MARGEN (%)</div><div id="kpiPerc" class="kpi-value">0%</div></div>
          </div>

          <div class="input-label" style="margin-bottom:10px;">INGREDIENTES</div>
          <div id="ingList" style="margin-bottom:20px;"></div>

          <div style="display:flex; gap:10px; align-items:flex-end;">
            <div style="flex:2;"><label class="input-label">INSUMO</label><select id="selSku" class="modal-select"></select></div>
            <div style="flex:1;"><label class="input-label">CANTIDAD</label><input type="number" id="newQty" class="modal-input"></div>
            <div style="width:80px;"><label class="input-label">UNIDAD</label><select id="newUnit" class="modal-select"><option value="ml">ml</option><option value="un">un</option></select></div>
            <button onclick="addIng()" class="btn-primary" style="height:42px;">+</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    let menuItems=[], skus=[], currentItemId=null;
    document.addEventListener('DOMContentLoaded',async()=>{
        const [mR,sR]=await Promise.all([
            client.from('menu_items').select('*').order('name'),
            client.from('inventory_skus').select('id,name,cost_price,volume_ml,unit_type').eq('is_active',true).order('name')
        ]);
        menuItems=mR.data||[]; skus=sR.data||[];
        document.getElementById('selSku').innerHTML='<option value="">--</option>'+skus.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
        renderMenu(menuItems);
        document.getElementById('searchMenu').addEventListener('input',(e)=>renderMenu(menuItems.filter(i=>i.name.toLowerCase().includes(e.target.value.toLowerCase()))));
    });
    function renderMenu(l){
        const c=document.getElementById('menuList');
        if(!l.length){c.innerHTML='<div style="padding:20px;text-align:center;">Vacio</div>';return;}
        c.innerHTML=l.map(i=>`<div class="menu-item-row" data-id="${i.id}" onclick="selectItem(${i.id})">
            <div style="font-weight:600; color:#fff;">${i.name}</div>
            <div style="font-size:11px; color:var(--text-secondary);">${MC_UTILS.formatCurrency(i.price)}</div>
        </div>`).join('');
        if(currentItemId) c.querySelector(`[data-id="${currentItemId}"]`)?.classList.add('active');
    }
    async function selectItem(id){
        currentItemId=id; renderMenu(menuItems);
        const i=menuItems.find(x=>x.id===id);
        document.getElementById('emptyState').style.display='none';
        document.getElementById('recipePanel').style.display='block';
        document.getElementById('currentItemId').value=id;
        document.getElementById('viewName').innerText=i.name;
        document.getElementById('viewPrice').value=i.price;
        await loadIngredients(id);
    }
    async function loadIngredients(mid){
        const{data}=await client.from('recipe_ingredients').select('id,quantity_needed,unit_needed,inventory_skus(name,cost_price,volume_ml,unit_type)').eq('menu_item_id',mid);
        const l=data||[]; let total=0;
        document.getElementById('ingList').innerHTML=l.map(x=>{
            const s=x.inventory_skus, q=Number(x.quantity_needed);
            let cost=0;
            if(x.unit_needed==='un'||s.unit_type==='UNIDAD') cost=s.cost_price*q;
            else if(x.unit_needed==='ml'&&s.volume_ml>0) cost=(s.cost_price/s.volume_ml)*q;
            total+=cost;
            return `<div class="ing-row" style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border-subtle);">
                <div><div style="font-weight:500;">${s.name}</div><div style="font-size:11px; color:var(--text-secondary);">${MC_UTILS.formatCurrency(s.cost_price)} (Base)</div></div>
                <div style="text-align:right;"><div>${q} ${x.unit_needed}</div><div style="color:var(--color-admin); font-size:11px;">${MC_UTILS.formatCurrency(cost)}</div></div>
                <button onclick="delIng(${x.id})" class="btn-icon">×</button>
            </div>`;
        }).join('');
        updateKPI(total);
    }
    function updateKPI(cost){
        const p=parseFloat(document.getElementById('viewPrice').value)||0, m=p-cost, perc=p>0?(m/p)*100:0;
        document.getElementById('kpiCost').innerText=MC_UTILS.formatCurrency(cost);
        document.getElementById('kpiMargin').innerText=MC_UTILS.formatCurrency(m);
        const pe=document.getElementById('kpiPerc'); pe.innerText=Math.round(perc)+'%';
        pe.style.color=perc<30?'var(--color-admin)':'var(--color-operativo)';
    }
    async function addIng(){
        const mid=document.getElementById('currentItemId').value, sid=document.getElementById('selSku').value, qty=document.getElementById('newQty').value, u=document.getElementById('newUnit').value;
        if(!sid||!qty)return;
        await client.from('recipe_ingredients').insert({menu_item_id:mid, sku_id:sid, quantity_needed:qty, unit_needed:u});
        document.getElementById('newQty').value=''; await loadIngredients(mid);
    }
    async function delIng(id){await client.from('recipe_ingredients').delete().eq('id',id); await loadIngredients(document.getElementById('currentItemId').value);}
    async function updatePrice(){
        const id=document.getElementById('currentItemId').value, p=document.getElementById('viewPrice').value;
        await client.from('menu_items').update({price:p}).eq('id',id);
        menuItems.find(x=>x.id==id).price=p; renderMenu(menuItems); await loadIngredients(id);
    }
    async function createItem(){const n=prompt('Nombre:'); if(n) {await client.from('menu_items').insert({name:n.toUpperCase()}); location.reload();}}
    async function deleteItem(){if(confirm('¿Eliminar?')) {await client.from('menu_items').delete().eq('id',document.getElementById('currentItemId').value); location.reload();}}
  </script>
</body>
</html>