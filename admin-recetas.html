<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Recetas</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  
  <style>
    .split-layout { display: grid; grid-template-columns: 320px 1fr; gap: 24px; height: calc(100vh - 120px); }
    @media(max-width:768px){ .split-layout { grid-template-columns: 1fr; height:auto; } }
    
    /* Panel Lateral (Lista) */
    .list-panel { 
        background: var(--mc-surface); border: 1px solid var(--mc-border); 
        border-radius: var(--radius-md); overflow-y: auto; display: flex; flex-direction: column; 
    }
    
    .menu-item-row { 
        padding: 16px 20px; border-bottom: 1px solid var(--mc-border); cursor: pointer; transition: all 0.2s; 
    }
    .menu-item-row:hover { background: var(--mc-surface-hover); }
    .menu-item-row.active { background: #1A1A1A; border-left: 4px solid var(--color-success); padding-left: 16px; }
    
    /* Panel Principal (Detalle) */
    .recipe-details { 
        background: var(--mc-surface); border: 1px solid var(--mc-border); 
        border-radius: var(--radius-md); padding: 32px; 
    }
    
    /* KPIs */
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px; }
    .kpi-card { background: #0A0A0A; border: 1px solid var(--mc-border); padding: 20px; text-align: center; border-radius: var(--radius-sm); }
    .kpi-val { font-family: 'Outfit'; font-size: 26px; font-weight: 700; color: #fff; margin-top: 8px; letter-spacing: -0.03em; }
    .kpi-lbl { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
    
    /* Lista Ingredientes */
    .ing-row { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 14px 0; border-bottom: 1px solid var(--mc-border); 
    }
    .ing-row:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--color-success);">LAB</span></div>
    <button onclick="window.location.href='panel-master.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container" style="max-width:1280px; padding-top:20px;">
    <div class="split-layout">
        
        <div class="list-panel">
            <div style="padding:16px; background:var(--mc-surface); border-bottom:1px solid var(--mc-border); position:sticky; top:0;">
                <button onclick="createItem()" class="btn-primary" style="width:100%;">+ NUEVO PRODUCTO</button>
                <input type="text" id="searchMenu" class="search-input-admin" placeholder="ðŸ” Buscar..." style="margin-top:12px; margin-bottom:0;">
            </div>
            <div id="menuList" style="flex:1;">
                <div style="padding:20px; text-align:center; color:var(--text-secondary);">Cargando...</div>
            </div>
        </div>

        <div id="recipePanel" class="recipe-details" style="display:none;">
            <input type="hidden" id="currentItemId">
            
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px;">
                <div>
                    <h2 id="viewName" style="margin:0; font-family:'Outfit'; font-size:32px; color:#fff;">--</h2>
                    <div style="margin-top:12px; display:flex; align-items:center; gap:12px;">
                        <span class="input-label" style="margin:0;">PRECIO VENTA AL PÃšBLICO</span>
                        <div style="position:relative;">
                            <span style="position:absolute; left:12px; top:13px; color:var(--text-secondary);">$</span>
                            <input type="number" id="viewPrice" class="modal-input" style="width:140px; padding-left:25px; background:#000;" onchange="updatePrice()">
                        </div>
                    </div>
                </div>
                <button onclick="deleteItem()" style="color:var(--color-danger); border:1px solid var(--color-danger); background:rgba(255, 69, 58, 0.1); padding:10px 16px; border-radius:100px; cursor:pointer; font-weight:700; font-size:11px; text-transform:uppercase;">ELIMINAR</button>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-lbl">COSTO INSUMOS</div>
                    <div class="kpi-val" id="kpiCost" style="color:var(--color-danger);">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">MARGEN BRUTO</div>
                    <div class="kpi-val" id="kpiMargin" style="color:#fff;">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-lbl">RENTABILIDAD</div>
                    <div class="kpi-val" id="kpiPerc">0%</div>
                </div>
            </div>

            <h3 class="section-title" style="font-size:14px; color:var(--text-secondary); margin-bottom:15px; border-bottom:1px solid var(--mc-border); padding-bottom:10px;">COMPOSICIÃ“N (ESCANDALLO)</h3>
            
            <div id="ingList" style="margin-bottom:30px;"></div>

            <div style="background:rgba(255,255,255,0.03); padding:20px; border-radius:10px; border:1px dashed var(--mc-border); display:flex; gap:15px; align-items:flex-end;">
                <div style="flex:3;">
                    <label class="input-label">INSUMO</label>
                    <select id="selSku" class="modal-select"></select>
                </div>
                <div style="flex:1;">
                    <label class="input-label">CANTIDAD</label>
                    <input type="number" id="newQty" class="modal-input" placeholder="0">
                </div>
                <div style="width:80px;">
                    <label class="input-label">UNIDAD</label>
                    <select id="newUnit" class="modal-select">
                        <option value="ml">ml</option>
                        <option value="un">un</option>
                        <option value="gr">gr</option>
                    </select>
                </div>
                <button onclick="addIng()" class="btn-primary" style="height:46px; padding:0 24px;">AGREGAR</button>
            </div>
        </div>

        <div id="emptyState" class="recipe-details" style="display:flex; justify-content:center; align-items:center; color:var(--text-secondary); flex-direction:column;">
            <div style="font-size:40px; margin-bottom:15px; opacity:0.3;">ðŸ“‹</div>
            <p>Selecciona un producto para editar su receta.</p>
        </div>
    </div>
  </div>

  <script>
    let menuItems = [], skus = [];
    
    window.onload = async () => {
        const [m, s] = await Promise.all([
            client.from('menu_items').select('*').order('name'),
            client.from('inventory_skus').select('id, name, unit_type, cost_price, volume_ml').order('name')
        ]);
        menuItems = m.data||[]; skus = s.data||[];
        renderMenu(menuItems);
        document.getElementById('selSku').innerHTML = '<option value="">Seleccionar insumo...</option>' + 
            skus.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
    };

    function renderMenu(list) {
        const c = document.getElementById('menuList');
        if(!list.length) { c.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary);">VacÃ­o</div>'; return; }
        
        c.innerHTML = list.map(i => `
            <div class="menu-item-row" onclick="selectItem(${i.id}, this)">
                <div style="font-weight:600; color:var(--text-primary); font-size:15px;">${i.name}</div>
                <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">${MC_UTILS.formatCurrency(i.price)}</div>
            </div>`).join('');
    }

    async function selectItem(id, el) {
        document.querySelectorAll('.menu-item-row').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('emptyState').style.display='none';
        document.getElementById('recipePanel').style.display='block';
        const item = menuItems.find(x=>x.id===id);
        document.getElementById('currentItemId').value=item.id;
        document.getElementById('viewName').innerText=item.name;
        document.getElementById('viewPrice').value=item.price;
        loadIngredients(id);
    }

    async function loadIngredients(itemId) {
        const { data } = await client.from('recipe_ingredients')
            .select(`id, quantity_needed, unit_needed, inventory_skus(id, name, cost_price, volume_ml, unit_type)`)
            .eq('menu_item_id', itemId);
        
        let total = 0;
        const c = document.getElementById('ingList');
        
        if(!data || !data.length) c.innerHTML = '<div style="color:var(--text-secondary); font-style:italic; padding:15px 0;">Sin ingredientes definidos.</div>';
        else c.innerHTML = data.map(ing => {
            const sku = ing.inventory_skus;
            let cost = 0;
            // CÃ¡lculo de costo proporcional
            if(ing.unit_needed === 'un' || sku.unit_type==='UNIDAD') cost = sku.cost_price * ing.quantity_needed;
            else if(ing.unit_needed === 'ml' && sku.volume_ml>0) cost = (sku.cost_price / sku.volume_ml) * ing.quantity_needed;
            total += cost;
            
            return `
            <div class="ing-row">
                <div>
                    <div style="color:var(--text-primary); font-weight:500;">${sku.name}</div>
                    <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">
                        ${ing.quantity_needed} ${ing.unit_needed} 
                        <span style="opacity:0.6;">(Base: $${sku.cost_price})</span>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:700; color:var(--text-primary); font-family:monospace;">${MC_UTILS.formatCurrency(cost)}</div>
                    <button onclick="delIng(${ing.id})" style="color:var(--color-danger); background:none; border:none; font-size:10px; font-weight:700; cursor:pointer; margin-top:2px;">QUITAR</button>
                </div>
            </div>`;
        }).join('');
        
        updateKPIs(total);
    }

    function updateKPIs(cost) {
        const p = parseFloat(document.getElementById('viewPrice').value)||0;
        const m = p - cost;
        const perc = p>0 ? (m/p)*100 : 0;
        document.getElementById('kpiCost').innerText = MC_UTILS.formatCurrency(cost);
        document.getElementById('kpiMargin').innerText = MC_UTILS.formatCurrency(m);
        const el = document.getElementById('kpiPerc');
        el.innerText = Math.round(perc)+'%';
        if(perc<30) el.style.color='var(--color-danger)'; else if(perc<60) el.style.color='var(--color-warning)'; else el.style.color='var(--color-success)';
    }

    async function addIng() {
        const mid = document.getElementById('currentItemId').value;
        const sid = document.getElementById('selSku').value;
        const qty = document.getElementById('newQty').value;
        const unit = document.getElementById('newUnit').value;
        if(!sid || !qty) return;
        await client.from('recipe_ingredients').insert({menu_item_id:mid, sku_id:sid, quantity_needed:qty, unit_needed:unit});
        document.getElementById('newQty').value='';
        loadIngredients(mid);
    }
    
    async function delIng(id) {
        await client.from('recipe_ingredients').delete().eq('id',id);
        loadIngredients(document.getElementById('currentItemId').value);
    }

    async function updatePrice() {
        const id = document.getElementById('currentItemId').value;
        const val = document.getElementById('viewPrice').value;
        await client.from('menu_items').update({price:val}).eq('id',id);
        menuItems.find(x=>x.id==id).price=val;
        loadIngredients(id);
    }

    async function createItem() {
        const n = prompt("Nombre del producto:"); if(!n)return;
        const {data,error} = await client.from('menu_items').insert({name:n.toUpperCase()}).select().single();
        if(!error) { menuItems.push(data); renderMenu(menuItems); selectItem(data.id, document.body); }
    }
    async function deleteItem() {
        if(confirm("Â¿Eliminar este producto?")) {
            await client.from('menu_items').delete().eq('id',document.getElementById('currentItemId').value);
            window.location.reload();
        }
    }
    document.getElementById('searchMenu').oninput = (e) => {
        renderMenu(menuItems.filter(i=>i.name.toLowerCase().includes(e.target.value.toLowerCase())));
    }
  </script>
</body>
</html>