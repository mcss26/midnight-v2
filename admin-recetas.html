<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midnight - Recetas</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap"
    rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>

<body>

  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div style="display:flex; align-items:center;">
          <button onclick="window.location.href='panel-master.html'" class="btn-back" type="button">
            VOLVER
          </button>
        </div>
        <div class="admin-logo" aria-hidden="true"></div>
        <div class="admin-header-right">
          <span class="session-chip">Master Data</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <section class="section-header">
      <h1 class="section-title">INGENIER√çA DE MEN√ö</h1>
      <p class="section-desc">Gesti√≥n de fichas t√©cnicas, costos y recetas.</p>
    </section>

    <div class="recipes-layout">

      <!-- PANEL IZQUIERDO: LISTA DE PRODUCTOS -->
      <aside class="recipes-list-panel">
        <div class="recipes-list-header">
          <div style="display:flex; gap:10px; margin-bottom:12px;">
            <button id="btnNewItem" class="btn-primary" style="flex:1;">+ NUEVO</button>
          </div>

          <input type="text" id="searchMenu" class="search-input-admin" placeholder="üîç Buscar producto..."
            style="margin-bottom:12px;">

          <div
            style="display:flex; justify-content:space-between; align-items:center; font-size:11px; color:var(--text-secondary);">
            <span id="countMenu" class="tag tag-gray">0 items</span>
            <span>VASO EST√ÅNDAR: 400ml</span>
          </div>
        </div>

        <div id="menuList" class="menu-list-scroll"></div>
      </aside>

      <!-- PANEL DERECHO: DETALLE DE RECETA -->
      <section class="recipes-details-panel">

        <div id="emptyState" style="text-align:center; padding:80px 20px; color:var(--text-secondary);">
          <div style="font-size:40px; margin-bottom:10px; opacity:0.3;">üìã</div>
          Seleccion√° un producto de la lista para ver su ficha t√©cnica.
        </div>

        <div id="recipePanel" style="display:none; height:100%; display:flex; flex-direction:column;">
          <input type="hidden" id="currentItemId">

          <div class="recipe-topbar">
            <div>
              <h2 id="viewName" class="recipe-name">‚Äî</h2>
              <div id="viewMeta" style="font-size:12px; color:var(--text-tertiary); margin-top:4px;">‚Äî</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span id="pillRecipeState" class="tag tag-gray">SIN RECETA</span>
              <button id="btnDeleteItem" class="btn-secondary"
                style="color:var(--accent-red); border-color:rgba(255,10,30,0.3);" title="Eliminar producto"
                type="button">
                ‚úï
              </button>
            </div>
          </div>

          <div class="box-soft" style="margin-bottom:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
              <div style="width:160px;">
                <label class="input-label">PRECIO VENTA ($)</label>
                <input type="number" id="viewPrice" class="modal-input" min="0" step="1" placeholder="0">
              </div>
              <div id="saveStatus" class="inline-status">‚Äî</div>
            </div>

            <div class="kpi-grid">
              <div class="kpi-card">
                <div class="input-label">COSTO</div>
                <div id="kpiCost" class="kpi-value">$0</div>
              </div>
              <div class="kpi-card">
                <div class="input-label">COSTO %</div>
                <div id="kpiCostPct" class="kpi-value">0%</div>
              </div>
              <div class="kpi-card">
                <div class="input-label">MARGEN $</div>
                <div id="kpiMargin" class="kpi-value">$0</div>
              </div>
              <div class="kpi-card">
                <div class="input-label">MARGEN %</div>
                <div id="kpiMarginPct" class="kpi-value">0%</div>
              </div>
            </div>
          </div>

          <div class="box-soft" style="margin:16px 0;">
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:6px;">
              <span style="color:var(--text-secondary);">VOLUMEN ESTIMADO (Target: 400ml)</span>
              <span id="volText" style="color:var(--text-primary); font-weight:700;">0 ml</span>
            </div>
            <div class="progress-track">
              <div id="volFill" class="progress-fill" style="width:0%;"></div>
            </div>
          </div>

          <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:8px;">
              <label class="input-label">INGREDIENTES</label>
              <span id="ingCount" class="tag tag-gray" style="font-size:9px;">0 insumos</span>
            </div>

            <div class="table-container" style="flex:1; margin-bottom:0;">
              <table class="sku-table">
                <thead>
                  <tr>
                    <th style="padding-left:16px;">INSUMO</th>
                    <th>TIPO</th>
                    <th class="text-right">BASE</th>
                    <th class="text-center" style="width:100px;">CANT</th>
                    <th class="text-center" style="width:80px;">UNID</th>
                    <th class="text-right">COSTO</th>
                    <th style="width:50px;"></th>
                  </tr>
                </thead>
                <tbody id="ingTableBody"></tbody>
              </table>
            </div>
          </div>

          <div
            style="background:var(--bg-card); border-top:1px solid var(--border-subtle); padding-top:16px; margin-top:16px;">
            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
              <div style="flex:1;">
                <label class="input-label">BUSCAR INSUMO</label>
                <input id="skuFilter" class="modal-input" placeholder="Filtrar lista..." />
              </div>
              <div style="flex:1.5; min-width:200px;">
                <label class="input-label">SELECCIONAR</label>
                <select id="selSku" class="modal-select"></select>
              </div>
              <div style="width:90px;">
                <label class="input-label">CANTIDAD</label>
                <input type="number" id="newQty" class="modal-input" placeholder="0">
              </div>
              <div style="width:80px;">
                <label class="input-label">UNIDAD</label>
                <select id="newUnit" class="modal-select">
                  <option value="ml">ml</option>
                  <option value="un">un</option>
                </select>
              </div>
              <button id="btnAddIng" class="btn-primary" style="height:40px;">AGREGAR</button>
            </div>
          </div>

        </div>
      </section>
    </div>
  </main>

  <script>
    // =========================================
    // CONFIG & ESTADO
    // =========================================
    const GLASS_ML = 400; // referencia de volumen objetivo

    let menuItems = [];
    let skus = [];
    let currentItemId = null;
    let menuSearchTerm = '';

    document.addEventListener('DOMContentLoaded', async () => {
      setStatus('Cargando...');
      await loadInitialData();
      setupEventListeners();
      setStatus('');
    });

    // =========================================
    // CARGA INICIAL
    // =========================================
    async function loadInitialData() {
      try {
        const [resMenu, resSkus] = await Promise.all([
          client.from('menu_items')
            .select('id, name, category, price, is_active')
            .order('name'),
          client.from('inventory_skus')
            .select('id, name, external_id, cost_price, volume_ml, unit_type, pack_size, unit_label, is_active')
            .eq('is_active', true)
            .order('name')
        ]);

        if (resMenu.error) throw resMenu.error;
        if (resSkus.error) throw resSkus.error;

        menuItems = resMenu.data || [];
        skus = resSkus.data || [];

        renderMenuList();
        renderSkuSelect();
        updateMenuCount();
      } catch (err) {
        console.error(err);
        const list = document.getElementById('menuList');
        if (list) {
          list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--accent-red);">Error al cargar datos.</div>';
        }
      }
    }

    // =========================================
    // FILTRO Y LISTA DE PRODUCTOS
    // =========================================
    function getFilteredMenuItems() {
      const term = (menuSearchTerm || '').toLowerCase();
      if (!term) return menuItems;
      return menuItems.filter(i => i.name.toLowerCase().includes(term));
    }

    function renderMenuList() {
      const container = document.getElementById('menuList');
      if (!container) return;

      const items = getFilteredMenuItems();

      if (!items.length) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-secondary);">Sin resultados.</div>';
        updateMenuCount();
        return;
      }

      container.innerHTML = items.map(item => {
        const isActive = item.is_active !== false;
        const hasCurrency = window.MC_UTILS && typeof window.MC_UTILS.formatCurrency === 'function';
        const priceRaw = Number(item.price || 0);
        const priceText = hasCurrency
          ? window.MC_UTILS.formatCurrency(priceRaw)
          : `$${priceRaw.toFixed(0)}`;

        const offTag = isActive ? '' : '<span class="tag tag-red" style="margin-left:6px;">OFF</span>';

        return `
          <div class="menu-item-row ${currentItemId === item.id ? 'active' : ''}" onclick="selectItem(${item.id})">
            <div>
              <div style="font-weight:600; font-size:13px; color:#fff;">
                ${escapeHtml(item.name)} ${offTag}
              </div>
              <div style="font-size:11px; color:var(--text-secondary);">${priceText}</div>
            </div>
            <span class="tag tag-gray" style="font-size:9px;">#${item.id}</span>
          </div>
        `;
      }).join('');

      updateMenuCount();
    }

    function updateMenuCount() {
      const el = document.getElementById('countMenu');
      if (!el) return;
      const visible = getFilteredMenuItems().length;
      el.innerText = `${visible} items`;
    }

    // =========================================
    // SELECT DE SKUS PARA INGREDIENTES
    // =========================================
    function renderSkuSelect() {
      const sel = document.getElementById('selSku');
      if (!sel) return;

      sel.innerHTML = '<option value="">-- Seleccionar Insumo --</option>' +
        skus.map(s => {
          let meta = '';
          if (s.unit_label === 'PACK' && s.pack_size) meta += ` [PACK x${s.pack_size}]`;
          if (s.volume_ml) meta += ` (${s.volume_ml}ml)`;
          return `<option value="${s.id}">${escapeHtml(s.name)}${meta}</option>`;
        }).join('');
    }

    function focusSkuByText(text) {
      const sel = document.getElementById('selSku');
      if (!sel) return;

      const term = (text || '').toLowerCase();

      // Si borr√°s el filtro, des-selecciona
      if (!term) {
        sel.value = '';
        return;
      }

      const options = Array.from(sel.options);
      const match = options.find(opt =>
        opt.value && opt.text.toLowerCase().includes(term)
      );

      if (match) {
        sel.value = match.value; // mueve el select al primer match
      }
    }


    // =========================================
    // SELECCI√ìN DE ITEM Y CARGA DE RECETA
    // =========================================
    async function selectItem(id) {
      currentItemId = id;

      const emptyState = document.getElementById('emptyState');
      const recipePanel = document.getElementById('recipePanel');
      if (emptyState) emptyState.style.display = 'none';
      if (recipePanel) recipePanel.style.display = 'flex';

      const item = menuItems.find(i => i.id === id);
      if (!item) return;

      document.getElementById('currentItemId').value = item.id;
      document.getElementById('viewName').innerText = item.name;

      const metaParts = [`ITEM #${item.id}`];
      if (item.category) metaParts.push(item.category);
      document.getElementById('viewMeta').innerText = metaParts.join(' ¬∑ ');

      document.getElementById('viewPrice').value = item.price || 0;

      renderMenuList();
      await loadRecipe(id);
    }

    async function loadRecipe(menuId) {
      setStatus('Cargando receta...');

      try {
        const { data, error } = await client
          .from('recipe_ingredients')
          .select('id, quantity_needed, unit_needed, inventory_skus ( id, name, cost_price, volume_ml, unit_type )')
          .eq('menu_item_id', menuId);

        if (error) throw error;
        renderIngredients(data || []);
      } catch (err) {
        console.error(err);
        const tbody = document.getElementById('ingTableBody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding:20px;">Error al cargar receta.</td></tr>';
        }
      } finally {
        setStatus('');
      }
    }

    // =========================================
    // RENDER INGREDIENTES + KPIs
    // =========================================
    function renderIngredients(ingredients) {
      const tbody = document.getElementById('ingTableBody');
      const pill = document.getElementById('pillRecipeState');
      const ingCount = document.getElementById('ingCount');
      if (!tbody || !pill || !ingCount) return;

      let totalCost = 0;
      let totalVol = 0;

      if (!ingredients.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted" style="padding:20px;">Sin ingredientes asignados.</td></tr>';
        pill.className = 'tag tag-gray';
        pill.innerText = 'SIN RECETA';
        ingCount.innerText = '0 insumos';
        updateKPIs(0);
        updateVolumeBar(0);
        return;
      }

      pill.className = 'tag tag-green';
      pill.innerText = 'CON RECETA';

      const hasCurrency = window.MC_UTILS && typeof window.MC_UTILS.formatCurrency === 'function';

      tbody.innerHTML = ingredients.map(ing => {
        const sku = ing.inventory_skus || {};
        const qty = Number(ing.quantity_needed) || 0;
        const unit = ing.unit_needed || 'ml';

        const skuCost = Number(sku.cost_price) || 0;
        const skuVol = Number(sku.volume_ml) || 0;

        let cost = 0;
        if (unit === 'ml' && skuVol > 0) {
          cost = (skuCost / skuVol) * qty;
          totalVol += qty;
        } else {
          cost = skuCost * qty;
          if (skuVol > 0) {
            totalVol += skuVol * qty;
          }
        }

        totalCost += cost;

        const baseCostText = hasCurrency
          ? window.MC_UTILS.formatCurrency(skuCost)
          : `$${skuCost.toFixed(2)}`;

        const costText = hasCurrency
          ? window.MC_UTILS.formatCurrency(cost)
          : `$${cost.toFixed(2)}`;

        return `
          <tr>
            <td>
              <div class="row-title">${escapeHtml(sku.name || '-')}</div>
            </td>
            <td class="text-center" style="font-size:11px; color:var(--text-secondary);">
              ${sku.unit_type || '-'}
            </td>
            <td class="text-right text-muted">${baseCostText}</td>
            <td class="text-center">
              <input
                type="number"
                class="table-input"
                value="${qty}"
                min="0"
                onchange="updateIng(${ing.id}, 'qty', this.value)"
              >
            </td>
            <td class="text-center">
              <select
                class="table-input"
                onchange="updateIng(${ing.id}, 'unit', this.value)"
                style="width:100%;"
              >
                <option value="ml" ${unit === 'ml' ? 'selected' : ''}>ml</option>
                <option value="un" ${unit === 'un' ? 'selected' : ''}>un</option>
              </select>
            </td>
            <td class="text-right col-costo">${costText}</td>
            <td class="text-center">
              <button
                class="btn-icon"
                style="color:var(--accent-red); border:none;"
                type="button"
                onclick="deleteIng(${ing.id})"
              >√ó</button>
            </td>
          </tr>
        `;
      }).join('');

      ingCount.innerText = `${ingredients.length} insumos`;
      updateKPIs(totalCost);
      updateVolumeBar(totalVol);
    }

    function updateKPIs(costValue) {
      const priceInput = document.getElementById('viewPrice');
      if (!priceInput) return;

      const price = parseFloat(priceInput.value) || 0;
      const cost = Number(costValue) || 0;
      const margin = price - cost;
      const costPct = price > 0 ? (cost / price) * 100 : 0;
      const marginPct = price > 0 ? 100 - costPct : 0;

      const costEl = document.getElementById('kpiCost');
      const costPctEl = document.getElementById('kpiCostPct');
      const marginEl = document.getElementById('kpiMargin');
      const marginPctEl = document.getElementById('kpiMarginPct');

      const hasCurrency = window.MC_UTILS && typeof window.MC_UTILS.formatCurrency === 'function';

      const costText = hasCurrency
        ? window.MC_UTILS.formatCurrency(cost)
        : `$${cost.toFixed(0)}`;

      const marginText = hasCurrency
        ? window.MC_UTILS.formatCurrency(margin)
        : `$${margin.toFixed(0)}`;

      costEl.innerText = costText;
      costPctEl.innerText = `${costPct.toFixed(1)}%`;
      marginEl.innerText = marginText;
      marginPctEl.innerText = `${marginPct.toFixed(1)}%`;

      if (marginPct < 30) {
        marginPctEl.style.color = 'var(--accent-red)';
      } else if (marginPct > 70) {
        marginPctEl.style.color = 'var(--accent-green)';
      } else {
        marginPctEl.style.color = 'var(--text-primary)';
      }
    }

    function updateVolumeBar(ml) {
      const volFill = document.getElementById('volFill');
      const volText = document.getElementById('volText');
      if (!volFill || !volText) return;

      const vol = Number(ml) || 0;
      const pct = Math.min((vol / GLASS_ML) * 100, 100);

      volFill.style.width = `${pct}%`;
      volText.innerText = `${Math.round(vol)} ml`;

      if (vol > GLASS_ML) {
        volFill.style.backgroundColor = 'var(--accent-red)';
      } else {
        volFill.style.backgroundColor = 'var(--accent-green)';
      }
    }

    // =========================================
    // CRUD INGREDIENTES
    // =========================================
    async function updateIng(id, field, val) {
      if (!id) return;
      const payload = {};

      if (field === 'qty') {
        const num = parseFloat(val);
        if (!Number.isFinite(num) || num <= 0) {
          alert('Cantidad inv√°lida.');
          return;
        }
        payload.quantity_needed = num;
      } else if (field === 'unit') {
        payload.unit_needed = val;
      } else {
        return;
      }

      try {
        const { error } = await client.from('recipe_ingredients').update(payload).eq('id', id);
        if (error) throw error;
        if (currentItemId) await loadRecipe(currentItemId);
      } catch (err) {
        console.error(err);
        alert('Error al guardar ingrediente.');
      }
    }

    async function addIng() {
      if (!currentItemId) {
        alert('Seleccion√° primero un producto.');
        return;
      }

      const skuVal = document.getElementById('selSku').value;
      const qtyVal = document.getElementById('newQty').value;
      const unit = document.getElementById('newUnit').value;

      const skuId = skuVal ? parseInt(skuVal, 10) : null;
      const qty = parseFloat(qtyVal);

      if (!skuId || !Number.isFinite(qty) || qty <= 0) {
        alert('Seleccion√° insumo y cantidad v√°lida.');
        return;
      }

      try {
        const { error } = await client.from('recipe_ingredients').insert({
          menu_item_id: currentItemId,
          sku_id: skuId,
          quantity_needed: qty,
          unit_needed: unit
        });
        if (error) throw error;

        document.getElementById('newQty').value = '';
        document.getElementById('newUnit').value = 'ml';
        document.getElementById('selSku').value = '';

        await loadRecipe(currentItemId);
      } catch (err) {
        console.error(err);
        alert('Error al agregar ingrediente.');
      }
    }

    async function deleteIng(id) {
      if (!id) return;
      if (!confirm('¬øQuitar ingrediente?')) return;

      try {
        const { error } = await client.from('recipe_ingredients').delete().eq('id', id);
        if (error) throw error;
        if (currentItemId) await loadRecipe(currentItemId);
      } catch (err) {
        console.error(err);
        alert('Error al quitar ingrediente.');
      }
    }

    // =========================================
    // CRUD PRODUCTOS (MENU_ITEMS)
    // =========================================
    async function updatePrice() {
      if (!currentItemId) return;

      const priceVal = document.getElementById('viewPrice').value;
      const price = parseFloat(priceVal) || 0;

      try {
        setStatus('Guardando precio...');
        const { error } = await client.from('menu_items')
          .update({ price: price })
          .eq('id', currentItemId);
        if (error) throw error;

        const item = menuItems.find(i => i.id === currentItemId);
        if (item) item.price = price;

        renderMenuList();
        await loadRecipe(currentItemId);
        setStatus('Guardado');
        setTimeout(() => setStatus(''), 1200);
      } catch (err) {
        console.error(err);
        alert('Error al guardar precio.');
        setStatus('');
      }
    }

    async function createItem() {
      const name = prompt('Nombre del nuevo producto:');
      if (!name) return;

      try {
        const { data, error } = await client.from('menu_items')
          .insert({
            name: name.toUpperCase().trim(),
            price: 0,
            is_active: true
          })
          .select()
          .single();

        if (error) throw error;

        menuItems.push(data);
        menuItems.sort((a, b) => a.name.localeCompare(b.name));

        renderMenuList();
        selectItem(data.id);
      } catch (err) {
        console.error(err);
        alert('Error al crear producto.');
      }
    }

    async function deleteItem() {
      if (!currentItemId) return;
      if (!confirm('¬øEliminar este producto y su receta?')) return;

      try {
        const { error } = await client.from('menu_items').delete().eq('id', currentItemId);
        if (error) throw error;

        menuItems = menuItems.filter(i => i.id !== currentItemId);
        currentItemId = null;

        renderMenuList();

        const emptyState = document.getElementById('emptyState');
        const recipePanel = document.getElementById('recipePanel');
        if (emptyState) emptyState.style.display = 'block';
        if (recipePanel) recipePanel.style.display = 'none';

        setStatus('');
      } catch (err) {
        console.error(err);
        alert('Error al eliminar producto.');
      }
    }

    // =========================================
    // UI HELPERS
    // =========================================
    function setStatus(msg) {
      const el = document.getElementById('saveStatus');
      if (el) el.innerText = msg || '‚Äî';
    }

    function setupEventListeners() {
      const searchMenu = document.getElementById('searchMenu');
      if (searchMenu) {
        searchMenu.addEventListener('input', (e) => {
          menuSearchTerm = e.target.value;
          renderMenuList();
        });
      }

      const skuFilter = document.getElementById('skuFilter');
      if (skuFilter) {
        skuFilter.addEventListener('input', (e) => {
          focusSkuByText(e.target.value);
        });
      }


      const btnNewItem = document.getElementById('btnNewItem');
      if (btnNewItem) btnNewItem.onclick = createItem;

      const btnAddIng = document.getElementById('btnAddIng');
      if (btnAddIng) btnAddIng.onclick = addIng;

      const btnDeleteItem = document.getElementById('btnDeleteItem');
      if (btnDeleteItem) btnDeleteItem.onclick = deleteItem;

      const viewPrice = document.getElementById('viewPrice');
      if (viewPrice) viewPrice.onchange = updatePrice;
    }

    // =========================================
    // UTILS
    // =========================================
    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
  </script>
</body>

</html>