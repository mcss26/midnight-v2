<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Logs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div class="admin-logo" aria-hidden="true"></div>
        <div class="admin-header-right">
          <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
        </div>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <div><h2 class="section-title">Auditor√≠a</h2><p class="section-desc">Bit√°cora de seguridad.</p></div>
      <button class="btn-secondary" onclick="loadLogs()">REFRESCAR</button>
    </div>
    <input type="text" id="searchLogs" class="search-input-admin" placeholder="üîç Buscar actividad..." oninput="filterLogs()">
    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr><th style="padding-left:25px; width:150px;">FECHA</th><th style="width:150px;">USUARIO</th><th style="width:150px;">ACCI√ìN</th><th>DETALLE</th></tr>
        </thead>
        <tbody id="logsList"></tbody>
      </table>
    </div>
  </div>

  <script>
    let logs=[], profiles={};
    document.addEventListener('DOMContentLoaded',loadLogs);
    async function loadLogs(){
        const{data}=await client.from('admin_logs').select('*').order('created_at',{ascending:false}).limit(100);
        logs=data||[];
        const uids=[...new Set(logs.map(l=>l.admin_id).filter(Boolean))];
        if(uids.length){
            const{data:usrs}=await client.from('profiles').select('id,username').in('id',uids);
            (usrs||[]).forEach(u=>profiles[u.id]=u.username);
        }
        renderLogs(logs);
    }
    function renderLogs(l){
        document.getElementById('logsList').innerHTML=l.map(x=>{
            const usr=profiles[x.admin_id]||'Sistema';
            const cls=x.action.includes('ERROR')||x.action.includes('DELETE')?'tag-red':(x.action.includes('CREATE')?'tag-green':'tag-gray');
            return `<tr>
                <td style="padding-left:25px; font-size:12px; color:var(--text-secondary);">${new Date(x.created_at).toLocaleString()}</td>
                <td style="font-weight:600;">${usr}</td>
                <td><span class="tag ${cls}">${x.action}</span></td>
                <td style="color:var(--text-secondary);">${x.details||'-'}</td>
            </tr>`;
        }).join('');
    }
    function filterLogs(){renderLogs(logs.filter(x=>(x.details||'').toLowerCase().includes(document.getElementById('searchLogs').value.toLowerCase())));}
  </script>
</body>
</html>
