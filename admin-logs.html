<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Logs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span class="logo-accent">LOGS</span></div>
    <div class="admin-header-right">
        <button onclick="window.location.href='panel-master.html'" class="btn-back">VOLVER</button>
    </div>
  </header>

  <div class="admin-container">
    <div class="section-header">
      <div>
        <h2 class="section-title">Registro de actividad</h2>
        <p class="section-desc">Bitácora automática de cambios y acciones.</p>
      </div>
      <button class="btn-secondary" onclick="reloadLogs()">REFRESCAR</button>
    </div>

    <input
      type="text"
      id="searchLogs"
      class="search-input-admin"
      placeholder="Buscar por usuario, acción o detalle..."
      oninput="filterLogs()"
    >

    <div class="table-container" style="margin-top:18px;">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left:20px; width:170px;">FECHA / HORA</th>
            <th style="width:160px;">USUARIO</th>
            <th style="width:180px;">ACCIÓN</th>
            <th>DETALLE</th>
          </tr>
        </thead>
        <tbody id="logsList">
          <tr>
            <td colspan="4" style="text-align:center; padding:40px; color:var(--text-secondary);">
              Cargando logs recientes...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let logs = [];
    let profilesMap = {};
    document.addEventListener('DOMContentLoaded', () => { loadLogs(); });

    async function reloadLogs() { await loadLogs(); }

    async function loadLogs() {
      const tbody = document.getElementById('logsList');
      try {
        const { data, error } = await client.from('admin_logs').select('*').order('created_at', { ascending: false }).limit(200);
        if (error) throw error;
        logs = data || [];
        await hydrateProfiles();
        renderLogs(logs);
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--state-error);">Error al cargar logs.</td></tr>';
      }
    }

    async function hydrateProfiles() {
      profilesMap = {};
      const ids = Array.from(new Set(logs.map(l => l.admin_id).filter(v => !!v)));
      if (!ids.length) return;
      const { data } = await client.from('profiles').select('id, full_name, username').in('id', ids);
      (data || []).forEach(p => { profilesMap[p.id] = p; });
    }

    function formatDateTime(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return d.toLocaleString('es-AR', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function renderLogs(list) {
      const tbody = document.getElementById('logsList');
      if (!list.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--text-secondary);">Sin actividad registrada.</td></tr>'; return; }

      tbody.innerHTML = list.map(log => {
        let actor = 'Sistema';
        if (log.admin_id && profilesMap[log.admin_id]) {
          const p = profilesMap[log.admin_id];
          actor = p.full_name || p.username || actor;
        }
        const action = log.action || '-';
        let tagClass = 'tag-gray';
        if (action.includes('INSERT') || action.includes('CREATE')) tagClass = 'tag-green';
        if (action.includes('DELETE') || action.includes('ERROR')) tagClass = 'tag-red';

        return `
          <tr>
            <td style="padding-left:20px; font-family:monospace; color:var(--text-secondary); font-size:12px;">${formatDateTime(log.created_at)}</td>
            <td style="font-size:13px; font-weight:500;">${actor}</td>
            <td><span class="tag ${tagClass}">${action}</span></td>
            <td style="color:var(--text-secondary); font-size:13px;">${log.details || '-'}</td>
          </tr>`;
      }).join('');
    }

    function filterLogs() {
      const t = document.getElementById('searchLogs').value.toLowerCase();
      renderLogs(logs.filter(log => {
        let actor = '';
        if (log.admin_id && profilesMap[log.admin_id]) {
          const p = profilesMap[log.admin_id];
          actor = (p.full_name || p.username || '').toLowerCase();
        }
        return (log.action||'').toLowerCase().includes(t) || (log.details||'').toLowerCase().includes(t) || actor.includes(t);
      }));
    }
  </script>
</body>
</html>