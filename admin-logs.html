<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Logs</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--mc-red);">LOGS</span></div>
    <button onclick="window.location.href='panel-master.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <div>
            <h2 class="section-title">Auditoría de Seguridad</h2>
            <p style="color:#666; font-size:12px;">Registro de movimientos y accesos</p>
        </div>
        <button onclick="loadLogs()" class="btn-refresh">↻ REFRESCAR</button>
    </div>

    <div class="table-responsive">
        <table class="sku-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Usuario / Actor</th>
                    <th>Acción</th>
                    <th>Detalle</th>
                </tr>
            </thead>
            <tbody id="logsBody"><tr><td colspan="4" style="text-align:center;">Cargando...</td></tr></tbody>
        </table>
    </div>
  </div>

  <script>
    window.onload = async () => {
        await loadLogs();
    };

    async function loadLogs() {
        const tbody = document.getElementById('logsBody');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Cargando registros...</td></tr>';

        const { data, error } = await client
            .from('admin_logs')
            .select('created_at, action, details, profiles(username, full_name)')
            .order('created_at', { ascending: false })
            .limit(100);

        if (error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:var(--mc-red);">Error cargando logs.</td></tr>';
            return;
        }
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Sin registros recientes.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(log => {
            const date = new Date(log.created_at).toLocaleString('es-AR', { 
                day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' 
            });
            const actor = log.profiles ? (log.profiles.full_name || log.profiles.username) : 'Sistema / Anónimo';
            
            let badgeColor = '#333';
            if (log.action.includes('DELETE') || log.action.includes('ERROR')) badgeColor = 'var(--mc-red)';
            if (log.action.includes('LOGIN')) badgeColor = 'var(--mc-accent-blue)';
            if (log.action.includes('IMPORT') || log.action.includes('UPDATE')) badgeColor = '#d600ff';

            return `
            <tr>
                <td style="font-family:monospace; color:#888; white-space:nowrap;">${date}</td>
                <td style="font-weight:700; color:#fff;">${actor.toUpperCase()}</td>
                <td><span style="background:${badgeColor}; padding:3px 8px; border-radius:4px; font-size:10px; font-weight:700; color:#fff;">${log.action}</span></td>
                <td style="color:#ccc; font-size:12px;">${log.details || '-'}</td>
            </tr>`;
        }).join('');
    }
  </script>
</body>
</html>