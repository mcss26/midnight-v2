<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Midnight - Proveedores</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <style>
    .supp-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .tag { font-size: 9px; padding: 2px 6px; border-radius: 3px; text-transform: uppercase; margin-right: 5px; }
    .tag-cat { background: #222; color: #aaa; }
    .tag-cc { background: #1a1a1a; border: 1px solid #444; color: #fff; }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: #fff;">AGENDA</span></div>
    <button onclick="window.history.back()" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    <div class="section-header">
        <h2 class="section-title">Directorio</h2>
        <button onclick="openModal()" class="btn-refresh">+ NUEVO</button>
    </div>

    <input type="text" id="search" class="search-input-admin" placeholder="üîç Buscar proveedor o CUIT..." oninput="filter()">
    <div id="listContainer"></div>
  </div>

  <div id="suppModal" class="modal-overlay">
    <div class="modal-box" style="max-width:500px;">
        <h3>Proveedor</h3>
        <input type="hidden" id="sId">
        
        <label class="input-label">Raz√≥n Social</label>
        <input type="text" id="sName" class="modal-input">

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label class="input-label">Categor√≠a</label><select id="sCat" class="modal-select"><option value="INSUMOS">Insumos</option><option value="SERVICIOS">Servicios</option><option value="MANTENIMIENTO">Mantenimiento</option></select></div>
            <div><label class="input-label">Centro Costos</label><select id="sCC" class="modal-select"><option value="COD">Directo (COD)</option><option value="OPEX">Operativo (OPEX)</option><option value="G&A">Admin (G&A)</option></select></div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label class="input-label">Cond. IVA</label><select id="sBill" class="modal-select"><option value="FACTURA_A">Factura A</option><option value="FACTURA_C">Factura C</option><option value="SIN_FACTURA">Sin Factura</option></select></div>
            <div><label class="input-label">CUIT</label><input type="text" id="sCuit" class="modal-input"></div>
        </div>

        <label class="input-label">Datos Bancarios (CBU / Alias)</label>
        <input type="text" id="sCbu" class="modal-input">

        <label class="input-label">Contacto (Tel / Email)</label>
        <input type="text" id="sContact" class="modal-input">

        <div class="modal-btns">
            <button onclick="closeModal()" class="btn-modal-cancel">CANCELAR</button>
            <button onclick="save()" class="btn-modal-save">GUARDAR</button>
        </div>
    </div>
  </div>

  <script>
    let allData = [];

    window.onload = async () => {
        const { data } = await client.from('suppliers').select('*').order('name');
        allData = data || [];
        render(allData);
    };

    function render(list) {
        document.getElementById('listContainer').innerHTML = list.map(s => `
            <div class="supp-card">
                <div>
                    <div style="font-weight:700; color:#fff; font-size:15px;">${s.name}</div>
                    <div style="margin-top:5px;">
                        <span class="tag tag-cat">${s.category}</span>
                        <span class="tag tag-cc">${s.cost_center}</span>
                        <span style="font-size:11px; color:#666;">${s.billing_condition.replace('_',' ')}</span>
                    </div>
                    ${s.contact_info ? `<div style="font-size:11px; color:#888; margin-top:5px;">üìû ${s.contact_info}</div>` : ''}
                </div>
                <button onclick="edit(${s.id})" style="border:none; background:none; cursor:pointer;">‚úèÔ∏è</button>
            </div>
        `).join('');
    }

    function filter() {
        const t = document.getElementById('search').value.toLowerCase();
        render(allData.filter(x => x.name.toLowerCase().includes(t) || (x.tax_id && x.tax_id.includes(t))));
    }

    function openModal() { document.getElementById('suppModal').style.display='flex'; document.getElementById('sId').value=''; }
    function closeModal() { document.getElementById('suppModal').style.display='none'; }

    async function edit(id) {
        const s = allData.find(x => x.id === id);
        document.getElementById('sId').value = s.id;
        document.getElementById('sName').value = s.name;
        document.getElementById('sCat').value = s.category;
        document.getElementById('sCC').value = s.cost_center;
        document.getElementById('sBill').value = s.billing_condition;
        document.getElementById('sCuit').value = s.tax_id || '';
        document.getElementById('sCbu').value = s.cbu_alias || '';
        document.getElementById('sContact').value = s.contact_info || '';
        document.getElementById('suppModal').style.display = 'flex';
    }

    async function save() {
        const id = document.getElementById('sId').value;
        const d = {
            name: document.getElementById('sName').value.toUpperCase(),
            category: document.getElementById('sCat').value,
            cost_center: document.getElementById('sCC').value,
            billing_condition: document.getElementById('sBill').value,
            tax_id: document.getElementById('sCuit').value,
            cbu_alias: document.getElementById('sCbu').value,
            contact_info: document.getElementById('sContact').value
        };

        const { error } = id ? await client.from('suppliers').update(d).eq('id', id) : await client.from('suppliers').insert(d);
        if(error) alert(error.message);
        else { closeModal(); window.location.reload(); }
    }
  </script>
</body>
</html>