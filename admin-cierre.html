<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Cierre de Noche</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>
</head>
<body>
  <!-- HEADER ESTÁNDAR CMS -->
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div>
          <button
            class="btn-back"
            type="button"
            onclick="window.location.href='administracion-index.html'">
            VOLVER
          </button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Administración</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <!-- TÍTULO -->
    <section class="section-header">
      <h1 class="section-title">CIERRE DE NOCHE</h1>
      <p class="section-desc">
        Cruce de cajas, accesos y tesorería para la fecha seleccionada.
      </p>
    </section>

    <!-- FECHA + RECARGAR + FINALIZAR -->
    <div
      class="box-soft"
      style="display:flex; justify-content:space-between; align-items:flex-end; gap:16px; flex-wrap:wrap; margin-bottom:20px;">
      <div style="display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap;">
        <div>
          <label class="input-label" for="eventDate">FECHA EVENTO</label>
          <input
            type="date"
            id="eventDate"
            class="modal-input"
            style="width:170px;" />
        </div>
        <button
          type="button"
          class="btn-secondary"
          onclick="loadData()">
          RECARGAR
        </button>
      </div>

      <button
        type="button"
        class="btn-primary"
        onclick="finalizarCierre()"
        style="min-width:210px;">
        FINALIZAR CIERRE
      </button>
    </div>

    <!-- TABS -->
    <nav class="tab-nav tabs-gold">
      <button class="tab-btn active" data-view="cajas" onclick="switchTab('cajas', this)">Cajas</button>
      <button class="tab-btn" data-view="acceso" onclick="switchTab('acceso', this)">Acceso &amp; servicios</button>
      <button class="tab-btn" data-view="tesoreria" onclick="switchTab('tesoreria', this)">Tesorería</button>
      <button class="tab-btn" data-view="stock" onclick="switchTab('stock', this)">Stock</button>
    </nav>

    <!-- TAB: CAJAS -->
    <section id="view-cajas">
      <div class="section-header" style="margin-bottom:12px; text-align:left;">
        <h3 class="dash-title">CRUCE DE EFECTIVO Y DIGITAL</h3>
        <p class="section-desc">
          Conciliación por terminal entre lo teórico (Gbol / sistema) y lo declarado en cierre.
        </p>
      </div>

      <!-- CONEXIÓN GBOL -->
      <div class="box-soft" style="margin-bottom:18px;">
        <p class="section-desc" style="margin-bottom:8px;">
          Sincroniza los datos de ventas directamente desde el servidor de <strong>GBol</strong>.
        </p>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <input type="file" id="facturaFileInput" accept=".xlsx,.xls" hidden />
          <button
            class="btn-secondary"
            type="button"
            id="facturaImportBtn">
            CONECTAR Y DESCARGAR DE GBOL (REAL)
          </button>
          <span
            id="cajasImportStatus"
            class="inline-status"
            style="text-transform:none; letter-spacing:0; margin-left:4px;">
          </span>
        </div>
      </div>

      <!-- RESUMEN CAJAS -->
      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Total teórico efectivo</div>
          <div class="summary-value" id="sumSystemCash">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total declarado efectivo</div>
          <div class="summary-value" id="sumDeclaredCash">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Diferencia total efectivo</div>
          <div class="summary-value" id="sumDiffCash">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Cajas con diferencia</div>
          <div class="summary-value" id="countDiffCajas">0</div>
        </div>
      </div>

      <!-- TABLA CAJAS -->
      <div class="table-container" style="margin-top:12px;">
        <table class="sku-table" aria-label="Conciliación por terminal">
          <thead>
            <tr>
              <th style="padding-left:20px;">TERMINAL</th>
              <th class="text-right">TEÓRICO EFVO (SISTEMA)</th>
              <th class="text-right">DECLARADO EFVO</th>
              <th class="text-right">DIFERENCIA EFVO</th>
              <th class="text-right">TEÓRICO DIGITAL (SISTEMA)</th>
              <th class="text-right">DECLARADO DIGITAL</th>
              <th class="text-right" style="padding-right:20px;">DIFERENCIA DIGITAL</th>
            </tr>
          </thead>
          <tbody id="conciliacionBody">
            <tr>
              <td colspan="7" style="text-align:center; padding:24px; color:var(--text-secondary);">
                No hay cajas mapeadas para iniciar la auditoría.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- TAB: ACCESO & SERVICIOS -->
    <section id="view-acceso" style="display:none;">
      <div class="section-header" style="margin-bottom:12px; text-align:left;">
        <h3 class="dash-title">ACCESOS Y SERVICIOS</h3>
        <p class="section-desc">
          Resumen de Passline, boletería física, guardarropas y control de tickets.
        </p>
      </div>

      <!-- IMPORT PASSLINE -->
      <div class="box-soft" style="margin-bottom:18px;">
        <p class="section-desc" style="margin-bottom:8px;">
          Importa el archivo <strong>“tickets_comprados… .csv”</strong> exportado desde Passline para esta fecha.
        </p>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <input type="file" id="passlineFileInput" accept=".csv" hidden />
          <button class="btn-secondary" type="button" id="passlineImportBtn">
            IMPORTAR PASSLINE CSV
          </button>
          <span
            id="passlineImportStatus"
            class="inline-status"
            style="text-transform:none; letter-spacing:0;">
          </span>
        </div>
      </div>

      <!-- KPIs PASSLINE / GUARDARROPAS -->
      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Passline – validados</div>
          <div class="summary-value" id="passlineValidated">0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Passline – total</div>
          <div class="summary-value" id="passlineTotal">0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Ingreso neto Passline</div>
          <div class="summary-value" id="passlineIngreso">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Guardarropas – efectivo</div>
          <div class="summary-value" id="guardarropasIngreso">$ 0</div>
        </div>
      </div>

      <!-- INPUTS MANUALES ACCESO -->
      <div class="box-soft" style="margin-top:16px;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:14px;">
          <div>
            <label class="input-label">PASSLINE – Validados</label>
            <input
              type="number"
              id="inputPasslineValidated"
              class="modal-input"
              min="0"
              value="0"
              oninput="updateAccesoFromInputs()" />
          </div>
          <div>
            <label class="input-label">PASSLINE – Total vendidos</label>
            <input
              type="number"
              id="inputPasslineTotal"
              class="modal-input"
              min="0"
              value="0"
              oninput="updateAccesoFromInputs()" />
          </div>
          <div>
            <label class="input-label">INGRESO PASSLINE ($)</label>
            <input
              type="number"
              id="inputPasslineIngreso"
              class="modal-input"
              min="0"
              value="0"
              oninput="updateAccesoFromInputs()" />
          </div>
          <div>
            <label class="input-label">INGRESO GUARDARROPAS ($)</label>
            <input
              type="number"
              id="inputGuardarropas"
              class="modal-input"
              min="0"
              value="0"
              oninput="updateAccesoFromInputs()" />
          </div>
        </div>
      </div>

      <!-- CONTROL FÍSICO DE TICKETS -->
      <div class="box-soft" style="margin-top:24px;">
        <div class="section-header" style="margin-bottom:10px; padding-bottom:6px; text-align:left;">
          <h3 class="dash-title" style="font-size:14px;">CONTROL FÍSICO DE TICKETS</h3>
          <p class="section-desc" style="margin-top:4px;">
            Talonario físico vs boletos vendidos en boletería.
          </p>
        </div>

        <div class="tickets-grid" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px;">
          <div>
            <label class="input-label">TALONARIO INICIAL</label>
            <input
              type="number"
              id="ticketsInitial"
              class="modal-input"
              value="0"
              min="0"
              oninput="renderTicketsFisicos()" />
          </div>
          <div>
            <label class="input-label">TICKETS RESTANTES (Control)</label>
            <input
              type="number"
              id="ticketsRemaining"
              class="modal-input"
              value="0"
              min="0"
              oninput="renderTicketsFisicos()" />
          </div>
          <div>
            <label class="input-label">VENDIDOS BOLETERÍA</label>
            <input
              type="number"
              id="ticketsBoleteria"
              class="modal-input"
              value="0"
              min="0"
              oninput="renderTicketsFisicos()" />
          </div>
        </div>

        <div class="summary-row" style="margin-top:14px;">
          <div class="summary-card">
            <div class="summary-label">Tickets usados físicos</div>
            <div class="summary-value" id="ticketsUsed">0</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Diferencia vs boletería</div>
            <div class="summary-value diff-ok" id="ticketsDiff">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB: TESORERÍA -->
    <section id="view-tesoreria" style="display:none;">
      <div class="section-header" style="margin-bottom:16px; text-align:left;">
        <h3 class="dash-title">TESORERÍA</h3>
        <p class="section-desc">
          Visión rápida de resultado de la noche cruzando cajas, accesos y egresos.
        </p>
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Facturación total (efvo + digital)</div>
          <div class="summary-value" id="tesoFacturado">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Declarado total cajas</div>
          <div class="summary-value" id="tesoDeclarado">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Diferencia neta cajas</div>
          <div class="summary-value" id="tesoDiferencia">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Egresos (mov. tesorería)</div>
          <div class="summary-value" id="tesoEgresos">$ 0</div>
        </div>
      </div>

      <p class="section-desc" style="margin-top:12px;">
        Más adelante, este panel va a tomar también egresos reales desde <strong>cash_movements</strong> y otros módulos de Administración.
      </p>
    </section>

    <!-- TAB: STOCK -->
    <section id="view-stock" style="display:none;">
      <div class="section-header" style="margin-bottom:12px; text-align:left;">
        <h3 class="dash-title">ARQUEO DE STOCK</h3>
        <p class="section-desc">
          Cruce entre stock teórico operativo y stock reportado por Gbol (STOCK_GENERAL) valorizado a costo.
        </p>
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Stock teórico operativo (valorizado)</div>
          <div class="summary-value" id="stockTeoricoTotal">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Stock según Gbol (valorizado)</div>
          <div class="summary-value" id="stockGbolTotal">$ 0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Diferencia valorizada</div>
          <div class="summary-value" id="stockDiffTotal">$ 0</div>
        </div>
      </div>

      <div class="table-container" style="margin-top:12px;">
        <table class="sku-table" id="stockAuditTable">
          <thead>
            <tr>
              <th>INSUMO</th>
              <th>TEÓRICO OPERATIVO</th>
              <th>GBOL</th>
              <th>DIF. UNIDADES</th>
              <th>COSTO UNITARIO</th>
              <th>DIF. VALORIZADA</th>
            </tr>
          </thead>
          <tbody>
            <!-- filas dinámicas -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ================= CONFIGURACIÓN GBOL =================
    // Token obtenido de la sesión (Vence en Dic 2025)
    const GBOL_TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiI3UUhyZHJTaWNmUDJjOWowT2RMc1VjNmJVcFFkVFRSMEpFZ3JTSDBGM2pieVlWaHpNeDRYTEJhcUlEVWR0VDR2OSt4a1kxTzliUHhDc3grMVBQNVo3RmVYN2I0RGR2dk5UaGh2dzJOWWVpcz0iLCJleHAiOjE3NjU1OTEwMjd9.qUXEqRBV2oArhWug01KMNaTQ-VYGQ3EVVNv816hWmao";
    
    // NUEVA URL: Endpoint de Facturación Detallada
    const GBOL_API_URL = "https://sd-2515114-h00190.ferozo.net/gbol/api/tickets/facturacionElectronicaConsulta";
    // ======================================================

    let currentClosingId = null;
    let terminals = {};
    let passlineData = { validated: 0, total: 0, ingreso: 0 };
    let tesoroData = { egresos: 0 };

    let cashTotals = {
      systemCash: 0,
      declaredCash: 0,
      diffCash: 0,
      systemDigital: 0,
      declaredDigital: 0,
      diffDigital: 0,
      cajasConDiferencia: 0
    };

    let facturaFileInput, facturaImportBtn, cajasImportStatus;
    let passlineFileInput, passlineImportBtn, passlineImportStatus;

    window.addEventListener('DOMContentLoaded', async () => {
      const dateInput = document.getElementById('eventDate');

      // Botones e Inputs
      facturaFileInput = document.getElementById('facturaFileInput');
      facturaImportBtn = document.getElementById('facturaImportBtn');
      cajasImportStatus = document.getElementById('cajasImportStatus');

      passlineFileInput = document.getElementById('passlineFileInput');
      passlineImportBtn = document.getElementById('passlineImportBtn');
      passlineImportStatus = document.getElementById('passlineImportStatus');

      // BOTÓN CONECTAR A GBOL
      if (facturaImportBtn) {
        facturaImportBtn.textContent = "CONECTAR Y DESCARGAR DE GBOL (REAL)";
        facturaImportBtn.onclick = handleImportGbolServer; 
      }

      if (passlineImportBtn && passlineFileInput) {
        passlineImportBtn.addEventListener('click', () => passlineFileInput.click());
        passlineFileInput.addEventListener('change', async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          await handlePasslineImport(file);
          passlineFileInput.value = '';
        });
      }

      if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }
      await loadData();
    });

    // --- FUNCIÓN MAESTRA: IMPORTAR DESDE SERVIDOR GBOL (DETALLADO) ---
    // --- VERSIÓN CORREGIDA Y ROBUSTA CORS ---
    async function handleImportGbolServer() {
      const dateStr = document.getElementById('eventDate').value; 
      if (!dateStr) {
        alert("Seleccioná una fecha primero.");
        return;
      }

      if (cajasImportStatus) {
        cajasImportStatus.textContent = 'Consultando tickets detallados...';
        cajasImportStatus.style.color = 'var(--text-primary)';
      }

      try {
        const rawBody = JSON.stringify({
            "estado": -1,
            "metodoDePago": -1,
            "puntoDeVenta": "T-0", 
            "noche": dateStr,      
            "tipoBusqueda": 1
        });

        console.log("Enviando a GBol:", rawBody);

        const response = await fetch(GBOL_API_URL, {
          method: 'POST',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json;charset=UTF-8',
            'Authorization': 'Bearer ' + GBOL_TOKEN
          },
          body: rawBody,
          mode: 'cors',
          credentials: 'omit'
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Respuesta de error del servidor:", errorText);
            throw new Error(`GBol respondió ${response.status}: ${errorText.substring(0, 100)}...`);
        }

        const data = await response.json();
        
        // --- PROCESAMIENTO ---
        if (!data.facturacion || !Array.isArray(data.facturacion)) {
            throw new Error("La respuesta no contiene lista de facturación.");
        }

        if (data.facturacion.length === 0) {
            throw new Error("Gbol dice que hay 0 tickets para esta fecha.");
        }

        // Agrupar Tickets por Caja
        const ventasPorCaja = {};

        data.facturacion.forEach(ticket => {
            const nombreCaja = (ticket.cajanom || "CAJA_DESCONOCIDA").trim().toUpperCase();

            if (!ventasPorCaja[nombreCaja]) {
                ventasPorCaja[nombreCaja] = { efectivo: 0, digital: 0, total: 0, tickets: 0 };
            }

            const efvo = parseFloat(ticket.efectivo) || 0;
            const tarjeta = parseFloat(ticket.tarjetas) || 0;
            const merpag = parseFloat(ticket.merpag) || 0;
            const importe = parseFloat(ticket.importe) || 0;

            ventasPorCaja[nombreCaja].efectivo += efvo;
            ventasPorCaja[nombreCaja].digital += (tarjeta + merpag);
            ventasPorCaja[nombreCaja].total += importe;
            ventasPorCaja[nombreCaja].tickets += 1;
        });

        // Insertar en Supabase
        const itemsToInsert = Object.keys(ventasPorCaja).map(nombre => {
            const v = ventasPorCaja[nombre];
            return {
                 cajanom: nombre,
                 fecha: dateStr,
                 importe: v.total,
                 efectivo: v.efectivo,
                 tarjetas: v.digital,
                 ticket_id: `AUTO-${v.tickets}T-${Date.now()}`,
                 processed: false
            };
        });

        const { error: deleteError } = await client.from('import_gbol_sales').delete().eq('fecha', dateStr);
        if (deleteError) throw deleteError;

        const { error: insertError } = await client.from('import_gbol_sales').insert(itemsToInsert);
        if (insertError) throw insertError;

        if (cajasImportStatus) {
            cajasImportStatus.textContent = `¡Éxito! Procesados ${data.facturacion.length} tickets.`;
            cajasImportStatus.style.color = 'var(--accent-green)';
        }
        
        await loadData(); 

      } catch (err) {
        console.error("Fallo Importación:", err);
        if (cajasImportStatus) {
            cajasImportStatus.textContent = `Error: ${err.message}`;
            cajasImportStatus.style.color = 'var(--state-error)';
        }
        alert(err.message);
      }
    }
    // -------------------------------------------------------

    function switchTab(view, btn) {
      const views = ['cajas', 'acceso', 'tesoreria', 'stock'];
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');

      views.forEach(v => {
        const el = document.getElementById('view-' + v);
        if (el) {
          el.style.display = v === view ? 'block' : 'none';
        }
      });

      if (view === 'tesoreria') {
        renderTesoroSummary();
      }

      if (view === 'stock') {
        loadStockAudit();
      }
    }

    async function loadData() {
      const date = document.getElementById('eventDate').value;
      if (!date) return;

      terminals = {};
      cashTotals = {
        systemCash: 0,
        declaredCash: 0,
        diffCash: 0,
        systemDigital: 0,
        declaredDigital: 0,
        diffDigital: 0,
        cajasConDiferencia: 0
      };

      try {
        // 1) cash_closings para la fecha
        const { data: closing, error: closingError } = await client
          .from('cash_closings')
          .select('id, status, total_passline')
          .eq('event_date', date)
          .maybeSingle();

        if (closingError && closingError.code !== 'PGRST116') {
          throw closingError;
        }

        currentClosingId = closing?.id ?? null;

        // 2) Declarado por terminal (closing_terminals)
        let declaredBy = new Map();
        if (currentClosingId) {
          const { data: terminalRows, error: ctError } = await client
            .from('closing_terminals')
            .select('terminal_name, system_cash, final_count_cash, system_digital, zoco_digital, cash_withdrawals')
            .eq('closing_id', currentClosingId);

          if (ctError) throw ctError;

          (terminalRows || []).forEach(row => {
            const name = (row.terminal_name || 'SIN NOMBRE').trim();
            declaredBy.set(name, {
              declared_cash: Number(row.final_count_cash) || 0,
              declared_digital: Number(row.zoco_digital) || 0,
              withdrawals: Number(row.cash_withdrawals) || 0,
              system_cash: Number(row.system_cash) || 0,
              system_digital: Number(row.system_digital) || 0
            });
          });
        }

        // 3) Teórico por terminal desde import_gbol_sales (Gbol)
        const { data: gbolRows, error: gbolError } = await client
          .from('import_gbol_sales')
          .select('cajanom, fecha, efectivo, tarjetas')
          .eq('fecha', date);

        if (gbolError) throw gbolError;

        const systemBy = new Map();
        (gbolRows || []).forEach(row => {
          const key = (row.cajanom || 'SIN NOMBRE').trim();
          const prev = systemBy.get(key) || { cash: 0, digital: 0 };
          prev.cash += Number(row.efectivo) || 0;
          prev.digital += Number(row.tarjetas) || 0;
          systemBy.set(key, prev);
        });

        // 4) Unir nombres de terminal de ambos lados
        const names = new Set([...declaredBy.keys(), ...systemBy.keys()]);
        terminals = {};

        names.forEach(name => {
          const dec = declaredBy.get(name) || {};
          const sysAgg = systemBy.get(name) || {};
          terminals[name] = {
            system_cash: (sysAgg.cash ?? dec.system_cash ?? 0),
            declared_cash: dec.declared_cash ?? 0,
            system_digital: (sysAgg.digital ?? dec.system_digital ?? 0),
            declared_digital: dec.declared_digital ?? 0,
            withdrawals: dec.withdrawals ?? 0
          };
        });

        renderConciliation();
        renderTesoroSummary();
      } catch (err) {
        console.error('Error al cargar datos de cierre', err);
        alert('No se pudieron cargar los datos de cierre para esa fecha.');
      }
    }

    function formatCurrency(val) {
      const n = Number(val) || 0;
      if (typeof MC_UTILS !== 'undefined' && MC_UTILS.formatCurrency) {
        return MC_UTILS.formatCurrency(n);
      }
      return '$ ' + n.toFixed(0);
    }

    function renderConciliation() {
      const tbody = document.getElementById('conciliacionBody');
      const keys = Object.keys(terminals).sort();

      if (keys.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="7" style="text-align:center; padding:24px; color:var(--text-secondary);">No hay cajas mapeadas para iniciar la auditoría.</td></tr>';

        const sumEls = ['sumSystemCash','sumDeclaredCash','sumDiffCash','countDiffCajas'];
        sumEls.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (id === 'countDiffCajas') el.textContent = '0';
          else el.textContent = '$ 0';
        });
        return;
      }

      let totalSystemCash = 0;
      let totalDeclaredCash = 0;
      let totalDiffCash = 0;

      let totalSystemDigital = 0;
      let totalDeclaredDigital = 0;
      let totalDiffDigital = 0;

      let cajasConDiferencia = 0;

      const rowsHtml = keys.map(key => {
        const t = terminals[key];

        const systemCash = Number(t.system_cash) || 0;
        const declaredCash = Number(t.declared_cash) || 0;
        const systemDigital = Number(t.system_digital) || 0;
        const declaredDigital = Number(t.declared_digital) || 0;

        const diffCash = declaredCash - systemCash;
        const diffDigital = declaredDigital - systemDigital;

        const diffCashClass =
          diffCash === 0 ? 'diff-ok' : diffCash < 0 ? 'diff-negative' : 'diff-positive';
        const diffDigitalClass =
          diffDigital === 0 ? 'diff-ok' : diffDigital < 0 ? 'diff-negative' : 'diff-positive';

        totalSystemCash += systemCash;
        totalDeclaredCash += declaredCash;
        totalDiffCash += diffCash;

        totalSystemDigital += systemDigital;
        totalDeclaredDigital += declaredDigital;
        totalDiffDigital += diffDigital;

        if (diffCash !== 0 || diffDigital !== 0) cajasConDiferencia++;

        return `
          <tr>
            <td style="font-weight:600; padding-left:20px;">${key}</td>
            <td class="text-right">${formatCurrency(systemCash)}</td>
            <td class="text-right">${formatCurrency(declaredCash)}</td>
            <td class="text-right ${diffCashClass}">${formatCurrency(diffCash)}</td>
            <td class="text-right">${formatCurrency(systemDigital)}</td>
            <td class="text-right">${formatCurrency(declaredDigital)}</td>
            <td class="text-right ${diffDigitalClass}" style="padding-right:20px;">
              ${formatCurrency(diffDigital)}
            </td>
          </tr>
        `;
      }).join('');

      const totalCashClass =
        totalDiffCash === 0 ? 'diff-ok' : totalDiffCash < 0 ? 'diff-negative' : 'diff-positive';
      const totalDigitalClass =
        totalDiffDigital === 0 ? 'diff-ok' : totalDiffDigital < 0 ? 'diff-negative' : 'diff-positive';

      const totalsRow = `
        <tr class="totals-row">
          <td class="totals-label">TOTAL</td>
          <td class="text-right">${formatCurrency(totalSystemCash)}</td>
          <td class="text-right">${formatCurrency(totalDeclaredCash)}</td>
          <td class="text-right ${totalCashClass}">${formatCurrency(totalDiffCash)}</td>
          <td class="text-right">${formatCurrency(totalSystemDigital)}</td>
          <td class="text-right">${formatCurrency(totalDeclaredDigital)}</td>
          <td class="text-right ${totalDigitalClass}" style="padding-right:20px;">
            ${formatCurrency(totalDiffDigital)}
          </td>
        </tr>
      `;

      tbody.innerHTML = rowsHtml + totalsRow;

      const sumSystemCashEl = document.getElementById('sumSystemCash');
      const sumDeclaredCashEl = document.getElementById('sumDeclaredCash');
      const sumDiffCashEl = document.getElementById('sumDiffCash');
      const countDiffEl = document.getElementById('countDiffCajas');

      if (sumSystemCashEl) sumSystemCashEl.textContent = formatCurrency(totalSystemCash);
      if (sumDeclaredCashEl) sumDeclaredCashEl.textContent = formatCurrency(totalDeclaredCash);
      if (sumDiffCashEl) sumDiffCashEl.textContent = formatCurrency(totalDiffCash);
      if (countDiffEl) countDiffEl.textContent = String(cajasConDiferencia);

      cashTotals = {
        systemCash: totalSystemCash,
        declaredCash: totalDeclaredCash,
        diffCash: totalDiffCash,
        systemDigital: totalSystemDigital,
        declaredDigital: totalDeclaredDigital,
        diffDigital: totalDiffDigital,
        cajasConDiferencia
      };
    }

    function updateAccesoFromInputs() {
      const vVal = parseInt(document.getElementById('inputPasslineValidated')?.value || '0', 10) || 0;
      const vTot = parseInt(document.getElementById('inputPasslineTotal')?.value || '0', 10) || 0;
      const vIng = Number(document.getElementById('inputPasslineIngreso')?.value || '0') || 0;
      const gIng = Number(document.getElementById('inputGuardarropas')?.value || '0') || 0;

      passlineData.validated = vVal;
      passlineData.total = vTot;
      passlineData.ingreso = vIng;

      const elVal = document.getElementById('passlineValidated');
      const elTot = document.getElementById('passlineTotal');
      const elIng = document.getElementById('passlineIngreso');
      const elGuard = document.getElementById('guardarropasIngreso');

      if (elVal) elVal.textContent = vVal.toString();
      if (elTot) elTot.textContent = vTot.toString();
      if (elIng) elIng.textContent = formatCurrency(vIng);
      if (elGuard) elGuard.textContent = formatCurrency(gIng);

      renderTesoroSummary();
    }

    function renderTicketsFisicos() {
      const initial = parseInt(document.getElementById('ticketsInitial')?.value || '0', 10) || 0;
      const remaining = parseInt(document.getElementById('ticketsRemaining')?.value || '0', 10) || 0;
      const boleteria = parseInt(document.getElementById('ticketsBoleteria')?.value || '0', 10) || 0;

      const used = Math.max(initial - remaining, 0);
      const diff = used - boleteria;

      const usedEl = document.getElementById('ticketsUsed');
      const diffEl = document.getElementById('ticketsDiff');

      if (usedEl) usedEl.textContent = used.toString();
      if (diffEl) {
        diffEl.textContent = diff.toString();
        diffEl.classList.remove('diff-ok', 'diff-negative', 'diff-positive');
        diffEl.classList.add(
          diff === 0 ? 'diff-ok' : diff < 0 ? 'diff-negative' : 'diff-positive'
        );
      }
    }

    function renderTesoroSummary() {
      const facturado = (cashTotals.systemCash + cashTotals.systemDigital) || 0;
      const declarado = (cashTotals.declaredCash + cashTotals.declaredDigital) || 0;
      const diff = (cashTotals.diffCash + cashTotals.diffDigital) || 0;
      const egresos = tesoroData.egresos || 0;

      const fEl = document.getElementById('tesoFacturado');
      const dEl = document.getElementById('tesoDeclarado');
      const diffEl = document.getElementById('tesoDiferencia');
      const eEl = document.getElementById('tesoEgresos');

      if (fEl) fEl.textContent = formatCurrency(facturado);
      if (dEl) dEl.textContent = formatCurrency(declarado);
      if (diffEl) diffEl.textContent = formatCurrency(diff);
      if (eEl) eEl.textContent = formatCurrency(egresos);
    }

    async function finalizarCierre() {
      const date = document.getElementById('eventDate').value;
      if (!date) {
        alert('Seleccioná una fecha de evento.');
        return;
      }
      const ok = confirm(`¿Confirmás el cierre de la noche del ${date}?`);
      if (!ok) return;

      try {
        const { data: closing, error } = await client
          .from('cash_closings')
          .upsert(
            { event_date: date, status: 'closed' },
            { onConflict: 'event_date' }
          )
          .select('id')
          .maybeSingle();

        if (error) throw error;
        currentClosingId = closing?.id ?? currentClosingId;

        await client.from('admin_logs').insert({
          action: 'CIERRE_NOCHE',
          details: `Jornada ${date} cerrada desde admin-cierre.`
        });

        alert('Cierre guardado.');
      } catch (err) {
        console.error('Error al guardar cierre', err);
        alert('No se pudo guardar el cierre.');
      }
    }

    async function handlePasslineImport(file) {
      if (!file) return;
      if (passlineImportStatus) passlineImportStatus.textContent = 'Importando Passline...';

      try {
        const text = await file.text();
        const workbook = XLSX.read(text, { type: 'string' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        if (!sheet) throw new Error('Hoja vacía en CSV.');

        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        if (!rows.length) {
          if (passlineImportStatus) {
            passlineImportStatus.textContent = 'El archivo CSV no contiene filas.';
          }
          return;
        }

        let totalTickets = 0;
        let totalImporte = 0;
        let totalService = 0;
        let validados = 0;
        let cortesias = 0;

        rows.forEach(r => {
          totalTickets++;
          const total = Number(String(r['Total'] ?? '0').replace(',', '.')) || 0;
          const cargo = Number(String(r['Cargo por Servicio'] ?? '0').replace(',', '.')) || 0;
          totalImporte += total;
          totalService += cargo;

          const validRaw = r['Fecha/Hora Validación'] || r['Fecha/Hora Validación.1'];
          const validStr = validRaw ? String(validRaw).trim() : '';
          if (validStr && validStr !== '31-12-1969') {
            validados++;
          }

          const cortRaw = r['Cortesia'] ?? r['Cortesía'];
          if (cortRaw && String(cortRaw).trim() !== '') {
            cortesias++;
          }
        });

        const net = totalImporte - totalService;

        passlineData.validated = validados;
        passlineData.total = totalTickets;
        passlineData.ingreso = net;

        const inputVal = document.getElementById('inputPasslineValidated');
        const inputTot = document.getElementById('inputPasslineTotal');
        const inputIng = document.getElementById('inputPasslineIngreso');

        if (inputVal) inputVal.value = String(validados);
        if (inputTot) inputTot.value = String(totalTickets);
        if (inputIng) inputIng.value = String(net.toFixed(0));

        updateAccesoFromInputs();

        // Actualizar total_passline en cash_closings
        const date = document.getElementById('eventDate')?.value || null;
        if (date) {
          let closingId = currentClosingId;
          if (!closingId) {
            const { data: closing, error: closingError } = await client
              .from('cash_closings')
              .insert({ event_date: date })
              .select('id')
              .maybeSingle();
            if (!closingError && closing) {
              closingId = closing.id;
              currentClosingId = closingId;
            }
          }
          if (closingId) {
            await client
              .from('cash_closings')
              .update({ total_passline: net })
              .eq('id', closingId);
          }
        }

        if (passlineImportStatus) {
          passlineImportStatus.textContent =
            `Importación completada. Tickets: ${totalTickets}, validados: ${validados}, cortesía: ${cortesias}`;
        }
      } catch (err) {
        console.error('Error al importar Passline', err);
        if (passlineImportStatus) {
          passlineImportStatus.textContent = 'Error al importar Passline. Revisá el archivo.';
        }
      }
    }

    function formatStockCurrency(value) {
      const numeric = Number(value) || 0;
      if (typeof MC_UTILS !== 'undefined' && MC_UTILS.formatCurrency) {
        return MC_UTILS.formatCurrency(numeric);
      }
      return `$${numeric.toFixed(2)}`;
    }

    async function loadStockAudit() {
      const tbody = document.querySelector('#stockAuditTable tbody');
      if (tbody) {
        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:14px;">Cargando arqueo de stock...</td></tr>';
      }

      try {
        const [
          { data: skuRows, error: skuError },
          { data: stockRows, error: stockError },
          { data: gbolRows, error: gbolError }
        ] = await Promise.all([
          client.from('inventory_skus').select('id, name, cost_price'),
          client.from('inventory_stock').select('sku_id, stock_current'),
          client
            .from('import_gbol_stock')
            .select('sku_id, stock_real, import_date')
            .order('import_date', { ascending: false })
        ]);

        if (skuError) throw skuError;
        if (stockError) throw stockError;
        if (gbolError) throw gbolError;

        const stockMap = new Map();
        (stockRows || []).forEach(row => {
          if (!row?.sku_id) return;
          stockMap.set(row.sku_id, Number(row.stock_current) || 0);
        });

        const gbolMap = new Map();
        (gbolRows || []).forEach(row => {
          if (!row?.sku_id) return;
          if (gbolMap.has(row.sku_id)) return;
          gbolMap.set(row.sku_id, {
            stock_real: Number(row.stock_real) || 0,
            import_date: row.import_date
          });
        });

        let totalTeorico = 0;
        let totalGbol = 0;

        const rows = (skuRows || [])
          .map(sku => {
            if (!sku?.id) return null;
            const teorico = stockMap.get(sku.id) ?? 0;
            const gbolEntry = gbolMap.get(sku.id);
            const gbol = gbolEntry?.stock_real ?? 0;
            const diffUnits = teorico - gbol;
            const cost = Number(sku.cost_price) || 0;
            const diffValue = diffUnits * cost;

            totalTeorico += teorico * cost;
            totalGbol += gbol * cost;

            return {
              name: sku.name || 'SIN NOMBRE',
              teorico,
              gbol,
              diffUnits,
              cost,
              diffValue
            };
          })
          .filter(Boolean);

        const totalDiffValue = totalTeorico - totalGbol;

        const totalEls = [
          { id: 'stockTeoricoTotal', value: totalTeorico },
          { id: 'stockGbolTotal', value: totalGbol },
          { id: 'stockDiffTotal', value: totalDiffValue }
        ];

        totalEls.forEach(({ id, value }) => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = formatStockCurrency(value);
          }
        });

        renderStockAuditTable(rows);
      } catch (err) {
        console.error('Error al cargar arqueo de stock', err);
        ['stockTeoricoTotal', 'stockGbolTotal', 'stockDiffTotal'].forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = formatStockCurrency(0);
          }
        });
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center; padding:14px;">No se pudo cargar el arqueo de stock.</td></tr>';
        }
      }
    }

    function renderStockAuditTable(rows = []) {
      const tbody = document.querySelector('#stockAuditTable tbody');
      if (!tbody) return;

      const validRows = (rows || []).filter(Boolean);
      const diffRows = validRows.filter(r => r.diffUnits !== 0);
      const sourceRows = diffRows.length > 0 ? diffRows : validRows;

      if (sourceRows.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center; padding:14px;">No hay diferencias de stock para esta fecha.</td></tr>';
        return;
      }

      const rowsHtml = sourceRows
        .map(row => {
          const diffUnitsStyle =
            row.diffUnits !== 0
              ? `font-weight:600; color:${row.diffUnits < 0 ? 'var(--state-error)' : 'var(--accent-green)'};`
              : '';
          const diffValueStyle =
            row.diffValue !== 0
              ? `font-weight:600; color:${row.diffValue < 0 ? 'var(--state-error)' : 'var(--accent-green)'};`
              : '';
          return `
            <tr>
              <td>
                <div class="row-title">${row.name}</div>
              </td>
              <td>${row.teorico ?? 0}</td>
              <td>${row.gbol ?? 0}</td>
              <td style="${diffUnitsStyle}">${row.diffUnits ?? 0}</td>
              <td class="col-costo">${formatStockCurrency(row.cost)}</td>
              <td class="col-costo" style="${diffValueStyle}">${formatStockCurrency(row.diffValue)}</td>
            </tr>
          `;
        })
        .join('');

      tbody.innerHTML = rowsHtml;
    }
  </script>
</body>
</html>
