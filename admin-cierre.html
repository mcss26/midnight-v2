<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Cierre de Noche</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="config.js"></script>

  <style>
    /* Estilos Espec铆ficos */
    .tab-nav { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--border-light); padding-bottom: 0; }
    .tab-btn { 
        background: none; border: none; color: var(--txt-secondary); padding: 15px 10px; 
        font-family: var(--font-main); font-size: 13px; font-weight: 600; cursor: pointer; 
        border-bottom: 3px solid transparent; transition: 0.2s;
    }
    .tab-btn:hover { color: #fff; }
    .tab-btn.active { color: var(--txt-primary); border-bottom-color: var(--accent-gold); }

    .audit-box { 
        background: var(--bg-card); border: 1px solid var(--border-light); border-radius: var(--radius);
        padding: 30px; margin-bottom: 25px; 
    }

    .diff-negative { color: var(--accent-red); font-weight: 700; }
    .diff-positive { color: var(--accent-green); font-weight: 700; }
    .diff-ok { color: var(--txt-secondary); }
    
    .val-lbl { font-size: 10px; color: var(--txt-secondary); text-transform: uppercase; margin-bottom: 4px; }
    .val-num { font-family: 'Outfit', monospace; font-size: 16px; font-weight: 700; color: #fff; }
  </style>
</head>
<body>

  <header class="admin-header">
    <div class="admin-logo">MIDNIGHT<span style="color: var(--accent-gold);">CIERRE</span></div>
    <button onclick="window.location.href='administracion-index.html'" class="btn-logout">VOLVER</button>
  </header>

  <div class="admin-container">
    
    <div class="section-header" style="align-items:center;">
        <div>
            <h2 class="section-title">Asistente de Conciliaci贸n</h2>
            <p class="section-desc">Cruce de datos de campo vs. Facturaci贸n Electr贸nica</p>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="date" id="eventDate" class="modal-input" style="width:160px;" onchange="loadData()">
            <button onclick="saveAll()" class="btn-primary"> CERRAR JORNADA</button>
        </div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('cajas', this)"> CONCILIACIN CAJAS</button>
        <button class="tab-btn" onclick="switchTab('acceso', this)"> ACCESO & SERVICIOS</button>
        <button class="tab-btn" onclick="switchTab('tesoreria', this)"> ARQUEO CAJA MADRE</button>
    </div>

    <div id="view-cajas" class="audit-box">
        <div class="section-header" style="margin-bottom:20px;">
            <h3 class="section-title" style="font-size:18px;">Cruce de Efectivo y Digital</h3>
            <div style="display:flex; gap:10px;">
                <input type="file" id="fileFacturas" hidden accept=".xlsx,.xls,.csv" onchange="importFacturas(this)">
                <button onclick="document.getElementById('fileFacturas').click()" class="btn-refresh" style="background:var(--accent-blue); color:#fff;"> IMPORTAR FACTURACIN (GBOL)</button>
            </div>
        </div>

        <div class="table-container">
            <table class="sku-table">
                <thead>
                    <tr>
                        <th style="padding-left:20px;">TERMINAL</th>
                        <th style="text-align:right;">TERICO EFVO (GBOL)</th>
                        <th style="text-align:right;">DECLARADO EFVO (STAFF)</th>
                        <th style="text-align:right;">DIFERENCIA EFVO</th>
                        <th style="text-align:right;">TERICO DIGITAL (GBOL)</th>
                        <th style="text-align:right;">DECLARADO DIGITAL</th>
                        <th style="text-align:right;">DIFERENCIA DIGITAL</th>
                    </tr>
                </thead>
                <tbody id="conciliacionBody">
                    <tr><td colspan="7" style="text-align:center; padding:30px; color:var(--txt-secondary);">Cargue las facturas electr贸nicas para conciliar.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="view-acceso" class="audit-box" style="display:none;">
        <h3 class="section-title" style="font-size:18px; margin-bottom:25px;">Ingresos Secundarios</h3>

        <div style="border:1px solid var(--border-light); padding:20px; border-radius:var(--radius); margin-bottom:30px;">
            <div class="section-header" style="margin-bottom:15px; padding-bottom:10px;">
                <h4 style="font-size:16px; margin:0; color:var(--accent-purple);">Passline (Venta de Acceso)</h4>
                <input type="file" id="filePassline" hidden accept=".csv" onchange="importPassline(this)">
                <button onclick="document.getElementById('filePassline').click()" class="btn-refresh"> IMPORTAR TICKETS</button>
            </div>
            
            <div id="passlineSummary" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
                <div style="background:#000; padding:15px; border-radius:var(--radius); text-align:center;">
                    <div class="val-lbl">COMPRADOS</div><div class="val-num" id="plTotal" style="color:#fff;">0</div>
                </div>
                <div style="background:#000; padding:15px; border-radius:var(--radius); text-align:center;">
                    <div class="val-lbl">ACREDITADOS</div><div class="val-num" id="plValidated" style="color:var(--accent-green);">0</div>
                </div>
                <div style="background:#000; padding:15px; border-radius:var(--radius); text-align:center;">
                    <div class="val-lbl">REMANENTE</div><div class="val-num" id="plRemanente" style="color:var(--accent-red);">0</div>
                </div>
                <div style="grid-column:1/-1; text-align:center; margin-top:10px;">
                    <span class="val-lbl">INGRESO BRUTO ESTIMADO:</span> <span class="val-num" id="plIngresoBruto" style="color:var(--accent-gold); font-size:18px;">$ 0</span>
                </div>
            </div>
        </div>

        <div style="border:1px solid var(--border-light); padding:20px; border-radius:var(--radius);">
            <label class="input-label">INGRESO GUARDARROPAS (Efectivo Contado)</label>
            <input type="number" id="totalWardrobe" class="modal-input" value="0" placeholder="0" oninput="renderTesoroSummary()">
        </div>
    </div>

    <div id="view-tesoreria" class="audit-box" style="display:none;">
        <h3 class="section-title" style="font-size:18px; margin-bottom:20px;">Arqueo y Cierre Tesorer铆a</h3>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
            <div class="val-card">
                <div class="val-lbl">INGRESO TOTAL EFECTIVO (TERICO)</div>
                <div class="val-num" id="tIngreso" style="font-size:24px; color:var(--accent-green);">$ 0</div>
                <div class="val-lbl" style="margin-top:15px;">EGRESOS CONFIRMADOS</div>
                <div class="val-num" id="tEgreso" style="color:var(--accent-red);">$ 0</div>
                <div class="val-lbl" style="margin-top:20px; border-top:1px solid var(--border-light); padding-top:10px;">SALDO FINAL TERICO</div>
                <div class="val-num" id="tSaldoFinal" style="font-size:28px;">$ 0</div>
            </div>

            <div class="val-card" style="background:#000;">
                <label class="input-label" style="color:#fff;">CONTEO FSICO (CAJA FUERTE)</label>
                <input type="number" id="tConteoFinal" class="modal-input" placeholder="0" oninput="calculateTesoroDiff()">
                
                <div class="input-label" style="margin-top:30px;">DIFERENCIA FINAL</div>
                <div class="val-num" id="tDiferencia" style="font-size:24px;">$ 0</div>
                <p class="section-desc" id="tNovedad" style="color:var(--accent-red); font-weight:600; margin-top:10px;"></p>
            </div>
        </div>

        <button onclick="saveAll()" class="btn-primary" style="width:100%; padding:15px;">FINALIZAR ARQUEO Y CERRAR JORNADA</button>
    </div>

  </div>

  <script>
    let currentClosingId = null;
    let terminals = {}; 
    let passlineData = { validated: 0, total: 0, ingreso: 0 };
    let tesoroData = { egresos: 0 };
    let posMapping = {};

    window.onload = async () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('eventDate').value = today;
        await loadMapping();
        await loadData();
    };

    function switchTab(view, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        ['cajas', 'acceso', 'tesoreria'].forEach(v => document.getElementById('view-'+v).style.display='none');
        document.getElementById('view-'+view).style.display='block';
        if (view === 'acceso' || view === 'tesoreria') {
            renderTesoroSummary();
        }
    }

    async function loadMapping() {
        const { data } = await client.from('pos_terminals').select('*');
        // El mapa usa el nombre amigable en may煤sculas como clave
        if(data) data.forEach(p => posMapping[p.provider+'_'+p.friendly_name.toUpperCase()] = p.friendly_name.toUpperCase());
    }
    
    // Funci贸n de limpieza num茅rica global
    function cleanNumber(str) {
        if (!str) return 0;
        let s = String(str);
        // 1. Eliminar caracteres no num茅ricos excepto coma y punto.
        s = s.replace(/[^\d,\.-]/g, ''); 
        
        // 2. Si hay m谩s de un separador (ej: 1.000.000,00), asumimos formato espa帽ol y eliminamos puntos de miles.
        if ((s.match(/[.,]/g) || []).length > 1) {
             s = s.replace(/\./g, ''); // Eliminar puntos de miles
        }
        
        // 3. Reemplazar la coma por punto (decimal).
        s = s.replace(/,/g, '.');

        return parseFloat(s) || 0;
    }

    async function loadData() {
        const date = document.getElementById('eventDate').value;
        const { data: closing } = await client.from('cash_closings').select('id, total_wardrobe').eq('event_date', date).maybeSingle();
        currentClosingId = closing?.id;

        // --- 1. INICIALIZACIN DE TERMINALES ---
        terminals = {};
        const friendlyNames = [...new Set(Object.values(posMapping))].sort();
        
        friendlyNames.forEach(name => {
            terminals[name] = { 
                terminal_name: name, declared_cash: 0, declared_digital: 0, withdrawals: 0, system_cash: 0, system_digital: 0,
                starting_cash: 0, staff_payments: 0, other_expenses: 0,
            };
        });
        
        // 2. Sobrescribir con los datos reportados por Staff
        if (currentClosingId) {
            const { data: details } = await client.from('closing_terminals').select('*').eq('closing_id', currentClosingId);
            details.forEach(d => {
                const name = d.terminal_name.toUpperCase();
                if (terminals[name]) { 
                    terminals[name] = { 
                        ...terminals[name], 
                        declared_cash: parseFloat(d.final_count_cash) || 0,
                        declared_digital: parseFloat(d.zoco_digital) || 0,
                        withdrawals: parseFloat(d.cash_withdrawals) || 0,
                    };
                }
            });
            document.getElementById('totalWardrobe').value = closing.total_wardrobe || 0;
        } else {
            document.getElementById('totalWardrobe').value = 0;
        }

        // 3. Cargar Movimientos de Egreso (Cash Movements)
        const { data: movements } = await client.from('cash_movements').select('amount').eq('event_date', date).eq('status', 'CONFIRMED');
        tesoroData.egresos = movements ? movements.reduce((sum, m) => sum + parseFloat(m.amount), 0) : 0;
        
        renderConciliation();
    }

    function renderConciliation() {
        const tbody = document.getElementById('conciliacionBody');
        const keys = Object.keys(terminals).sort();

        if (keys.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--txt-secondary);">No hay cajas mapeadas para iniciar la auditor铆a.</td></tr>';
            return;
        }

        tbody.innerHTML = keys.map(key => {
            const t = terminals[key];
            
            // CONCILIACIN DE EFECTIVO
            const diffCash = t.declared_cash - t.system_cash;
            const diffCashClass = diffCash === 0 ? 'diff-ok' : (Math.abs(diffCash) < 100 ? 'diff-ok' : (diffCash < 0 ? 'diff-negative' : 'diff-positive'));
            
            // CONCILIACIN DIGITAL
            const diffDigital = t.declared_digital - t.system_digital;
            const diffDigitalClass = diffDigital === 0 ? 'diff-ok' : (Math.abs(diffDigital) < 100 ? 'diff-ok' : (diffDigital < 0 ? 'diff-negative' : 'diff-positive'));

            return `
            <tr>
                <td style="font-weight:600; padding-left:20px;">${key}</td>
                <td style="text-align:right;">${MC_UTILS.formatCurrency(t.system_cash)}</td>
                <td style="text-align:right;">${MC_UTILS.formatCurrency(t.declared_cash)}</td>
                <td class="${diffCashClass}" style="text-align:right;">${MC_UTILS.formatCurrency(diffCash)}</td>
                <td style="text-align:right;">${MC_UTILS.formatCurrency(t.system_digital)}</td>
                <td style="text-align:right;">${MC_UTILS.formatCurrency(t.declared_digital)}</td>
                <td class="${diffDigitalClass}" style="text-align:right; padding-right:20px;">${MC_UTILS.formatCurrency(diffDigital)}</td>
            </tr>`;
        }).join('');

        renderTesoroSummary();
    }

    // --- IMPORTADORES EXTERNOS ---

    // FIX: Importaci贸n Robusta de Facturas Electr贸nicas (GBOL)
    async function importFacturas(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                
                // 1. Buscar cabecera de forma robusta
                const raw = XLSX.utils.sheet_to_json(ws, { header: 1 });
                let hIdx = raw.findIndex(r => {
                    const rowStr = JSON.stringify(r).toLowerCase();
                    return (rowStr.includes('cajanom') || rowStr.includes('caja')) && rowStr.includes('efectivo');
                });
                
                if(hIdx === -1) throw new Error("Formato inv谩lido. Se requiere 'cajanom/caja' y 'efectivo'.");
                
                // 2. Procesar con la limpieza de n煤meros
                const rows = XLSX.utils.sheet_to_json(ws, { range: hIdx });
                
                Object.keys(terminals).forEach(k => { terminals[k].system_cash = 0; terminals[k].system_digital = 0; });

                rows.forEach(r => {
                    const rawBoxName = String(r['cajanom'] || r['caja']).trim().toUpperCase();
                    const boxName = rawBoxName.replace(/\s+/g, ' '); 
                    
                    const efectivo = cleanNumber(r['efectivo']);
                    const tarjetas = cleanNumber(r['tarjetas']);
                    const merpag = cleanNumber(r['merpag']);
                    const digitalTotal = tarjetas + merpag;

                    if (terminals[boxName]) {
                        terminals[boxName].system_cash += efectivo; 
                        terminals[boxName].system_digital += digitalTotal;
                    } else if (boxName.includes('BOLETERIA')) {
                        const genericBoleteriaName = 'BOLETERIA GENERAL 1';
                        if (terminals[genericBoleteriaName]) {
                            terminals[genericBoleteriaName].system_cash += efectivo; 
                            terminals[genericBoleteriaName].system_digital += digitalTotal;
                        }
                    }
                });

                await client.from('admin_logs').insert({ action: 'IMPORT_FACTURA', details: `Importadas ventas de ${rows.length} facturas.` });
                alert("Ventas Te贸ricas (GBol) Importadas y conciliadas.");
                renderConciliation();
                input.value = '';
            } catch (err) { alert("Error GBol: " + err.message); }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // IMPORTAR PASSLINE (Control de Acceso) - FIX FINAL DE MAGNITUD
    async function importPassline(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const csvData = e.target.result;
                const lines = csvData.split('\n').map(line => line.split(';'));
                
                if (lines.length < 2) throw new Error("Archivo Passline vac铆o.");
                
                const headerIndex = lines.findIndex(row => row.some(cell => cell.includes("Estado del eticket")));
                if (headerIndex === -1) throw new Error("No se encontr贸 el encabezado de Passline.");

                const statusCol = lines[headerIndex].findIndex(h => h.includes("Estado del eticket"));
                const totalCol = lines[headerIndex].findIndex(h => h.includes("Total"));
                
                if (statusCol === -1 || totalCol === -1) throw new Error("Columnas Estado/Total no encontradas.");
                
                let totalTickets = 0;
                let validatedTickets = 0;
                let ingresoBruto = 0;
                
                for (let i = headerIndex + 1; i < lines.length; i++) {
                    const row = lines[i];
                    if (row.length > statusCol) {
                        totalTickets++;
                        const status = row[statusCol].replace(/"/g, '').trim();
                        
                        // LIMPIEZA CRTICA
                        const totalRaw = row[totalCol];
                        let total = cleanNumber(totalRaw); 
                        
                        // FIX DE MAGNITUD: Si el n煤mero es demasiado grande y no tiene decimales, asumimos que viene en formato entero sin separador decimal
                        if (total > 1000000 && total % 10 === 0) { 
                             total = total / 100; 
                        }


                        if (status === 'Validada') {
                            validatedTickets++;
                            ingresoBruto += total;
                        }
                    }
                }

                passlineData.total = totalTickets;
                passlineData.validated = validatedTickets;
                passlineData.ingreso = ingresoBruto;

                document.getElementById('plTotal').innerText = totalTickets;
                document.getElementById('plValidated').innerText = validatedTickets;
                document.getElementById('plRemanente').innerText = totalTickets - validatedTickets;
                document.getElementById('plIngresoBruto').innerText = MC_UTILS.formatCurrency(ingresoBruto);

                alert("Reporte Passline importado.");
                input.value = '';
                renderTesoroSummary();
            } catch (err) { alert("Error Passline: " + err.message); }
        };
        reader.readAsText(file, 'utf-8');
    }
    
    // === VISTA TESORERA (C谩lculos Blindados) ===

    function renderTesoroSummary() {
        const ingresoGuardarropas = parseFloat(document.getElementById('totalWardrobe').value) || 0;
        
        const efectivoCajas = Object.values(terminals).reduce((sum, t) => sum + t.declared_cash, 0);
        const ingresoConsolidado = efectivoCajas + ingresoGuardarropas + passlineData.ingreso; 
        
        const egresoConfirmado = tesoroData.egresos;

        const saldoFinalTeorico = ingresoConsolidado - egresoConfirmado;
        
        document.getElementById('tIngreso').innerText = MC_UTILS.formatCurrency(ingresoConsolidado);
        document.getElementById('tEgreso').innerText = MC_UTILS.formatCurrency(egresoConfirmado);
        document.getElementById('tSaldoFinal').innerText = MC_UTILS.formatCurrency(saldoFinalTeorico);

        calculateTesoroDiff();
    }

    function calculateTesoroDiff() {
        const saldoFinalTeorico = parseFloat(document.getElementById('tSaldoFinal').innerText.replace(/[$,]/g, '').replace(/[\.]/g, '').replace(/,/g, '.')) || 0;
        const conteoFisico = parseFloat(document.getElementById('tConteoFinal').value) || 0;
        const diferencia = conteoFisico - saldoFinalTeorico;
        
        document.getElementById('tDiferencia').innerText = MC_UTILS.formatCurrency(diferencia);

        const novelty = document.getElementById('tNovedad');
        if (Math.abs(diferencia) > 1000) {
            novelty.innerText = diferencia > 0 ? "隆SOBRANTE! Audite la procedencia." : "隆FALTANTE! Se requiere justificaci贸n.";
            novelty.style.color = diferencia > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        } else {
            novelty.innerText = "Cuadrado (Diferencia menor a $1000)";
            novelty.style.color = 'var(--txt-secondary)';
        }
    }

    // --- ACCIN FINAL: GUARDAR CIERRE ---
    async function saveAll() {
        // L贸gica para guardar cierre y detalles
        const date = document.getElementById('eventDate').value;
        const ward = parseFloat(document.getElementById('totalWardrobe').value) || 0;
        const pass = passlineData.ingreso;
        
        // 1. Upsert Cabecera
        let { data: head, error: err1 } = await client.from('cash_closings')
            .upsert({ event_date: date, total_passline: pass, total_wardrobe: ward, status: 'closed' }, { onConflict: 'event_date' })
            .select().single();
            
        if(err1) return alert("Error al crear cierre: " + err1.message);

        // 2. Insertar/Actualizar Detalles (Finalizar el cierre de terminales)
        await client.from('closing_terminals').delete().eq('closing_id', head.id);
        const details = Object.values(terminals).map(t => ({
            closing_id: head.id,
            terminal_name: t.terminal_name,
            final_count_cash: t.declared_cash,
            system_cash: t.system_cash,
            system_digital: t.system_digital,
            zoco_digital: t.declared_digital, // Lo que el staff cont贸 como digital
            cash_withdrawals: t.withdrawals,
        }));
        
        const { error: err2 } = await client.from('closing_terminals').insert(details);
        if(err2) return alert("Error al guardar detalles: " + err2.message);

        // 3. Log
        await client.from('admin_logs').insert({ action: 'CIERRE_JORNADA', details: `Jornada ${date} cerrada por Administrador.` });

        alert("Cierre de Noche V2.1 Finalizado.");
        window.location.href = 'administracion-index.html';
    }
  </script>
  <script type="module" src="app-init.js"></script>
</body>
</html>