<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Stock Operativo</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>

  <style>
    .mc-toolbar { display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap; }
    .mc-left { flex:1; min-width:260px; max-width:520px; }
    .mc-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .mc-subrow { display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:12px; flex-wrap:wrap; }
    .mc-actions { display:flex; align-items:center; justify-content:center; gap:6px; }
    .mc-muted { color: var(--text-secondary); }
    .mc-empty { padding:40px; text-align:center; color: var(--text-secondary); }
    .mc-small { font-size:10px; }
    .mc-pack { font-size:11px; }
    .mc-toggles { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .mc-toggle { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border-subtle); border-radius:999px; background:var(--bg-card); cursor:pointer; user-select:none; }
    .mc-toggle input { accent-color: var(--accent-green); }
    .mc-debug { display:none; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:11px; color:var(--text-secondary); border:1px dashed var(--border-subtle); border-radius:14px; padding:10px; margin-top:10px; }
  </style>
</head>

<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div style="display:flex; align-items:center;">
          <button onclick="window.location.href='operativo-index.html'" class="btn-back">VOLVER</button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Operativo</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <section class="section-header">
      <h1 class="section-title">STOCK OPERATIVO</h1>
      <p class="section-desc">Stock por ubicaci√≥n (Dep√≥sito / Barras). Movimientos por ledger (in/out/adjust) y solicitudes hacia Compras/Admin.</p>
    </section>

    <div class="box-soft" style="margin-bottom:16px;">
      <div class="mc-toolbar">
        <div class="mc-left">
          <input
            type="text"
            id="searchInput"
            class="search-input-admin"
            placeholder="üîç Buscar por nombre o categor√≠a..."
            oninput="filterList()"
          >
        </div>

        <div class="mc-right">
          <select id="locationSelect" class="modal-select" style="min-width:220px;" onchange="loadData()">
            <option value="">Cargando ubicaciones...</option>
          </select>

          <div class="mc-toggles">
            <label class="mc-toggle" title="Muestra solo los que est√°n por debajo del ideal">
              <input type="checkbox" id="togLow" onchange="filterList()">
              <span class="mc-small">Bajo ideal</span>
            </label>

            <label class="mc-toggle" title="Muestra solo los que tienen reposici√≥n pendiente">
              <input type="checkbox" id="togPending" onchange="filterList()">
              <span class="mc-small">Con pendientes</span>
            </label>
          </div>

          <span id="countSkus" class="tag tag-gray">0 insumos</span>
          <button onclick="loadData()" class="btn-secondary">REFRESCAR</button>
        </div>
      </div>

      <div class="mc-subrow">
        <span id="stockStatus" class="inline-status">Cargando...</span>
        <span id="locHint" class="tag tag-blue" style="display:none;">‚Äî</span>
      </div>

      <div id="debugBox" class="mc-debug"></div>
    </div>

    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left:20px;">INSUMO / CATEGOR√çA</th>
            <th>FORMATO</th>
            <th class="text-center" style="width:140px;">STOCK (UBIC.)</th>
            <th class="text-center" style="width:100px;">IDEAL</th>
            <th class="text-center" style="width:160px;">MOVIMIENTO</th>
            <th class="text-center" style="width:240px; padding-right:20px;">SOLICITAR REPOSICI√ìN</th>
          </tr>
        </thead>
        <tbody id="skuList">
          <tr>
            <td colspan="6" class="text-center text-muted mc-empty">Cargando...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal Ajuste Manual -->
  <div id="adjustModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <h3 class="section-title" style="font-size:18px; margin:0;">MOVIMIENTO DE STOCK</h3>
          <p class="section-desc" style="margin:0; font-size:12px;">Inserta en ledger (inventory_movements). El stock se actualiza por trigger.</p>
        </div>
        <div style="text-align:right;">
          <span id="adjToday" class="tag tag-gray">Hoy</span>
        </div>
      </div>

      <input type="hidden" id="adjSkuId">
      <input type="hidden" id="adjCurrentStock">

      <div class="box-soft" style="margin-bottom:16px;">
        <label class="input-label">INSUMO SELECCIONADO</label>
        <div id="adjSkuName" class="row-title" style="font-size:16px;">‚Äî</div>
        <div id="adjSkuMeta" class="row-sub-text">Stock actual: ‚Äî</div>
      </div>

      <div style="display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:240px;">
          <label class="input-label">ACCI√ìN</label>
          <select id="adjAction" class="modal-select" onchange="syncAdjHint()">
            <option value="in">INGRESO (+)</option>
            <option value="out">EGRESO (-)</option>
            <option value="purchase_in">RECEPCI√ìN COMPRA (+)</option>
            <option value="count_set">CONTEO F√çSICO (setear stock)</option>
          </select>
          <div id="adjHint" class="row-sub-text" style="margin-top:6px; font-size:11px; color:var(--text-secondary);">‚Äî</div>
        </div>

        <div style="width:160px;">
          <label id="adjAmountLabel" class="input-label">CANTIDAD</label>
          <input type="number" id="adjAmount" class="modal-input" placeholder="0" inputmode="numeric">
        </div>
      </div>

      <div style="margin-bottom:8px;">
        <label class="input-label">NOTA / JUSTIFICACI√ìN (OBLIGATORIO)</label>
        <textarea id="adjNotes" class="modal-input" placeholder="Motivo..." style="height:90px;"></textarea>
      </div>

      <div class="modal-btns">
        <button onclick="closeModal()" class="btn-secondary">CANCELAR</button>
        <button onclick="saveAdjustment()" id="btnSaveAdj" class="btn-primary">CONFIRMAR</button>
      </div>
    </div>
  </div>

  <script>
    let allSkus = [];
    let locations = [];
    let currentUser = null;

    const statusEl = document.getElementById('stockStatus');
    const countEl = document.getElementById('countSkus');
    const locHintEl = document.getElementById('locHint');
    const debugBox = document.getElementById('debugBox');

    function getDb() {
      if (typeof client !== 'undefined') return client;
      if (window.client) return window.client;
      if (window.supa) return window.supa;
      throw new Error('Supabase client no inicializado (revis√° config.js).');
    }

    function setDebug(msg) {
      // activalo si quer√©s: localStorage.mc_debug = "1"
      const on = localStorage.getItem('mc_debug') === '1';
      debugBox.style.display = on ? 'block' : 'none';
      if (on) debugBox.textContent = String(msg || '');
    }

    window.addEventListener('error', (e) => setDebug('window.error:\n' + (e?.message || e)));
    window.addEventListener('unhandledrejection', (e) => setDebug('unhandledrejection:\n' + (e?.reason?.message || e?.reason || e)));

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const session = localStorage.getItem('mc_user');
        if (!session) { window.location.href = 'index.html'; return; }
        currentUser = JSON.parse(session);

        document.getElementById('adjToday').innerText = new Date().toLocaleDateString('es-AR');

        document.getElementById('adjustModal').addEventListener('click', (e) => {
          if (e.target && e.target.id === 'adjustModal') closeModal();
        });

        await loadLocations();
        await loadData();
      } catch (e) {
        console.error(e);
        setFatalError(e);
      }
    });

    function setFatalError(e) {
      const tbody = document.getElementById('skuList');
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center mc-empty" style="color:var(--accent-red);">
            Error: ${escapeHtml(e?.message || e)}
          </td>
        </tr>`;
      statusEl.textContent = 'Error. Revis√° config/RLS/vistas.';
      setDebug(e?.stack || e?.message || e);
    }

    // =========================
    // UBICACIONES
    // =========================
    async function loadLocations() {
      const db = getDb();
      try {
        const { data, error } = await db
          .from('inventory_locations')
          .select('id, code, name, kind, sort_order, is_active')
          .eq('is_active', true)
          .order('sort_order', { ascending: true });

        if (error) throw error;

        locations = (data || []).map(x => ({
          id: Number(x.id),
          code: x.code || '',
          name: x.name || '',
          kind: x.kind || '',
          sort_order: Number(x.sort_order || 0)
        }));

        const sel = document.getElementById('locationSelect');

        if (!locations.length) {
          sel.innerHTML = `<option value="">Sin ubicaciones</option>`;
          return;
        }

        sel.innerHTML = locations.map(l =>
          `<option value="${l.id}">${escapeHtml(l.code)} ‚Äî ${escapeHtml(l.name)}</option>`
        ).join('');

        const deposit = locations.find(l => String(l.kind).toUpperCase() === 'DEPOSIT');
        sel.value = String((deposit?.id || locations[0]?.id || 1));

      } catch (e) {
        console.error(e);
        // fallback seguro
        locations = [{ id: 1, code: 'DEP', name: 'DEPOSITO', kind: 'DEPOSIT', sort_order: 0 }];
        const sel = document.getElementById('locationSelect');
        sel.innerHTML = `<option value="1">DEP ‚Äî DEPOSITO</option>`;
        sel.value = "1";
      }
    }

    function getSelectedLocationId() {
      const v = document.getElementById('locationSelect').value;
      const n = Number(v);
      return Number.isFinite(n) && n > 0 ? n : 1;
    }

    function getSelectedLocationLabel() {
      const id = getSelectedLocationId();
      const loc = locations.find(x => x.id === id);
      return loc ? `${loc.code} ‚Äî ${loc.name}` : `Ubicaci√≥n ${id}`;
    }

    // =========================
    // CARGA DE DATOS (sin embeds)
    // =========================
    async function loadData() {
      const db = getDb();
      try {
        statusEl.textContent = 'Actualizando...';

        const locationId = getSelectedLocationId();
        const locLabel = getSelectedLocationLabel();
        locHintEl.style.display = 'inline-flex';
        locHintEl.textContent = `UBICACI√ìN: ${locLabel}`;

        // 1) SKUs
        const { data: skusData, error: skusError } = await db
          .from('inventory_skus')
          .select('id, name, category, unit_type, pack_size, unit_label')
          .eq('is_active', true)
          .order('name');

        if (skusError) throw skusError;

        const skuIds = (skusData || []).map(s => Number(s.id)).filter(Boolean);

        // 2) IDEAL (inventory_stock)
        const idealMap = new Map();
        if (skuIds.length) {
          for (const batch of chunkArray(skuIds, 500)) {
            const { data: stockData, error: stockError } = await db
              .from('inventory_stock')
              .select('sku_id, stock_ideal')
              .in('sku_id', batch);
            if (stockError) throw stockError;
            (stockData || []).forEach(r => idealMap.set(Number(r.sku_id), safeNum(r.stock_ideal)));
          }
        }

        // 3) STOCK POR UBICACI√ìN (vista inventory_location_stock)
        const locMap = new Map();
        if (skuIds.length) {
          for (const batch of chunkArray(skuIds, 500)) {
            const { data: locStockData, error: locStockError } = await db
              .from('inventory_location_stock')
              .select('sku_id, stock_current, location_id')
              .eq('location_id', locationId)
              .in('sku_id', batch);

            if (locStockError) throw locStockError;
            (locStockData || []).forEach(r => locMap.set(Number(r.sku_id), safeNum(r.stock_current)));
          }
        }

        // 4) Requests pendientes
        const { data: reqData, error: reqError } = await db
          .from('stock_requests')
          .select('sku_id, requested_qty, status')
          .eq('status', 'PENDING');

        if (reqError) throw reqError;

        const pendingRequests = new Map();
        (reqData || []).forEach(r => {
          const key = Number(r.sku_id);
          const prev = pendingRequests.get(key) || 0;
          pendingRequests.set(key, prev + (safeNum(r.requested_qty) || 0));
        });

        allSkus = (skusData || []).map(item => ({
          id: Number(item.id),
          name: item.name || '',
          category: item.category || null,
          unit_type: item.unit_type || null,
          pack_size: item.pack_size,
          unit_label: item.unit_label || null,
          stock_current: locMap.get(Number(item.id)) ?? 0,
          stock_ideal: idealMap.get(Number(item.id)) ?? 0,
          pending_request: pendingRequests.get(Number(item.id)) || 0
        }));

        renderList(getCurrentList());
        updateCount();

        statusEl.textContent = 'OK ‚Äî ' + new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        setDebug('');

      } catch (e) {
        console.error(e);
        setFatalError(e);
      }
    }

    function updateCount() { countEl.textContent = `${allSkus.length} insumos`; }

    // =========================
    // LISTA & FILTRO
    // =========================
    function getCurrentList() {
      const t = (document.getElementById('searchInput').value || '').toLowerCase().trim();
      const onlyLow = document.getElementById('togLow').checked;
      const onlyPending = document.getElementById('togPending').checked;

      let list = allSkus;

      if (t) {
        list = list.filter(i =>
          (i.name || '').toLowerCase().includes(t) ||
          (i.category || '').toLowerCase().includes(t)
        );
      }

      if (onlyPending) list = list.filter(i => safeNum(i.pending_request) > 0);

      if (onlyLow) {
        list = list.filter(i => {
          const ideal = safeNum(i.stock_ideal);
          const cur = safeNum(i.stock_current);
          return ideal > 0 && cur < ideal;
        });
      }

      return list;
    }

    function filterList() { renderList(getCurrentList()); }

    function renderList(list) {
      const tbody = document.getElementById('skuList');

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted mc-empty">Sin resultados.</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(i => {
        const stockVal = safeNum(i.stock_current);
        const idealVal = safeNum(i.stock_ideal);

        let stockColor = 'var(--text-primary)';
        if (idealVal > 0) {
          if (stockVal <= (idealVal * 0.2)) stockColor = 'var(--accent-red)';
          else if (stockVal < idealVal) stockColor = 'var(--accent-gold)';
          else stockColor = 'var(--accent-green)';
        } else {
          stockColor = 'var(--text-secondary)';
        }

        let presentation = escapeHtml(i.unit_type || '-');
        if (String(i.unit_label || '').toUpperCase() === 'PACK' && safeNum(i.pack_size) > 1) {
          presentation = `<span class="tag tag-blue mc-pack">${escapeHtml(i.unit_type || 'UNIDAD')} (PACK x${safeNum(i.pack_size)})</span>`;
        }

        const pendingText = i.pending_request > 0
          ? `<div class="mc-small" style="color:var(--accent-gold); margin-top:4px;">‚è≥ Pendiente: ${safeNum(i.pending_request)}</div>`
          : '';

        return `
          <tr>
            <td style="padding-left: 20px;">
              <div class="row-title">${escapeHtml(i.name)}</div>
              <div class="row-sub-text">${escapeHtml(i.category || 'SIN CATEGOR√çA')}</div>
            </td>

            <td class="mc-pack">${presentation}</td>

            <td class="text-center" style="font-size:14px; font-weight:800; color:${stockColor};">
              ${stockVal}
            </td>

            <td class="text-center text-muted">
              ${idealVal || '-'}
            </td>

            <td class="text-center">
              <button onclick="openModal(${i.id}, 1)" class="btn-icon" title="Ingreso">+</button>
              <button onclick="openModal(${i.id}, -1)" class="btn-icon" title="Egreso" style="margin-left:6px;">‚àí</button>
            </td>

            <td class="text-center" style="padding-right:20px;">
              <div class="mc-actions">
                <input
                  type="number"
                  min="1"
                  id="req-${i.id}"
                  class="table-input"
                  style="width:70px;"
                  placeholder="0"
                  inputmode="numeric"
                >
                <button class="btn-primary" style="padding:6px 10px; font-size:10px;" onclick="handleRequest(${i.id})">
                  PEDIR
                </button>
              </div>
              ${pendingText}
            </td>
          </tr>
        `;
      }).join('');
    }

    // =========================
    // MODAL MOVIMIENTO
    // =========================
    function openModal(skuId, typeSign) {
      const sku = allSkus.find(x => x.id === Number(skuId));
      if (!sku) return;

      const locLabel = getSelectedLocationLabel();

      document.getElementById('adjSkuId').value = sku.id;
      document.getElementById('adjCurrentStock').value = safeNum(sku.stock_current);
      document.getElementById('adjSkuName').innerText = sku.name;
      document.getElementById('adjSkuMeta').innerText = `Ubicaci√≥n: ${locLabel} ‚Äî Stock actual: ${safeNum(sku.stock_current)} ${sku.unit_type || 'UNIDAD'}`;

      const action = document.getElementById('adjAction');
      const btn = document.getElementById('btnSaveAdj');

      if (typeSign === 1) {
        action.value = 'in';
        btn.textContent = 'CONFIRMAR INGRESO';
      } else {
        action.value = 'out';
        btn.textContent = 'CONFIRMAR EGRESO';
      }

      document.getElementById('adjAmount').value = '';
      document.getElementById('adjNotes').value = '';

      syncAdjHint();

      document.getElementById('adjustModal').style.display = 'flex';
      setTimeout(() => document.getElementById('adjAmount').focus(), 50);
    }

    function syncAdjHint() {
      const v = document.getElementById('adjAction').value;
      const hint = document.getElementById('adjHint');
      const label = document.getElementById('adjAmountLabel');

      if (v === 'count_set') {
        label.textContent = 'CONTEO (stock final)';
        hint.textContent = 'Ingres√°s el stock final contado. Se registra un ADJUST con la diferencia (no permite delta 0).';
      } else if (v === 'purchase_in') {
        label.textContent = 'CANTIDAD';
        hint.textContent = 'Ingreso por compra (movement_type=in, reason_code=PURCHASE).';
      } else if (v === 'out') {
        label.textContent = 'CANTIDAD';
        hint.textContent = 'Egreso (movement_type=out).';
      } else {
        label.textContent = 'CANTIDAD';
        hint.textContent = 'Ingreso (movement_type=in).';
      }
    }

    function closeModal() { document.getElementById('adjustModal').style.display = 'none'; }

    // =========================
    // ACCIONES (solo ledger)
    // =========================
    async function saveAdjustment() {
      const db = getDb();

      const skuId = Number(document.getElementById('adjSkuId').value);
      const currentStock = safeNum(document.getElementById('adjCurrentStock').value);
      const action = document.getElementById('adjAction').value;
      const amount = safeNum(document.getElementById('adjAmount').value);
      const notesRaw = (document.getElementById('adjNotes').value || '').trim();

      if (!notesRaw) return alert('La justificaci√≥n es obligatoria.');

      const locationId = getSelectedLocationId();
      const locLabel = getSelectedLocationLabel();

      let movement_type = 'adjust';
      let reason_code = 'MANUAL';
      let change_amount = 0;

      if (action === 'count_set') {
        if (!Number.isFinite(amount) || amount < 0) return alert('Ingres√° un conteo v√°lido (>= 0).');
        change_amount = amount - currentStock;
        movement_type = 'adjust';
        reason_code = 'COUNT';
        if (change_amount === 0) return alert('Conteo sin cambios. No se registra movimiento.');
      } else {
        if (!amount || amount <= 0) return alert('Ingres√° una cantidad v√°lida (> 0).');

        if (action === 'purchase_in') {
          movement_type = 'in';
          reason_code = 'PURCHASE';
          change_amount = Math.abs(amount);
        } else if (action === 'in') {
          movement_type = 'in';
          reason_code = 'MANUAL_IN';
          change_amount = Math.abs(amount);
        } else if (action === 'out') {
          movement_type = 'out';
          reason_code = 'MANUAL_OUT';
          change_amount = -Math.abs(amount);
        }
      }

      const newStock = currentStock + change_amount;
      if (newStock < 0) return alert('El stock resultante no puede ser negativo.');

      const btn = document.getElementById('btnSaveAdj');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'PROCESANDO...';

      try {
        const userId = asUuidOrNull(currentUser?.id);
        const notes = `[${locLabel}] ${notesRaw}`;

        const { error: moveError } = await db.from('inventory_movements').insert({
          sku_id: skuId,
          user_id: userId,
          change_amount: change_amount,
          movement_type: movement_type,     // in/out/adjust (SIEMPRE)
          notes: notes,
          location_id: locationId,
          reason_code: reason_code
          // event_date: opcional (trigger la completa si es null)
        });

        if (moveError) throw moveError;

        toast('Movimiento registrado.');
        closeModal();
        await loadData();

      } catch (e) {
        console.error(e);
        alert('Error: ' + (e.message || e));
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function handleRequest(skuId) {
      const db = getDb();

      const input = document.getElementById(`req-${skuId}`);
      const qty = safeNum(input.value);
      if (!qty || qty <= 0) return alert('Ingres√° una cantidad v√°lida.');

      const sku = allSkus.find(x => x.id === Number(skuId));
      if (!sku) return;

      const locLabel = getSelectedLocationLabel();
      if (!confirm(`¬øSolicitar ${qty} ${sku.unit_type || 'UN'} de ${sku.name} para ${locLabel}?`)) return;

      const payload = {
        sku_id: Number(skuId),
        requested_qty: qty,
        requested_by: asUuidOrNull(currentUser?.id),
        status: 'PENDING'
      };

      try {
        let { error } = await db.from('stock_requests').insert(payload);

        // retry por compatibilidad si existen variaciones de schema (notes/location_id)
        if (error && /column .*notes/i.test(error.message || '')) {
          // nada, no mandamos notes
        } else if (error) {
          throw error;
        }

        input.value = '';
        toast('Solicitud creada.');
        await loadData();

      } catch (e) {
        console.error(e);
        alert('Error al solicitar: ' + (e.message || e));
      }
    }

    // =========================
    // HELPERS
    // =========================
    function toast(msg) {
      if (window.MC_UTILS && typeof MC_UTILS.showToast === 'function') return MC_UTILS.showToast(msg);
      // fallback silencioso
      statusEl.textContent = msg;
    }

    function safeNum(v) {
      const n = Number(String(v ?? '').replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function chunkArray(arr, size) {
      const out = [];
      for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
      return out;
    }

    function asUuidOrNull(v) {
      const s = String(v || '').trim().toLowerCase();
      const uuidRe = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
      return uuidRe.test(s) ? s : null;
    }
  </script>
</body>
</html>
