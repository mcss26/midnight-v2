<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Stock Global Operativo</title>
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>


</head>
<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div class="admin-logo"></div>
        <div class="admin-header-right">
          <button onclick="window.location.href='operativo-index.html'" class="btn-back">VOLVER</button>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <div class="section-header">
      <h2 class="section-title">STOCK GLOBAL OPERATIVO</h2>
      <p class="section-desc">Conteo manual, ajustes y solicitudes de reposición hacia Administración.</p>
    </div>

    <div class="section-header" style="flex-direction: row; justify-content: space-between; align-items: center;">
      <input
        type="text"
        id="searchInput"
        class="search-input-admin"
        placeholder="Buscar insumo por nombre..."
        oninput="filterList()"
      >
      <button onclick="loadData()" class="btn-primary">REFRESCAR</button>
    </div>

    <div class="table-container" style="margin-top: 12px;">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left: 25px;">INSUMO / CATEGORÍA</th>
            <th style="text-align:center; width: 110px;">STOCK ACTUAL</th>
            <th style="text-align:center; width: 110px;">STOCK IDEAL</th>
            <th style="width: 220px; text-align:center;">AJUSTE RÁPIDO</th>
            <th style="width: 220px; text-align:center;">SOLICITAR</th>
          </tr>
        </thead>
        <tbody id="skuList">
          <tr>
            <td colspan="5" style="text-align:center; padding: 40px; color: var(--text-secondary);">
              Cargando inventario...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- MODAL AJUSTE -->
  <div id="adjustModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
      <h3 class="section-title" style="font-size:20px; margin-bottom:10px;">
        Ajuste Detallado de Stock
      </h3>
      <p class="section-desc">
        Registra un movimiento en <span id="adjToday"></span>
      </p>

      <input type="hidden" id="adjSkuId">
      <input type="hidden" id="adjCurrentStock">
      
      <label class="input-label">INSUMO:</label>
      <div
        id="adjSkuName"
        style="font-weight:700; color:var(--accent-blue); font-size:16px; margin-bottom:15px;"
      ></div>

      <div style="display:flex; gap:15px;">
        <div style="flex:1;">
          <label class="input-label">TIPO DE MOVIMIENTO</label>
          <select id="adjType" class="modal-select">
            <option value="AJUSTE_POSITIVO">INGRESO / AJUSTE (+)</option>
            <option value="AJUSTE_NEGATIVO">EGRESO / AJUSTE (-)</option>
            <option value="RECEPCION_COMPRA">RECEPCIÓN DE COMPRA</option>
            <option value="INVENTARIO_FISICO">CONTEO FÍSICO (Inicial/Final)</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="input-label">CANTIDAD A AJUSTAR</label>
          <input type="number" id="adjAmount" class="modal-input" placeholder="0">
        </div>
      </div>

      <label class="input-label">NOTA / JUSTIFICACIÓN (Obligatorio)</label>
      <textarea
        id="adjNotes"
        class="modal-input"
        placeholder="Detalle el motivo del ajuste..."
        style="height:80px;"
      ></textarea>

      <div class="modal-btns">
        <button onclick="closeModal()" class="btn-modal-cancel">Cancelar</button>
        <button
          onclick="saveAdjustment()"
          class="btn-modal-save"
          style="background:var(--accent-green);"
        >
          GUARDAR Y ACTUALIZAR STOCK
        </button>
      </div>
    </div>
  </div>

  <script>
    let allSkus = [];
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const session = localStorage.getItem('mc_user');
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = JSON.parse(session);

      // Fecha de hoy en el modal
      document.getElementById('adjToday').innerText =
        new Date().toLocaleDateString('es-AR');

      await loadData();
    });

    // =========================
    // CARGA DE DATOS DESDE SUPABASE
    // =========================
    async function loadData() {
      try {
        const skusRes = await client
          .from('inventory_stock')
          .select(`
            sku_id,
            stock_current,
            stock_ideal,
            inventory_skus (
              id,
              name,
              category,
              unit_type,
              cost_price,
              is_active
            )
          `)
          .eq('inventory_skus.is_active', true)
          .order('sku_id');

        if (skusRes.error) {
          console.error('Error de carga de Supabase:', skusRes.error);
          document.getElementById('skuList').innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--accent-red);">Error al conectar/cargar datos.</td></tr>';
          return;
        }

        const data = skusRes.data || [];

        // Pedidos pendientes de stock_requests
        const { data: reqData, error: reqError } = await client
          .from('stock_requests')
          .select('sku_id, requested_qty, status');

        if (reqError) {
          console.error('Error al cargar solicitudes:', reqError);
        }

        const pendingRequests = new Map();
        (reqData || [])
          .filter(r => r.status === 'PENDING')
          .forEach(r => {
            const prev = pendingRequests.get(r.sku_id) || 0;
            pendingRequests.set(r.sku_id, prev + (Number(r.requested_qty) || 0));
          });

        allSkus = data
          .filter(item => item.inventory_skus)
          .map(item => ({
            id: item.sku_id,
            name: item.inventory_skus.name,
            category: item.inventory_skus.category,
            unit_type: item.inventory_skus.unit_type,
            cost_price: item.inventory_skus.cost_price,
            stock_current: item.stock_current,
            stock_ideal: item.stock_ideal,
            pending_request: pendingRequests.get(item.sku_id) || 0
          }));

        renderList(allSkus);
      } catch (e) {
        console.error('Error general al cargar datos:', e);
        document.getElementById('skuList').innerHTML =
          '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--accent-red);">Error al cargar datos.</td></tr>';
      }
    }

    // =========================
    // RENDER TABLA
    // =========================
    function renderList(list) {
      const tbody = document.getElementById('skuList');

      if (!list.length) {
        tbody.innerHTML =
          '<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-secondary);">Sin insumos operativos cargados.</td></tr>';
        return;
      }

      tbody.innerHTML = list
        .map(i => {
          const stockColor =
            i.stock_current < (i.stock_ideal * 0.2)
              ? 'var(--accent-red)'
              : (i.stock_current < i.stock_ideal
                  ? 'var(--accent-gold)'
                  : 'var(--accent-green)');

          const pendingText = i.pending_request > 0
            ? `<div class="request-pending">Pendiente: ${i.pending_request} ${i.unit_type || ''}</div>`
            : '';

          return `
            <tr>
              <td style="padding-left: 25px;">
                <div class="row-title">${i.name}</div>
                <div class="row-sub-text">
                  <span class="tag tag-gray">${i.category || 'GRAL'}</span>
                </div>
              </td>
              <td style="text-align:center; font-weight:700; color:${stockColor};">
                ${i.stock_current} ${i.unit_type || ''}
              </td>
              <td style="text-align:center; color:var(--text-secondary);">
                ${i.stock_ideal ?? '-'}
              </td>
              <td style="text-align:center;">
                <button
                  onclick="openModal(${i.id}, 1)"
                  class="btn-stock-adjust"
                  style="border-color:var(--accent-green); color:var(--accent-green);"
                >
                  + AJUSTE
                </button>
                <button
                  onclick="openModal(${i.id}, -1)"
                  class="btn-stock-adjust"
                  style="border-color:var(--accent-red); color:var(--accent-red); margin-left:8px;"
                >
                  - AJUSTE
                </button>
              </td>
              <td style="text-align:center;">
                <input
                  type="number"
                  min="1"
                  step="1"
                  id="req-${i.id}"
                  class="table-input"
                  placeholder="0"
                />
                <button
                  type="button"
                  class="btn-primary btn-stock-request"
                  onclick="handleRequest(${i.id})"
                >
                  SOLICITAR
                </button>
                ${pendingText}
              </td>
            </tr>
          `;
        })
        .join('');
    }

    // =========================
    // BUSCADOR
    // =========================
    function filterList() {
      const t = document.getElementById('searchInput').value.toLowerCase();
      renderList(allSkus.filter(i => i.name.toLowerCase().includes(t)));
    }

    // =========================
    // MODAL AJUSTE
    // =========================
    function openModal(skuId, typeSign) {
      const sku = allSkus.find(x => x.id === skuId);
      if (!sku) return;

      document.getElementById('adjSkuId').value = sku.id;
      document.getElementById('adjCurrentStock').value = sku.stock_current;
      document.getElementById('adjSkuName').innerText = sku.name;

      const saveBtn = document.querySelector('.modal-box button.btn-modal-save');

      if (typeSign === 1) {
        document.getElementById('adjType').value = 'AJUSTE_POSITIVO';
        saveBtn.style.background = 'var(--accent-green)';
      } else {
        document.getElementById('adjType').value = 'AJUSTE_NEGATIVO';
        saveBtn.style.background = 'var(--accent-red)';
      }

      document.getElementById('adjAmount').value = '';
      document.getElementById('adjNotes').value = '';

      document.getElementById('adjustModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('adjustModal').style.display = 'none';
    }

    // =========================
    // GUARDAR AJUSTE
    // =========================
    async function saveAdjustment() {
      const skuId = document.getElementById('adjSkuId').value;
      const currentStock = parseFloat(document.getElementById('adjCurrentStock').value);
      const type = document.getElementById('adjType').value;
      const amount = parseFloat(document.getElementById('adjAmount').value);
      const notes = document.getElementById('adjNotes').value.trim();

      if (!amount || amount <= 0) {
        alert('Ingresa una cantidad válida.');
        return;
      }
      if (!notes) {
        alert('La justificación es obligatoria.');
        return;
      }

      let changeAmount = amount;
      if (type === 'AJUSTE_NEGATIVO') {
        changeAmount = -amount;
      }

      const newStock = currentStock + changeAmount;

      if (newStock < 0) {
        alert('Error: El ajuste negativo excede el stock actual.');
        return;
      }

      if (!confirm(`Confirmar ajuste de ${changeAmount} unidades? Stock final estimado: ${newStock}`)) {
        return;
      }

      const userId = (currentUser.id === 'dev') ? null : currentUser.id;

      const btn = document.querySelector('.modal-box button.btn-modal-save');
      btn.disabled = true;
      btn.innerText = 'ACTUALIZANDO...';

      try {
        // 1. Registrar el movimiento
        const { error: moveError } = await client
          .from('inventory_movements')
          .insert({
            sku_id: skuId,
            user_id: userId,
            change_amount: changeAmount,
            movement_type: type,
            notes: notes,
            event_date: new Date().toISOString().split('T')[0]
          });

        if (moveError) throw moveError;

        // 2. Actualizar el stock operativo
        const { error: stockError } = await client
          .from('inventory_stock')
          .update({ stock_current: newStock })
          .eq('sku_id', skuId);

        if (stockError) throw stockError;

        // 3. Log de admin (no rompe si falla)
        await client.from('admin_logs').insert({
          admin_id: userId,
          action: 'AJUSTE_STOCK_OPERATIVO',
          details: `SKU ${skuId}: ${type} por ${changeAmount}. Nuevo stock: ${newStock}.`
        });

        alert('✅ Stock ajustado y movimiento registrado.');
        closeModal();
        await loadData();

      } catch (e) {
        console.error('Error al guardar el ajuste:', e);
        alert('Error al guardar el ajuste: ' + (e.message || 'Error desconocido'));
      } finally {
        btn.disabled = false;
        btn.innerText = 'GUARDAR Y ACTUALIZAR STOCK';
      }
    }

    // =========================
    // SOLICITAR REPOSICIÓN
    // =========================
    async function handleRequest(skuId) {
      const input = document.getElementById(`req-${skuId}`);
      if (!input) return;

      const qty = parseFloat(input.value);
      if (!qty || qty <= 0) {
        alert('Ingresa una cantidad válida para solicitar.');
        return;
      }

      const sku = allSkus.find(x => x.id === skuId);
      if (!sku) {
        alert('SKU no encontrado.');
        return;
      }

      const userId = (currentUser.id === 'dev') ? null : currentUser.id;

      if (!confirm(`Confirmar solicitud de ${qty} ${sku.unit_type || ''} de "${sku.name}"?`)) {
        return;
      }

      try {
        const { error } = await client
          .from('stock_requests')
          .insert({
            sku_id: skuId,
            requested_qty: qty,
            requested_by: userId,
            status: 'PENDING'
          });

        if (error) throw error;

        alert('Solicitud registrada y enviada a Administración.');
        input.value = '';
        await loadData();
      } catch (e) {
        console.error('Error al registrar solicitud:', e);
        alert('No se pudo registrar la solicitud. Intenta nuevamente.');
      }
    }
  </script>
</body>
</html>
