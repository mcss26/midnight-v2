<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Stock Operativo</title>
  
  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>
<body>

  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        
        <div style="display:flex; align-items:center;">
          <button onclick="window.location.href='operativo-index.html'" class="btn-back">VOLVER</button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Operativo</span>
        </div>

      </div>
    </div>
  </header>

  <main class="admin-container">
    
    <section class="section-header">
      <h1 class="section-title">STOCK GLOBAL OPERATIVO</h1>
      <p class="section-desc">
        Control de inventario f√≠sico, ajustes r√°pidos y solicitudes de reposici√≥n hacia Compras/Admin.
      </p>
    </section>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:16px; flex-wrap:wrap;">
      <div style="flex:1; min-width:260px; max-width:420px;">
        <input
          type="text"
          id="searchInput"
          class="search-input-admin"
          placeholder="üîç Buscar por nombre o categor√≠a..."
          oninput="filterList()"
        >
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <span id="countSkus" class="tag tag-gray">0 insumos</span>
        <button onclick="loadData()" class="btn-secondary">REFRESCAR DATOS</button>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <span id="stockStatus" class="inline-status">Cargando inventario...</span>
    </div>

    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left: 20px;">INSUMO / CATEGOR√çA</th>
            <th>FORMATO</th>
            <th class="text-center" style="width: 120px;">STOCK (UN)</th>
            <th class="text-center" style="width: 100px;">IDEAL</th>
            <th class="text-center" style="width: 160px;">AJUSTE R√ÅPIDO</th>
            <th class="text-center" style="width: 220px;">SOLICITAR REPOSICI√ìN</th>
          </tr>
        </thead>
        <tbody id="skuList">
          <tr>
            <td colspan="6" style="text-align:center; padding: 40px; color: var(--text-secondary);">
              Cargando inventario...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </main>

  <div id="adjustModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <h3 class="section-title" style="font-size:18px; margin:0;">AJUSTE DE STOCK</h3>
          <p class="section-desc" style="margin:0; font-size:12px;">Registra un movimiento manual.</p>
        </div>
        <div style="text-align:right;">
          <span id="adjToday" class="tag tag-gray">Hoy</span>
        </div>
      </div>

      <input type="hidden" id="adjSkuId">
      <input type="hidden" id="adjCurrentStock">
      
      <div style="margin-bottom:16px; background:rgba(255,255,255,0.03); padding:12px; border-radius:8px;">
        <label class="input-label">INSUMO SELECCIONADO</label>
        <div id="adjSkuName" style="font-weight:700; font-size:16px; color:#fff;">‚Äî</div>
        <div id="adjSkuMeta" class="row-sub-text">Stock actual: ‚Äî</div>
      </div>

      <div style="display:flex; gap:12px; margin-bottom:12px;">
        <div style="flex:1;">
          <label class="input-label">TIPO DE MOVIMIENTO</label>
          <select id="adjType" class="modal-select">
            <option value="AJUSTE_POSITIVO">INGRESO / AJUSTE (+)</option>
            <option value="AJUSTE_NEGATIVO">EGRESO / AJUSTE (-)</option>
            <option value="RECEPCION_COMPRA">RECEPCI√ìN DE COMPRA</option>
            <option value="INVENTARIO_FISICO">CONTEO F√çSICO (CORRECCI√ìN)</option>
          </select>
        </div>
        <div style="width:120px;">
          <label class="input-label">CANTIDAD</label>
          <input type="number" id="adjAmount" class="modal-input" placeholder="0">
        </div>
      </div>

      <div style="margin-bottom:20px;">
        <label class="input-label">NOTA / JUSTIFICACI√ìN (OBLIGATORIO)</label>
        <textarea id="adjNotes" class="modal-input" placeholder="Motivo del ajuste..." style="height:80px;"></textarea>
      </div>

      <div class="modal-btns">
        <button onclick="closeModal()" class="btn-secondary">Cancelar</button>
        <button onclick="saveAdjustment()" id="btnSaveAdj" class="btn-primary">Confirmar Ajuste</button>
      </div>
    </div>
  </div>

  <script>
    let allSkus = [];
    let currentUser = null;

    const statusEl = document.getElementById('stockStatus');
    const countEl = document.getElementById('countSkus');

    document.addEventListener('DOMContentLoaded', async () => {
      const session = localStorage.getItem('mc_user');
      if (!session) {
        // Fallback modo dev si no hay sesi√≥n (para pruebas)
        currentUser = { id: 'dev', username: 'DEV' };
      } else {
        currentUser = JSON.parse(session);
      }

      const today = new Date();
      const formattedDate = today.toLocaleDateString('es-AR');
      document.getElementById('adjToday').innerText = formattedDate;

      await loadData();
    });

    // =========================
    // CARGA DE DATOS
    // =========================
    async function loadData() {
      try {
        statusEl.textContent = 'Actualizando datos...';

        // 1. Traer TODOS los SKUs activos + su stock (left join)
        const { data: skusData, error: skusError } = await client
          .from('inventory_skus')
          .select(`
            id,
            name,
            category,
            unit_type,
            pack_size,
            unit_label,
            inventory_stock (stock_current, stock_ideal)
          `)
          .eq('is_active', true)
          .order('name');

        if (skusError) throw skusError;

        // 2. Traer solicitudes pendientes
        const { data: reqData } = await client
          .from('stock_requests')
          .select('sku_id, requested_qty, status')
          .eq('status', 'PENDING');

        const pendingRequests = new Map();
        (reqData || []).forEach(r => {
          const prev = pendingRequests.get(r.sku_id) || 0;
          pendingRequests.set(r.sku_id, prev + (Number(r.requested_qty) || 0));
        });

        // 3. Mapear datos (flatten)
        allSkus = (skusData || []).map(item => {
          const stockRecord = Array.isArray(item.inventory_stock)
            ? item.inventory_stock[0]
            : item.inventory_stock;

          return {
            id: item.id,
            name: item.name,
            category: item.category,
            unit_type: item.unit_type,
            pack_size: item.pack_size,
            unit_label: item.unit_label,
            stock_current: stockRecord ? Number(stockRecord.stock_current) : 0,
            stock_ideal: stockRecord ? Number(stockRecord.stock_ideal) : 0,
            pending_request: pendingRequests.get(item.id) || 0
          };
        });

        renderList(allSkus);
        updateCount();
        statusEl.textContent = 'Actualizado ' + new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

      } catch (e) {
        console.error('Error:', e);
        document.getElementById('skuList').innerHTML =
          '<tr><td colspan="6" class="text-center" style="padding: 40px; color:var(--accent-red);">Error de conexi√≥n: ' + e.message + '</td></tr>';
        statusEl.textContent = 'Error de conexi√≥n. Intent√° nuevamente.';
      }
    }

    function updateCount() {
      countEl.textContent = `${allSkus.length} insumos`;
    }

    // =========================
    // RENDERIZADO
    // =========================
    function renderList(list) {
      const tbody = document.getElementById('skuList');

      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" style="padding:40px;">Sin insumos operativos.</td></tr>';
        return;
      }

      tbody.innerHTML = list.map(i => {
        const stockVal = i.stock_current || 0;
        const idealVal = i.stock_ideal || 0;

        let stockColor = 'var(--text-primary)';
        if (idealVal > 0) {
          if (stockVal <= (idealVal * 0.2)) stockColor = 'var(--accent-red)';
          else if (stockVal < idealVal) stockColor = 'var(--accent-gold)';
          else stockColor = 'var(--accent-green)';
        } else if (idealVal === 0) {
          stockColor = 'var(--text-secondary)';
        }

        let presentation = i.unit_type || '-';
        if (i.unit_label === 'PACK' && i.pack_size > 1) {
          presentation = `<span class="tag tag-blue" style="font-size:9px;">${i.unit_type || 'UNIDAD'} (PACK x${i.pack_size})</span>`;
        }

        const pendingText = i.pending_request > 0
          ? `<div style="font-size:10px; color:var(--accent-gold); margin-top:4px;">‚è≥ Pendiente: ${i.pending_request}</div>`
          : '';

        return `
          <tr>
            <td style="padding-left: 20px;">
              <div class="row-title">${i.name}</div>
              <div class="row-sub-text">${i.category || 'SIN CATEGOR√çA'}</div>
            </td>
            <td style="font-size:11px;">
              ${presentation}
            </td>
            <td class="text-center" style="font-size:14px; font-weight:700; color:${stockColor};">
              ${stockVal}
            </td>
            <td class="text-center text-muted">
              ${idealVal || '-'}
            </td>
            <td class="text-center">
              <button onclick="openModal(${i.id}, 1)" class="btn-icon" title="Ingreso r√°pido">
                +
              </button>
              <button onclick="openModal(${i.id}, -1)" class="btn-icon" title="Egreso r√°pido" style="margin-left:6px;">
                ‚àí
              </button>
            </td>
            <td class="text-center">
              <div style="display:flex; align-items:center; justify-content:center; gap:6px;">
                <input
                  type="number"
                  min="1"
                  id="req-${i.id}"
                  class="table-input"
                  style="width:60px; border:1px solid var(--border-subtle);"
                  placeholder="0"
                >
                <button class="btn-primary" style="padding:6px 10px; font-size:10px;" onclick="handleRequest(${i.id})">
                  PEDIR
                </button>
              </div>
              ${pendingText}
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterList() {
      const t = document.getElementById('searchInput').value.toLowerCase().trim();
      if (!t) {
        renderList(allSkus);
        return;
      }

      const filtered = allSkus.filter(i =>
        i.name.toLowerCase().includes(t) ||
        (i.category || '').toLowerCase().includes(t)
      );
      renderList(filtered);
    }

    // =========================
    // MODAL AJUSTE
    // =========================
    function openModal(skuId, typeSign) {
      const sku = allSkus.find(x => x.id === skuId);
      if (!sku) return;

      document.getElementById('adjSkuId').value = sku.id;
      document.getElementById('adjCurrentStock').value = sku.stock_current;
      document.getElementById('adjSkuName').innerText = sku.name;
      document.getElementById('adjSkuMeta').innerText =
        `Stock actual: ${sku.stock_current || 0} ${sku.unit_type || 'UNIDAD'}`;

      const saveBtn = document.getElementById('btnSaveAdj');
      const selectType = document.getElementById('adjType');

      if (typeSign === 1) {
        selectType.value = 'AJUSTE_POSITIVO';
        saveBtn.style.background = 'var(--accent-green)';
        saveBtn.innerText = 'CONFIRMAR INGRESO';
      } else {
        selectType.value = 'AJUSTE_NEGATIVO';
        saveBtn.style.background = 'var(--accent-red)';
        saveBtn.innerText = 'CONFIRMAR EGRESO';
      }

      document.getElementById('adjAmount').value = '';
      document.getElementById('adjNotes').value = '';
      document.getElementById('adjustModal').style.display = 'flex';
      document.getElementById('adjAmount').focus();
    }

    function closeModal() {
      document.getElementById('adjustModal').style.display = 'none';
    }

    // =========================
    // ACCIONES (AJUSTE & SOLICITUD)
    // =========================
    async function saveAdjustment() {
      const skuId = document.getElementById('adjSkuId').value;
      const currentStock = parseFloat(document.getElementById('adjCurrentStock').value);
      const type = document.getElementById('adjType').value;
      const amount = parseFloat(document.getElementById('adjAmount').value);
      const notes = document.getElementById('adjNotes').value.trim();

      if (!amount || amount <= 0) return alert('Ingresa una cantidad v√°lida.');
      if (!notes) return alert('La justificaci√≥n es obligatoria.');

      let changeAmount = amount;
      if (type === 'AJUSTE_NEGATIVO') changeAmount = -amount;

      // Si es inventario f√≠sico, el cambio es la diferencia entre lo contado y lo actual
      if (type === 'INVENTARIO_FISICO') {
        changeAmount = amount - currentStock;
      }

      const newStock = currentStock + changeAmount;
      if (newStock < 0) return alert('Error: El stock resultante no puede ser negativo.');

      const btn = document.getElementById('btnSaveAdj');
      btn.disabled = true;
      btn.innerText = 'PROCESANDO...';

      try {
        // 1. Log movimiento
        const { error: moveError } = await client.from('inventory_movements').insert({
          sku_id: skuId,
          user_id: currentUser.id === 'dev' ? null : currentUser.id,
          change_amount: changeAmount,
          movement_type: type,
          notes: notes,
          event_date: new Date().toISOString().split('T')[0]
        });
        if (moveError) throw moveError;

        // 2. Update Stock (UPSERT por sku_id)
        const { error: stockError } = await client.from('inventory_stock').upsert({
          sku_id: skuId,
          stock_current: newStock
        }, { onConflict: 'sku_id' });

        if (stockError) throw stockError;

        if (window.MC_UTILS && typeof MC_UTILS.showToast === 'function') {
          MC_UTILS.showToast('Stock actualizado.');
        } else {
          alert('‚úÖ Stock actualizado.');
        }

        closeModal();
        await loadData();

      } catch (e) {
        console.error(e);
        alert('Error: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.innerText = 'Confirmar Ajuste';
      }
    }

    async function handleRequest(skuId) {
      const input = document.getElementById(`req-${skuId}`);
      const qty = parseFloat(input.value);
      
      if (!qty || qty <= 0) return alert('Ingresa una cantidad v√°lida.');

      const sku = allSkus.find(x => x.id === skuId);
      if (!sku) return;

      if (!confirm(`¬øSolicitar ${qty} ${sku.unit_type || 'UN'} de ${sku.name}?`)) return;

      try {
        const { error } = await client.from('stock_requests').insert({
          sku_id: skuId,
          requested_qty: qty,
          requested_by: currentUser.id === 'dev' ? null : currentUser.id,
          status: 'PENDING'
        });

        if (error) throw error;

        if (window.MC_UTILS && typeof MC_UTILS.showToast === 'function') {
          MC_UTILS.showToast('Solicitud enviada a Compras/Admin.');
        } else {
          alert('Solicitud enviada a Compras/Admin.');
        }

        input.value = '';
        await loadData();
      } catch (e) {
        console.error(e);
        alert('Error al solicitar: ' + e.message);
      }
    }
  </script>
</body>
</html>

