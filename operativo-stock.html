<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Midnight - Stock Operativo</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>

<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div style="display:flex; align-items:center;">
          <button onclick="window.location.href='operativo-index.html'" class="btn-back">VOLVER</button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">Operativo</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <section class="section-header">
      <h1 class="section-title">STOCK GLOBAL OPERATIVO</h1>
      <p class="section-desc">Control de inventario f√≠sico, ajustes r√°pidos y solicitudes de reposici√≥n hacia Compras/Admin.</p>
    </section>

    <div class="box-soft" style="margin-bottom:16px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px; max-width:520px;">
          <input
            type="text"
            id="searchInput"
            class="search-input-admin"
            placeholder="üîç Buscar por nombre o categor√≠a..."
            oninput="filterList()"
          >
        </div>

        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span id="countSkus" class="tag tag-gray">0 insumos</span>
          <button onclick="loadData()" class="btn-secondary">REFRESCAR DATOS</button>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; gap:12px; flex-wrap:wrap;">
        <span id="stockStatus" class="inline-status">Cargando inventario...</span>
      </div>
    </div>

    <div class="table-container">
      <table class="sku-table">
        <thead>
          <tr>
            <th style="padding-left:20px;">INSUMO / CATEGOR√çA</th>
            <th>FORMATO</th>
            <th class="text-center" style="width:120px;">STOCK (UN)</th>
            <th class="text-center" style="width:100px;">IDEAL</th>
            <th class="text-center" style="width:160px;">AJUSTE R√ÅPIDO</th>
            <th class="text-center" style="width:240px; padding-right:20px;">SOLICITAR REPOSICI√ìN</th>
          </tr>
        </thead>
        <tbody id="skuList">
          <tr>
            <td colspan="6" class="text-center text-muted" style="padding:40px;">Cargando inventario...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Modal Ajuste Manual -->
  <div id="adjustModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <h3 class="section-title" style="font-size:18px; margin:0;">AJUSTE DE STOCK</h3>
          <p class="section-desc" style="margin:0; font-size:12px;">Registra un movimiento manual (impacta al instante).</p>
        </div>
        <div style="text-align:right;">
          <span id="adjToday" class="tag tag-gray">Hoy</span>
        </div>
      </div>

      <input type="hidden" id="adjSkuId">
      <input type="hidden" id="adjCurrentStock">

      <div class="box-soft" style="margin-bottom:16px;">
        <label class="input-label">INSUMO SELECCIONADO</label>
        <div id="adjSkuName" class="row-title" style="font-size:16px;">‚Äî</div>
        <div id="adjSkuMeta" class="row-sub-text">Stock actual: ‚Äî</div>
      </div>

      <div style="display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:240px;">
          <label class="input-label">TIPO DE MOVIMIENTO</label>
          <select id="adjType" class="modal-select">
            <option value="AJUSTE_POSITIVO">INGRESO / AJUSTE (+)</option>
            <option value="AJUSTE_NEGATIVO">EGRESO / AJUSTE (-)</option>
            <option value="RECEPCION_COMPRA">RECEPCI√ìN DE COMPRA (+)</option>
            <option value="INVENTARIO_FISICO">CONTEO F√çSICO (CORRECCI√ìN)</option>
          </select>
        </div>

        <div style="width:140px;">
          <label class="input-label">CANTIDAD</label>
          <input type="number" id="adjAmount" class="modal-input" placeholder="0" inputmode="numeric">
        </div>
      </div>

      <div style="margin-bottom:8px;">
        <label class="input-label">NOTA / JUSTIFICACI√ìN (OBLIGATORIO)</label>
        <textarea id="adjNotes" class="modal-input" placeholder="Motivo del ajuste..." style="height:90px;"></textarea>
      </div>

      <div class="modal-btns">
        <button onclick="closeModal()" class="btn-secondary">CANCELAR</button>
        <button onclick="saveAdjustment()" id="btnSaveAdj" class="btn-primary">CONFIRMAR</button>
      </div>
    </div>
  </div>

  <script>
    let allSkus = [];
    let currentUser = null;

    const statusEl = document.getElementById('stockStatus');
    const countEl = document.getElementById('countSkus');

    document.addEventListener('DOMContentLoaded', async () => {
      const session = localStorage.getItem('mc_user');
      if (!session) { window.location.href = 'index.html'; return; }
      currentUser = JSON.parse(session);

      document.getElementById('adjToday').innerText = new Date().toLocaleDateString('es-AR');

      // click fuera para cerrar modal
      document.getElementById('adjustModal').addEventListener('click', (e) => {
        if (e.target && e.target.id === 'adjustModal') closeModal();
      });

      await loadData();
    });

    // =========================
    // CARGA DE DATOS
    // =========================
    async function loadData() {
      try {
        statusEl.textContent = 'Actualizando datos...';

        const { data: skusData, error: skusError } = await client
          .from('inventory_skus')
          .select(`
            id,
            name,
            category,
            unit_type,
            pack_size,
            unit_label,
            inventory_stock (stock_current, stock_ideal)
          `)
          .eq('is_active', true)
          .order('name');

        if (skusError) throw skusError;

        const { data: reqData } = await client
          .from('stock_requests')
          .select('sku_id, requested_qty, status')
          .eq('status', 'PENDING');

        const pendingRequests = new Map();
        (reqData || []).forEach(r => {
          const prev = pendingRequests.get(r.sku_id) || 0;
          pendingRequests.set(r.sku_id, prev + (safeNum(r.requested_qty) || 0));
        });

        allSkus = (skusData || []).map(item => {
          const stockRecord = Array.isArray(item.inventory_stock) ? item.inventory_stock[0] : item.inventory_stock;
          return {
            id: Number(item.id),
            name: item.name || '',
            category: item.category || null,
            unit_type: item.unit_type || null,
            pack_size: item.pack_size,
            unit_label: item.unit_label || null,
            stock_current: stockRecord ? safeNum(stockRecord.stock_current) : 0,
            stock_ideal: stockRecord ? safeNum(stockRecord.stock_ideal) : 0,
            pending_request: pendingRequests.get(item.id) || 0
          };
        });

        renderList(getCurrentList());
        updateCount();

        statusEl.textContent = 'Actualizado ' + new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });

      } catch (e) {
        console.error('Error:', e);
        document.getElementById('skuList').innerHTML =
          '<tr><td colspan="6" class="text-center" style="padding: 40px; color:var(--accent-red);">Error de conexi√≥n: ' + escapeHtml(e.message || e) + '</td></tr>';
        statusEl.textContent = 'Error de conexi√≥n. Intent√° nuevamente.';
      }
    }

    function updateCount() { countEl.textContent = `${allSkus.length} insumos`; }

    // =========================
    // LISTA & FILTRO
    // =========================
    function getCurrentList() {
      const t = (document.getElementById('searchInput').value || '').toLowerCase().trim();
      if (!t) return allSkus;
      return allSkus.filter(i =>
        (i.name || '').toLowerCase().includes(t) ||
        (i.category || '').toLowerCase().includes(t)
      );
    }

    function filterList() { renderList(getCurrentList()); }

    function renderList(list) {
      const tbody = document.getElementById('skuList');

      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted" style="padding:40px;">Sin resultados.</td></tr>';
        return;
      }

      tbody.innerHTML = list.map(i => {
        const stockVal = safeNum(i.stock_current);
        const idealVal = safeNum(i.stock_ideal);

        let stockColor = 'var(--text-primary)';
        if (idealVal > 0) {
          if (stockVal <= (idealVal * 0.2)) stockColor = 'var(--accent-red)';
          else if (stockVal < idealVal) stockColor = 'var(--accent-gold)';
          else stockColor = 'var(--accent-green)';
        } else {
          stockColor = 'var(--text-secondary)';
        }

        let presentation = escapeHtml(i.unit_type || '-');
        if (i.unit_label === 'PACK' && safeNum(i.pack_size) > 1) {
          presentation = `<span class="tag tag-blue">${escapeHtml(i.unit_type || 'UNIDAD')} (PACK x${safeNum(i.pack_size)})</span>`;
        }

        const pendingText = i.pending_request > 0
          ? `<div style="font-size:10px; color:var(--accent-gold); margin-top:4px;">‚è≥ Pendiente: ${i.pending_request}</div>`
          : '';

        return `
          <tr>
            <td style="padding-left: 20px;">
              <div class="row-title">${escapeHtml(i.name)}</div>
              <div class="row-sub-text">${escapeHtml(i.category || 'SIN CATEGOR√çA')}</div>
            </td>

            <td style="font-size:11px;">${presentation}</td>

            <td class="text-center" style="font-size:14px; font-weight:800; color:${stockColor};">
              ${stockVal}
            </td>

            <td class="text-center text-muted">
              ${idealVal || '-'}
            </td>

            <td class="text-center">
              <button onclick="openModal(${i.id}, 1)" class="btn-icon" title="Ingreso r√°pido">+</button>
              <button onclick="openModal(${i.id}, -1)" class="btn-icon" title="Egreso r√°pido" style="margin-left:6px;">‚àí</button>
            </td>

            <td class="text-center" style="padding-right:20px;">
              <div style="display:flex; align-items:center; justify-content:center; gap:6px;">
                <input
                  type="number"
                  min="1"
                  id="req-${i.id}"
                  class="table-input"
                  style="width:70px; border:1px solid var(--border-subtle);"
                  placeholder="0"
                  inputmode="numeric"
                >
                <button class="btn-primary" style="padding:6px 10px; font-size:10px;" onclick="handleRequest(${i.id})">
                  PEDIR
                </button>
              </div>
              ${pendingText}
            </td>
          </tr>
        `;
      }).join('');
    }

    // =========================
    // MODAL AJUSTE
    // =========================
    function openModal(skuId, typeSign) {
      const sku = allSkus.find(x => x.id === Number(skuId));
      if (!sku) return;

      document.getElementById('adjSkuId').value = sku.id;
      document.getElementById('adjCurrentStock').value = safeNum(sku.stock_current);
      document.getElementById('adjSkuName').innerText = sku.name;
      document.getElementById('adjSkuMeta').innerText = `Stock actual: ${safeNum(sku.stock_current)} ${sku.unit_type || 'UNIDAD'}`;

      const selectType = document.getElementById('adjType');
      const btn = document.getElementById('btnSaveAdj');

      if (typeSign === 1) {
        selectType.value = 'AJUSTE_POSITIVO';
        btn.textContent = 'CONFIRMAR INGRESO';
      } else {
        selectType.value = 'AJUSTE_NEGATIVO';
        btn.textContent = 'CONFIRMAR EGRESO';
      }

      document.getElementById('adjAmount').value = '';
      document.getElementById('adjNotes').value = '';

      document.getElementById('adjustModal').style.display = 'flex';
      setTimeout(() => document.getElementById('adjAmount').focus(), 50);
    }

    function closeModal() { document.getElementById('adjustModal').style.display = 'none'; }

    // =========================
    // ACCIONES
    // =========================
    async function saveAdjustment() {
      const skuId = Number(document.getElementById('adjSkuId').value);
      const currentStock = safeNum(document.getElementById('adjCurrentStock').value);
      const type = document.getElementById('adjType').value;
      const amount = safeNum(document.getElementById('adjAmount').value);
      const notes = (document.getElementById('adjNotes').value || '').trim();

      if (!amount || amount <= 0) return alert('Ingres√° una cantidad v√°lida.');
      if (!notes) return alert('La justificaci√≥n es obligatoria.');

      let changeAmount = amount;

      if (type === 'AJUSTE_NEGATIVO') changeAmount = -amount;
      if (type === 'INVENTARIO_FISICO') {
        // amount = conteo total
        changeAmount = amount - currentStock;
      }
      // RECEPCION_COMPRA => positivo, queda tal cual

      const newStock = currentStock + changeAmount;
      if (newStock < 0) return alert('El stock resultante no puede ser negativo.');

      const btn = document.getElementById('btnSaveAdj');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'PROCESANDO...';

      try {
        const eventDate = getLocalISODate();

        const { error: moveError } = await client.from('inventory_movements').insert({
          sku_id: skuId,
          user_id: currentUser?.id || null,
          change_amount: changeAmount,
          movement_type: type,
          notes: notes,
          event_date: eventDate
        });
        if (moveError) throw moveError;

        const { error: stockError } = await client.from('inventory_stock').upsert({
          sku_id: skuId,
          stock_current: newStock
        }, { onConflict: 'sku_id' });
        if (stockError) throw stockError;

        if (window.MC_UTILS && typeof MC_UTILS.showToast === 'function') {
          MC_UTILS.showToast('Stock actualizado.');
        }

        closeModal();
        await loadData();

      } catch (e) {
        console.error(e);
        alert('Error: ' + (e.message || e));
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function handleRequest(skuId) {
      const input = document.getElementById(`req-${skuId}`);
      const qty = safeNum(input.value);

      if (!qty || qty <= 0) return alert('Ingres√° una cantidad v√°lida.');

      const sku = allSkus.find(x => x.id === Number(skuId));
      if (!sku) return;

      if (!confirm(`¬øSolicitar ${qty} ${sku.unit_type || 'UN'} de ${sku.name}?`)) return;

      try {
        const { error } = await client.from('stock_requests').insert({
          sku_id: Number(skuId),
          requested_qty: qty,
          requested_by: currentUser?.id || null,
          status: 'PENDING'
        });

        if (error) throw error;

        input.value = '';
        await loadData();

      } catch (e) {
        console.error(e);
        alert('Error al solicitar: ' + (e.message || e));
      }
    }

    // =========================
    // HELPERS
    // =========================
    function safeNum(v) {
      const n = Number(String(v ?? '').replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function getLocalISODate() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }
  </script>
</body>
</html>
