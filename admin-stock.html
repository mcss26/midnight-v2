<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Midnight - Stock Administrativo</title>

  <link rel="stylesheet" href="admin-styles.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@600;700&display=swap"
    rel="stylesheet" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
</head>

<body>
  <header class="admin-header">
    <div class="admin-header-inner">
      <div class="admin-header-top">
        <div>
          <button onclick="window.location.href='administracion-index.html'" class="btn-back">VOLVER</button>
        </div>

        <div class="admin-logo" aria-hidden="true"></div>

        <div class="admin-header-right">
          <span class="session-chip">AdministraciÃ³n</span>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-container">
    <section class="section-header">
      <h1 class="section-title">STOCK ADMINISTRATIVO</h1>
      <p class="section-desc">ComparaciÃ³n Gbol vs stock ideal y solicitudes operativas.</p>
    </section>

    <div class="box-soft"
      style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; flex-wrap:wrap;">
      <p class="section-desc" style="margin:0; font-size:11px; max-width:460px;">
        SincronizÃ¡ los datos directamente desde el servidor de <strong>GBol</strong> (Stock actual y Precios).
      </p>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="btn-secondary" type="button" id="syncButton">
          ðŸ”„ SINCRONIZAR CON GBOL
        </button>
      </div>
    </div>

    <div id="importStatus" class="section-desc" style="min-height:18px; margin-bottom:4px;"></div>

    <div
      style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:space-between; margin-bottom:16px;">
      <div style="flex:1; min-width:220px;">
        <label class="input-label" for="searchSku">BUSCAR INSUMO</label>
        <input id="searchSku" class="search-input-admin" type="text" placeholder="Nombre o cÃ³digo..." />
      </div>

      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:flex-end;">
        <div style="min-width:150px;">
          <label class="input-label" for="filterStatus">ESTADO STOCK</label>
          <select id="filterStatus" class="modal-select">
            <option value="">Todos</option>
            <option value="BAJO">Stock bajo</option>
            <option value="OK">Stock OK</option>
            <option value="SOBRE">Sobre stock</option>
            <option value="SIN_STOCK">Sin stock real</option>
            <option value="SIN_IDEAL">Sin ideal</option>
          </select>
        </div>

        <div style="min-width:160px;">
          <label class="input-label" for="orderBy">ORDENAR POR</label>
          <select id="orderBy" class="modal-select">
            <option value="NAME_ASC">Nombre A-Z</option>
            <option value="NAME_DESC">Nombre Z-A</option>
            <option value="VALUE_DESC">Valor stock â†“</option>
            <option value="DELTA_DESC">Brecha vs ideal â†“</option>
          </select>
        </div>

        <div class="box-soft" style="min-width:220px; text-align:right; padding:10px 14px;">
          <div class="input-label" style="font-size:10px;">
            VALOR TOTAL STOCK (GBOL)
          </div>
          <div id="stockTotalValue" style="margin-top:4px; font-size:18px; font-weight:600;">
            -
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="sku-table" id="stockTable" aria-label="Tabla de stock administrativo">
        <thead>
          <tr>
            <th>INSUMO</th>
            <th class="text-right">STOCK GBOL</th>
            <th class="text-right">STOCK IDEAL</th>
            <th class="text-right">COSTO UNITARIO</th>
            <th class="text-right">VALOR STOCK</th>
            <th class="text-right">SOLICITUD</th>
            <th class="text-right" style="width:100px;">ORDENAR</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>
  </main>

  <script>
    const syncButton = document.getElementById('syncButton');
    const importStatus = document.getElementById('importStatus');
    const tableBody = document.querySelector('#stockTable tbody');

    const searchInput = document.getElementById('searchSku');
    const filterStatus = document.getElementById('filterStatus');
    const orderBySelect = document.getElementById('orderBy');

    let allRows = [];
    let totalValorStock = 0;

    document.addEventListener('DOMContentLoaded', () => {
      loadData(); // Carga inicial con lo que haya en DB

      syncButton.addEventListener('click', async () => {
        await syncGbolData();
        await loadData(); // Recarga la tabla tras sincronizar
      });

      // Filtros
      searchInput.addEventListener('input', applyFiltersAndRender);
      filterStatus.addEventListener('change', applyFiltersAndRender);
      orderBySelect.addEventListener('change', applyFiltersAndRender);
    });

    // --- CARGA DE DATOS (LEER DE SUPABASE) ---
    async function loadData() {
      // Limpiamos mensaje de estado solo si no estamos en proceso de carga
      if (syncButton.disabled === false) importStatus.textContent = '';
      
      try {
        const [{ data: skus, error: skusError }, { data: stock, error: stockError }] =
          await Promise.all([
            client
              .from('inventory_skus')
              .select('id, external_id, name, cost_price')
              .order('name', { ascending: true }),
            client.from('inventory_stock').select('sku_id, stock_ideal')
          ]);

        if (skusError) throw skusError;
        if (stockError) throw stockError;

        // Obtenemos el ÃšLTIMO registro de importaciÃ³n para cada SKU
        // Ordenamos por fecha descendente para tomar el mÃ¡s nuevo
        const { data: gbolData, error: gbolError } = await client
          .from('import_gbol_stock')
          .select('sku_id, stock_real, import_date')
          .order('import_date', { ascending: false });

        if (gbolError) throw gbolError;

        const latestGbolBySku = new Map();
        (gbolData || []).forEach((row) => {
          if (row.sku_id && !latestGbolBySku.has(row.sku_id)) {
            latestGbolBySku.set(row.sku_id, row);
          }
        });

        // Solicitudes pendientes
        const { data: requestsData, error: reqError } = await client
          .from('stock_requests')
          .select('sku_id, requested_qty, status');

        if (reqError) throw reqError;

        const pendingRequests = new Map();
        (requestsData || [])
          .filter((r) => r.status === 'PENDING')
          .forEach((r) => {
            const prev = pendingRequests.get(r.sku_id) || 0;
            pendingRequests.set(r.sku_id, prev + (Number(r.requested_qty) || 0));
          });

        // Stock Ideal Map
        const stockMap = new Map();
        (stock || []).forEach((row) => {
          stockMap.set(row.sku_id, Number(row.stock_ideal) || 0);
        });

        // Unificar todo
        allRows = (skus || []).map((sku) => {
          const stockActual = Number(latestGbolBySku.get(sku.id)?.stock_real) || 0;
          const stockIdeal = stockMap.get(sku.id) ?? 0;
          const solicitudOperativa = pendingRequests.get(sku.id) || 0;
          const costoUnitario = Number(sku.cost_price) || 0;
          const valorStock = stockActual * costoUnitario;

          // ClasificaciÃ³n de estado
          let status = 'SIN_IDEAL';
          if (stockIdeal > 0) {
            if (stockActual === 0) status = 'SIN_STOCK';
            else if (stockActual < stockIdeal) status = 'BAJO';
            else if (stockActual > stockIdeal * 1.3) status = 'SOBRE';
            else status = 'OK';
          } else if (stockActual === 0) {
            status = 'SIN_IDEAL';
          } else {
            status = 'SOBRE';
          }

          return {
            skuId: sku.id,
            codigo: sku.external_id,
            insumo: sku.name,
            stockActual,
            stockIdeal,
            costoUnitario,
            solicitudOperativa,
            valorStock,
            status,
            deltaIdeal: stockActual - stockIdeal
          };
        });

        totalValorStock = allRows.reduce((acc, r) => acc + (r.valorStock || 0), 0);
        updateTotalCard();
        applyFiltersAndRender();
      } catch (error) {
        console.error('Error al cargar datos', error);
        importStatus.textContent = 'Error al cargar datos de Supabase.';
      }
    }

   // --- PEGA ESTO REEMPLAZANDO LA FUNCIÃ“N ANTERIOR EN admin-stock.html ---
    async function syncGbolData() {
      try {
        syncButton.disabled = true;
        syncButton.textContent = 'CONECTANDO...';
        importStatus.textContent = 'Consultando API de GBol...';

        // 1. Fetch a la API
        const response = await fetch("https://sd-2515114-h00190.ferozo.net/gbol/api/inventarios/stockIdealCompras", {
          "headers": {
            "accept": "application/json, text/plain, */*",
            "authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiI3UUhyZHJTaWNmUDJjOWowT2RMc1VjNmJVcFFkVFRSMEpFZ3JTSDBGM2pieVlWaHpNeDRYTEJhcUlEVWR0VDR2OSt4a1kxTzliUHhDc3grMVBQNVo3RmVYN2I0RGR2dk5UaGh2dzJOWWVpcz0iLCJleHAiOjE3NjU1OTEwMjd9.qUXEqRBV2oArhWug01KMNaTQ-VYGQ3EVVNv816hWmao"
          },
          "method": "GET",
          "mode": "cors",
          "credentials": "omit"  // <--- CAMBIAMOS A "omit" O BORRAMOS LA LÃNEA
        });

        if (!response.ok) {
          throw new Error(`Error API GBol: ${response.status}`);
        }

        const jsonData = await response.json();
        
        if (!Array.isArray(jsonData) || jsonData.length === 0) {
          throw new Error('La API devolviÃ³ datos vacÃ­os o formato incorrecto.');
        }

        importStatus.textContent = `Procesando ${jsonData.length} registros...`;

        // 2. Obtener SKUs para mapear
        const { data: skus, error: skusError } = await client
          .from('inventory_skus')
          .select('id, external_id');

        if (skusError) throw skusError;

        const skuMap = new Map((skus || []).map((s) => [String(s.external_id).trim(), s.id]));
        const now = new Date().toISOString();

        const stockPayload = [];
        const priceUpdates = [];

        // 3. Recorrer JSON
        for (const item of jsonData) {
            const codigo = String(item.codigo || '').trim();
            const skuId = skuMap.get(codigo);

            if (skuId) {
                const stockReal = parseFloat(item.stock) || 0;
                
                stockPayload.push({
                    sku_id: skuId,
                    codigo: codigo,
                    detalle: item.detalle || '',
                    stock_real: stockReal,
                    import_date: now
                });

                const nuevoPrecio = parseFloat(item.precio) || 0;
                if (nuevoPrecio > 0) {
                    priceUpdates.push({
                        skuId: skuId,
                        cost: nuevoPrecio
                    });
                }
            }
        }

        if (stockPayload.length === 0) {
            throw new Error('No se encontraron coincidencias de CÃ³digos (External ID).');
        }

        // 4. Insertar Historial
        const { error: insertError } = await client.from('import_gbol_stock').insert(stockPayload);
        if (insertError) throw insertError;

        // 5. Actualizar Precios
        let updatedPricesCount = 0;
        if (priceUpdates.length > 0) {
            importStatus.textContent = 'Actualizando precios...';
            for (const p of priceUpdates) {
                await client
                    .from('inventory_skus')
                    .update({ cost_price: p.cost })
                    .eq('id', p.skuId);
                updatedPricesCount++;
            }
        }

        importStatus.textContent = `SincronizaciÃ³n Exitosa: ${stockPayload.length} stocks, ${updatedPricesCount} precios.`;
        importStatus.style.color = 'var(--accent-green)';

      } catch (error) {
        console.error('Error Sync GBol', error);
        importStatus.textContent = 'Error: ' + error.message;
        importStatus.style.color = 'var(--accent-red)';
      } finally {
        syncButton.disabled = false;
        syncButton.textContent = 'ðŸ”„ SINCRONIZAR CON GBOL';
      }
    }
    // --- RENDERIZADO Y UTILIDADES ---

    function updateTotalCard() {
      const totalEl = document.getElementById('stockTotalValue');
      if (!totalEl) return;

      if (typeof MC_UTILS !== 'undefined' && MC_UTILS.formatCurrency) {
        totalEl.textContent = MC_UTILS.formatCurrency(totalValorStock);
      } else {
        totalEl.textContent = `$ ${totalValorStock.toFixed(0)}`;
      }
    }

    function applyFiltersAndRender() {
      let rows = [...allRows];

      const term = (searchInput.value || '').toLowerCase().trim();
      const statusFilter = filterStatus.value;

      if (term) {
        rows = rows.filter((r) => {
          return (
            (r.insumo || '').toLowerCase().includes(term) ||
            (r.codigo || '').toString().toLowerCase().includes(term)
          );
        });
      }

      if (statusFilter) {
        rows = rows.filter((r) => r.status === statusFilter);
      }

      const orderBy = orderBySelect.value || 'NAME_ASC';
      rows.sort((a, b) => {
        switch (orderBy) {
          case 'NAME_DESC':
            return b.insumo.localeCompare(a.insumo);
          case 'VALUE_DESC':
            return (b.valorStock || 0) - (a.valorStock || 0);
          case 'DELTA_DESC':
            return (b.deltaIdeal || 0) - (a.deltaIdeal || 0);
          case 'NAME_ASC':
          default:
            return a.insumo.localeCompare(b.insumo);
        }
      });

      renderTable(rows);
    }

    function renderTable(rows) {
      tableBody.innerHTML = '';

      if (!rows.length) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center; padding:30px;">
              Sin resultados para las condiciones actuales.
            </td>
          </tr>
        `;
        return;
      }

      rows.forEach((row) => {
        const tr = document.createElement('tr');

        const tdInsumo = document.createElement('td');
        tdInsumo.innerHTML = `
          <div class="row-title">${row.insumo}</div>
          <div class="row-sub-text">CÃ³digo: ${row.codigo ?? '-'}</div>
        `;

        // STOCK GBOL (color segÃºn estado)
        const tdActual = document.createElement('td');
        tdActual.className = 'text-right';
        tdActual.textContent = row.stockActual;

        let stockColor = 'var(--text-primary)';
        if (row.status === 'SIN_STOCK') stockColor = 'var(--accent-red)';
        else if (row.status === 'BAJO') stockColor = 'var(--accent-gold)';
        else if (row.status === 'OK') stockColor = 'var(--accent-green)';
        else if (row.status === 'SOBRE') stockColor = 'var(--text-secondary)';

        tdActual.style.color = stockColor;
        tdActual.style.fontWeight = '600';

        // STOCK IDEAL + brecha
        const tdIdeal = document.createElement('td');
        tdIdeal.className = 'text-right';

        const idealVal = row.stockIdeal || 0;
        const faltante = Math.max(row.stockIdeal - row.stockActual, 0);
        const sobra = Math.max(row.stockActual - row.stockIdeal, 0);

        let idealSub = '';
        if (row.stockIdeal > 0) {
          if (faltante > 0) idealSub = `Faltan ${faltante}`;
          else if (sobra > 0) idealSub = `+${sobra} sobre ideal`;
          else idealSub = 'En rango';
        } else {
          idealSub = 'Sin ideal';
        }

        tdIdeal.innerHTML = `
          <div>${idealVal}</div>
          <div class="row-sub-text" style="text-align:right;">${idealSub}</div>
        `;

        // COSTO UNITARIO
        const tdCosto = document.createElement('td');
        tdCosto.className = 'text-right col-costo';
        const unitCost = row.costoUnitario || 0;
        tdCosto.textContent =
          typeof MC_UTILS !== 'undefined' && MC_UTILS.formatCurrency
            ? MC_UTILS.formatCurrency(unitCost)
            : `$ ${unitCost.toFixed(0)}`;

        // VALOR STOCK
        const tdValor = document.createElement('td');
        tdValor.className = 'text-right col-costo';
        const valor = row.valorStock || 0;
        tdValor.textContent =
          typeof MC_UTILS !== 'undefined' && MC_UTILS.formatCurrency
            ? MC_UTILS.formatCurrency(valor)
            : `$ ${valor.toFixed(0)}`;

        // SOLICITUD OPERATIVA
        const tdSolicitud = document.createElement('td');
        tdSolicitud.className = 'text-right';
        if (row.solicitudOperativa > 0) {
          tdSolicitud.innerHTML = `
            <span class="tag tag-gray" style="border-color:var(--accent-gold); color:var(--accent-gold);">
              PEND: ${row.solicitudOperativa}
            </span>
          `;
        } else {
          tdSolicitud.innerHTML = `<span class="row-sub-text">â€”</span>`;
        }

        // BOTÃ“N ORDENAR
        const tdOrden = document.createElement('td');
        tdOrden.className = 'text-right';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-primary';
        btn.textContent = 'ORDENAR';

        // Leve acento visual si estÃ¡ bajo/sin stock
        if (row.status === 'SIN_STOCK' || row.status === 'BAJO') {
          btn.style.borderColor = 'var(--accent-gold)';
        }

        btn.addEventListener('click', () => handleOrderClick(row, btn));
        tdOrden.appendChild(btn);

        tr.append(tdInsumo, tdActual, tdIdeal, tdCosto, tdValor, tdSolicitud, tdOrden);
        tableBody.appendChild(tr);
      });
    }

    async function handleOrderClick(row, buttonEl) {
      const faltanteIdeal = Math.max(row.stockIdeal - row.stockActual, 0);
      const cantidad = row.solicitudOperativa > 0 ? row.solicitudOperativa : faltanteIdeal;

      if (cantidad <= 0) {
        alert('No hay cantidad pendiente para ordenar (Stock actual cubre el ideal).');
        return;
      }

      const unitCost = row.costoUnitario || 0;
      const totalCost = unitCost * cantidad;

      try {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Generando...';

        const { error } = await client.from('stock_orders').insert({
          sku_id: row.skuId,
          quantity: cantidad,
          unit_cost: unitCost,
          total_cost: totalCost,
          status: 'PENDING'
        });
        if (error) throw error;

        // Actualizar solicitud operativa a ORDERED si existÃ­a
        try {
          await client
            .from('stock_requests')
            .update({ status: 'ORDERED' })
            .eq('sku_id', row.skuId)
            .eq('status', 'PENDING');
        } catch (err) {
          console.warn('No se pudieron actualizar las solicitudes', err);
        }

        buttonEl.textContent = 'Orden generada';
        // Opcional: recargar datos
        // await loadData(); 
      } catch (error) {
        console.error('Error al generar orden', error);
        buttonEl.disabled = false;
        buttonEl.textContent = 'ORDENAR';
        alert('No se pudo generar la orden. Intenta nuevamente.');
      }
    }
  </script>
</body>
</html>